(()=>{"use strict";let e,t=Symbol("Comlink.proxy"),a=Symbol("Comlink.endpoint"),r=Symbol("Comlink.releaseProxy"),n=Symbol("Comlink.finalizer"),i=Symbol("Comlink.thrown"),s=e=>"object"==typeof e&&null!==e||"function"==typeof e,o=new Map([["proxy",{canHandle:e=>s(e)&&e[t],serialize(e){let{port1:t,port2:a}=new MessageChannel;return l(e,t),[a,[a]]},deserialize:e=>{var t;let n;return e.start(),t=e,n=new Map,t.addEventListener("message",function(e){let{data:t}=e;if(!t||!t.id)return;let a=n.get(t.id);if(a)try{a(t)}finally{n.delete(t.id)}}),function e(t,n,i=[],s=function(){}){let o,l=!1,p=new Proxy(s,{get(a,s){if(d(l),s===r)return()=>{u&&u.unregister(p),c(t),n.clear(),l=!0};if("then"===s){if(0===i.length)return{then:()=>p};let e=w(t,n,{type:"GET",path:i.map(e=>e.toString())}).then(m);return e.then.bind(e)}return e(t,n,[...i,s])},set(e,a,r){d(l);let[s,o]=g(r);return w(t,n,{type:"SET",path:[...i,a].map(e=>e.toString()),value:s},o).then(m)},apply(r,s,o){d(l);let p=i[i.length-1];if(p===a)return w(t,n,{type:"ENDPOINT"}).then(m);if("bind"===p)return e(t,n,i.slice(0,-1));let[c,h]=f(o);return w(t,n,{type:"APPLY",path:i.map(e=>e.toString()),argumentList:c},h).then(m)},construct(e,a){d(l);let[r,s]=f(a);return w(t,n,{type:"CONSTRUCT",path:i.map(e=>e.toString()),argumentList:r},s).then(m)}});return o=(h.get(t)||0)+1,h.set(t,o),u&&u.register(p,t,p),p}(t,n,[],void 0)}}],["throw",{canHandle:e=>s(e)&&i in e,serialize:({value:e})=>[e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[]],deserialize(e){if(e.isError)throw Object.assign(Error(e.value.message),e.value);throw e.value}}]]);function l(e,a=globalThis,r=["*"]){a.addEventListener("message",function s(o){let d;if(!o||!o.data)return;if(!function(e,t){for(let a of e)if(t===a||"*"===a||a instanceof RegExp&&a.test(t))return!0;return!1}(r,o.origin))return void console.warn(`Invalid origin '${o.origin}' for comlink proxy`);let{id:c,type:h,path:u}=Object.assign({path:[]},o.data),f=(o.data.argumentList||[]).map(m);try{var w,b,S;let a=u.slice(0,-1).reduce((e,t)=>e[t],e),r=u.reduce((e,t)=>e[t],e);switch(h){case"GET":d=r;break;case"SET":a[u.slice(-1)[0]]=m(o.data.value),d=!0;break;case"APPLY":d=r.apply(a,f);break;case"CONSTRUCT":w=new r(...f),d=Object.assign(w,{[t]:!0});break;case"ENDPOINT":{let{port1:t,port2:a}=new MessageChannel;l(e,a),b=t,S=[t],y.set(b,S),d=b}break;case"RELEASE":d=void 0;break;default:return}}catch(e){d={value:e,[i]:0}}Promise.resolve(d).catch(e=>({value:e,[i]:0})).then(t=>{let[r,i]=g(t);a.postMessage(Object.assign(Object.assign({},r),{id:c}),i),"RELEASE"===h&&(a.removeEventListener("message",s),p(a),n in e&&"function"==typeof e[n]&&e[n]())}).catch(e=>{let[t,r]=g({value:TypeError("Unserializable return value"),[i]:0});a.postMessage(Object.assign(Object.assign({},t),{id:c}),r)})}),a.start&&a.start()}function p(e){"MessagePort"===e.constructor.name&&e.close()}function d(e){if(e)throw Error("Proxy has been released and is not useable")}function c(e){return w(e,new Map,{type:"RELEASE"}).then(()=>{p(e)})}let h=new WeakMap,u="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{let t=(h.get(e)||0)-1;h.set(e,t),0===t&&c(e)});function f(e){var t;let a=e.map(g);return[a.map(e=>e[0]),(t=a.map(e=>e[1]),Array.prototype.concat.apply([],t))]}let y=new WeakMap;function g(e){for(let[t,a]of o)if(a.canHandle(e)){let[r,n]=a.serialize(e);return[{type:"HANDLER",name:t,value:r},n]}return[{type:"RAW",value:e},y.get(e)||[]]}function m(e){switch(e.type){case"HANDLER":return o.get(e.name).deserialize(e.value);case"RAW":return e.value}}function w(e,t,a,r){return new Promise(n=>{let i=[,,,,].fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.set(i,n),e.start&&e.start(),e.postMessage(Object.assign({id:i},a),r)})}let b=`
def patch_matplotlib():
  import matplotlib
  import matplotlib.pyplot as plt
  from matplotlib import font_manager

  # patch plt.show
  matplotlib.use('Agg')
  index = 1
  def show():
    nonlocal index
    plt.savefig(f'/mnt/data/plot_{index}.png', format="png")
    plt.clf()
    index += 1
  plt.show = show

  # patch fonts
  font_path = '/usr/share/fonts/truetype/STSong.ttf'
  font_manager.fontManager.addfont(font_path)
  plt.rcParams['font.family'] = 'STSong'

patch_matplotlib()`;class S{constructor(e){this.pypiIndexUrl=e.pypiIndexUrl||"PYPI",this.pyodideIndexUrl=e.pyodideIndexUrl||"https://cdn.jsdelivr.net/pyodide/v0.28.2/full",globalThis.importScripts(function(){var e;return e="object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments),function(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var a=e.shift();e[0]=a+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var r=0;r<e.length;r++){var n=e[r];if("string"!=typeof n)throw TypeError("Url must be a string. Received "+n);""!==n&&(r>0&&(n=n.replace(/^[\/]+/,"")),n=r<e.length-1?n.replace(/[\/]+$/,""):n.replace(/[\/]+$/,"/"),t.push(n))}var i=t.join("/"),s=(i=i.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return s.shift()+(s.length>0?"?":"")+s.join("&")}(e)}(this.pyodideIndexUrl,"pyodide.js")),this.uploadedFiles=[]}get pyodide(){if(!e)throw Error("Python interpreter not initialized");return e}async init(){(e=await globalThis.loadPyodide({indexURL:this.pyodideIndexUrl})).FS.mkdirTree("/mnt/data"),e.FS.chdir("/mnt/data")}async uploadFiles(e){for(let t of e){let e=new Uint8Array(await t.arrayBuffer());t.name.startsWith("/")?this.pyodide.FS.writeFile(t.name,e):this.pyodide.FS.writeFile(`/mnt/data/${t.name}`,e),this.uploadedFiles.push(t)}}async downloadFiles(){let e=[];for(let t of this.pyodide.FS.readdir("/mnt/data")){if("."===t||".."===t)continue;let a=`/mnt/data/${t}`,r=new File([new Blob([this.pyodide.FS.readFile(a,{encoding:"binary"})])],a);await this.isNewFile(r)&&e.push(r)}return e}async installPackages(e){await this.pyodide.loadPackage("micropip");let t=this.pyodide.pyimport("micropip");t.set_index_urls([this.pypiIndexUrl,"PYPI"]),await t.install(e)}async runPython(e){let t;await this.patchFonts(),await this.pyodide.loadPackagesFromImports(e),await this.patchPackages();let a=[];this.pyodide.setStdout({batched:e=>{a.push({data:e,type:"stdout"})}}),this.pyodide.setStderr({batched:e=>{a.push({data:e,type:"stderr"})}});let r=!1;try{t=await this.pyodide.runPythonAsync(e),r=!0}catch(e){a.push({data:e instanceof Error?e.message:String(e),type:"stderr"})}return{output:a,result:t?.toString(),success:r}}async patchPackages(){Object.keys(this.pyodide.loadedPackages).includes("matplotlib")&&await this.pyodide.runPythonAsync(b)}async patchFonts(){for(let[e,t]of(this.pyodide.FS.mkdirTree("/usr/share/fonts/truetype"),Object.entries({"STSong.ttf":"https://cdn.jsdelivr.net/gh/Haixing-Hu/latex-chinese-fonts@latest/chinese/宋体/STSong.ttf"}))){let a=await fetch(t,{cache:"force-cache"}).then(e=>e.arrayBuffer());this.pyodide.FS.writeFile(`/usr/share/fonts/truetype/${e}`,new Uint8Array(a))}}async isNewFile(e){let t=async(e,t)=>{if(e.name.startsWith("/")){if(e.name!==t.name)return!1}else if(`/mnt/data/${e.name}`!==t.name)return!1;if(e.size!==t.size)return!1;let a=await e.arrayBuffer(),r=await t.arrayBuffer(),n=new Uint8Array(a),i=new Uint8Array(r),s=n.length;for(let e=0;e<s;e++)if(n[e]!==i[e])return!1;return!0};return(await Promise.all(this.uploadedFiles.map(a=>t(a,e)))).every(e=>!e)}}l(S)})(),_N_E={};