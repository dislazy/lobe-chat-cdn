"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[64811],{5569:(e,t,s)=>{s.d(t,{R:()=>p});var a=s(38326),o=s(71171),r=s(13082),i=s(91804);let n=e=>t=>a.operationSelectors.isMessageInToolCalling(e)(t),l=(e,t)=>s=>{let a=s.toolCallingStreamIds[e];return!!a&&a[t]},d=e=>e.messageRAGLoadingIds.some(t=>(0,o.yf)(e).includes(t)),c=e=>e.isCreatingMessage,u=e=>e.messageLoadingIds.some(t=>(0,o.yf)(e).includes(t)),p={isCreatingMessage:c,isHasMessageLoading:u,isInRAGFlow:d,isInToolsCalling:(e,t)=>s=>{let o=l(e,t)(s),r=a.operationSelectors.isMessageInToolCalling(e)(s);return o||r},isMessageCollapsed:e=>t=>{let s=(0,i.oy)(e)(t);return s?.metadata?.collapsed??!1},isMessageContinuing:e=>t=>a.operationSelectors.isMessageContinuing(e)(t),isMessageCreating:e=>t=>a.operationSelectors.isMessageCreating(e)(t),isMessageEditing:e=>t=>t.messageEditingIds.includes(e),isMessageGenerating:e=>t=>a.operationSelectors.isMessageGenerating(e)(t),isMessageInChatReasoning:e=>t=>a.operationSelectors.isMessageInReasoning(e)(t),isMessageInRAGFlow:e=>t=>t.messageRAGLoadingIds.includes(e),isMessageLoading:e=>t=>!!a.operationSelectors.isMessageProcessing(e)(t)||t.messageLoadingIds.includes(e),isMessageRegenerating:e=>t=>a.operationSelectors.isMessageRegenerating(e)(t),isPluginApiInvoking:n,isSendButtonDisabledByMessage:e=>u(e)||e.creatingTopic||c(e)||d(e),isToolApiNameShining:(e,t,s)=>a=>{let o=(0,r.OX)(s)(a)?.id,i=l(e,t)(a),d=!o||n(o)(a);return i||d},isToolCallStreaming:l}},6182:(e,t,s)=>{s.d(t,{Fp:()=>i,QC:()=>r,vM:()=>n});var a=s(5003);let o=["ar","bg-BG","de-DE","en-US","es-ES","fr-FR","ja-JP","ko-KR","pt-BR","ru-RU","tr-TR","zh-CN","zh-TW","vi-VN","fa-IR","it-IT","pl-PL","nl-NL"],r=e=>{if(!e)return a.xN;if(e.startsWith("ar"))return"ar";if(e.startsWith("fa"))return"fa-IR";if(e.startsWith("cn"))return"zh-CN";for(let t of o)if(t.startsWith(e))return t;return a.xN},i=[{label:"English",value:"en-US"},{label:"简体中文",value:"zh-CN"},{label:"繁體中文",value:"zh-TW"},{label:"日本語",value:"ja-JP"},{label:"한국어",value:"ko-KR"},{label:"Deutsch",value:"de-DE"},{label:"Espa\xf1ol",value:"es-ES"},{label:"العربية",value:"ar"},{label:"Fran\xe7ais",value:"fr-FR"},{label:"Portugu\xeas",value:"pt-BR"},{label:"Русский",value:"ru-RU"},{label:"T\xfcrk\xe7e",value:"tr-TR"},{label:"Polski",value:"pl-PL"},{label:"Nederlands",value:"nl-NL"},{label:"Italiano",value:"it-IT"},{label:"Tiếng Việt",value:"vi-VN"},{label:"Български",value:"bg-BG"},{label:"فارسی",value:"fa-IR"}],n=[...o,"en","zh"]},10903:(e,t,s)=>{s.d(t,{Z:()=>M});var a=s(74551),o=s(45541),r=s(82964),i=s(35475),n=s(91804),l=s(22309);let d=(e,t,s)=>{if(!t)return[];if(s===l.bF.Standalone)return e.filter(e=>e.id===t);let a=e.findIndex(e=>e.id===t);return a<0?[]:e.slice(0,a+1)},c=e=>e.activeTopicId&&e.threadMaps[e.activeTopicId]||[],u=e=>{if(e.portalThreadId)return c(e).find(t=>t.id===e.portalThreadId)},p=e=>e.threadStartMessageId,g=e=>{if(e.startToForkThread)return p(e);let t=u(e);return t?.sourceMessageId},m=(e,t)=>{if(e.startToForkThread){let s=p(e);return d(t.filter(e=>!e.threadId),s,e.newThreadMode)}let s=u(e);return d(t,s?.sourceMessageId,s?.type)},h=e=>t=>n._1.activeDisplayMessages(t).filter(t=>!!e&&t.threadId===e),f=e=>{let t,s=(t=n._1.activeDisplayMessages(e),m(e,t)),o=h(e.portalThreadId)(e);return[...s,n._1.activeDisplayMessages(e).find(e=>e.threadId===a.vS),...o].filter(Boolean)},y=e=>f(e).map(e=>e.id),v=e=>{let t=n._1.activeDisplayMessages(e);return m(e,t)},I=e=>t=>n._1.activeDisplayMessages(t).filter(t=>!!e&&t.threadId===e),M={currentPortalThread:u,currentTopicThreads:c,getFirstThreadBySourceMsgId:e=>t=>c(t).find(t=>t.sourceMessageId===e),getThreadsBySourceMsgId:e=>t=>c(t).filter(t=>t.sourceMessageId===e),getThreadsByTopic:e=>t=>{if(e)return t.threadMaps[e]},hasThreadBySourceMsgId:e=>t=>c(t).some(t=>t.sourceMessageId===e),isSendButtonDisabledByMessage:e=>e.messageLoadingIds.some(t=>y(e).includes(t))||e.isCreatingThread||e.isCreatingThreadMessage||e.messageRAGLoadingIds.some(t=>y(e).includes(t)),isThreadAIGenerating:e=>{let{operationSelectors:t}=s(38326);return t.isAnyMessageLoading(y(e))(e)},portalAIChats:e=>[...v(e),...I(e.portalThreadId)(e)].filter(Boolean),portalAIChatsWithHistoryConfig:e=>{let t=[...v(e),...I(e.portalThreadId)(e)].filter(Boolean),s=r.c.enableHistoryCount(o.o.getState()),a=r.c.historyCount(o.o.getState());return i.m4.getSlicedMessages(t,{enableHistoryCount:s,historyCount:a})},portalDisplayChatIDs:y,portalDisplayChats:f,portalDisplayChatsLength:e=>f(e).length,portalDisplayChatsString:e=>f(e).map(e=>e.content).join(""),portalDisplayChildChatsByThreadId:h,threadSourceMessageId:g,threadSourceMessageIndex:e=>{let t=g(e),s=f(e);return t?s.findIndex(e=>e.id===t):-1},threadStartMessageId:p}},11439:(e,t,s)=>{s.d(t,{e:()=>h});var a=s(96987),o=s(2644),r=s.n(o),i=s(6912),n=s.n(i),l=s(38973),d=s.n(l);r().extend(n()),r().extend(d());let c=e=>{var t;let s;if(!e.length)return[];let a=[...e].sort((e,t)=>t.createdAt-e.createdAt),o=new Map;return a.forEach(e=>{let t=(e=>{let t=r()(e),s=r()();if(t.isToday())return"today";if(t.isYesterday())return"yesterday";let a=s.subtract(7,"day");return!t.isAfter(a)||t.isToday()||t.isYesterday()?t.month()===s.month()&&t.year()===s.year()?"month":t.year()===s.year()?`${t.year()}-${(t.month()+1).toString().padStart(2,"0")}`:`${t.year()}`:"week"})(e.createdAt),s=o.get(t)||[];o.set(t,[...s,e])}),t=Array.from(o.entries()).map(([e,t])=>({children:t,id:e})),(s=new Map).set("today",0),s.set("yesterday",1),s.set("week",2),s.set("month",3),t.sort((e,t)=>{let a=s.get(e.id)??Number.MAX_SAFE_INTEGER,o=s.get(t.id)??Number.MAX_SAFE_INTEGER;return a!==Number.MAX_SAFE_INTEGER||o!==Number.MAX_SAFE_INTEGER?a-o:t.id.localeCompare(e.id)})},u=e=>e.topicMaps[e.activeId],p=e=>u(e)?.find(t=>t.id===e.activeTopicId),g=e=>u(e),m=e=>u(e)?.filter(e=>!e.favorite)||[],h={currentActiveTopic:p,currentActiveTopicSummary:e=>{let t=p(e);if(t)return{content:t.historySummary||"",model:t.metadata?.model||"",provider:t.metadata?.provider||""}},currentTopicLength:e=>u(e)?.length||0,currentTopics:u,currentUnFavTopics:m,displayTopics:g,getTopicById:e=>t=>u(t)?.find(t=>t.id===e),groupedTopicsSelector:e=>{let t=g(e);if(!t)return[];let s=u(e)?.filter(e=>e.favorite)||[],o=m(e);return s.length>0?[{children:s,id:"favorite",title:(0,a.t)("favorite",{ns:"topic"})},...c(o)]:c(t)},isCreatingTopic:e=>e.creatingTopic,isInSearchMode:e=>e.inSearchingMode,isSearchingTopic:e=>e.isSearchingTopic,isUndefinedTopics:e=>!u(e),searchTopics:e=>e.searchTopics}},11678:(e,t,s)=>{s.d(t,{p:()=>i});var a=s(35245),o=s(77605);class r{constructor(){this.createTopic=e=>o.du.topic.createTopic.mutate({...e,sessionId:this.toDbSessionId(e.sessionId)}),this.batchCreateTopics=e=>o.du.topic.batchCreateTopics.mutate(e),this.cloneTopic=(e,t)=>o.du.topic.cloneTopic.mutate({id:e,newTitle:t}),this.getTopics=e=>o.du.topic.getTopics.query({...e,containerId:this.toDbSessionId(e.containerId)}),this.getAllTopics=()=>o.du.topic.getAllTopics.query(),this.countTopics=async e=>o.du.topic.countTopics.query(e),this.rankTopics=async e=>o.du.topic.rankTopics.query(e),this.searchTopics=(e,t,s)=>o.du.topic.searchTopics.query({groupId:s,keywords:e,sessionId:this.toDbSessionId(t)}),this.updateTopic=(e,t)=>o.du.topic.updateTopic.mutate({id:e,value:t}),this.removeTopic=e=>o.du.topic.removeTopic.mutate({id:e}),this.removeTopics=e=>o.du.topic.batchDeleteBySessionId.mutate({id:this.toDbSessionId(e)}),this.batchRemoveTopics=e=>o.du.topic.batchDelete.mutate({ids:e}),this.removeAllTopic=()=>o.du.topic.removeAllTopics.mutate(),this.toDbSessionId=e=>e===a.Ed?null:e}}let i=new r},13082:(e,t,s)=>{s.d(t,{E1:()=>u,OX:()=>d});var a=s(35475),o=s(84354);let r=e=>(0,o.T)(e.activeId,e.activeTopicId),i=e=>t=>t.dbMessagesMap[e]||[],n=e=>e.activeId?i(r(e))(e):[],l=e=>t=>{for(let s of Object.values(t.dbMessagesMap)){let t=a.m4.getMessageById(s,e);if(t)return t}},d=e=>t=>n(t).find(t=>t.tool_call_id===e),c=e=>n(e).filter(e=>"user"===e.role),u={activeDbMessages:n,countDbMessagesByThreadId:e=>t=>n(t).filter(t=>t.threadId===e).length,currentDbChatKey:r,dbToolMessages:e=>n(e).filter(e=>"tool"===e.role),dbUserFiles:e=>c(e).filter(e=>e.fileList&&e.fileList.length>0).flatMap(e=>e.fileList).filter(Boolean),dbUserMessages:c,getDbMessageById:l,getDbMessageByToolCallId:d,getDbMessagesByKey:i,getTraceIdByDbMessageId:e=>t=>l(e)(t)?.traceId,inboxActiveTopicDbMessages:e=>{let t=e.activeTopicId,s=(0,o.T)("inbox",t);return e.dbMessagesMap[s]||[]},isCurrentDbChatLoaded:e=>!!e.dbMessagesMap[r(e)],latestDbMessage:e=>n(e).at(-1)}},17068:(e,t,s)=>{s.d(t,{b:()=>tu,L:()=>tc});var a=s(14308),o=s(50786),r=s(23993),i=s(41734),n=s(40712);let l={activeId:"inbox",activeSessionType:void 0,dbMessagesMap:{},groupAgentMaps:{},groupMaps:{},groupsInit:!1,isCreatingMessage:!1,messageEditingIds:[],messageLoadingIds:[],messagesInit:!1,messagesMap:{},supervisorDebounceTimers:{},supervisorDecisionAbortControllers:{},supervisorDecisionLoading:[],supervisorTodos:{},inputFiles:[],inputMessage:"",mainInputEditor:null,messageRAGLoadingIds:[],searchWorkflowLoadingIds:[],threadInputEditor:null,toolCallingStreamIds:{},activeTopicId:null,creatingTopic:!1,isSearchingTopic:!1,searchTopics:[],topicLoadingIds:[],topicMaps:{},topicSearchKeywords:"",topicsInit:!1,codeInterpreterExecuting:{},codeInterpreterImageMap:{},dalleImageLoading:{},dalleImageMap:{},localFileLoading:{},searchLoading:{},...{isCreatingThread:!1,newThreadMode:s(84106).bF.Continuation,threadInputMessage:"",threadLoadingIds:[],threadMaps:{},threadsInit:!1},...n.O,messageOperationMap:{},operations:{},operationsByContext:{},operationsByMessage:{},operationsByType:{}};var d=s(68096),c=s.n(d),u=s(85601),p=s(53493),g=s(46265),m=s(46355),h=s(87587);let f=(()=>{if("undefined"!=typeof Worker){let e=new Worker(s.tu(new URL(s.p+s.u(93820),s.b)),{type:void 0});return h.LV(e)}})();var y=s(55036);class v{async runPython(e,t,s){if("undefined"==typeof Worker)return;let a=await new f({pyodideIndexUrl:y.env.NEXT_PUBLIC_PYODIDE_INDEX_URL,pypiIndexUrl:y.env.NEXT_PUBLIC_PYPI_INDEX_URL});await a.init(),await a.installPackages(t.filter(e=>""!==e)),await a.uploadFiles(s);let o=await a.runPython(e);return{files:(await a.downloadFiles()).map(e=>({data:e,filename:e.name,previewUrl:URL.createObjectURL(e)})),...o}}}let I=new v;var M=s(13082),T=s(56003),w=s(14056),S=s(61497);let C=(0,S.K)("codeInterpreter"),b=c()("lobe-store:builtin-tool");var _=s(95313);class A{async listLocalFiles(e){try{let t=await _.V.listLocalFiles(e);return{content:JSON.stringify(t),state:{listResults:t},success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async readLocalFile(e){try{let t=await _.V.readLocalFile(e);return{content:JSON.stringify(t),state:{fileContent:t},success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async readLocalFiles(e){try{let t=await _.V.readLocalFiles(e);return{content:JSON.stringify(t),state:{filesContent:t},success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async searchLocalFiles(e){try{let t=await _.V.searchLocalFiles(e);return{content:JSON.stringify(t),state:{searchResults:t},success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async moveLocalFiles(e){try{let t=await _.V.moveLocalFiles(e),s=t.every(e=>e.success),a=t.some(e=>!e.success),o=t.filter(e=>e.success).length,r=t.length-o,i="";i=s?`Successfully moved ${t.length} item(s).`:a?`Moved ${o} item(s) successfully. Failed to move ${r} item(s).`:`Failed to move all ${t.length} item(s).`;let n={results:t,successCount:o,totalCount:t.length};return{content:JSON.stringify({message:i,results:t}),state:n,success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async renameLocalFile(e){try{let t=await _.V.renameLocalFile(e);if(!t.success){let s={error:t.error,newPath:"",oldPath:e.path,success:!1};return{content:JSON.stringify({message:t.error,success:!1}),state:s,success:!1}}let s={newPath:t.newPath,oldPath:e.path,success:!0};return{content:JSON.stringify({message:`Successfully renamed file ${e.path} to ${e.newName}.`,success:!0}),state:s,success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async writeLocalFile(e){try{let t=await _.V.writeFile(e);if(!t.success)return{content:JSON.stringify({message:t.error||"写入文件失败",success:!1}),error:t.error,success:!1};return{content:JSON.stringify({message:`成功写入文件 ${e.path}`,success:!0}),success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async editLocalFile(e){try{let t=await _.V.editLocalFile(e);if(!t.success)return{content:`Edit failed: ${t.error}`,success:!1};let s=t.linesAdded||t.linesDeleted?` (+${t.linesAdded||0} -${t.linesDeleted||0})`:"",a=`Successfully replaced ${t.replacements} occurrence(s) in ${e.file_path}${s}`,o={diffText:t.diffText,linesAdded:t.linesAdded,linesDeleted:t.linesDeleted,replacements:t.replacements};return{content:a,state:o,success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async runCommand(e){try{let t=await _.V.runCommand(e),s={message:t.success?t.shell_id?`Command started in background with shell_id: ${t.shell_id}`:"Command completed successfully.":`Command failed: ${t.error}`,result:t};return{content:JSON.stringify(t),state:s,success:t.success}}catch(e){return{content:e.message,error:e,success:!1}}}async getCommandOutput(e){try{let t=await _.V.getCommandOutput(e),s=t.success?`Output retrieved. Running: ${t.running}`:`Failed: ${t.error}`;return{content:JSON.stringify(t),state:{message:s,result:t},success:t.success}}catch(e){return{content:e.message,error:e,success:!1}}}async killCommand(e){try{let t=await _.V.killCommand(e),s=t.success?`Successfully killed shell: ${e.shell_id}`:`Failed to kill shell: ${t.error}`;return{content:JSON.stringify(t),state:{message:s,result:t},success:t.success}}catch(e){return{content:e.message,error:e,success:!1}}}async grepContent(e){try{let t=await _.V.grepContent(e),s=t.success?`Found ${t.total_matches} matches in ${t.matches.length} locations`:"Search failed";return{content:JSON.stringify(t),state:{message:s,result:t},success:t.success}}catch(e){return{content:e.message,error:e,success:!1}}}async globLocalFiles(e){try{let t=await _.V.globFiles(e),s=t.success?`Found ${t.total_files} files`:"Glob search failed";return{content:JSON.stringify(t),state:{message:s,result:t},success:t.success}}catch(e){return{content:e.message,error:e,success:!1}}}}let x=c()("lobe-store:builtin-tool"),k=new A;var E=s(15361),L=s(22309),O=s(60317),P=s(82649);class R{search(e,t){return P.t.search.query.query({optionalParams:t,query:e})}crawlPage(e){return P.t.search.crawlPages.mutate({urls:[e]})}crawlPages(e){return P.t.search.crawlPages.mutate(e)}async webSearch(e,t){return P.t.search.webSearch.query(e,{signal:t?.signal})}}let D=new R;var F=s(25429);class G{constructor(e){this.searchService=e.searchService}async search(e,t){try{let s=await this.searchService.webSearch(e,t),a=s.results.slice(0,F.MX).map(e=>({title:e.title,url:e.url,...e.content&&{content:e.content},...e.publishedDate&&{publishedDate:e.publishedDate},...e.imgSrc&&{imgSrc:e.imgSrc},...e.thumbnail&&{thumbnail:e.thumbnail}}));return{content:(0,E.X6)(a),state:s,success:!0}}catch(e){return{content:e.message,error:e,success:!1}}}async crawlSinglePage(e){return this.crawlMultiPages({urls:[e.url]})}async crawlMultiPages(e){let t=await this.searchService.crawlPages({urls:e.urls}),{results:s}=t,a=s.map(e=>"errorMessage"in e?e:{...e.data,content:e.data.content?.slice(0,F.tH)});return{content:(0,E.Sy)(a),state:t,success:!0}}}let B=c()("lobe-store:builtin-tool"),U=new G({searchService:D});var $=s(6182),N=s(71411),j=s(56790),H=s(38759),q=s(70030);class K{getActiveBranchId(e,t){let s=e.metadata?.activeBranchIndex;if("number"==typeof s&&s>=0&&s<t.children.length)return t.children[s].id;for(let e of t.children)if(e.children.length>0)return e.id;return t.children[0].id}getActiveBranchIdFromMetadata(e,t,s){let a=e.metadata?.activeBranchIndex;if("number"==typeof a&&a>=0&&a<t.length)return t[a];for(let e of t){let t=s.get(e);if(t&&t.length>0)return e}return t[0]}}class W{constructor(e,t,s,a,o){this.messageMap=e,this.messageGroupMap=t,this.branchResolver=s,this.messageCollector=a,this.generateNodeId=o}transformAll(e){let t=[];for(let s of e)this.transformToLinear(s,t);return t}transformToLinear(e,t){let s=this.messageMap.get(e.id);if(!s)return;if(this.isCompareMode(s)&&e.children.length>1){let a=this.createMessageNode(s);t.push(a);let o=this.createCompareNodeFromChildren(s,e);if(t.push(o),o.activeColumnId){let s=e.children.find(e=>e.id===o.activeColumnId);s&&s.children.length>0&&this.transformToLinear(s.children[0],t)}return}let a=s.groupId?this.messageGroupMap.get(s.groupId):void 0;if(a&&"compare"===a.mode){let o=this.createCompareNode(a,s);if(t.push(o),o.activeColumnId){let s=e.children.find(e=>e.id===o.activeColumnId);s&&s.children.length>0&&this.transformToLinear(s.children[0],t)}return}if(this.isAssistantGroupNode(s,e)){let a=this.createAssistantGroupNode(s,e);t.push(a);let o=this.messageCollector.findNextAfterTools(s,e);o&&this.transformToLinear(o,t);return}if(e.children.length>1){let a=this.createMessageNode(s);t.push(a);let o=this.createBranchNode(s,e);t.push(o);return}let o=this.createMessageNode(s);t.push(o),1===e.children.length&&this.transformToLinear(e.children[0],t)}isCompareMode(e){return e.metadata?.compare===!0}isAssistantGroupNode(e,t){return"assistant"===e.role&&t.children.length>0&&t.children.every(e=>{let t=this.messageMap.get(e.id);return t?.role==="tool"})}createMessageNode(e){return{id:e.id,type:"message"}}createAssistantGroupNode(e,t){let s=[];return this.messageCollector.collectAssistantGroupMessages(e,t,s),{children:s,id:e.id,type:"assistantGroup"}}createBranchNode(e,t){let s=this.branchResolver.getActiveBranchId(e,t),a=t.children.findIndex(e=>e.id===s);return{activeBranchIndex:a>=0?a:0,branches:t.children.map(e=>{let t=[];return this.transformToLinear(e,t),t}),id:this.generateNodeId("branch",e.id),parentMessageId:e.id,type:"branch"}}createCompareNodeFromChildren(e,t){let s,a=t.children.map(e=>{let t=this.messageMap.get(e.id);return t&&(t.metadata?.activeColumn===!0&&(s=e.id),this.isAssistantGroupNode(t,e))?[this.createAssistantGroupNode(t,e)]:[{id:e.id,type:"message"}]}),o=t.children.map(e=>e.id).join("-"),r=`compare-${e.id}-${o}`;return{activeColumnId:s,columns:a,id:r,messageId:e.id,type:"compare"}}createCompareNode(e,t){let s=[];for(let t of this.messageMap.values())t.groupId===e.id&&s.push(t);return{activeColumnId:s.find(e=>e.metadata?.activeColumn===!0)?.id,columns:s.map(e=>[{id:e.id,type:"message"}]),id:this.generateNodeId("compare",e.id),messageId:e.parentMessageId||t.id,type:"compare"}}}class J{constructor(e,t,s,a,o,r){this.messageMap=e,this.messageGroupMap=t,this.childrenMap=s,this.branchResolver=a,this.messageCollector=o,this.messageTransformer=r}flatten(e){let t=[],s=new Set;return this.buildFlatListRecursive(null,t,s,e),t}buildFlatListRecursive(e,t,s,a){for(let o of this.childrenMap.get(e)??[]){if(s.has(o))continue;let e=this.messageMap.get(o);if(!e)continue;let r=e.groupId?this.messageGroupMap.get(e.groupId):void 0;if(r&&"compare"===r.mode&&!s.has(r.id)){let o=this.messageCollector.collectGroupMembers(e.groupId,a),i=this.createCompareMessage(r,o);t.push(i),o.forEach(e=>s.add(e.id)),s.add(r.id),i.activeColumnId&&this.buildFlatListRecursive(i.activeColumnId,t,s,a);continue}if("assistant"===e.role&&e.tools&&e.tools.length>0){let o=[],r=[];this.messageCollector.collectAssistantChain(e,a,o,r,s);let i=this.createAssistantGroupMessage(o[0],o,r);t.push(i),o.forEach(e=>s.add(e.id)),r.forEach(e=>s.add(e.id));let n=o.at(-1),l=new Set(r.map(e=>e.id)),d=n?this.childrenMap.get(n.id)?.filter(e=>!l.has(e)):void 0;if(d&&d.length>0&&n)this.buildFlatListRecursive(n.id,t,s,a);else for(let e of r)this.buildFlatListRecursive(e.id,t,s,a);continue}let i=this.childrenMap.get(e.id)??[];if(this.isCompareMode(e)&&i.length>1){t.push(e),s.add(e.id);let o=this.createCompareMessageFromChildIds(e,i,a,s);t.push(o),o.activeColumnId&&this.buildFlatListRecursive(o.activeColumnId,t,s,a);continue}if("user"===e.role&&i.length>1){let o=this.branchResolver.getActiveBranchIdFromMetadata(e,i,this.childrenMap),r=i.indexOf(o),n=this.createUserMessageWithBranches(e,i.length,r);t.push(n),s.add(e.id);let l=this.messageMap.get(o);if(l)if("assistant"===l.role&&l.tools&&l.tools.length>0){let e=[],o=[];this.messageCollector.collectAssistantChain(l,a,e,o,s);let r=this.createAssistantGroupMessage(e[0],e,o);t.push(r),e.forEach(e=>s.add(e.id)),o.forEach(e=>s.add(e.id));let i=e.at(-1),n=new Set(o.map(e=>e.id)),d=i?this.childrenMap.get(i.id)?.filter(e=>!n.has(e)):void 0;if(d&&d.length>0&&i)this.buildFlatListRecursive(i.id,t,s,a);else for(let e of o)this.buildFlatListRecursive(e.id,t,s,a)}else t.push(l),s.add(o),this.buildFlatListRecursive(o,t,s,a);continue}if("assistant"===e.role&&i.length>1){let o=this.branchResolver.getActiveBranchIdFromMetadata(e,i,this.childrenMap);t.push(e),s.add(e.id);let r=this.messageMap.get(o);r&&(t.push(r),s.add(o),this.buildFlatListRecursive(o,t,s,a));continue}t.push(e),s.add(e.id),this.buildFlatListRecursive(e.id,t,s,a)}}isCompareMode(e){return e.metadata?.compare===!0}createCompareMessageFromChildIds(e,t,s,a){let o,r=[],i=[];for(let e of t){let t=this.messageMap.get(e);if(t)if(i.push(e),t.metadata?.activeColumn===!0&&(o=e),"assistant"===t.role&&t.tools&&t.tools.length>0){let e=[],o=[],i=new Set;this.messageCollector.collectAssistantChain(t,s,e,o,i);let n=this.createAssistantGroupMessage(e[0],e,o);r.push([n]),e.forEach(e=>a.add(e.id)),o.forEach(e=>a.add(e.id))}else r.push([t]),a.add(e)}let n=i.join("-"),l=`compare-${e.id}-${n}`,d=t.map(e=>this.messageMap.get(e)).filter(Boolean),c=d.length>0?Math.min(...d.map(e=>e.createdAt)):e.createdAt,u=d.length>0?Math.max(...d.map(e=>e.updatedAt)):e.updatedAt;return{activeColumnId:o,columns:r,content:"",createdAt:c,extra:{parentMessageId:e.id},id:l,meta:e.meta||{},role:"compare",updatedAt:u}}createCompareMessage(e,t){return{activeColumnId:t.find(e=>e.metadata?.activeColumn===!0)?.id,columns:t.map(e=>[e]),content:"",createdAt:Math.min(...t.map(e=>e.createdAt)),extra:{groupMode:e.mode,parentMessageId:e.parentMessageId},id:e.id,meta:t[0]?.meta||{},role:"compare",updatedAt:Math.max(...t.map(e=>e.updatedAt))}}createAssistantGroupMessage(e,t,s){let a=[],o=new Map;for(let e of(s.forEach(e=>{e.tool_call_id&&o.set(e.tool_call_id,e)}),t)){let t=e.tools?.map(e=>{let t=o.get(e.id);if(t){let s={content:t.content||"",id:t.id};return t.error&&(s.error=t.error),t.pluginState&&(s.state=t.pluginState),{...e,intervention:t.pluginIntervention,result:s,result_msg_id:t.id}}return e})||[],{usage:s,performance:r}=this.messageTransformer.splitMetadata(e.metadata),i=e.usage||s,n=e.performance||r,l={};if(e.metadata){let t=new Set(["acceptedPredictionTokens","cost","duration","inputAudioTokens","inputCacheMissTokens","inputCachedTokens","inputCitationTokens","inputImageTokens","inputTextTokens","inputWriteCacheTokens","latency","outputAudioTokens","outputImageTokens","outputReasoningTokens","outputTextTokens","rejectedPredictionTokens","totalInputTokens","totalOutputTokens","totalTokens","tps","ttft"]);Object.entries(e.metadata).forEach(([e,s])=>{t.has(e)||(l[e]=s)})}let d={content:e.content||"",id:e.id};e.error&&(d.error=e.error),e.imageList&&e.imageList.length>0&&(d.imageList=e.imageList),n&&(d.performance=n),e.reasoning&&(d.reasoning=e.reasoning),t.length>0&&(d.tools=t),i&&(d.usage=i),Object.keys(l).length>0&&(d.metadata=l),a.push(d)}let r=this.messageTransformer.aggregateMetadata(a),i={};if(a.forEach(e=>{e.metadata&&Object.assign(i,e.metadata)}),Object.keys(i).length>0&&a.length>0){a[0].metadata||(a[0].metadata={}),Object.assign(a[0].metadata,i);for(let e=1;e<a.length;e++)delete a[e].metadata}let n={...e,children:a,content:"",role:"assistantGroup"};return delete n.imageList,delete n.metadata,delete n.reasoning,delete n.tools,r.performance&&(n.performance=r.performance),r.usage&&(n.usage=r.usage),Object.keys(i).length>0&&(n.metadata=i),n}createUserMessageWithBranches(e,t,s){return{...e,branch:{activeBranchIndex:s,count:t}}}}class V{constructor(e,t){this.messageMap=e,this.childrenMap=t}collectGroupMembers(e,t){return t.filter(t=>t.groupId===e)}collectToolMessages(e,t){let s=new Set(e.tools?.map(e=>e.id)||[]);return t.filter(e=>"tool"===e.role&&e.tool_call_id&&s.has(e.tool_call_id))}collectAssistantChain(e,t,s,a,o){if(o.has(e.id))return;s.push(e);let r=this.collectToolMessages(e,t);for(let e of(a.push(...r),r))for(let r of t.filter(t=>t.parentId===e.id))if("assistant"===r.role&&r.tools&&r.tools.length>0)return void this.collectAssistantChain(r,t,s,a,o);else if("assistant"===r.role)return void s.push(r)}collectAssistantGroupMessages(e,t,s){let a=t.children.filter(e=>{let t=this.messageMap.get(e.id);return t?.role==="tool"}).map(e=>e.id),o={id:e.id,type:"message"};for(let e of(a.length>0&&(o.tools=a),s.push(o),t.children)){let t=this.messageMap.get(e.id);if(t?.role==="tool"&&e.children.length>0){let t=e.children[0],a=this.messageMap.get(t.id);if(a?.role==="assistant")return void this.collectAssistantGroupMessages(a,t,s)}}}findNextAfterTools(e,t){let s=this.findLastNodeInAssistantGroup(t);return s&&s.children.length>0?s.children[0]:null}findLastNodeInAssistantGroup(e){let t=e.children.filter(e=>{let t=this.messageMap.get(e.id);return t?.role==="tool"});if(0===t.length)return e;for(let e of t)if(e.children.length>0){let t=e.children[0],s=this.messageMap.get(t.id);if(s?.role==="assistant")return this.findLastNodeInAssistantGroup(t)}return t.at(-1)??null}}class z{messageToContentBlock(e){let{usage:t,performance:s}=this.splitMetadata(e.metadata);return{content:e.content||"",error:e.error,id:e.id,imageList:e.imageList,performance:s,reasoning:e.reasoning||void 0,tools:e.tools,usage:t}}splitMetadata(e){if(!e)return{};let t={},s={},a=!1;["acceptedPredictionTokens","cost","inputAudioTokens","inputCacheMissTokens","inputCachedTokens","inputCitationTokens","inputImageTokens","inputTextTokens","inputWriteCacheTokens","outputAudioTokens","outputImageTokens","outputReasoningTokens","outputTextTokens","rejectedPredictionTokens","totalInputTokens","totalOutputTokens","totalTokens"].forEach(s=>{void 0!==e[s]&&(t[s]=e[s],a=!0)});let o=!1;return["duration","latency","tps","ttft"].forEach(t=>{void 0!==e[t]&&(s[t]=e[t],o=!0)}),{performance:o?s:void 0,usage:a?t:void 0}}aggregateMetadata(e){let t={},s={},a=!1,o=!1,r=0,i=0;return e.forEach(e=>{e.usage&&(["acceptedPredictionTokens","inputAudioTokens","inputCacheMissTokens","inputCachedTokens","inputCitationTokens","inputImageTokens","inputTextTokens","inputWriteCacheTokens","outputAudioTokens","outputImageTokens","outputReasoningTokens","outputTextTokens","rejectedPredictionTokens","totalInputTokens","totalOutputTokens","totalTokens"].forEach(s=>{"number"==typeof e.usage[s]&&(t[s]=(t[s]||0)+e.usage[s],a=!0)}),"number"==typeof e.usage.cost&&(t.cost=(t.cost||0)+e.usage.cost,a=!0)),e.performance&&(void 0!==e.performance.ttft&&void 0===s.ttft&&(s.ttft=e.performance.ttft,o=!0),"number"==typeof e.performance.tps&&(r+=e.performance.tps,i+=1,o=!0),void 0!==e.performance.duration&&(s.duration=(s.duration||0)+e.performance.duration,o=!0),void 0!==e.performance.latency&&(s.latency=(s.latency||0)+e.performance.latency,o=!0))}),i>0&&(s.tps=r/i),{performance:o?s:void 0,usage:a?t:void 0}}}class Q{constructor(e){this.helperMaps=e,this.nodeIdCounter=0,this.messageMap=e.messageMap,this.branchResolver=new K,this.messageCollector=new V(this.messageMap,e.childrenMap),this.messageTransformer=new z,this.contextTreeBuilder=new W(e.messageMap,e.messageGroupMap,this.branchResolver,this.messageCollector,this.generateNodeId.bind(this)),this.flatListBuilder=new J(e.messageMap,e.messageGroupMap,e.childrenMap,this.branchResolver,this.messageCollector,this.messageTransformer)}generateNodeId(e,t){return`${e}-${t}-${this.nodeIdCounter++}`}transformAll(e){return this.contextTreeBuilder.transformAll(e)}flatten(e){return this.flatListBuilder.flatten(e)}}function X(e,t){let s=function(e,t){let s=new Map,a=new Map,o=new Map,r=new Map;for(let t of e){s.set(t.id,t);let e=t.parentId??null,r=a.get(e);if(r?r.push(t.id):a.set(e,[t.id]),t.threadId){let e=o.get(t.threadId);e?e.push(t):o.set(t.threadId,[t])}}if(t)for(let e of t)r.set(e.id,e);return{childrenMap:a,messageGroupMap:r,messageMap:s,threadMap:o}}(e,t),a=function(e){let{childrenMap:t,messageMap:s}=e,a=e=>({children:(t.get(e)??[]).filter(e=>{let t=s.get(e);return t&&!t.threadId}).map(e=>a(e)),id:e});return(t.get(null)??[]).filter(e=>{let t=s.get(e);return t&&!t.threadId}).map(e=>a(e))}(s),o=new Q(s),r=o.transformAll(a),i=o.flatten(e),n={},l=new Set(["acceptedPredictionTokens","cost","duration","inputAudioTokens","inputCacheMissTokens","inputCachedTokens","inputCitationTokens","inputImageTokens","inputTextTokens","inputWriteCacheTokens","latency","outputAudioTokens","outputImageTokens","outputReasoningTokens","outputTextTokens","rejectedPredictionTokens","totalInputTokens","totalOutputTokens","totalTokens","tps","ttft"]);return s.messageMap.forEach((e,t)=>{if("assistant"===e.role&&e.tools&&e.tools.length>0&&e.metadata){let s={};Object.entries(e.metadata).forEach(([e,t])=>{l.has(e)&&(s[e]=t)}),n[t]={...e,metadata:Object.keys(s).length>0?s:void 0}}else n[t]=e}),{contextTree:r,flatList:i,messageMap:n}}var Y=s(31021),Z=s.n(Y),ee=s(32308),et=s(71457);class es{constructor(){this.request=async e=>{try{return fetch(ee.Sn.trace,{body:JSON.stringify(e),headers:{"Content-Type":"application/json"},method:"POST"})}catch(e){console.error(e)}},this.traceEvent=async e=>{if(et.U.userAllowTrace(H.k.getState()))return this.request(e)}}}let ea=new es;var eo=s(91804),er=s(84354),ei=s(67095);let en=c()("lobe-store:message-internals");var el=s(47690),ed=s(11678),ec=s(64811),eu=s(62016);let ep=e=>{e.returnValue="你有正在生成中的请求，确定要离开吗？"},eg=(e,t,s)=>(0,u.jM)(e,e=>{if(s)e.includes(t)||e.push(t);else{let s=e.indexOf(t);s>=0&&e.splice(s,1)}}),em=(0,S.K)("m");var eh=s(64911);let ef=(0,S.K)("m"),ey="SWR_USE_FETCH_MESSAGES",ev=(0,S.K)("m");var eI=s(47194),eM=s(74038),eT=s(68172),ew=s(94399),eS=s(47581),eC=s(15652),eb=s(96987),e_=s(10858);let eA=c()("lobe-store:plugin-types");var ex=s(10903),ek=s(85366),eE=s(29914),eL=s(19530),eO=s(14306),eP=s(11439);let eR=(0,S.K)("t"),eD="SWR_USE_FETCH_TOPIC";var eF=s(74551),eG=s(49938),eB=s(77605),eU=s(64752);class e${constructor(){this.sendMessageInServer=async(e,t)=>eB.du.aiChat.sendMessageInServer.mutate((0,O.jv)(e),{context:{showNotification:!1},signal:t?.signal}),this.generateJSON=async(e,t)=>eB.du.aiChat.outputJSON.mutate({...e,keyVaultsPayload:(0,eU.q9)(e.provider)},{context:{showNotification:!1},signal:t?.signal})}}let eN=new e$;var ej=s(45541),eH=s(82964),eq=s(88990),eK=s(5569),eW=s(38608);let eJ=()=>eq.e.currentKnowledgeIds(ej.o.getState()),eV=[{description:"Recursive deletion of home directory is extremely dangerous",match:{command:{pattern:"rm.*-r.*(~|\\$HOME|/Users/[^/]+|/home/[^/]+)/?\\s*$",type:"regex"}}},{description:"Recursive deletion of root directory will destroy the system",match:{command:{pattern:"rm.*-r.*/\\s*$",type:"regex"}}},{description:"Force recursive deletion without specific target is too dangerous",match:{command:{pattern:"rm\\s+-rf\\s+[~./]\\s*$",type:"regex"}}},{description:"Modifying /etc/passwd could lock you out of the system",match:{command:{pattern:".*(/etc/passwd|/etc/shadow).*",type:"regex"}}},{description:"Modifying sudoers file without proper validation is dangerous",match:{command:{pattern:".*/etc/sudoers.*",type:"regex"}}},{description:"Fork bomb can crash the system",match:{command:{pattern:".*:\\(\\).*\\{.*\\|.*&.*\\};.*:.*",type:"regex"}}},{description:"Writing random data to disk devices can destroy data",match:{command:{pattern:"dd.*of=/dev/(sd|hd|nvme).*",type:"regex"}}},{description:"Formatting system partitions will destroy data",match:{command:{pattern:"(mkfs|fdisk|parted).*(/dev/(sd|hd|nvme)|/)",type:"regex"}}},{description:"Disabling firewall exposes system to attacks",match:{command:{pattern:"(ufw\\s+disable|iptables\\s+-F|systemctl\\s+stop\\s+firewalld)",type:"regex"}}},{description:"Changing SSH configuration could lock you out",match:{command:{pattern:".*(/etc/ssh/sshd_config).*",type:"regex"}}},{description:"Removing essential system packages can break the system",match:{command:{pattern:"(apt|yum|dnf|pacman)\\s+(remove|purge|erase).*(systemd|kernel|glibc|bash|sudo)",type:"regex"}}},{description:"Modifying kernel parameters without understanding can crash the system",match:{command:{pattern:"echo.*>/proc/sys/.*",type:"regex"}}},{description:"Direct memory access is extremely dangerous",match:{command:{pattern:".*(/dev/(mem|kmem|port)).*",type:"regex"}}},{description:"Changing file ownership of system directories is dangerous",match:{command:{pattern:"chown.*-R.*(/(etc|bin|sbin|usr|var|sys|proc)|~).*",type:"regex"}}},{description:"Setting SUID on shells or interpreters is a security risk",match:{command:{pattern:"chmod.*(4755|u\\+s).*(sh|bash|python|perl|ruby|node)",type:"regex"}}},{description:"Reading .env files may leak sensitive credentials and API keys",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*\\.env.*",type:"regex"}}},{description:"Reading .env files may leak sensitive credentials and API keys",match:{path:{pattern:".*\\.env.*",type:"regex"}}},{description:"Reading SSH private keys can compromise system security",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*(id_rsa|id_ed25519|id_ecdsa)(?!\\.pub).*",type:"regex"}}},{description:"Reading SSH private keys can compromise system security",match:{path:{pattern:".*/\\.ssh/(id_rsa|id_ed25519|id_ecdsa)$",type:"regex"}}},{description:"Accessing AWS credentials can leak cloud access keys",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.aws/credentials.*",type:"regex"}}},{description:"Accessing AWS credentials can leak cloud access keys",match:{path:{pattern:".*/\\.aws/credentials.*",type:"regex"}}},{description:"Reading Docker config may expose registry credentials",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.docker/config\\.json.*",type:"regex"}}},{description:"Reading Docker config may expose registry credentials",match:{path:{pattern:".*/\\.docker/config\\.json$",type:"regex"}}},{description:"Reading Kubernetes config may expose cluster credentials",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.kube/config.*",type:"regex"}}},{description:"Reading Kubernetes config may expose cluster credentials",match:{path:{pattern:".*/\\.kube/config$",type:"regex"}}},{description:"Reading Git credentials file may leak access tokens",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.git-credentials.*",type:"regex"}}},{description:"Reading Git credentials file may leak access tokens",match:{path:{pattern:".*/\\.git-credentials$",type:"regex"}}},{description:"Reading npm token file may expose package registry credentials",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.npmrc.*",type:"regex"}}},{description:"Reading npm token file may expose package registry credentials",match:{path:{pattern:".*/\\.npmrc$",type:"regex"}}},{description:"Reading history files may expose sensitive commands and credentials",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.(bash_history|zsh_history|history).*",type:"regex"}}},{description:"Reading history files may expose sensitive commands and credentials",match:{path:{pattern:".*/\\.(bash_history|zsh_history|history)$",type:"regex"}}},{description:"Accessing browser credential storage may leak passwords",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*(Cookies|Login Data|Web Data).*",type:"regex"}}},{description:"Reading GCP credentials may leak cloud service account keys",match:{command:{pattern:"(cat|less|more|head|tail|vim|nano|vi|emacs|code).*/\\.config/gcloud/.*\\.json.*",type:"regex"}}},{description:"Reading GCP credentials may leak cloud service account keys",match:{path:{pattern:".*/\\.config/gcloud/.*\\.json$",type:"regex"}}}];class ez{static checkSecurityBlacklist(e=[],t={}){for(let s of e)if(this.matchesSecurityRule(s,t))return{blocked:!0,reason:s.description};return{blocked:!1}}static shouldIntervene(e){let{config:t,toolArgs:s={}}=e,a=void 0!==e.securityBlacklist?e.securityBlacklist:eV;if(this.checkSecurityBlacklist(a,s).blocked)return"required";if(!t)return"never";if("string"==typeof t)return t;for(let e of t)if(this.matchesRule(e,s))return e.policy;return"required"}static matchesSecurityRule(e,t){if(!e.match)return!1;for(let[s,a]of Object.entries(e.match)){let e=t[s];if(void 0===e||!this.matchesArgument(a,e))return!1}return!0}static matchesRule(e,t){if(!e.match)return!0;for(let[s,a]of Object.entries(e.match)){let e=t[s];if(void 0===e||!this.matchesArgument(a,e))return!1}return!0}static matchesArgument(e,t){let s=String(t);if("string"==typeof e)return this.matchPattern(e,s);let{pattern:a,type:o}=e;switch(o){case"exact":return s===a;case"prefix":return s.startsWith(a);case"wildcard":return this.matchPattern(a,s);case"regex":return new RegExp(a).test(s);default:return!1}}static matchPattern(e,t){if(e.includes(":")){let[s,a]=e.split(":");if("*"===a)return t.startsWith(s+":")||t===s}let s=e.replaceAll(/[$()+.?[\\\]^{|}]/g,"\\$&").replaceAll("*",".*");return RegExp(`^${s}$`).test(t)}static generateToolKey(e,t,s){let a=`${e}/${t}`;return s?`${a}#${s}`:a}static hashArguments(e){let t=Object.keys(e).sort().map(t=>`${t}=${JSON.stringify(e[t])}`).join("&"),s=0;for(let e=0;e<t.length;e++)s=(s<<5)-s+t.charCodeAt(e),s&=s;return Math.abs(s).toString(36)}}class eQ{constructor(e,t={}){this.agent=e,this.config=t,this.operationId=t.operationId,this.getOperation=t.getOperation,this.executors={call_llm:this.createCallLLMExecutor(),call_tool:this.createCallToolExecutor(),finish:this.createFinishExecutor(),request_human_approve:this.createHumanApproveExecutor(),request_human_prompt:this.createHumanPromptExecutor(),request_human_select:this.createHumanSelectExecutor(),...t.executors,...e.executors}}getContext(){if(this.operationId&&this.getOperation)return this.getOperation(this.operationId).context}getAbortController(){if(this.operationId&&this.getOperation)return this.getOperation(this.operationId).abortController}async step(e,t){try{let s,a,o=structuredClone(e);if(o.stepCount+=1,o.lastModified=new Date().toISOString(),o.maxSteps&&o.stepCount>o.maxSteps)return o.status="done",{events:[{finalState:o,reason:"max_steps_exceeded",reasonDetail:`Maximum steps exceeded: ${o.maxSteps}`,type:"done"}],newState:o,nextContext:void 0};let r=t||this.createInitialContext(o);if("human_approved_tool"===r.phase){let e=r.payload,t=e.approvedToolCall;s={payload:{parentMessageId:e.parentMessageId,skipCreateToolMessage:e.skipCreateToolMessage,toolCalling:t},type:"call_tool"}}else s=await this.agent.runner(r,o);let i=(Array.isArray(s)?s:[s]).map(e=>{if("call_tools_batch"===e.type&&Array.isArray(e.payload)){let t=e.payload.map(e=>({apiName:e.function.name,arguments:e.function.arguments,id:e.id,identifier:e.function.name,type:"default"}));return{payload:{parentMessageId:"",toolsCalling:t},type:"call_tools_batch"}}return e}),n=o,l=[];for(let e of i){let t;if("call_tools_batch"===e.type)t=await this.executeToolsBatch(e,n);else{let s=this.executors[e.type];if(!s)throw Error(`No executor found for instruction type: ${e.type}`);t=await s(e,n)}if(l.push(...t.events),n=t.newState,t.nextContext&&(a=t.nextContext),"waiting_for_human"===n.status||"interrupted"===n.status)break}return n.stepCount=o.stepCount,n.lastModified=o.lastModified,{events:l,newState:n,nextContext:a}}catch(s){let t=structuredClone(e);return t.stepCount+=1,t.lastModified=new Date().toISOString(),this.createErrorResult(t,s)}}async approveToolCall(e,t){let s={operationId:this.operationId,payload:{approvedToolCall:t},phase:"human_approved_tool",session:this.createSessionContext(e)};return this.step(e,s)}interrupt(e,t,s=!0,a){let o=structuredClone(e),r=new Date().toISOString();return o.status="interrupted",o.lastModified=r,o.interruption={canResume:s,interruptedAt:r,interruptedInstruction:void 0,reason:t},{events:[{canResume:s,interruptedAt:r,metadata:a,reason:t,type:"interrupted"}],newState:o}}async resume(e,t="User resumed execution",s){if("interrupted"!==e.status)throw Error("Cannot resume: state is not interrupted");if(e.interruption&&!e.interruption.canResume)throw Error("Cannot resume: interruption is not resumable");let a=structuredClone(e),o=new Date().toISOString(),r=e.stepCount;a.status="running",a.lastModified=o,a.interruption=void 0;let i={reason:t,resumedAt:o,resumedFromStep:r,type:"resumed"};if(s){let e=await this.step(a,s);return{events:[i,...e.events],newState:e.newState,nextContext:e.nextContext}}let n=this.createInitialContext(a);return{events:[i],newState:a,nextContext:n}}static createDefaultUsage(){return{humanInteraction:{approvalRequests:0,promptRequests:0,selectRequests:0,totalWaitingTimeMs:0},llm:{apiCalls:0,processingTimeMs:0,tokens:{input:0,output:0,total:0}},tools:{byTool:[],totalCalls:0,totalTimeMs:0}}}static createDefaultCost(){return{calculatedAt:new Date().toISOString(),currency:"USD",llm:{byModel:[],currency:"USD",total:0},tools:{byTool:[],currency:"USD",total:0},total:0}}static createInitialState(e){let t=new Date().toISOString();return{cost:eQ.createDefaultCost(),createdAt:t,lastModified:t,messages:[],status:"idle",stepCount:0,toolManifestMap:{},usage:eQ.createDefaultUsage(),...e||{sessionId:""}}}createCallLLMExecutor(){return async(e,t)=>{let{payload:s}=e,a=structuredClone(t),o=[];a.status="running",a.lastModified=new Date().toISOString(),o.push({payload:s,type:"llm_start"});let r=this.agent.modelRuntime;if(!r)throw Error("Model Runtime is required for call_llm instruction. Provide it via Agent.modelRuntime or RuntimeConfig.modelRuntime");let i="",n=[];try{for await(let e of r(s))o.push({chunk:e,type:"llm_stream"}),e.content&&(i+=e.content),e.tool_calls&&(n=e.tool_calls);if(o.push({result:{content:i,tool_calls:n},type:"llm_result"}),this.agent.calculateUsage&&(a.usage=this.agent.calculateUsage("llm",{content:i,tool_calls:n},a.usage)),this.agent.calculateCost&&(a.cost=this.agent.calculateCost({costLimit:a.costLimit,previousCost:a.cost,usage:a.usage})),a.costLimit&&a.cost.total>a.costLimit.maxTotalCost)return this.handleCostLimitExceeded(a);let e={operationId:this.operationId,payload:{hasToolCalls:n.length>0,result:{content:i,tool_calls:n},toolCalls:n},phase:"llm_result",session:this.createSessionContext(a)};return{events:o,newState:a,nextContext:e}}catch(e){return this.createErrorResult(t,e)}}}createCallToolExecutor(){return async(e,t)=>{let{payload:s}=e,a=structuredClone(t),o=[];a.lastModified=new Date().toISOString(),a.status="running";let r=this.agent.tools||{},i=s.toolCalling,n=i.apiName,l=i.arguments,d=i.id,c=r[n];if(!c)throw Error(`Tool not found: ${n}`);let u=JSON.parse(l),p=await c(u);if(a.messages.push({content:JSON.stringify(p),role:"tool",tool_call_id:d}),o.push({id:d,result:p,type:"tool_result"}),this.agent.calculateUsage&&(a.usage=this.agent.calculateUsage("tool",{executionTime:0,result:p,toolCall:i},a.usage)),this.agent.calculateCost&&(a.cost=this.agent.calculateCost({costLimit:a.costLimit,previousCost:a.cost,usage:a.usage})),a.costLimit&&a.cost.total>a.costLimit.maxTotalCost)return this.handleCostLimitExceeded(a);let g={operationId:this.operationId,payload:{result:p,toolCall:i,toolCallId:i.id},phase:"tool_result",session:this.createSessionContext(a)};return{events:o,newState:a,nextContext:g}}}createHumanApproveExecutor(){return async(e,t)=>{let{pendingToolsCalling:s}=e,a=structuredClone(t);return a.lastModified=new Date().toISOString(),a.status="waiting_for_human",a.pendingToolsCalling=s,{events:[{pendingToolsCalling:s,sessionId:a.sessionId,type:"human_approve_required"}],newState:a}}}createHumanPromptExecutor(){return async(e,t)=>{let{metadata:s,prompt:a}=e,o=structuredClone(t);return o.lastModified=new Date().toISOString(),o.status="waiting_for_human",o.pendingHumanPrompt={metadata:s,prompt:a},{events:[{metadata:s,prompt:a,sessionId:o.sessionId,type:"human_prompt_required"}],newState:o}}}createHumanSelectExecutor(){return async(e,t)=>{let{metadata:s,multi:a,options:o,prompt:r}=e,i=structuredClone(t);return i.lastModified=new Date().toISOString(),i.status="waiting_for_human",i.pendingHumanSelect={metadata:s,multi:a,options:o,prompt:r},{events:[{metadata:s,multi:a,options:o,prompt:r,sessionId:i.sessionId,type:"human_select_required"}],newState:i}}}createFinishExecutor(){return async(e,t)=>{let{reason:s,reasonDetail:a}=e,o=structuredClone(t);return o.lastModified=new Date().toISOString(),o.status="done",{events:[{finalState:o,reason:s,reasonDetail:a,type:"done"}],newState:o}}}async executeToolsBatch(e,t){let{payload:s}=e,a=await (0,p.Ay)(e.payload.toolsCalling,e=>this.executors.call_tool({payload:{parentMessageId:s.parentMessageId,toolCalling:e},type:"call_tool"},structuredClone(t))),o=a.at(-1).nextContext?.payload?.parentMessageId;return this.mergeToolResults(a,t,o)}mergeToolResults(e,t,s){let a=structuredClone(t),o=[];for(let t of e){let e=t.newState.messages.filter(e=>"tool"===e.role);a.messages.push(...e),o.push(...t.events),t.newState.usage&&a.usage&&(a.usage.tools.totalCalls+=t.newState.usage.tools.totalCalls,a.usage.tools.totalTimeMs+=t.newState.usage.tools.totalTimeMs,t.newState.usage.tools.byTool.forEach(e=>{let t=a.usage.tools.byTool.find(t=>t.name===e.name);t?(t.calls+=e.calls,t.totalTimeMs+=e.totalTimeMs,t.errors+=e.errors||0):a.usage.tools.byTool.push({...e})})),t.newState.cost&&a.cost&&(a.cost.tools.total+=t.newState.cost.tools.total,a.cost.total+=t.newState.cost.tools.total,t.newState.cost.tools.byTool.forEach(e=>{let t=a.cost.tools.byTool.find(t=>t.name===e.name);t?(t.calls+=e.calls,t.totalCost+=e.totalCost):a.cost.tools.byTool.push({...e})}))}return a.lastModified=new Date().toISOString(),{events:o,newState:a,nextContext:{operationId:this.operationId,payload:{parentMessageId:s,toolCount:e.length,toolResults:e.map(e=>e.nextContext?.payload)},phase:"tools_batch_result",session:this.createSessionContext(a)}}}handleCostLimitExceeded(e){let t=structuredClone(e),s=t.costLimit;switch(s.onExceeded){case"stop":return t.status="done",{events:[{finalState:t,reason:"cost_limit_exceeded",reasonDetail:`Cost limit exceeded: ${t.cost.total} ${t.cost.currency} > ${s.maxTotalCost} ${s.currency}`,type:"done"}],newState:t,nextContext:void 0};case"interrupt":return{...this.interrupt(t,`Cost limit exceeded: ${t.cost.total} ${t.cost.currency}`,!0,{costExceeded:!0,currentCost:t.cost.total,limitCost:s.maxTotalCost}),nextContext:void 0};default:{let e={error:Error(`Warning: Cost limit exceeded: ${t.cost.total} ${t.cost.currency}`),type:"error"};return{events:[e],newState:t,nextContext:{operationId:this.operationId,payload:{error:e.error,isCostWarning:!0},phase:"error",session:this.createSessionContext(t)}}}}}createSessionContext(e){return{messageCount:e.messages.length,sessionId:e.sessionId,status:e.status,stepCount:e.stepCount}}createInitialContext(e){let t=e.messages.at(-1);return t?.role==="user"?{operationId:this.operationId,payload:{isFirstMessage:1===e.messages.length,message:t},phase:"user_input",session:this.createSessionContext(e)}:{operationId:this.operationId,payload:void 0,phase:"init",session:this.createSessionContext(e)}}createErrorResult(e,t){let s=structuredClone(e);return s.status="error",s.error=t,s.lastModified=new Date().toISOString(),{events:[{error:t,type:"error"}],newState:s}}}class eX{static createDefaultUsage(){return{humanInteraction:{approvalRequests:0,promptRequests:0,selectRequests:0,totalWaitingTimeMs:0},llm:{apiCalls:0,processingTimeMs:0,tokens:{input:0,output:0,total:0}},tools:{byTool:[],totalCalls:0,totalTimeMs:0}}}static createDefaultCost(){return{calculatedAt:new Date().toISOString(),currency:"USD",llm:{byModel:[],currency:"USD",total:0},tools:{byTool:[],currency:"USD",total:0},total:0}}static mergeModelUsage(e,t){if(!e)return t;let s={...t};for(let a of["inputCachedTokens","inputCacheMissTokens","inputWriteCacheTokens","inputTextTokens","inputImageTokens","inputAudioTokens","inputCitationTokens","outputTextTokens","outputImageTokens","outputAudioTokens","outputReasoningTokens","acceptedPredictionTokens","rejectedPredictionTokens","totalInputTokens","totalOutputTokens","totalTokens"]){let o=e[a],r=t[a];(void 0!==o||void 0!==r)&&(s[a]=(o||0)+(r||0))}return(void 0!==e.cost||void 0!==t.cost)&&(s.cost=(e.cost||0)+(t.cost||0)),s}static accumulateLLM(e){let{usage:t,cost:s,provider:a,model:o,modelUsage:r}=e,i=t?structuredClone(t):this.createDefaultUsage();i.llm.tokens.input+=r.totalInputTokens??0,i.llm.tokens.output+=r.totalOutputTokens??0,i.llm.tokens.total+=r.totalTokens??0,i.llm.apiCalls+=1;let n=s?structuredClone(s):r.cost?this.createDefaultCost():void 0;if(r.cost&&n){let e=`${a}/${o}`,t=n.llm.byModel.find(t=>t.id===e);t||(t={id:e,model:o,provider:a,totalCost:0,usage:{}},n.llm.byModel.push(t)),t.usage=eX.mergeModelUsage(t.usage,r),t.totalCost+=r.cost,n.llm.total+=r.cost,n.total+=r.cost,n.calculatedAt=new Date().toISOString()}return{cost:n,usage:i}}static accumulateTool(e){let{usage:t,cost:s,toolName:a,executionTime:o,success:r,toolCost:i}=e,n=t?structuredClone(t):this.createDefaultUsage(),l=n.tools.byTool.find(e=>e.name===a);l||(l={calls:0,errors:0,name:a,totalTimeMs:0},n.tools.byTool.push(l)),l.calls+=1,l.totalTimeMs+=o,r||(l.errors+=1),n.tools.totalCalls+=1,n.tools.totalTimeMs+=o;let d=s?structuredClone(s):i?this.createDefaultCost():void 0;if(i&&d){let e=d.tools.byTool.find(e=>e.name===a);e||(e={calls:0,currency:"USD",name:a,totalCost:0},d.tools.byTool.push(e)),e.calls+=1,e.totalCost+=i,d.tools.total+=i,d.total+=i,d.calculatedAt=new Date().toISOString()}return{cost:d,usage:n}}}var eY=s(7729);class eZ{constructor(e){this.config=e}getToolInterventionConfig(e,t){let{identifier:s,apiName:a}=e,o=t.toolManifestMap[s];if(!o)return;let r=o.api?.find(e=>e.name===a);return r?.humanIntervention??o.humanIntervention}checkInterventionNeeded(e,t){let s=[],a=[],o=t.securityBlacklist??eV,{approvalMode:r,allowList:i=[]}=t.userInterventionConfig||{approvalMode:"manual"};for(let n of e){let{identifier:e,apiName:l}=n,d=`${e}/${l}`,c={};try{c=JSON.parse(n.arguments||"{}")}catch{}if(ez.checkSecurityBlacklist(o,c).blocked){s.push(n);continue}if("auto-run"===r){a.push(n);continue}if("allow-list"===r){i.includes(d)?a.push(n):s.push(n);continue}let u=this.getToolInterventionConfig(n,t);"never"===ez.shouldIntervene({config:u,securityBlacklist:o,toolArgs:c})?a.push(n):s.push(n)}return[s,a]}extractAbortInfo(e,t){let s=!1,a=[],o="";switch(e.phase){case"llm_result":{let t=e.payload;s=t.hasToolsCalling||!1,a=t.toolsCalling||[],o=t.parentMessageId;break}case"human_abort":{let t=e.payload;s=t.hasToolsCalling||!1,a=t.toolsCalling||[],o=t.parentMessageId;break}case"tool_result":case"tools_batch_result":{o=e.payload.parentMessageId;let r=t.messages.filter(e=>"tool"===e.role&&e.pluginIntervention?.status==="pending");r.length>0&&(s=!0,a=r.map(e=>e.plugin).filter(Boolean))}}return{hasToolsCalling:s,parentMessageId:o,toolsCalling:a}}handleAbort(e,t){let{hasToolsCalling:s,parentMessageId:a,toolsCalling:o}=this.extractAbortInfo(e,t);return s&&o.length>0?{payload:{parentMessageId:a,toolsCalling:o},type:"resolve_aborted_tools"}:{reason:"user_requested",reasonDetail:"Operation cancelled by user",type:"finish"}}async runner(e,t){if("interrupted"===t.status)return this.handleAbort(e,t);switch(e.phase){case"init":case"user_input":return{payload:{...e.payload,messages:t.messages},type:"call_llm"};case"llm_result":{let{hasToolsCalling:s,toolsCalling:a,parentMessageId:o}=e.payload;if(s&&a&&a.length>0){let[e,s]=this.checkInterventionNeeded(a,t),r=[];return s.length>0&&(s.length>1?r.push({payload:{parentMessageId:o,toolsCalling:s},type:"call_tools_batch"}):r.push({payload:{parentMessageId:o,toolCalling:s[0]},type:"call_tool"})),e.length>0&&r.push({pendingToolsCalling:e,reason:"human_intervention_required",type:"request_human_approve"}),r}return{reason:"completed",reasonDetail:"LLM response completed without tool calls",type:"finish"}}case"tool_result":{let{parentMessageId:s}=e.payload,a=t.messages.filter(e=>"tool"===e.role&&e.pluginIntervention?.status==="pending");if(a.length>0)return{pendingToolsCalling:a.map(e=>e.plugin).filter(Boolean),reason:"Some tools still pending approval",skipCreateToolMessage:!0,type:"request_human_approve"};return{payload:{messages:t.messages,model:this.config.modelRuntimeConfig?.model,parentMessageId:s,provider:this.config.modelRuntimeConfig?.provider,tools:t.tools},type:"call_llm"}}case"tools_batch_result":{let{parentMessageId:s}=e.payload,a=t.messages.filter(e=>"tool"===e.role&&e.pluginIntervention?.status==="pending");if(a.length>0)return{pendingToolsCalling:a.map(e=>e.plugin).filter(Boolean),reason:"Some tools still pending approval",skipCreateToolMessage:!0,type:"request_human_approve"};return{payload:{messages:t.messages,model:this.config.modelRuntimeConfig?.model,parentMessageId:s,provider:this.config.modelRuntimeConfig?.provider,tools:t.tools},type:"call_llm"}}case"human_abort":{let{hasToolsCalling:t,parentMessageId:s,toolsCalling:a,reason:o}=e.payload;if(t&&a&&a.length>0)return{payload:{parentMessageId:s,toolsCalling:a},type:"resolve_aborted_tools"};return{reason:"user_requested",reasonDetail:o,type:"finish"}}case"error":{let{error:t}=e.payload;return{reason:"error_recovery",reasonDetail:t?.message||"Unknown error occurred",type:"finish"}}default:return{reason:"agent_decision",reasonDetail:`Unknown phase: ${e.phase}`,type:"finish"}}}}let e0=c()("lobe-store:agent-executors"),e1={"lobe-web-browsing/craw":.002,"lobe-web-browsing/search":.001};var e4=s(77799),e5=s(32559),e2=s(79555),e9=s(67103);let e6=c()("lobe-store:streaming-executor");var e3=s(35245);class e7{constructor(){this.getThreads=e=>eB.du.thread.getThreads.query({topicId:e}),this.createThreadWithMessage=async({message:e,...t})=>eB.du.thread.createThreadWithMessage.mutate({...t,message:{...e,sessionId:this.toDbSessionId(e.sessionId)}}),this.updateThread=async(e,t)=>eB.du.thread.updateThread.mutate({id:e,value:t}),this.removeThread=async e=>eB.du.thread.removeThread.mutate({id:e}),this.toDbSessionId=e=>e===e3.Ed?null:e}}let e8=new e7,te=(0,S.K)("thd"),tt="SWR_USE_FETCH_THREADS";var ts=s(99061),ta=s(61520);class to{async makeDecision(e){let{availableAgents:t}=e;if(0===t.length)return{decisions:[],todoUpdated:!1,todos:[]};try{let s=await this.callLLMForDecision(e),a=this.parseSupervisorResponse(s,t,e);return console.log("Supervisor TODO list:",a.todos),a}catch(e){throw Error(`Supervisor decision failed: ${e instanceof Error?e.message:String(e)}`)}}async callLLMForDecision(e){let t=(0,E.O9)({allowDM:e.allowDM,availableAgents:e.availableAgents.filter(e=>e.id).map(e=>({id:e.id,title:e.title})),messages:e.messages,scene:e.scene,todoList:e.todoList,userName:e.userName});try{let s=await eN.generateJSON({...t,model:e.model,provider:e.provider},e.abortController||new AbortController);if(console.log("SUPERVISOR RESPONSE",JSON.stringify(s,null,2)),Array.isArray(s))return s.map(e=>({parameter:e.arguments||e.parameter,tool_name:e.name||e.tool_name}));if("string"==typeof s)try{let e=JSON.parse(s);if(Array.isArray(e))return e.map(e=>({parameter:e.arguments||e.parameter,tool_name:e.name||e.tool_name}))}catch{return s}return"object"==typeof s?JSON.stringify(s):String(s)}catch(t){if(this.isAbortError(t,e))throw this.createAbortError();throw console.error("Supervisor LLM error:",t),t instanceof Error?t:Error(String(t))}}createAbortError(){let e=Error("The operation was aborted");return e.name="AbortError",e}isAbortError(e,t){return!!t.abortController?.signal.aborted||"AbortError"===e?.name}parseSupervisorResponse(e,t,s){let a=(s.todoList||[]).map(e=>({...e})),o=null;try{let o=this.normalizeToolCalls(e);return this.processToolCalls(o,a,t,s)}catch(e){o=e}try{let s=this.extractLegacyTodoList(e,a);return{decisions:this.parseLegacyDecisions(e,t),todoUpdated:!1,todos:s}}catch(s){let e=o instanceof Error&&"__LEGACY_FORMAT__"===o.message?"legacy format detected":o instanceof Error?o.message:String(o),t=s instanceof Error?s.message:String(s);throw Error(`Failed to parse supervisor response: ${e} | ${t}`)}}normalizeToolCalls(e){if(Array.isArray(e))return e.filter(e=>e&&"object"==typeof e&&e.tool_name).map(e=>({parameter:e.parameter,tool_name:e.tool_name}));if("string"==typeof e){let t=this.tryParseJson(e);if(Array.isArray(t))return t.filter(e=>e&&"object"==typeof e&&e.tool_name).map(e=>({parameter:e.parameter,tool_name:e.tool_name}));if(t&&"object"==typeof t&&("decisions"in t||"todos"in t))throw Error("__LEGACY_FORMAT__");throw Error("No tool calls array found in response")}throw Error("Unsupported supervisor response format")}processToolCalls(e,t,s,a){if(0===e.length)return{decisions:[],todoUpdated:!1,todos:t};let o=t.map(e=>({...e})),r=[],i=!1;return e.forEach(e=>{switch(e.tool_name){case"create_todo":if("productive"===a.scene){let t=this.applyCreateTodo(o,e.parameter);i=i||t}break;case"finish_todo":if("productive"===a.scene){let t=this.applyFinishTodo(o,e.parameter);i=i||t}break;case"wait_for_user_input":console.log("DEBUG: Supervisor paused conversation:",e.parameter);break;case"trigger_agent":case"trigger_agent_dm":{let t=this.buildDecisionFromTool(e.parameter,s,a);console.log("DEBUG: Built decision from tool:",{decision:t,parameter:e.parameter,toolName:e.tool_name}),t&&r.push(t)}}}),console.log("DEBUG: Final decisions:",r),{decisions:r,todoUpdated:i,todos:o}}applyCreateTodo(e,t){if(!t||"object"!=typeof t)return!1;if(Array.isArray(t.todos)){let s=!1;for(let a of t.todos){let{content:t,assignee:o}=this.extractTodoData(a);if(!t||e.some(e=>e.content.trim().toLowerCase()===t.toLowerCase()&&!e.finished))continue;let r={content:t,finished:!1};o&&"string"==typeof o&&o.trim()&&(r.assignee=o.trim()),e.push(r),s=!0}return s}let{content:s,assignee:a}=this.extractTodoData(t);if(!s||e.some(e=>e.content.trim().toLowerCase()===s.toLowerCase()&&!e.finished))return!1;let o={content:s,finished:!1};return a&&"string"==typeof a&&a.trim()&&(o.assignee=a.trim()),e.push(o),!0}extractTodoData(e){if("string"==typeof e)return{content:e.trim()||null};if(!e||"object"!=typeof e)return{content:null};for(let t of[e.content,e.id,e.title,e.task,e.text,e.message])if("string"==typeof t&&t.trim())return{assignee:this.extractAssignee(e),content:t.trim()};return{content:null}}extractAssignee(e){let t=e.assignee;if("string"==typeof t&&t.trim())return t.trim()}applyFinishTodo(e,t){return!!t&&"object"==typeof t&&"number"==typeof t.index&&this.finishTodoByIndex(e,t.index)}finishTodoByIndex(e,t){return!!Number.isInteger(t)&&!(t<0)&&!(t>=e.length)&&!e[t].finished&&(e[t].finished=!0,!0)}buildDecisionFromTool(e,t,s){return"string"==typeof e?this.createDecisionFromPayload({id:e},t,s):e&&"object"==typeof e?this.createDecisionFromPayload(e,t,s):null}createDecisionFromPayload(e,t,s){let a,o="string"==typeof e.id?e.id:"string"==typeof e.agentId?e.agentId:"string"==typeof e.speaker?e.speaker:void 0;if(!o||!t.some(e=>e.id===o))return null;let r="string"==typeof e.instruction?e.instruction:"string"==typeof e.message?e.message:void 0;for(let t of[e.target,e.recipient,e.to])if("string"==typeof t){a=t;break}return a&&"user"!==a&&(t.some(e=>e.id===a)||(a=void 0)),!1===s.allowDM&&(a=void 0),{id:o,instruction:r,target:a||void 0}}parseLegacyDecisions(e,t){try{let s=this.normalizeLegacyDecisions(e);if(!Array.isArray(s))throw Error("Response must include a decisions array");if(0===s.length)return[];return s.filter(e=>"object"==typeof e&&null!==e&&"string"==typeof e.id&&t.some(t=>t.id===e.id)).map(e=>({id:e.id,instruction:"string"==typeof e.instruction?e.instruction:void 0,target:"string"==typeof e.target?e.target:void 0}))}catch(e){throw Error(`Failed to parse supervisor decision: ${e instanceof Error?e.message:String(e)}`)}}normalizeLegacyDecisions(e){if("string"==typeof e){let t=this.extractJsonObjectFromString(e);if(Array.isArray(t))return t;if(t&&Array.isArray(t.decisions))return t.decisions;let s=this.extractJsonArrayFromString(e);if(!Array.isArray(s))throw Error("No JSON array found in response");return s}if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.decisions;if(Array.isArray(t))return t}return null}extractLegacyTodoList(e,t){let s=e=>{if(void 0!==e)return Array.isArray(e)?e.filter(e=>"object"==typeof e&&null!==e&&"string"==typeof e.content&&"boolean"==typeof e.finished).map(e=>({assignee:"string"==typeof e.assignee&&e.assignee.trim()?e.assignee.trim():void 0,content:e.content,finished:e.finished})):[]};if("string"==typeof e){let a=this.extractJsonObjectFromString(e);if(a){let e=s(a.todos);if(void 0!==e)return e}return t}if(e&&"object"==typeof e&&!Array.isArray(e)){let t=s(e.todos);if(void 0!==t)return t}return t}tryParseJson(e){let t;if(!e)return;try{t=JSON.parse(e)}catch{t=void 0}if(void 0!==t)return t;let s=this.extractJsonObjectFromString(e);return null!==s?s:this.extractJsonArrayFromString(e)??void 0}extractJsonObjectFromString(e){let t,s=e.trim();try{t=JSON.parse(s)}catch{t=void 0}if(t&&"object"==typeof t)return t;let a=e.indexOf("{"),o=e.lastIndexOf("}");if(-1===a||-1===o||o<a)return null;let r=e.slice(a,o+1);try{return JSON.parse(r)}catch{return null}}extractJsonArrayFromString(e){let t=e.indexOf("["),s=e.lastIndexOf("]");if(-1===t||-1===s||s<t)return null;let a=e.slice(t,s+1);try{return JSON.parse(a)}catch(e){return console.error("Failed to parse JSON array from supervisor response:",e),null}}validateDecision(e,t){let{availableAgents:s}=t;return 0===e.length||e.every(e=>!!s.some(t=>t.id===e.id)&&(!e.target||"user"===e.target||s.some(t=>t.id===e.target)))}}let tr=(0,S.K)("aiGroupChat"),ti=new to,tn=(0,S.K)("operation"),tl=c()("lobe-store:operation"),td=(0,i.t)("chat"),tc=(0,r.h)()((0,a.eh)(td((...e)=>({...l,...((...e)=>({...((e,t)=>({addAIMessage:async()=>{let{optimisticCreateMessage:e,updateMessageInput:s,activeTopicId:a,activeId:o,inputMessage:r}=t();if(!o)return;let i=eo._1.lastDisplayMessageId(t());await e({content:r,role:"assistant",sessionId:o,topicId:a,parentId:i})&&s("")},addUserMessage:async({message:e,fileList:s})=>{let{optimisticCreateMessage:a,updateMessageInput:o,activeTopicId:r,activeId:i,activeThreadId:n}=t();if(!i)return;let l=eo._1.lastDisplayMessageId(t());await a({content:e,files:s,role:"user",sessionId:i,topicId:r,threadId:n,parentId:l})&&o("")},deleteAssistantMessage:async e=>{let s=M.E1.getDbMessageById(e)(t());if(!s)return;let a=[s.id];if(s.tools){let e=M.E1.activeDbMessages(t()),o=s.tools.flatMap(t=>e.filter(e=>e.tool_call_id===t.id).map(e=>e.id));a=a.concat(o)}await t().optimisticDeleteMessages(a)},deleteMessage:async e=>{let s=eo._1.getDisplayMessageById(e)(t());if(!s)return;let a=[s.id];if("assistantGroup"===s.role&&s.children){let e=s.children.map(e=>e.id);a=a.concat(e);let t=s.children.flatMap(e=>e.tools?e.tools.filter(e=>e.result?.id).map(e=>e.result.id):[]);a=a.concat(t)}await t().optimisticDeleteMessages(a)},deleteDBMessage:async e=>{let s=M.E1.getDbMessageById(e)(t());if(!s)return;let a=[s.id];t().internal_dispatchMessage({type:"deleteMessages",ids:a});let o=await j.T.removeMessages(a,{sessionId:t().activeId,topicId:t().activeTopicId});o?.success&&o.messages&&t().replaceMessages(o.messages)},deleteToolMessage:async e=>{let s=M.E1.getDbMessageById(e)(t());if(!s||"tool"!==s.role)return;let a=async()=>{s.parentId&&await t().optimisticRemoveToolFromAssistantMessage(s.parentId,s.tool_call_id)};await Promise.all([t().optimisticDeleteMessage(e),a()])},clearMessage:async()=>{let{activeId:e,activeTopicId:s,refreshTopic:a,switchTopic:o,activeSessionType:r}=t(),i="group"===r;if(void 0===r){let e=ec.B.getState();i=eu.z.isCurrentSessionGroupSession(e)}i?await j.T.removeMessagesByGroup(e,s):await j.T.removeMessagesByAssistant(e,s),s&&await ed.p.removeTopic(s),await a(),t().replaceMessages([]),o()},clearAllMessages:async()=>{await j.T.removeAllMessages(),t().replaceMessages([])},copyMessage:async(e,s)=>{await (0,el.l)(s),t().internal_traceMessage(e,{eventType:L.OH.CopyMessage})},toggleMessageEditing:(s,a)=>{e({messageEditingIds:eg(t().messageEditingIds,s,a)},!1,"toggleMessageEditing")},updateMessageInput:s=>{Z()(s,t().inputMessage)||e({inputMessage:s},!1,em("updateMessageInput",s))},modifyMessageContent:async(e,s)=>{t().internal_traceMessage(e,{eventType:L.OH.ModifyMessage,nextContent:s}),await t().optimisticUpdateMessageContent(e,s)},toggleMessageCollapsed:async(e,s)=>{let a=eo._1.getDisplayMessageById(e)(t());if(!a)return;let o=s??!a.metadata?.collapsed;await t().optimisticUpdateMessageMetadata(e,{collapsed:o})},toggleInspectExpanded:async(e,s)=>{let a=M.E1.getDbMessageById(e)(t());if(!a)return;let o=s??!a.metadata?.inspectExpanded;await t().optimisticUpdateMessageMetadata(e,{inspectExpanded:o})}}))(...e),...((e,t)=>({optimisticCreateMessage:async(e,s)=>{let{optimisticCreateTmpMessage:a,internal_toggleMessageLoading:o,internal_dispatchMessage:r,replaceMessages:i}=t(),n=s?.tempMessageId;n||o(!0,n=a(e));try{let a=await j.T.createMessage(e),{sessionId:r,topicId:l}=t().internal_getSessionContext(s);return i(a.messages,{sessionId:r,topicId:l}),o(!1,n),a}catch(e){o(!1,n),r({id:n,type:"updateMessage",value:{error:{body:e,message:e.message,type:L.T_.CreateMessageError}}},s)}},optimisticCreateTmpMessage:e=>{let{internal_dispatchMessage:s}=t(),a="tmp_"+(0,O.Ak)();return s({id:a,type:"createMessage",value:e}),a},optimisticDeleteMessage:async(e,s)=>{t().internal_dispatchMessage({id:e,type:"deleteMessage"},s);let{sessionId:a,topicId:o}=t().internal_getSessionContext(s),r=await j.T.removeMessage(e,{sessionId:a,topicId:o});r?.success&&r.messages&&t().replaceMessages(r.messages,{sessionId:a,topicId:o})},optimisticDeleteMessages:async(e,s)=>{t().internal_dispatchMessage({ids:e,type:"deleteMessages"},s);let{sessionId:a,topicId:o}=t().internal_getSessionContext(s),r=await j.T.removeMessages(e,{sessionId:a,topicId:o});r?.success&&r.messages&&t().replaceMessages(r.messages,{sessionId:a,topicId:o})},optimisticUpdateMessageContent:async(e,s,a,o)=>{let{internal_dispatchMessage:r,refreshMessages:i,replaceMessages:n}=t();a?.tools?r({id:e,type:"updateMessage",value:{tools:a?.tools}},o):r({id:e,type:"updateMessage",value:{content:s}},o);let{sessionId:l,topicId:d}=t().internal_getSessionContext(o),c=await j.T.updateMessage(e,{content:s,imageList:a?.imageList,metadata:a?.metadata,model:a?.model,provider:a?.provider,reasoning:a?.reasoning,search:a?.search,tools:a?.tools},{sessionId:l,topicId:d});c&&c.success&&c.messages?n(c.messages,{action:"optimisticUpdateMessageContent",sessionId:l,topicId:d}):await i()},optimisticUpdateMessageError:async(e,s,a)=>{t().internal_dispatchMessage({id:e,type:"updateMessage",value:{error:s}},a);let{sessionId:o,topicId:r}=t().internal_getSessionContext(a),i=await j.T.updateMessage(e,{error:s},{sessionId:o,topicId:r});i?.success&&i.messages?t().replaceMessages(i.messages,{sessionId:o,topicId:r}):await t().refreshMessages()},optimisticUpdateMessageMetadata:async(e,s,a)=>{let{internal_dispatchMessage:o,refreshMessages:r,replaceMessages:i}=t();o({id:e,type:"updateMessageMetadata",value:s},a);let{sessionId:n,topicId:l}=t().internal_getSessionContext(a),d=await j.T.updateMessageMetadata(e,s,{sessionId:n,topicId:l});d?.success&&d.messages?i(d.messages,{sessionId:n,topicId:l}):await r()},optimisticUpdateMessagePlugin:async(e,s,a)=>{let{internal_dispatchMessage:o,replaceMessages:r}=t();o({id:e,type:"updateMessagePlugin",value:s},a);let{sessionId:i,topicId:n}=t().internal_getSessionContext(a),l=await j.T.updateMessagePlugin(e,s,{sessionId:i,topicId:n});l?.success&&l.messages&&r(l.messages,{sessionId:i,topicId:n})},optimisticUpdateMessagePluginError:async(e,s,a)=>{let{sessionId:o,topicId:r}=t().internal_getSessionContext(a),i=await j.T.updateMessagePluginError(e,s,{sessionId:o,topicId:r});i?.success&&i.messages&&t().replaceMessages(i.messages,{sessionId:o,topicId:r})},optimisticUpdateMessageRAG:async(e,s,a)=>{let{sessionId:o,topicId:r}=t().internal_getSessionContext(a),i=await j.T.updateMessageRAG(e,s,{sessionId:o,topicId:r});i?.success&&i.messages&&t().replaceMessages(i.messages,{sessionId:o,topicId:r})}}))(...e),...((e,t)=>({refreshMessages:async(e,s)=>{let a=e??t().activeId,o=void 0!==s?s:t().activeTopicId;await (0,eh.j)([ey,a,o,"session"]),await (0,eh.j)([ey,a,o,"group"])},replaceMessages:(s,a)=>{let o=(0,er.T)(a?.sessionId??t().activeId,a?.topicId??t().activeTopicId),r={...t().dbMessagesMap,[o]:s};if(Z()(r,t().dbMessagesMap))return;let{flatList:i}=X(s);e({dbMessagesMap:r,messagesMap:{...t().messagesMap,[o]:i}},!1,a?.action??"replaceMessages")},useFetchMessages:(s,a,o,r="session")=>(0,g.lA)(s?[ey,a,o,r]:null,async([,e,t,s])=>"session"===s?j.T.getMessages(e,t):j.T.getGroupMessages(e,t),{onSuccess:(s,r)=>{let i={...t().dbMessagesMap,[(0,er.T)(a||"",o)]:s};t().messagesInit&&Z()(i,t().dbMessagesMap)||(e({messagesInit:!0},!1,ef("useFetchMessages(success)",{messages:s,queryKey:r})),t().replaceMessages(s,{action:ef("useFetchMessages/updateMessages")}))}})}))(...e),...((e,t)=>({internal_toggleLoadingArrays:(s,a,o,r)=>{let i=`${s}AbortController`;if(a){window.addEventListener("beforeunload",ep);let n=new AbortController;return e({[i]:n,[s]:eg(t()[s],o,a)},!1,r),n}o?e({[i]:void 0,[s]:eg(t()[s],o,a)},!1,r):e({[i]:void 0,[s]:[]},!1,r),window.removeEventListener("beforeunload",ep)},internal_toggleMessageLoading:(s,a)=>{e({messageLoadingIds:eg(t().messageLoadingIds,a,s)},!1,`internal_toggleMessageLoading/${s?"start":"end"}`)},internal_updateActiveId:s=>{t().activeId!==s&&(t().internal_cancelAllSupervisorDecisions(),e({activeId:s},!1,ev(`updateActiveId/${s}`)))},internal_updateActiveSessionType:s=>{t().activeSessionType!==s&&e({activeSessionType:s},!1,ev("updateActiveSessionType"))}}))(...e),...((e,t)=>({internal_dispatchMessage:(s,a)=>{let o,r;if(a?.operationId){let e=t().operations[a.operationId];if(!e)throw en("[internal_dispatchMessage] ERROR: Operation not found: %s",a.operationId),Error(`Operation not found: ${a.operationId}`);o=e.context.sessionId,r=e.context.topicId,en("[internal_dispatchMessage] get context from operation %s: sessionId=%s, topicId=%s",a.operationId,o,r)}else en("[internal_dispatchMessage] use global context: sessionId=%s, topicId=%s",o=t().activeId,r=t().activeTopicId);let i=(0,er.T)(o,r),n=((e,t)=>{switch(t.type){case"updateMessage":return(0,u.jM)(e,e=>{let{id:s,value:a}=t,o=e.findIndex(e=>e.id===s);o>=0&&(e[o]=(0,ei.h)(e[o],{...a,updatedAt:Date.now()}))});case"updateMessageExtra":return(0,u.jM)(e,e=>{let{id:s,key:a,value:o}=t,r=e.find(e=>e.id===s);r&&(r.extra?r.extra[a]=o:r.extra={[a]:o},r.updatedAt=Date.now())});case"updateMessageMetadata":return(0,u.jM)(e,e=>{let{id:s,value:a}=t,o=e.find(e=>e.id===s);o&&(o.metadata=(0,ei.h)(o.metadata,a),o.updatedAt=Date.now())});case"updatePluginState":return(0,u.jM)(e,e=>{let s,{id:a,key:o,value:r}=t,i=e.find(e=>e.id===a);!i||(s=i.pluginState?(0,ei.h)(i.pluginState,{[o]:r}):{[o]:r},Z()(i.pluginState,s)||(i.pluginState=s,i.updatedAt=Date.now()))});case"updateMessagePlugin":return(0,u.jM)(e,e=>{let{id:s,value:a}=t,o=e.find(e=>e.id===s);o&&"tool"===o.role&&(o.plugin=(0,ei.h)(o.plugin,a),o.updatedAt=Date.now())});case"addMessageTool":return(0,u.jM)(e,e=>{let{id:s,value:a}=t,o=e.find(e=>e.id===s);if(o&&"assistant"===o.role){if(o.tools){if(o.tools.findIndex(e=>e.id===a.id)>0)return;o.tools.push(a)}else o.tools=[a];o.updatedAt=Date.now()}});case"deleteMessageTool":return(0,u.jM)(e,e=>{let{id:s,tool_call_id:a}=t,o=e.find(e=>e.id===s);o&&"assistant"===o.role&&o.tools&&(o.tools=o.tools.filter(e=>e.id!==a),o.updatedAt=Date.now())});case"updateMessageTools":return(0,u.jM)(e,e=>{let{id:s,value:a,tool_call_id:o}=t,r=e.find(e=>e.id===s);if(!r||"assistant"!==r.role||!r.tools)return;let i=r.tools.findIndex(e=>e.id===o);i<0||(r.tools[i]=(0,ei.h)(r.tools[i],a),r.updatedAt=Date.now())});case"createMessage":return(0,u.jM)(e,e=>{let{value:s,id:a}=t;e.push({...s,createdAt:Date.now(),id:a,meta:{},updatedAt:Date.now()})});case"updateMessages":return t.value;case"deleteMessage":return(0,u.jM)(e,e=>{let{id:s}=t,a=e.findIndex(e=>e.id===s);a>=0&&e.splice(a,1)});case"deleteMessages":return(0,u.jM)(e,e=>{let{ids:s}=t;return e.filter(e=>!s.includes(e.id))});default:throw Error("暂未实现的 type，请检查 reducer")}})(t().dbMessagesMap[i]||[],s),l={...t().dbMessagesMap,[i]:n};if(Z()(l,t().dbMessagesMap))return;let{flatList:d}=X(n);e({dbMessagesMap:l,messagesMap:{...t().messagesMap,[i]:d}},!1,{payload:s,type:`dispatchMessage/${s.type}`})},internal_traceMessage:async(e,s)=>{let a=eo._1.getDisplayMessageById(e)(t());if(!a)return;let o=a?.traceId,r=a?.observationId;o&&a?.role==="assistant"&&ea.traceEvent({content:a.content,observationId:r,traceId:o,...s}).catch()}}))(...e)}))(...e),...((e,t)=>({updateThreadInputMessage:s=>{Z()(s,t().threadInputMessage)||e({threadInputMessage:s},!1,te("updateThreadInputMessage",s))},openThreadCreator:s=>{e({threadStartMessageId:s,portalThreadId:void 0,startToForkThread:!0},!1,"openThreadCreator"),t().togglePortal(!0)},openThreadInPortal:(s,a)=>{e({portalThreadId:s,threadStartMessageId:a,startToForkThread:!1},!1,"openThreadInPortal"),t().togglePortal(!0)},closeThreadPortal:()=>{e({threadStartMessageId:void 0,portalThreadId:void 0,startToForkThread:void 0},!1,"closeThreadPortal"),t().togglePortal(!1)},sendThreadMessage:async({message:s})=>{let a,o,{internal_execAgentRuntime:r,activeTopicId:i,activeId:n,threadStartMessageId:l,newThreadMode:d,portalThreadId:c}=t();if(!n||!i||!s)return;e({isCreatingThreadMessage:!0},!1,te("creatingThreadMessage/start"));let u={content:s,role:"user",sessionId:n,topicId:i,threadId:c};if(c){o=t().optimisticCreateTmpMessage(u),t().internal_toggleMessageLoading(!0,o);let e=await t().optimisticCreateMessage(u,{tempMessageId:o});if(!e)return;a=e.id}else{if(!l)return;o=t().optimisticCreateTmpMessage({...u,threadId:eF.vS}),t().internal_toggleMessageLoading(!0,o);let{threadId:e,messageId:s}=await t().createThread({message:u,sourceMessageId:l,topicId:i,type:d});a=s,await t().refreshThreads(),await t().refreshMessages(),t().openThreadInPortal(e,l)}if(t().internal_toggleMessageLoading(!1,o),!a)return;ec.B.getState().triggerSessionUpdate(t().activeId);let p=ex.Z.portalAIChats(t());if(await r({messages:p,parentMessageId:a,parentMessageType:"user",sessionId:t().activeId,topicId:t().activeTopicId,ragQuery:t().internal_shouldUseRAG()?s:void 0,threadId:t().portalThreadId,inPortalThread:!0}),e({isCreatingThreadMessage:!1},!1,te("creatingThreadMessage/stop")),!c){let e=ex.Z.currentPortalThread(t());if(!e)return;let s=ex.Z.portalAIChats(t());await t().summaryThreadTitle(e.id,s)}},resendThreadMessage:async e=>{await t().regenerateUserMessage(e,{})},delAndResendThreadMessage:async e=>{t().resendThreadMessage(e),t().deleteMessage(e)},createThread:async({message:t,sourceMessageId:s,topicId:a,type:o})=>{e({isCreatingThread:!0},!1,te("creatingThread/start"));let r=await e8.createThreadWithMessage({topicId:a,sourceMessageId:s,type:o,message:t});return e({isCreatingThread:!1},!1,te("creatingThread/end")),r},useFetchThreads:(s,a)=>(0,g.lA)(s&&a?[tt,a]:null,async([,e])=>e8.getThreads(e),{onSuccess:s=>{let o={...t().threadMaps,[a]:s};t().topicsInit&&Z()(o,t().topicMaps)||e({threadMaps:o,threadsInit:!0},!1,te("useFetchThreads(success)",{topicId:a}))}}),refreshThreads:async()=>{let e=t().activeTopicId;if(e)return(0,eh.j)([tt,e])},removeThread:async s=>{await e8.removeThread(s),await t().refreshThreads(),t().activeThreadId===s&&e({activeThreadId:void 0})},switchThread:async t=>{e({activeThreadId:t},!1,te("toggleTopic"))},updateThreadTitle:async(e,s)=>{await t().internal_updateThread(e,{title:s})},summaryThreadTitle:async(e,s)=>{let{internal_updateThreadTitleInSummary:a,internal_updateThreadLoading:o}=t(),r=ex.Z.currentPortalThread(t());if(!r)return;a(e,eF.m5);let i="",n=q.v.thread(H.k.getState());await N.O.fetchPresetTaskResult({onError:()=>{a(e,r.title)},onFinish:async s=>{await t().internal_updateThread(e,{title:s})},onLoadingChange:t=>{o(e,t)},onMessageHandle:t=>{"text"===t.type&&(i+=t.text),a(e,i)},params:(0,ei.h)(n,(0,E.y_)(s,eO.J.getCurrentLanguage()))})},internal_updateThreadTitleInSummary:(e,s)=>{t().internal_dispatchThread({type:"updateThread",id:e,value:{title:s}},"updateThreadTitleInSummary")},internal_updateThreadLoading:(t,s)=>{e(e=>s?{threadLoadingIds:[...e.threadLoadingIds,t]}:{threadLoadingIds:e.threadLoadingIds.filter(e=>e!==t)},!1,te("updateThreadLoading"))},internal_updateThread:async(e,s)=>{t().internal_dispatchThread({type:"updateThread",id:e,value:s}),t().internal_updateThreadLoading(e,!0),await e8.updateThread(e,s),await t().refreshThreads(),t().internal_updateThreadLoading(e,!1)},internal_dispatchThread:(s,a)=>{let o=((e=[],t)=>{switch(t.type){case"updateThread":return(0,u.jM)(e,e=>{let{value:s,id:a}=t,o=e.findIndex(e=>e.id===a);-1!==o&&(e[o]={...e[o],...s,updatedAt:new Date})});case"deleteThread":return(0,u.jM)(e,e=>{let s=e.findIndex(e=>e.id===t.id);-1!==s&&e.splice(s,1)});default:return e}})(ex.Z.currentTopicThreads(t()),s),r={...t().threadMaps,[t().activeTopicId]:o};Z()(r,t().threadMaps)||e({threadMaps:r},!1,a??te(`dispatchThread/${s.type}`))}}))(...e),...((...e)=>({...((e,t)=>({deleteUserMessageRagQuery:async e=>{let s=M.E1.getDbMessageById(e)(t());s&&s.ragQueryId&&(t().internal_dispatchMessage({id:e,type:"updateMessage",value:{ragQuery:null}}),await eW.o.deleteMessageRagQuery(s.ragQueryId),await t().refreshMessages())},internal_retrieveChunks:async(e,s,a)=>{t().internal_toggleMessageRAGLoading(!0,e);let o=M.E1.getDbMessageById(e)(t()),r=o?.ragQuery;!o?.ragQuery&&a.length>0&&(r=await t().internal_rewriteQuery(e,s,a));let i=M.E1.dbUserFiles(t()).map(e=>e?.id).filter(Boolean);try{let{chunks:a,queryId:o}=await eW.o.semanticSearchForChat({fileIds:eJ().fileIds.concat(i),knowledgeIds:eJ().knowledgeBaseIds,messageId:e,rewriteQuery:r||s,userQuery:s});return t().internal_toggleMessageRAGLoading(!1,e),{chunks:a,queryId:o,rewriteQuery:r}}catch{return t().internal_toggleMessageRAGLoading(!1,e),{chunks:[]}}},internal_rewriteQuery:async(e,s,a)=>{let o=s,r=q.v.queryRewrite(H.k.getState());if(!r.enabled)return s;let i={model:r.model,provider:r.provider,...(0,E.K7)(s,a,r.customPrompt?r.customPrompt:void 0)},n="";return await N.O.fetchPresetTaskResult({onFinish:async e=>{o=e},onMessageHandle:s=>{"text"===s.type&&(n+=s.text,t().internal_dispatchMessage({id:e,type:"updateMessage",value:{ragQuery:n}}))},params:i}),o},internal_shouldUseRAG:()=>eq.e.hasEnabledKnowledge(ej.o.getState()),internal_toggleMessageRAGLoading:(s,a)=>{e({messageRAGLoadingIds:eg(t().messageRAGLoadingIds,a,s)},!1,"internal_toggleMessageLoading")},rewriteQuery:async e=>{let s=M.E1.getDbMessageById(e)(t());if(!s)return;await t().deleteUserMessageRagQuery(e);let a=eo._1.mainAIChatsWithHistoryConfig(t());await t().internal_rewriteQuery(e,s.content,a.map(e=>e.content))}}))(...e),...((e,t)=>({internal_summaryHistory:async e=>{let s=t().activeTopicId;if(e.length<=1||!s)return;let{model:a,provider:o}=q.v.historyCompress(H.k.getState()),r="";await N.O.fetchPresetTaskResult({onFinish:async e=>{r=e},params:{...(0,E.aj)(e),model:a,provider:o,stream:!1},trace:{sessionId:t().activeId,topicId:t().activeTopicId,traceName:L.Fs.SummaryHistoryMessages}}),await ed.p.updateTopic(s,{historySummary:r,metadata:{model:a,provider:o}}),await t().refreshTopic(),await t().refreshMessages()}}))(...e),...((e,t)=>({sendMessage:async({message:e,files:s,onlyAddUserMessage:a})=>{let o,r,{activeTopicId:i,activeId:n,activeThreadId:l,internal_execAgentRuntime:d,mainInputEditor:c}=t();if(!n)return;let u=s?.map(e=>e.id),p=!!u&&u.length>0;if(!e&&!p)return;if(a)return void await t().addUserMessage({message:e,fileList:u});let g=eo._1.activeDisplayMessages(t()),m=eo._1.lastDisplayMessageId(t());m&&(o=eo._1.findLastMessageId(m)(t()));let h=eH.c.currentChatConfig((0,ej._)()),f=h.autoCreateTopicThreshold??eF.iD.autoCreateTopicThreshold,y=!i&&!!h.enableAutoCreateTopic&&g.length+2>=f,v=(0,T.$)().chatUploadFileList,I=v.filter(e=>e.file?.type?.startsWith("image")).map(e=>({id:e.id,url:e.fileUrl||e.base64Url||e.previewUrl||"",alt:e.file?.name||e.id})),w=v.filter(e=>e.file?.type?.startsWith("video")).map(e=>({id:e.id,url:e.fileUrl||e.base64Url||e.previewUrl||"",alt:e.file?.name||e.id})),S=t().optimisticCreateTmpMessage({content:e,files:u,role:"user",sessionId:n,topicId:i,threadId:l,imageList:I.length>0?I:void 0,videoList:w.length>0?w:void 0}),C=t().optimisticCreateTmpMessage({content:eF.m5,role:"assistant",sessionId:n,topicId:i,threadId:l});t().internal_toggleMessageLoading(!0,S);let{operationId:b,abortController:_}=t().startOperation({type:"sendMessage",context:{sessionId:n,topicId:i,threadId:l,messageId:S},label:"Send Message",metadata:{inThread:!1}});t().associateMessageWithOperation(S,b);let A=c?.getJSONState();t().updateOperationMetadata(b,{inputEditorTempState:A,inputSendErrorMsg:void 0});try{let{model:s,provider:a}=eq.e.currentAgentConfig((0,ej._)());r=await eN.sendMessageInServer({newUserMessage:{content:e,files:u,parentId:o},topicId:i,threadId:l,newTopic:y?{topicMessageIds:g.map(e=>e.id),title:e.slice(0,10)||(0,eb.t)("defaultTitle",{ns:"topic"})}:void 0,sessionId:n===eF.Ed?void 0:n,newAssistantMessage:{model:s,provider:a}},_);let d=i;r?.topics&&(t().internal_dispatchTopic({type:"updateTopics",value:r.topics}),d=r.topicId,t().updateOperationMetadata(b,{createdTopicId:r.topicId})),t().replaceMessages(r.messages,{sessionId:n,topicId:d,action:"sendMessage/serverResponse"}),r.isCreateNewTopic&&r.topicId&&await t().switchTopic(r.topicId,!0)}catch(e){t().failOperation(b,{type:e instanceof Error?e.name:"unknown_error",message:e instanceof Error?e.message:"Unknown error"}),e instanceof eG.HN&&(e.message.includes("aborted")||"AbortError"===e.name||(t().updateOperationMetadata(b,{inputSendErrorMsg:e.message}),t().mainInputEditor?.setJSONState(A)))}finally{(r?.isCreateNewTopic||!r)&&t().internal_dispatchMessage({type:"deleteMessages",ids:[S,C]},{operationId:b})}if(t().internal_toggleMessageLoading(!1,S),r&&t().updateOperationMetadata(b,{inputEditorTempState:null}),!r)return;(0,ec.L)().triggerSessionUpdate(t().activeId),r.topicId&&t().internal_updateTopicLoading(r.topicId,!0),(async()=>{if(r.isCreateNewTopic)return void await t().summaryTopicTitle(r.topicId,r.messages);if(!r.topicId)return;let e=eP.e.getTopicById(r.topicId)(t());if(e&&!e.title){let s=eo._1.getDisplayMessagesByKey((0,er.T)(n,e.id))(t()).filter(e=>e.id!==r.assistantMessageId);await t().summaryTopicTitle(e.id,s)}})().catch(console.error);let x=eo._1.activeDisplayMessages(t());try{await d({messages:x,parentMessageId:r.assistantMessageId,parentMessageType:"assistant",sessionId:n,topicId:r.topicId??i,parentOperationId:b,ragQuery:t().internal_shouldUseRAG()?e:void 0,threadId:l,skipCreateFirstMessage:!0});let s=M.E1.dbUserFiles(t()).map(e=>e?.id).filter(Boolean);s.length>0&&await (0,ej._)().addFilesToAgent(s,!1),t().completeOperation(b)}catch(e){console.error(e),t().failOperation(b,{type:e instanceof Error?e.name:"unknown_error",message:e instanceof Error?e.message:"AI generation failed"})}finally{r.topicId&&t().internal_updateTopicLoading(r.topicId,!1)}},regenerateUserMessage:async(e,s)=>{if(eK.R.isMessageRegenerating(e)(t()))return;let a=eo._1.getDisplayMessageById(e)(t());if(!a)return;let o=eo._1.mainAIChats(t()),r=o.findIndex(t=>t.id===e),i=o.slice(0,r+1);if(i.length<=0)return;let{internal_execAgentRuntime:n,activeThreadId:l,activeId:d,activeTopicId:c}=t(),{operationId:u}=t().startOperation({type:"regenerate",context:{sessionId:d,topicId:c,messageId:e}});try{let o=s?.traceId??M.E1.getTraceIdByDbMessageId(e)(t());await t().switchMessageBranch(e,a.branch?a.branch.count:1),await n({messages:i,parentMessageId:e,parentMessageType:"user",sessionId:d,topicId:c,traceId:o,ragQuery:t().internal_shouldUseRAG()?a.content:void 0,threadId:l,parentOperationId:u}),s?.skipTrace||t().internal_traceMessage(e,{eventType:L.OH.RegenerateMessage}),t().completeOperation(u)}catch(e){throw t().failOperation(u,{type:"RegenerateError",message:e instanceof Error?e.message:String(e)}),e}},regenerateAssistantMessage:async(e,s)=>{if(eK.R.isMessageRegenerating(e)(t()))return;let a=eo._1.mainAIChats(t()),o=a.findIndex(t=>t.id===e),r=a[o].parentId,i=a.findIndex(e=>e.id===r);!(a.slice(0,i<0?o+1:i+1).length<=0)&&r&&await t().regenerateUserMessage(r,s)},continueGenerationMessage:async(e,s)=>{let a=M.E1.getDbMessageById(e)(t());if(!a)return;let{activeId:o,activeTopicId:r}=t(),{operationId:i}=t().startOperation({type:"continue",context:{sessionId:o,topicId:r,messageId:s}});try{let s=eo._1.mainAIChatsWithHistoryConfig(t());await t().internal_execAgentRuntime({messages:s,parentMessageId:e,parentMessageType:a.role,sessionId:o,topicId:r,parentOperationId:i}),t().completeOperation(i)}catch(e){throw t().failOperation(i,{type:"ContinueError",message:e instanceof Error?e.message:String(e)}),e}},delAndRegenerateMessage:async e=>{let s=M.E1.getTraceIdByDbMessageId(e)(t());t().regenerateAssistantMessage(e,{skipTrace:!0,traceId:s}),t().deleteMessage(e),t().internal_traceMessage(e,{eventType:L.OH.DeleteAndRegenerateMessage})}}))(...e),...((e,t)=>({stopGenerateMessage:()=>{let{activeId:e,activeTopicId:s,cancelOperations:a}=t();a({type:"execAgentRuntime",status:"running",sessionId:e,topicId:s},eF.OB)},cancelSendMessageInServer:e=>{let{activeId:s,activeTopicId:a}=t(),o=(0,er.T)(s,e??a),r=t().operationsByContext[o]||[];if(r.forEach(e=>{let s=t().operations[e];s&&"sendMessage"===s.type&&"running"===s.status&&t().cancelOperation(e,"User cancelled")}),o===(0,er.T)(s,a))for(let e of[...r].reverse()){let s=t().operations[e];if(s&&"sendMessage"===s.type&&s.metadata.inputEditorTempState){t().mainInputEditor?.setJSONState(s.metadata.inputEditorTempState);break}}},clearSendMessageError:()=>{let{activeId:e,activeTopicId:s}=t(),a=(0,er.T)(e,s);(t().operationsByContext[a]||[]).forEach(e=>{let s=t().operations[e];s&&"sendMessage"===s.type&&s.metadata.inputSendErrorMsg&&t().updateOperationMetadata(e,{inputSendErrorMsg:void 0})})},switchMessageBranch:async(e,s)=>{await t().optimisticUpdateMessageMetadata(e,{activeBranchIndex:s})},approveToolCalling:async e=>{let{activeThreadId:s,internal_execAgentRuntime:a}=t(),o=M.E1.getDbMessageById(e)(t());if(!o)return;await t().optimisticUpdatePlugin(e,{intervention:{status:"approved"}});let r=eo._1.mainAIChats(t()),{state:i,context:n}=t().internal_createAgentState({messages:r,parentMessageId:e,threadId:s}),l={...n,phase:"human_approved_tool",payload:{approvedToolCall:o.plugin,parentMessageId:e,skipCreateToolMessage:!0}};try{await a({messages:r,parentMessageId:e,parentMessageType:"tool",sessionId:t().activeId,topicId:t().activeTopicId,threadId:s,initialState:i,initialContext:l})}catch(e){console.error("[approveToolCalling] Error executing agent runtime:",e)}},rejectToolCalling:async(e,s)=>{let a=M.E1.getDbMessageById(e)(t());if(!a)return;await t().optimisticUpdatePlugin(a.id,{intervention:{rejectedReason:s,status:"rejected"}});let o=s?`User reject this tool calling with reason: ${s}`:"User reject this tool calling without reason";await t().optimisticUpdateMessageContent(e,o)},rejectAndContinueToolCalling:async(e,s)=>{if(await t().rejectToolCalling(e,s),!M.E1.getDbMessageById(e)(t()))return;let a=eo._1.mainAIChats(t()),{activeThreadId:o,internal_execAgentRuntime:r}=t(),{state:i,context:n}=t().internal_createAgentState({messages:a,parentMessageId:e,threadId:o}),l={...n,phase:"user_input"};try{await r({messages:a,parentMessageId:e,parentMessageType:"tool",sessionId:t().activeId,topicId:t().activeTopicId,threadId:o,initialState:i,initialContext:l})}catch(e){console.error("[rejectAndContinueToolCalling] Error executing agent runtime:",e)}}}))(...e),...((e,t)=>({internal_createAgentState:({messages:e,parentMessageId:s,sessionId:a,topicId:o,threadId:r,initialState:i,initialContext:n})=>{let l,{activeId:d,activeTopicId:c}=t(),u=a??d,p=(0,ej._)(),g=eq.e.currentAgentConfig(p),m=(l={model:g.model,provider:g.provider},(0,e5.QG)({defaultToolIds:[e2.J.identifier],enableChecker:({pluginId:e})=>e!==e2.J.identifier||(0,e4.H)(l.model,l.provider).useApplicationBuiltinSearchTool})),{enabledToolIds:h}=m.generateToolsDetailed({model:g.model,provider:g.provider,toolIds:g.plugins}),f=Object.fromEntries(m.getEnabledPluginManifests(h).entries()),y=(0,H.c)(),v={approvalMode:e9.g.approvalMode(y),allowList:e9.g.allowList(y)},I=i||eQ.createInitialState({sessionId:u,messages:e,maxSteps:400,metadata:{sessionId:u,topicId:void 0!==o?o:c,threadId:r},toolManifestMap:f,userInterventionConfig:v}),M=n||{phase:"init",payload:{model:g.model,provider:g.provider,parentMessageId:s},session:{sessionId:u,messageCount:e.length,status:I.status,stepCount:0}};return{state:I,context:M}},internal_fetchAIChatMessage:async({messageId:e,messages:s,model:a,provider:o,operationId:r,agentConfig:i,traceId:n})=>{let l,d,c,u,p,g,m,h,f,y,v,{optimisticUpdateMessageContent:I,internal_dispatchMessage:M,internal_toggleToolCallingStreaming:w}=t(),S=n;if(r){let e=t().operations[r];if(!e)throw e6("[internal_fetchAIChatMessage] ERROR: Operation not found: %s",r),Error(`Operation not found: ${r}`);l=e.context.sessionId,d=e.context.topicId,c=e.abortController,e6("[internal_fetchAIChatMessage] get context from operation %s: sessionId=%s, topicId=%s, aborted=%s",r,l,d,c.signal.aborted),S||(S=e.metadata?.traceId)}else l=t().activeId,d=t().activeTopicId,c=new AbortController,e6("[internal_fetchAIChatMessage] use global context: sessionId=%s, topicId=%s",l,d);let C=i||eq.e.currentAgentConfig((0,ej._)()),b=eH.c.currentChatConfig((0,ej._)());C.params.max_tokens=b.enableMaxTokens?C.params.max_tokens:void 0,C.params.reasoning_effort=b.enableReasoningEffort?C.params.reasoning_effort:void 0;let _=!1,A="",x="",k=new Map,E=(0,eY.A)(s=>{M({id:e,type:"updateMessage",value:{tools:t().internal_transformToolCalls(s)}},{operationId:r})},300,{leading:!0,trailing:!0}),O=b.enableCompressHistory?eP.e.currentActiveTopicSummary(t()):void 0;return await N.O.createAssistantMessageStream({abortController:c,params:{messages:s,model:a,provider:o,...C.params,plugins:C.plugins},historySummary:O?.content,trace:{traceId:S,sessionId:l,topicId:d??void 0,traceName:L.Fs.Conversation},onErrorHandle:async s=>{e6("[internal_fetchAIChatMessage] onError: messageId=%s, error=%s, operationId=%s",e,s.message,r),await t().optimisticUpdateMessageError(e,s,{operationId:r})},onFinish:async(s,{traceId:a,observationId:o,toolCalls:i,reasoning:n,grounding:c,usage:h,speed:y,type:M})=>{a&&(m=a,j.T.updateMessage(e,{traceId:a,observationId:o??void 0},{sessionId:l,topicId:d}));let T=[];if(k.size>0)try{T=(await Promise.all(k.values())).filter(e=>!!e.url)}catch(e){console.error("Error waiting for image uploads:",e)}let S=i;S&&S.length>0&&(E.flush(),w(e,void 0),p=i,S=S.map(e=>({...e,function:{...e.function,arguments:e.function.arguments?e.function.arguments:"{}"}})),u=t().internal_transformToolCalls(S),_=!0),g=h,v=M,e6("[internal_fetchAIChatMessage] onFinish: messageId=%s, finishType=%s, operationId=%s",e,M,r),await I(e,s,{tools:u,reasoning:n?{...n,duration:f&&!isNaN(f)?f:void 0}:void 0,search:c?.citations?c:void 0,imageList:T.length>0?T:void 0,metadata:{...h,...y,performance:y,usage:h,finishType:M}},{operationId:r})},onMessageHandle:async s=>{switch(s.type){case"grounding":if(!s.grounding||!s.grounding.citations||s.grounding.citations.length<=0)return;M({id:e,type:"updateMessage",value:{search:{citations:s.grounding.citations,searchQueries:s.grounding.searchQueries}}},{operationId:r});break;case"base64_image":{M({id:e,type:"updateMessage",value:{imageList:s.images.map(e=>({id:e.id,url:e.data,alt:e.id}))}},{operationId:r});let t=s.image,a=(0,T.$)().uploadBase64FileWithProgress(t.data).then(e=>({id:e?.id,url:e?.url,alt:e?.filename||e?.id}));k.set(t.id,a);break}case"text":A+=s.text,!f&&(f=Date.now()-h,y&&(t().completeOperation(y),y=void 0)),e6("[text stream] messageId=%s, output length=%d, operationId=%s",e,A.length,r),M({id:e,type:"updateMessage",value:{content:A,reasoning:x?{content:x,duration:f}:void 0}},{operationId:r});break;case"reasoning":if(!h){h=Date.now();let{operationId:s}=t().startOperation({type:"reasoning",context:{sessionId:l,topicId:d,messageId:e},parentOperationId:r});y=s,t().associateMessageWithOperation(e,y)}M({id:e,type:"updateMessage",value:{reasoning:{content:x+=s.text}}},{operationId:r});break;case"tool_calls":w(e,s.isAnimationActives),E(s.tool_calls),_=!0,!f&&y&&(f=Date.now()-h,t().completeOperation(y),y=void 0)}}}),e6("[internal_fetchAIChatMessage] completed: messageId=%s, finishType=%s, isFunctionCall=%s, operationId=%s",e,v,_,r),{isFunctionCall:_,traceId:m,content:A,tools:u,usage:g,tool_calls:p,finishType:v}},internal_execAgentRuntime:async e=>{var a;let o,r,{messages:i,parentMessageId:n,parentMessageType:l,sessionId:d,topicId:c}=e,{activeId:u,activeTopicId:g}=t(),m=d??u,h=void 0!==c?c:g,f=(0,er.T)(m,h),y=e.operationId;if(!y){let{operationId:s}=t().startOperation({type:"execAgentRuntime",context:{sessionId:m,topicId:h,messageId:n,threadId:e.threadId},parentOperationId:e.parentOperationId,label:"AI Generation",metadata:{inThread:e.inPortalThread||!1}});y=s,t().associateMessageWithOperation(n,y)}e6("[internal_execAgentRuntime] start, operationId: %s, sessionId: %s, topicId: %s, messageKey: %s, parentMessageId: %s, parentMessageType: %s, messages count: %d",y,m,h,f,n,l,i.length);let v=[...i],I=(0,ej._)(),M=eq.e.currentAgentConfig(I),{chatConfig:T}=M,w=M.model,S=M.provider;if(e.ragQuery&&"user"===l){e6("[internal_execAgentRuntime] RAG preprocessing start");let{chunks:s,queryId:a,rewriteQuery:o}=await t().internal_retrieveChunks(n,e.ragQuery,v.map(e=>e.content).slice(0,v.length-1));e6("[internal_execAgentRuntime] RAG chunks retrieved: %d chunks",s.length);let r=v.pop(),i=(0,E.fQ)({chunks:s,userQuery:r.content,rewriteQuery:o,knowledge:eq.e.currentEnabledKnowledge(I)});v.push({...r,content:(r.content+"\n\n"+i).trim()});let l=s.map(e=>({id:e.id,similarity:e.similarity}));l.length>0&&(e.ragMetadata={ragQueryId:a,fileChunks:l}),e6("[internal_execAgentRuntime] RAG preprocessing completed")}e6("[internal_execAgentRuntime] Creating agent runtime");let C=new eQ(new eZ({agentConfig:{maxSteps:1e3},sessionId:`${f}/${e.parentMessageId}`,modelRuntimeConfig:{model:w,provider:S}}),{executors:(o=(a={get:t,messageKey:f,operationId:y,parentId:e.parentMessageId,skipCreateFirstMessage:e.skipCreateFirstMessage}).skipCreateFirstMessage,r=()=>{let e=a.get().operations[a.operationId];if(!e)throw Error(`Operation not found: ${a.operationId}`);return e.context},{call_llm:async(e,t)=>{let s,i=`${t.sessionId}:${t.stepCount}`,n=`[${i}][call_llm]`,l=e.payload;if(e0(`${n} Starting session`),o)s=a.parentId,o=!1;else{let e=r();l.parentMessageId||(l.parentMessageId=a.parentId);let t=await a.get().optimisticCreateMessage({content:eL.VH,model:l.model,parentId:l.parentMessageId,provider:l.provider,role:"assistant",sessionId:e.sessionId,threadId:e.threadId,topicId:e.topicId??void 0});if(!t)throw Error("Failed to create assistant message");s=t.id,a.get().associateMessageWithOperation(s,a.operationId)}e0(`${n} Created assistant message, id: %s`,s),e0(`${n} calling model-runtime chat (model: %s, messages: %d, tools: %d)`,l.model,l.messages.length,l.tools?.length??0);let d=l.messages.filter(e=>e.id!==s),{isFunctionCall:c,content:u,tools:p,usage:g,tool_calls:m,finishType:h}=await a.get().internal_fetchAIChatMessage({messageId:s,messages:d,model:l.model,provider:l.provider,operationId:a.operationId});e0(`[${i}] finish model-runtime calling`);let f=a.get().dbMessagesMap[a.messageKey]||[],y=f.find(e=>e.id===s),v=p||[];u&&e0(`[${i}][content]`,u),y?.reasoning?.content&&e0(`[${i}][reasoning]`,y.reasoning.content),v.length>0&&e0(`[${i}][toolsCalling] `,v),g&&e0(`[${i}][usage] %O`,g),e0("[%s:%d] call_llm completed, finishType: %s",t.sessionId,t.stepCount,h);let I={...t,messages:f};if(g){let{usage:e,cost:s}=eX.accumulateLLM({cost:t.cost,model:l.model,modelUsage:g,provider:l.provider,usage:t.usage});I.usage=e,s&&(I.cost=s)}return"abort"===h?(e0("[%s:%d] call_llm aborted by user, entering human_abort phase",t.sessionId,t.stepCount),{events:[],newState:I,nextContext:{payload:{reason:"user_cancelled",parentMessageId:s,hasToolsCalling:c,toolsCalling:v,result:{content:u,tool_calls:m}},phase:"human_abort",session:{messageCount:I.messages.length,sessionId:t.sessionId,status:"running",stepCount:t.stepCount+1}}}):{events:[],newState:I,nextContext:{payload:{hasToolsCalling:c,parentMessageId:s,result:{content:u,tool_calls:m},toolsCalling:v},phase:"llm_result",session:{messageCount:I.messages.length,sessionId:t.sessionId,status:"running",stepCount:t.stepCount+1},stepUsage:g}}},call_tool:async(e,t)=>{let s=e.payload,o=[],i=`${t.sessionId}:${t.stepCount}`;e0("[%s][call_tool] Executor start, payload: %O",i,s);let n=s.toolCalling,l=`${n.identifier}/${n.apiName}`,d=performance.now(),c=r(),{operationId:u}=a.get().startOperation({type:"toolCalling",context:{sessionId:c.sessionId,topicId:c.topicId},parentOperationId:a.operationId,metadata:{startTime:Date.now(),identifier:n.identifier,apiName:n.apiName,tool_call_id:n.id}});try{let e,r=a.get().dbMessagesMap[a.messageKey]||[],p=r.findLast(e=>"assistant"===e.role);if(s.skipCreateToolMessage){e=s.parentMessageId;let t=r.find(t=>t.id===e);e0("[%s][call_tool] Resuming with existing tool message: %s (status: %s)",i,e,t.pluginIntervention?.status)}else{e0("[%s][call_tool] Creating tool message for tool_call_id: %s",i,n.id);let t=a.get().startOperation({type:"createToolMessage",context:{sessionId:c.sessionId,topicId:c.topicId},parentOperationId:u,metadata:{startTime:Date.now(),tool_call_id:n.id}}).operationId;a.get().onOperationCancel(t,async({metadata:e})=>{e0("[%s][call_tool] createToolMessage cancelled, ensuring creation completes",i);let s=await e?.createMessagePromise;if(s){let e=s.id;await Promise.all([a.get().optimisticUpdateMessageContent(e,"Tool execution was cancelled by user.",void 0,{operationId:t}),a.get().optimisticUpdateMessagePlugin(e,{intervention:{status:"aborted"}},{operationId:t})])}});let o={content:"",groupId:p?.groupId,parentId:s.parentMessageId,plugin:n,role:"tool",sessionId:c.sessionId,threadId:c.threadId,tool_call_id:n.id,topicId:c.topicId??void 0},r=a.get().optimisticCreateMessage(o);a.get().updateOperationMetadata(t,{createMessagePromise:r});let l=await r;if(!l)throw a.get().failOperation(t,{type:"CreateMessageError",message:`Failed to create tool message for tool_call_id: ${n.id}`}),Error(`Failed to create tool message for tool_call_id: ${n.id}`);e=l.id,e0("[%s][call_tool] Created tool message, id: %s",i,e),a.get().completeOperation(t)}let g=u?a.get().operations[u]:void 0;if(g?.abortController.signal.aborted)return e0("[%s][call_tool] Parent operation cancelled, skipping tool execution",i),{events:o,newState:t};let{operationId:m}=a.get().startOperation({type:"executeToolCall",context:{messageId:e},parentOperationId:u,metadata:{startTime:Date.now(),tool_call_id:n.id}});e0("[%s][call_tool] Created executeToolCall operation %s for message %s",i,m,e),a.get().onOperationCancel(m,async()=>{e0("[%s][call_tool] executeToolCall cancelled, updating message",i),await Promise.all([a.get().optimisticUpdateMessageContent(e,"Tool execution was cancelled by user.",void 0,{operationId:m}),a.get().optimisticUpdateMessagePlugin(e,{intervention:{status:"aborted"}},{operationId:m})])}),e0("[%s][call_tool] Executing tool %s ...",i,l);let h=await a.get().internal_invokeDifferentTypePlugin(e,n),f=a.get().operations[m];if(f?.abortController.signal.aborted)return e0("[%s][call_tool] Tool execution completed but operation was cancelled",i),{events:o,newState:t};a.get().completeOperation(m);let y=Math.round(performance.now()-d),v=!h.error;e0("[%s][call_tool] Executing %s in %dms, result: %O",i,l,y,h),u&&(v?a.get().completeOperation(u):a.get().failOperation(u,{type:"ToolExecutionError",message:h.error||"Tool execution failed"})),o.push({id:n.id,result:h,type:"tool_result"});let I=a.get().dbMessagesMap[a.messageKey]||[],M={...t,messages:I},T=e1[l]||0,{usage:w,cost:S}=eX.accumulateTool({cost:t.cost,executionTime:y,success:v,toolCost:T,toolName:l,usage:t.usage});M.usage=w,S&&(M.cost=S);let C=w.tools.byTool.find(e=>e.name===l);return e0("[%s][tool usage] %s: calls=%d, time=%dms, success=%s, cost=$%s",i,l,C?.calls||0,y,v,T.toFixed(4)),e0("[%s][call_tool] Tool execution completed",i),{events:o,newState:M,nextContext:{payload:{data:h,executionTime:y,isSuccess:v,parentMessageId:e,toolCall:n,toolCallId:n.id},phase:"tool_result",session:{eventCount:o.length,messageCount:M.messages.length,sessionId:t.sessionId,status:"running",stepCount:t.stepCount+1},stepUsage:{cost:T,toolName:l,unitPrice:T,usageCount:1}}}}catch(e){return e0("[%s][call_tool] ERROR: Tool execution failed: %O",i,e),o.push({error:e,type:"error"}),{events:o,newState:t}}},request_human_approve:async(e,t)=>{let{pendingToolsCalling:s,reason:o,skipCreateToolMessage:i}=e,n=structuredClone(t),l=[],d=`${t.sessionId}:${t.stepCount}`;e0("[%s][request_human_approve] Executor start, pending tools count: %d, reason: %s",d,s.length,o||"human_intervention_required"),n.lastModified=new Date().toISOString(),n.status="waiting_for_human",n.pendingToolsCalling=s;let c=(a.get().dbMessagesMap[a.messageKey]||[]).findLast(e=>"assistant"===e.role);if(!c)throw e0("[%s][request_human_approve] ERROR: No assistant message found",d),Error("No assistant message found for intervention");if(e0("[%s][request_human_approve] Found assistant message: %s",d,c.id),i)e0("[%s][request_human_approve] Resuming with existing tool messages",d);else{let e=r();await (0,p.Ay)(s,async t=>{let s=`${t.identifier}/${t.apiName}`;e0("[%s][request_human_approve] Creating tool message for %s with tool_call_id: %s",d,s,t.id);let o={content:"",groupId:c.groupId,parentId:c.id,plugin:{...t},pluginIntervention:{status:"pending"},role:"tool",sessionId:e.sessionId,threadId:e.threadId,tool_call_id:t.id,topicId:e.topicId??void 0},r=await a.get().optimisticCreateMessage(o);if(!r)throw e0("[%s][request_human_approve] ERROR: Failed to create tool message for %s",d,s),Error(`Failed to create tool message for ${s}`);e0("[%s][request_human_approve] Created tool message: %s for %s",d,r.id,s)})}return e0("[%s][request_human_approve] All tool messages created, emitting human_approve_required event",d),l.push({pendingToolsCalling:s,sessionId:n.sessionId,type:"human_approve_required"}),{events:l,newState:n}},resolve_aborted_tools:async(e,t)=>{let{parentMessageId:s,toolsCalling:o}=e.payload,i=[],n=`${t.sessionId}:${t.stepCount}`,l=structuredClone(t);e0("[%s][resolve_aborted_tools] Resolving %d aborted tools",n,o.length);let d=r();return await (0,p.Ay)(o,async e=>{let t=`${e.identifier}/${e.apiName}`;e0("[%s][resolve_aborted_tools] Creating aborted tool message for %s",n,t);let o={content:"Tool execution was aborted by user.",parentId:s,plugin:e,pluginIntervention:{status:"aborted"},role:"tool",sessionId:d.sessionId,threadId:d.threadId,tool_call_id:e.id,topicId:d.topicId??void 0},r=await a.get().optimisticCreateMessage(o);r&&e0("[%s][resolve_aborted_tools] Created aborted tool message: %s for %s",n,r.id,t)}),e0("[%s][resolve_aborted_tools] All aborted tool messages created",n),l.lastModified=new Date().toISOString(),l.status="done",i.push({finalState:l,reason:"user_aborted",reasonDetail:"User aborted operation with pending tool calls",type:"done"}),{events:i,newState:l}},finish:async(e,t)=>{let{reason:s,reasonDetail:a}=e,o=`${t.sessionId}:${t.stepCount}`;e0(`[${o}] Finishing execution: (%s)`,s);let r=structuredClone(t);return r.lastModified=new Date().toISOString(),r.status="done",{events:[{finalState:r,reason:s,reasonDetail:a,type:"done"}],newState:r}}}),getOperation:e=>{let s=t().operations[e];if(!s)throw Error(`Operation not found: ${e}`);return{abortController:s.abortController,context:s.context}},operationId:y}),{state:b,context:_}=t().internal_createAgentState({messages:v,parentMessageId:e.parentMessageId,sessionId:m,topicId:h,threadId:e.threadId,initialState:e.initialState,initialContext:e.initialContext}),A=b,x=_;e6("[internal_execAgentRuntime] Agent runtime loop start, initial phase: %s",x.phase);let k=0;for(;"done"!==A.status&&"error"!==A.status;){let e=t().operations[y];if(e?.status==="cancelled"){e6("[internal_execAgentRuntime] Operation cancelled, marking state as interrupted"),A={...A,status:"interrupted"},A=(await C.step(A,x)).newState,e6("[internal_execAgentRuntime] Operation cancelled, stopping loop");break}e6("[internal_execAgentRuntime][step-%d]: phase=%s, status=%s",++k,x.phase,A.status);let s=await C.step(A,x);for(let e of(e6("[internal_execAgentRuntime] Step %d completed, events: %d, newStatus=%s",k,s.events.length,s.newState.status),s.events))switch(e.type){case"done":e6("[internal_execAgentRuntime] Received done event");break;case"error":{e6("[internal_execAgentRuntime] Received error event: %o",e.error);let s=(t().messagesMap[f]||[]).findLast(e=>"assistant"===e.role);s&&await j.T.updateMessageError(s.id,e.error,{sessionId:m,topicId:h});let a=t().messagesMap[f]||[];t().replaceMessages(a,{sessionId:m,topicId:h})}}A=s.newState;let a=t().operations[y];if(a?.status==="cancelled"){e6("[internal_execAgentRuntime] Operation cancelled after step %d, marking state as interrupted",k),A={...A,status:"interrupted"};let e=s.nextContext||x;A=(await C.step(A,e)).newState,e6("[internal_execAgentRuntime] Operation cancelled, stopping loop");break}if(!s.nextContext){e6("[internal_execAgentRuntime] No next context, stopping loop");break}x=s.nextContext}if(e6("[internal_execAgentRuntime] Agent runtime loop finished, final status: %s, total steps: %d",A.status,k),e.ragMetadata){let s=(t().messagesMap[f]||[]).findLast(e=>"assistant"===e.role);s&&(await t().optimisticUpdateMessageRAG(s.id,e.ragMetadata,{operationId:y}),e6("[internal_execAgentRuntime] RAG metadata updated for assistant message"))}if("done"===A.status?(t().completeOperation(y),e6("[internal_execAgentRuntime] Operation completed successfully")):"error"===A.status&&(t().failOperation(y,{type:"runtime_error",message:"Agent runtime execution failed"}),e6("[internal_execAgentRuntime] Operation failed")),e6("[internal_execAgentRuntime] completed"),eF.xl)try{let e=`${u}_${g??null}`,a=(t().messagesMap[e]||[]).findLast(e=>"assistant"===e.role);if(a?.content&&!a?.tools){let{desktopNotificationService:e}=await s.e(46784).then(s.bind(s,46784));await e.showNotification({body:a.content,title:(0,eb.t)("notification.finishChatGeneration",{ns:"electron"})})}}catch(e){console.error("Desktop notification error:",e)}let L=eH.c.historyCount(I);if(eH.c.enableHistoryCount(I)&&T.enableCompressHistory&&v.length>L){let e=v.slice(0,-L+1);await t().internal_summaryHistory(e)}}}))(...e),...((e,t)=>({internal_toggleSearchWorkflow:(e,s)=>t().internal_toggleLoadingArrays("searchWorkflowLoadingIds",e,s),internal_toggleToolCallingStreaming:(s,a)=>{let o=t().toolCallingStreamIds,r=(0,u.jM)(o,e=>{a?e[s]=a:delete e[s]});Z()(o,r)||e({toolCallingStreamIds:r},!1,`toggleToolCallingStreaming/${a?"start":"end"}`)}}))(...e)}))(...e),...((e,t)=>{let s=e=>{let{groupMaps:s}=t(),a=s[e];return(0,ei.h)(ts.DM,a?.config||{})};return{sendGroupMessage:async({groupId:a,message:o,files:r,onlyAddUserMessage:i,targetMemberId:n})=>{let{optimisticCreateMessage:l,internal_triggerSupervisorDecisionDebounced:d,internal_setActiveGroup:c,activeTopicId:u}=t();if(o.trim()||r&&0!==r.length){c(a),e({isCreatingMessage:!0},!1,tr("creatingGroupMessage/start"));try{let c={content:o,files:r?.map(e=>e.id),role:"user",groupId:a,sessionId:ec.B.getState().activeId,topicId:u,targetId:n},p=await l(c);if(i)return void e({isCreatingMessage:!1},!1,tr("creatingGroupMessage/onlyUser"));if(!p)return;if(p.id){let e=s(a);if(e?.enableSupervisor)d(a);else{let e=eu.z.currentGroupAgents(ec.B.getState()),s=e.map(e=>({id:e.id,title:e.title??e.id})),r=((e,t)=>{let s,a=/<mention\s+[^>]*id="([^"]+)"[^>]*\/>/g,o=new Set;for(;null!==(s=a.exec(e));){let e=s[1];if(e){if("ALL_MEMBERS"===e){t?.length&&t.forEach(e=>{e.id&&o.add(e.id)});continue}o.add(e)}}return[...o]})(o,s),i=new Set(r);if(n&&e?.some(e=>e.id===n)&&i.add(n),i.size>0){let s=[...i].filter(t=>e?.some(e=>e.id===t));if(s.length>0){console.log("Supervisor disabled, triggering direct mentions:",s);let{internal_executeAgentResponses:e}=t(),o=s.map(e=>({id:e,target:n&&e===n?"user":void 0}));await e(a,o)}else console.log("Supervisor disabled, mentioned agents not found in group")}else n?console.log("Supervisor disabled and DM target not found in group, no agent responses triggered"):console.log("Supervisor disabled and no mentions found, no agent responses triggered")}}}catch(e){console.error("Failed to send group message:",e)}finally{e({isCreatingMessage:!1},!1,tr("creatingGroupMessage/end"))}}},internal_triggerSupervisorDecision:async(a,o,r=!1)=>{let{messagesMap:i,internal_toggleSupervisorLoading:n,optimisticCreateMessage:l,supervisorTodos:d}=t(),c=void 0===o?t().activeTopicId:o,p=s(a),g=async e=>{if(!a)return;let t=ec.B.getState().activeId||a;if(!t)return;let s={content:JSON.stringify({type:"supervisor_todo",todos:e||[],timestamp:Date.now()}),model:p.orchestratorModel,provider:p.orchestratorProvider,groupId:a,role:"supervisor",sessionId:t,topicId:c??void 0};console.log("Creating supervisor todo message:",s),await l(s)},m=i[(0,er.T)(a,c)]||[],h=eu.z.currentGroupAgents(ec.B.getState());if(0===m.length)return;if(!p?.enableSupervisor)return void console.log("Supervisor is disabled for this group, skipping supervisor decision");if(((e,t,s=!1)=>{if(0===e.length)return!0;let a=e.at(-1);if(!a||"assistant"===a.role&&a.tools&&a.tools.length>0||"tool"===a.role)return!0;if(!s&&t&&t>0){let s=(e=>{let t=0;for(let s=e.length-1;s>=0;s--){let a=e[s];if("user"===a.role)break;"assistant"===a.role&&t++}return t})(e);if(s>=t)return console.log(`Avoiding automatic supervisor decision: ${s} consecutive assistant messages exceed limit of ${t}`),!0}return!1})(m,p?.maxResponseInRow,r)){let e=r?"waiting for tool calling sequence to complete":"waiting for tool calling sequence to complete or max responses exceeded";console.log(`Skipping supervisor decision - ${e}`);return}let f=new AbortController;e((0,u.jM)(e=>{e.supervisorDecisionAbortControllers[a]=f}),!1,tr(`setSupervisorAbortController/${a}`));let y=(0,H.c)(),v=ta.f.nickName(y)||"User";try{let e=(0,er.T)(a,c),s={allowDM:p.allowDM,availableAgents:h,groupId:a,messages:m,model:p.orchestratorModel,provider:p.orchestratorProvider,scene:p.scene,userName:v,systemPrompt:p.systemPrompt,abortController:f,todoList:d?.[e]||[]};n(!0,a);let{decisions:o,todos:r,todoUpdated:i}=await ti.makeDecision(s);n(!1,a),t().internal_updateSupervisorTodos(a,c,r),i&&await g(r),console.log("Supervisor decisions:",o),o.length>0&&await t().internal_executeAgentResponses(a,o)}catch(e){n(!1,a),e instanceof Error&&"AbortError"===e.name||e instanceof Error&&e.message.includes("The operation was aborted")?console.log("Supervisor decision was aborted for group:",a):(console.error("Supervisor decision failed:",e),await t().internal_createSupervisorErrorMessage(a,"Supervisor Decision Failed, Please check your configuration"))}finally{e((0,u.jM)(e=>{delete e.supervisorDecisionAbortControllers[a]}),!1,tr(`cleanupSupervisorAbortController/${a}`))}},internal_executeAgentResponses:async(e,a)=>{console.log("DEBUG: Executing agent responses with decisions:",a);let{internal_processAgentMessage:o,internal_triggerSupervisorDecisionDebounced:r}=t(),i=s(e),n=eu.z.currentGroupAgents(ec.B.getState()),l=i?.responseOrder==="sequential"?[...a].sort((e,t)=>{let s=n?.find(t=>t.id===e.id),a=n?.find(e=>e.id===t.id);return(s?.order??0)-(a?.order??0)}):a;try{if(i?.responseOrder==="sequential")for(let[t,s]of l.entries())t>0&&await new Promise(e=>{setTimeout(e,1500)}),await o(e,s.id,s.target,s.instruction);else{let t=l.map(t=>o(e,t.id,t.target,t.instruction));await Promise.all(t)}l.length>0&&r(e)}catch(s){console.error("Failed to execute agent responses:",s),await t().internal_createSupervisorErrorMessage(e,s instanceof Error?s:Error(String(s)),"Agent Response Execution Failed")}},internal_processAgentMessage:async(e,s,a,o)=>{console.log("DEBUG: internal_processAgentMessage called with:",{groupId:e,agentId:s,targetId:a,instruction:o});let{messagesMap:r,optimisticCreateMessage:i,internal_fetchAIChatMessage:n,refreshMessages:l,activeTopicId:d,internal_dispatchMessage:c}=t();try{let t=r[(0,er.T)(e,d)]||[];if(0===t.length)return;let c=(0,E.JN)(t,s),u=eu.z.currentGroupAgents(ec.B.getState()),p=u?.find(e=>e.id===s);if(!p)return void console.error(`Agent ${s} not found in group members`);let g=p.provider||void 0,m=p.model||void 0;if(console.log("DEBUG: Group chat agent data:",p),!g||!m)return void console.error(`No provider or model configured for agent ${s}`);let h=(0,H.c)(),f=ta.f.nickName(h)||"User",y=[{id:"user",title:f},...(u||[]).map(e=>({id:e.id||"",title:e.title||""}))],v=p.systemRole||"",I=(0,E.P4)({groupMembers:y,baseSystemRole:v,agentId:s,messages:c,targetId:a,instruction:o}),M={role:"assistant",model:m,groupId:e,content:eF.m5,provider:g,agentId:s,sessionId:ec.B.getState().activeId,topicId:d,targetId:a};console.log("DEBUG: Creating agent message with:",M);let T=await i(M);if(!T)return;let w=T.id,S={id:"group-system",role:"system",content:I,createdAt:Date.now(),updatedAt:Date.now(),meta:{}},C=c.map(e=>{let t=y.find(t=>"user"===e.role?"user"===t.id:t.id===e.agentId),s=t?.title||("user"===e.role?f:"Unknown"),a="user"===e.role?"user":e.agentId||"unknown";return"user"===e.role?{...e,content:e.content}:{...e,content:`<author_name_do_not_include_in_your_response name="${s}" id="${a}" />${e.content}`}}),b=[S,...C];w&&await n({messageId:w,messages:b,model:m,provider:g,agentConfig:p,traceId:`group-${e}-agent-${s}`}),await l()}catch(o){console.error(`Failed to process message for agent ${s}:`,o),await t().internal_createSupervisorErrorMessage(e,o instanceof Error?o:Error(String(o)),`Agent ${s} Response Failed`);let a=(t().messagesMap[(0,er.T)(e,d)]||[]).find(e=>"assistant"===e.role&&e.agentId===s&&e.content===eF.m5);a&&c({id:a.id,type:"updateMessage",value:{content:`Error: Failed to generate response. ${o instanceof Error?o.message:"Unknown error"}`,error:{type:L.T_.CreateMessageError,message:o instanceof Error?o.message:"Unknown error"}}})}},internal_setActiveGroup:()=>{t().internal_updateActiveSessionType("group")},internal_toggleSupervisorLoading:(s,a)=>{e({supervisorDecisionLoading:a?eg(t().supervisorDecisionLoading,a,s):s?t().supervisorDecisionLoading:[]},!1,tr(`toggleSupervisorLoading/${s?"start":"end"}`))},internal_triggerSupervisorDecisionDebounced:a=>{let{internal_cancelSupervisorDecision:o,internal_triggerSupervisorDecision:r}=t();o(a);let i=s(a),n=i?.responseSpeed,l=(e=>{switch(e){case"fast":return 1500;case"medium":default:return 5e3;case"slow":return 8e3}})(n);console.log(`Using debounce threshold: ${l}ms for responseSpeed: ${n}`);let d=t().activeTopicId,c=setTimeout(async()=>{console.log(`Debounced supervisor decision triggered for group ${a}`),e((0,u.jM)(e=>{delete e.supervisorDebounceTimers[a]}),!1,tr(`cleanupSupervisorTimer/${a}`));try{await r(a,d,!1)}catch(e){console.error(`Failed to execute supervisor decision for group ${a}:`,e)}},l);e((0,u.jM)(e=>{e.supervisorDebounceTimers[a]=c}),!1,tr(`setSupervisorTimer/${a}`))},internal_cancelSupervisorDecision:s=>{let{supervisorDebounceTimers:a,supervisorDecisionAbortControllers:o,internal_toggleSupervisorLoading:r}=t(),i=a[s],n=o[s];i&&(clearTimeout(i),console.log(`Cancelled pending supervisor decision timer for group ${s}`),e((0,u.jM)(e=>{delete e.supervisorDebounceTimers[s]}),!1,tr(`cancelSupervisorTimer/${s}`))),n&&(n.abort("User cancelled supervisor decision"),console.log(`Aborted ongoing supervisor decision request for group ${s}`),e((0,u.jM)(e=>{delete e.supervisorDecisionAbortControllers[s]}),!1,tr(`cancelSupervisorAbortController/${s}`))),r(!1,s),console.log(`Stopped supervisor loading state for group ${s}`)},internal_cancelAllSupervisorDecisions:()=>{let{supervisorDebounceTimers:s,supervisorDecisionAbortControllers:a}=t(),o=Object.keys(s),r=Object.keys(a);(o.length>0||r.length>0)&&(console.log("Cancelling all pending supervisor decisions for session change/cleanup"),o.forEach(e=>{let t=s[e];t&&clearTimeout(t)}),r.forEach(e=>{let t=a[e];t&&t.abort("Session cleanup")}),e({supervisorDebounceTimers:{},supervisorDecisionAbortControllers:{}},!1,tr("cancelAllSupervisorDecisions")))},internal_updateSupervisorTodos:(t,s,a)=>{if(!t)return;let o=(0,er.T)(t,s);e((0,u.jM)(e=>{e.supervisorTodos[o]=a}),!1,tr(`internal_updateSupervisorTodos/${t}`))},internal_createSupervisorErrorMessage:async(e,a)=>{let{optimisticCreateTmpMessage:o,activeTopicId:r}=t();try{let t=a instanceof Error?a.message:a,i=s(e),n={role:"supervisor",model:i.orchestratorModel,provider:i.orchestratorProvider,groupId:e,sessionId:ec.B.getState().activeId||e,topicId:r,error:{type:L.T_.SupervisorDecisionFailed,message:t},content:eF.m5};o(n)}catch(e){console.error("Failed to create supervisor error message:",e)}}}})(...e),...((e,t)=>({openNewTopicOrSaveTopic:async()=>{let{switchTopic:e,saveToTopic:s,refreshMessages:a,activeTopicId:o}=t();o?e():(await s(),a())},createTopic:async(s,a)=>{let{activeId:o,activeSessionType:r,internal_createTopic:i}=t(),n=eo._1.activeDisplayMessages(t());e({creatingTopic:!0},!1,eR("creatingTopic/start"));let l=await i({title:(0,eb.t)("defaultTitle",{ns:"topic"}),messages:n.map(e=>e.id),..."group"===r?{groupId:a||o}:{sessionId:s||o}});return e({creatingTopic:!1},!1,eR("creatingTopic/end")),l},saveToTopic:async(s,a)=>{let o=eo._1.activeDisplayMessages(t());if(0===o.length)return;let{activeId:r,activeSessionType:i,summaryTopicTitle:n,internal_createTopic:l}=t(),d=await l({title:(0,eb.t)("defaultTitle",{ns:"topic"}),messages:o.map(e=>e.id),..."group"===i?{groupId:a||r}:{sessionId:s||r}});t().internal_updateTopicLoading(d,!0),n(d,o);try{let{activeId:s,activeSessionType:o}=t(),r="group"===o;if(void 0===o){let e=ec.B.getState();r=eu.z.isCurrentSessionGroupSession(e)}r&&e((0,u.jM)(e=>{e.supervisorTodos[(0,er.T)(a||s,null)]=[]}),!1,eR("resetSupervisorTodosOnSaveToTopic",{groupId:a||s}))}catch(e){}return d},duplicateTopic:async e=>{let{refreshTopic:s,switchTopic:a}=t(),o=eP.e.getTopicById(e)(t());if(!o)return;let r=(0,eb.t)("duplicateTitle",{ns:"chat",title:o?.title});eE.iU.loading({content:(0,eb.t)("duplicateLoading",{ns:"topic"}),key:"duplicateTopic",duration:0});let i=await ed.p.cloneTopic(e,r);await s(),eE.iU.destroy("duplicateTopic"),eE.iU.success((0,eb.t)("duplicateSuccess",{ns:"topic"})),await a(i)},summaryTopicTitle:async(e,s)=>{let{internal_updateTopicTitleInSummary:a,internal_updateTopicLoading:o}=t(),r=eP.e.getTopicById(e)(t());if(!r)return;a(e,eL.VH);let i="",n=q.v.topic(H.k.getState());await N.O.fetchPresetTaskResult({onError:()=>{a(e,r.title)},onFinish:async s=>{await t().internal_updateTopic(e,{title:s})},onLoadingChange:t=>{o(e,t)},onMessageHandle:t=>{"text"===t.type&&(i+=t.text),a(e,i)},params:(0,ei.h)(n,(0,E.y_)(s,eO.J.getCurrentLanguage())),trace:t().getCurrentTracePayload({traceName:L.Fs.SummaryTopicTitle,topicId:e})})},favoriteTopic:async(e,s)=>{await t().internal_updateTopic(e,{favorite:s})},updateTopicTitle:async(e,s)=>{await t().internal_updateTopic(e,{title:s})},autoRenameTopicTitle:async e=>{let{activeId:s,summaryTopicTitle:a,internal_updateTopicLoading:o}=t();o(e,!0);let r=await j.T.getMessages(s,e);await a(e,r),o(e,!1)},useFetchTopics:(s,a)=>(0,g.lA)(s?[eD,a]:null,async([,e])=>ed.p.getTopics({containerId:e}),{onSuccess:s=>{if(!a)return;let o={...t().topicMaps,[a]:s};t().topicsInit&&Z()(o,t().topicMaps)||e({topicMaps:o,topicsInit:!0},!1,eR("useFetchTopics(success)",{containerId:a}))}}),useSearchTopics:(t,s,a)=>(0,ek.Ay)(["SWR_USE_SEARCH_TOPIC",t,s,a],([,e,t,s])=>ed.p.searchTopics(e,t,s),{onSuccess:s=>{e({searchTopics:s,isSearchingTopic:!1},!1,eR("useSearchTopics(success)",{keywords:t}))}}),switchTopic:async(s,a)=>{e({activeTopicId:s||null,activeThreadId:void 0},!1,eR("toggleTopic"));try{let{activeId:a,activeSessionType:o,internal_cancelSupervisorDecision:r}=t(),i="group"===o;if(void 0===o){let e=ec.B.getState();i=eu.z.isCurrentSessionGroupSession(e)}if(i){let t=(0,er.T)(a,s??null);e((0,u.jM)(e=>{e.supervisorTodos[t]=[]}),!1,eR("resetSupervisorTodosOnTopicSwitch",{groupId:a,topicId:s??null})),r?.(a)}}catch{}a||await t().refreshMessages()},removeSessionTopics:async()=>{let{switchTopic:e,activeId:s,refreshTopic:a}=t();await ed.p.removeTopics(s),await a(),e()},removeGroupTopics:async e=>{let{switchTopic:s,refreshTopic:a}=t(),o=(t().topicMaps[e]||[]).map(e=>e.id);o.length>0&&await ed.p.batchRemoveTopics(o),await a(),s()},removeAllTopics:async()=>{let{refreshTopic:e}=t();await ed.p.removeAllTopic(),await e()},removeTopic:async e=>{let{activeId:s,activeTopicId:a,switchTopic:o,refreshTopic:r}=t();await j.T.removeMessagesByAssistant(s,e),await ed.p.removeTopic(e),await r(),a===e&&o()},removeUnstarredTopic:async()=>{let{refreshTopic:e,switchTopic:s}=t(),a=eP.e.currentUnFavTopics(t());await ed.p.batchRemoveTopics(a.map(e=>e.id)),await e(),s()},internal_updateTopicTitleInSummary:(e,s)=>{t().internal_dispatchTopic({type:"updateTopic",id:e,value:{title:s}},"updateTopicTitleInSummary")},refreshTopic:async()=>(0,eh.j)([eD,t().activeId]),internal_updateTopicLoading:(t,s)=>{e(e=>s?{topicLoadingIds:[...e.topicLoadingIds,t]}:{topicLoadingIds:e.topicLoadingIds.filter(e=>e!==t)},!1,eR("updateTopicLoading"))},internal_updateTopic:async(e,s)=>{t().internal_dispatchTopic({type:"updateTopic",id:e,value:s}),t().internal_updateTopicLoading(e,!0),await ed.p.updateTopic(e,s),await t().refreshTopic(),t().internal_updateTopicLoading(e,!1)},internal_createTopic:async e=>{let s=Date.now().toString();t().internal_dispatchTopic({type:"addTopic",value:{...e,id:s}},"internal_createTopic"),t().internal_updateTopicLoading(s,!0);let a=await ed.p.createTopic(e);return t().internal_updateTopicLoading(s,!1),t().internal_updateTopicLoading(a,!0),await t().refreshTopic(),t().internal_updateTopicLoading(a,!1),a},internal_dispatchTopic:(s,a)=>{let o=((e=[],t)=>{switch(t.type){case"addTopic":return(0,u.jM)(e,e=>(e.unshift({...t.value,createdAt:Date.now(),favorite:!1,id:t.value.id??Date.now().toString(),sessionId:t.value.sessionId?t.value.sessionId:void 0,updatedAt:Date.now()}),e.sort((e,t)=>Number(t.favorite)-Number(e.favorite))));case"updateTopic":return(0,u.jM)(e,e=>{let{value:s,id:a}=t,o=e.findIndex(e=>e.id===a);if(-1!==o){let t=e[o],a={...t,...s};Z()(t,a)||(e[o]={...a,updatedAt:new Date})}});case"updateTopics":return t.value;case"deleteTopic":return(0,u.jM)(e,e=>{let s=e.findIndex(e=>e.id===t.id);-1!==s&&e.splice(s,1)});default:return e}})(eP.e.currentTopics(t()),s),r={...t().topicMaps,[t().activeId]:o};Z()(r,t().topicMaps)||e({topicMaps:r},!1,a??eR(`dispatchTopic/${s.type}`))}}))(...e),...((e,t)=>({clearTranslate:async e=>{await t().updateMessageTranslate(e,!1)},getCurrentTracePayload:e=>({sessionId:t().activeId,topicId:t().activeTopicId,...e}),translateMessage:async(e,s)=>{let{updateMessageTranslate:a,internal_dispatchMessage:o}=t(),r=M.E1.getDbMessageById(e)(t());if(!r)return;let i=q.v.translation(H.k.getState());await a(e,{content:"",from:"",to:s});let{operationId:n}=t().startOperation({context:{messageId:e,sessionId:r.sessionId,topicId:r.topicId},label:"Translating message",type:"translate"});t().associateMessageWithOperation(e,n);try{let l="",d="";N.O.fetchPresetTaskResult({onFinish:async t=>{t&&$.vM.includes(t)&&(d=t),await a(e,{content:l,from:d,to:s})},params:(0,O.h1)(i,(0,E.vB)(r.content)),trace:t().getCurrentTracePayload({traceName:L.Fs.LanguageDetect})}),await N.O.fetchPresetTaskResult({onFinish:async o=>{await a(e,{content:o,from:d,to:s}),t().completeOperation(n)},onMessageHandle:t=>{"text"===t.type&&(l+=t.text,o({id:e,key:"translate",type:"updateMessageExtra",value:{content:l,from:d,to:s}},{operationId:n}))},params:(0,O.h1)(i,(0,E.o9)(r.content,s)),trace:t().getCurrentTracePayload({traceName:L.Fs.Translator})})}catch(e){throw t().failOperation(n,{message:e instanceof Error?e.message:String(e),type:"TranslateError"}),e}},updateMessageTranslate:async(e,s)=>{await j.T.updateMessageTranslate(e,s),await t().refreshMessages()}}))(...e),...((e,t)=>({clearTTS:async e=>{await t().updateMessageTTS(e,!1)},ttsMessage:async(e,s={})=>{await t().updateMessageTTS(e,s)},updateMessageTTS:async(e,s)=>{await j.T.updateMessageTTS(e,s),await t().refreshMessages()}}))(...e),...((...e)=>({...((e,t)=>({crawlMultiPages:async(e,s,a=!0)=>{let o=t().messageOperationMap[e],{operationId:r,abortController:i}=t().startOperation({context:{messageId:e},metadata:{startTime:Date.now(),urls:s.urls},parentOperationId:o,type:"builtinToolSearch"});B("[crawlMultiPages] messageId=%s, parentOpId=%s, crawlOpId=%s, urls=%o, aborted=%s",e,o,r,s.urls,i.signal.aborted);let n={operationId:r};try{let{content:o,success:i,error:l,state:d}=await U.crawlMultiPages(s);return t().completeOperation(r),await t().optimisticUpdateMessageContent(e,o,void 0,n),i?await t().optimisticUpdatePluginState(e,d,n):await t().optimisticUpdatePluginError(e,l,n),a}catch(o){if(B("[crawlMultiPages] Error: messageId=%s, error=%s",e,o.message),o.message.includes("The user aborted a request.")||"AbortError"===o.name){B("[crawlMultiPages] Request aborted: messageId=%s",e),t().failOperation(r,{message:"User cancelled the request",type:"UserAborted"});return}t().failOperation(r,{message:o.message,type:"PluginServerError"}),console.error(o);let s=[{errorMessage:o.message,errorType:o.name}],a=(0,E.Sy)(s);await t().optimisticUpdateMessageContent(e,a,void 0,n)}},crawlSinglePage:async(e,s,a)=>{let{crawlMultiPages:o}=t();return await o(e,{urls:[s.url]},a)},saveSearchResult:async e=>{let s=M.E1.getDbMessageById(e)(t());if(!s||!s.plugin)return;let{optimisticAddToolToAssistantMessage:a,optimisticCreateMessage:o,openToolUI:r}=t(),i=t().messageOperationMap[e],n=i?{operationId:i}:void 0,l=`tool_call_${(0,O.Ak)()}`,d={content:s.content,id:void 0,parentId:s.parentId,plugin:s.plugin,pluginState:s.pluginState,role:"tool",sessionId:s.sessionId??t().activeId,tool_call_id:l,topicId:void 0!==s.topicId?s.topicId:t().activeTopicId},c=async()=>{s.parentId&&s.plugin&&await a(s.parentId,{id:l,...s.plugin},n)},[u]=await Promise.all([o(d,n),c()]);u&&r(u.id,s.plugin.identifier)},search:async(e,s,a=!0)=>{let o=t().messageOperationMap[e],{operationId:r,abortController:i}=t().startOperation({context:{messageId:e},metadata:{query:s.query,startTime:Date.now()},parentOperationId:o,type:"builtinToolSearch"});B("[search] messageId=%s, parentOpId=%s, searchOpId=%s, aborted=%s",e,o,r,i.signal.aborted);let n={operationId:r};try{let{content:o,success:l,error:d,state:c}=await U.search(s,{signal:i.signal});return t().completeOperation(r),l?await t().optimisticUpdatePluginState(e,c,n):d.message===L.zT?await t().optimisticUpdateMessagePluginError(e,{body:{provider:"searxng"},message:"SearXNG is not configured",type:"PluginSettingsInvalid"},n):await t().optimisticUpdateMessagePluginError(e,{body:d,message:d.message,type:"PluginServerError"},n),await t().optimisticUpdateMessageContent(e,o,void 0,n),a}catch(s){if(B("[search] Error: messageId=%s, error=%s",e,s.message),s.message.includes("The user aborted a request.")||"AbortError"===s.name){B("[search] Request aborted: messageId=%s",e),t().failOperation(r,{message:"User cancelled the request",type:"UserAborted"});return}t().failOperation(r,{message:s.message,type:"PluginServerError"}),await t().optimisticUpdateMessagePluginError(e,{body:s,message:s.message,type:"PluginServerError"},n)}},togglePageContent:t=>{e({activePageContentUrl:t})},triggerSearchAgain:async(e,s,a)=>{await t().optimisticUpdatePluginArguments(e,s),await t().search(e,s,a?.aiSummary)}}))(...e),...((e,t)=>({editLocalFile:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.editLocalFile(s)),writeLocalFile:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.writeLocalFile(s)),moveLocalFiles:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.moveLocalFiles(s)),renameLocalFile:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.renameLocalFile(s)),grepContent:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.grepContent(s)),globLocalFiles:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.globLocalFiles(s)),searchLocalFiles:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.searchLocalFiles(s)),listLocalFiles:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.listLocalFiles(s)),reSearchLocalFiles:async(e,s)=>(await t().optimisticUpdatePluginArguments(e,s),t().searchLocalFiles(e,s)),readLocalFile:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.readLocalFile(s)),readLocalFiles:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.readLocalFiles(s)),runCommand:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.runCommand(s)),killCommand:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.killCommand(s)),getCommandOutput:async(e,s)=>t().internal_triggerLocalFileToolCalling(e,async()=>await k.getCommandOutput(s)),internal_triggerLocalFileToolCalling:async(e,s)=>{let a=t().messageOperationMap[e],{operationId:o,abortController:r}=t().startOperation({type:"builtinToolLocalSystem",context:{messageId:e},parentOperationId:a,metadata:{startTime:Date.now()}});x("[localSystem] messageId=%s, parentOpId=%s, localSystemOpId=%s, aborted=%s",e,a,o,r.signal.aborted);let i={operationId:o};try{let{state:a,content:r,success:n,error:l}=await s();return t().completeOperation(o),n?a&&await t().optimisticUpdatePluginState(e,a,i):await t().optimisticUpdateMessagePluginError(e,{body:l,message:l?.message||"Operation failed",type:"PluginServerError"},i),await t().optimisticUpdateMessageContent(e,r,void 0,i),!0}catch(s){if(x("[localSystem] Error: messageId=%s, error=%s",e,s.message),s.message.includes("The user aborted a request.")||"AbortError"===s.name)return x("[localSystem] Request aborted: messageId=%s",e),t().failOperation(o,{message:"User cancelled the request",type:"UserAborted"}),!1;return t().failOperation(o,{message:s.message,type:"PluginServerError"}),await t().optimisticUpdateMessagePluginError(e,{body:s,message:s.message,type:"PluginServerError"},i),!1}}}))(...e),...((e,t)=>({python:async(e,s)=>{let a=t().messageOperationMap[e],{operationId:o,abortController:r}=t().startOperation({context:{messageId:e},metadata:{startTime:Date.now()},parentOperationId:a,type:"builtinToolInterpreter"});b("[python] messageId=%s, parentOpId=%s, interpreterOpId=%s, aborted=%s",e,a,o,r.signal.aborted);let i={operationId:o};try{let a=[];for(let e of M.E1.dbUserMessages(t())){for(let t of e.fileList??[]){let e=await fetch(t.url).then(e=>e.blob());a.push(new File([e],t.name))}for(let t of e.imageList??[]){let e=await fetch(t.url).then(e=>e.blob());a.push(new File([e],t.alt))}for(let s of e.tools??[])if(s.identifier===w.v){let e=M.E1.getDbMessageByToolCallId(s.id)(t());if(e?.content)for(let t of JSON.parse(e.content).files??[]){let e=await m.Y.getFile(t.fileId),s=await fetch(e.url).then(e=>e.blob());a.push(new File([s],t.filename))}}}let r=await I.runPython(s.code,s.packages,a);return t().completeOperation(o),r?.files?(await t().optimisticUpdateMessageContent(e,JSON.stringify(r),void 0,i),await t().uploadInterpreterFiles(e,r.files)):await t().optimisticUpdateMessageContent(e,JSON.stringify(r),void 0,i),!0}catch(s){if(b("[python] Error: messageId=%s, error=%s",e,s.message),s.message.includes("The user aborted a request.")||"AbortError"===s.name){b("[python] Request aborted: messageId=%s",e),t().failOperation(o,{message:"User cancelled the request",type:"UserAborted"});return}t().failOperation(o,{message:s.message,type:"PluginServerError"}),await t().optimisticUpdatePluginState(e,{error:s},i);return}},updateInterpreterFileItem:async(e,s)=>{let a=M.E1.getDbMessageById(e)(t());if(!a)return;let o=JSON.parse(a.content);if(!o.files)return;let r=(0,u.jM)(o,s);await t().optimisticUpdateMessageContent(e,JSON.stringify(r))},uploadInterpreterFiles:async(e,s)=>{let{updateInterpreterFileItem:a}=t();s&&await (0,p.Ay)(s,async(t,s)=>{if(t.data)try{let o=await T.x.getState().uploadWithProgress({file:t.data,skipCheckFileType:!0});o?.id&&await a(e,e=>{e.files?.[s]&&(e.files[s].fileId=o.id,e.files[s].previewUrl=void 0,e.files[s].data=void 0)})}catch(e){console.error("Failed to upload CodeInterpreter file:",e)}})},useFetchInterpreterFileItem:t=>(0,g.lA)(t?["FetchCodeInterpreterFileItem",t]:null,async()=>{if(!t)return null;let s=await m.Y.getFile(t);return e((0,u.jM)(e=>{e.codeInterpreterFileMap||(e.codeInterpreterFileMap={}),e.codeInterpreterFileMap[t]||(e.codeInterpreterFileMap[t]=s)}),!1,C("useFetchInterpreterFileItem")),s})}))(...e)}))(...e),...((...e)=>({...((e,t)=>({fillPluginMessageContent:async(e,s,a)=>{let{triggerAIMessage:o,optimisticUpdateMessageContent:r}=t();await r(e,s),a&&await o({parentId:e})},reInvokeToolMessage:async e=>{let s=eo._1.getDisplayMessageById(e)(t());if(!s||"tool"!==s.role||!s.plugin)return;let a=t().messageOperationMap[e];s.pluginError&&t().optimisticUpdateMessagePluginError(e,null,a?{operationId:a}:void 0);let o={...s.plugin,id:s.tool_call_id};await t().internal_invokeDifferentTypePlugin(e,o)},summaryPluginContent:async e=>{let s=eo._1.getDisplayMessageById(e)(t());s&&"tool"===s.role&&await t().internal_execAgentRuntime({messages:[{role:"assistant",content:"作为一名总结专家，请结合以上系统提示词，将以下内容进行总结："},{...s,content:s.content,role:"assistant",name:void 0,tool_call_id:void 0}],parentMessageId:s.id,parentMessageType:"assistant"})},internal_invokeDifferentTypePlugin:async(e,s)=>{switch(s.type){case"standalone":return await t().invokeStandaloneTypePlugin(e,s);case"markdown":return await t().invokeMarkdownTypePlugin(e,s);case"builtin":return await t().invokeBuiltinTool(e,s);case"mcp":return await t().invokeMCPTypePlugin(e,s);default:return await t().invokeDefaultTypePlugin(e,s)}}}))(...e),...((e,t)=>({optimisticUpdatePluginState:async(e,s,a)=>{let{replaceMessages:o,internal_getSessionContext:r}=t();t().internal_dispatchMessage({id:e,type:"updateMessage",value:{pluginState:s}},a);let{sessionId:i,topicId:n}=r(a),l=await j.T.updateMessagePluginState(e,s,{sessionId:i,topicId:n});l?.success&&l.messages&&o(l.messages,{sessionId:i,topicId:n})},optimisticUpdatePluginArguments:async(e,s,a=!1)=>{let{refreshMessages:o}=t(),r=eo._1.getDisplayMessageById(e)(t());if(!r||!r?.tool_call_id)return;let i=eo._1.getDisplayMessageById(r?.parentId||"")(t()),n=r?.plugin?.arguments,l=(0,eS.N)(n||""),d=a?s:(0,ei.h)(l||{},s);if(Z()(l,d))return;t().internal_dispatchMessage({id:e,type:"updateMessagePlugin",value:{arguments:JSON.stringify(d)}}),i&&(t().internal_dispatchMessage({id:i.id,type:"updateMessageTools",tool_call_id:r?.tool_call_id,value:{arguments:JSON.stringify(d)}}),i=eo._1.getDisplayMessageById(i?.id)(t()));let c=async()=>{i&&await j.T.updateMessage(i.id,{tools:i?.tools})};await Promise.all([j.T.updateMessagePluginArguments(e,d),c()]),await o()},optimisticUpdatePlugin:async(e,s,a)=>{let{replaceMessages:o,internal_getSessionContext:r}=t();t().internal_dispatchMessage({id:e,type:"updateMessagePlugin",value:s},a);let{sessionId:i,topicId:n}=r(a),l=await j.T.updateMessagePlugin(e,s,{sessionId:i,topicId:n});l?.success&&l.messages&&o(l.messages,{sessionId:i,topicId:n})},optimisticAddToolToAssistantMessage:async(e,s,a)=>{let o=eo._1.getDisplayMessageById(e)(t());if(!o)return;let{internal_dispatchMessage:r,internal_refreshToUpdateMessageTools:i}=t();r({type:"addMessageTool",value:s,id:o.id}),await i(e,a)},optimisticRemoveToolFromAssistantMessage:async(e,s,a)=>{let o=eo._1.getDisplayMessageById(e)(t());if(!o||!s)return;let{internal_dispatchMessage:r,internal_refreshToUpdateMessageTools:i}=t();r({type:"deleteMessageTool",tool_call_id:s,id:o.id}),await i(e,a)},optimisticUpdatePluginError:async(e,s,a)=>{let{replaceMessages:o,internal_getSessionContext:r}=t();t().internal_dispatchMessage({id:e,type:"updateMessage",value:{error:s}},a);let{sessionId:i,topicId:n}=r(a),l=await j.T.updateMessage(e,{error:s},{sessionId:i,topicId:n});l?.success&&l.messages&&o(l.messages,{sessionId:i,topicId:n})},internal_refreshToUpdateMessageTools:async(e,a)=>{let{dbMessageSelectors:o}=await s.e(34907).then(s.bind(s,34907)),r=o.getDbMessageById(e)(t());if(!r||!r.tools)return;let{internal_toggleMessageLoading:i,replaceMessages:n,internal_getSessionContext:l}=t(),{sessionId:d,topicId:c}=l(a);i(!0,e);let u=await j.T.updateMessage(e,{tools:r.tools},{sessionId:d,topicId:c});i(!1,e),u?.success&&u.messages&&n(u.messages,{sessionId:d,topicId:c})}}))(...e),...((e,t)=>({invokeBuiltinTool:async(e,s)=>{let{[s.apiName]:a}=t();if(!a)return;let o=(0,eS.N)(s.arguments);if(o)return await a(e,o)},invokeDefaultTypePlugin:async(e,s)=>{let{internal_callPluginApi:a}=t(),o=await a(e,s);if(o)return o},invokeMarkdownTypePlugin:async(e,s)=>{let{internal_callPluginApi:a}=t();await a(e,s)},invokeStandaloneTypePlugin:async(e,s)=>{let a=await eM.j.getState().validatePluginSettings(s.identifier);if(a&&!a.valid){let s=M.E1.getDbMessageById(e)(t()),o=await j.T.updateMessageError(e,{body:{error:a.errors,message:"[plugin] your settings is invalid with plugin manifest setting schema"},message:(0,eb.t)("response.PluginSettingsInvalid",{ns:"error"}),type:eC.mq.PluginSettingsInvalid},{sessionId:s?.sessionId,topicId:s?.topicId});o?.success&&o.messages&&t().replaceMessages(o.messages,{sessionId:s?.sessionId,topicId:s?.topicId});return}},invokeMCPTypePlugin:async(e,s)=>{let a,{optimisticUpdateMessageContent:o,internal_constructToolsCallingContext:r,optimisticUpdatePluginState:i,optimisticUpdateMessagePluginError:n}=t(),l=M.E1.getDbMessageById(e)(t()),d=t().messageOperationMap[e],c=d?t().operations[d]:void 0,u=c?.abortController;eA("[invokeMCPTypePlugin] messageId=%s, tool=%s, operationId=%s, aborted=%s",e,s.apiName,d,u?.signal.aborted);try{let t=r(e),o=await e_.S.invokeMcpToolCall(s,{signal:u?.signal,topicId:t?.topicId});o&&(a=o)}catch(a){if(console.log(a),a.message.includes("The user aborted a request."))eA("[invokeMCPTypePlugin] Request aborted: messageId=%s, tool=%s",e,s.apiName);else{let s=await j.T.updateMessageError(e,a,{sessionId:l?.sessionId,topicId:l?.topicId});s?.success&&s.messages&&t().replaceMessages(s.messages,{sessionId:l?.sessionId,topicId:l?.topicId})}}if(!a)return;let p=d?{operationId:d}:void 0;return await Promise.all([o(e,a.content,void 0,p),(async()=>{a.success?await i(e,a.state,p):await n(e,a.error,p)})()]),a.content},internal_callPluginApi:async(e,s)=>{let a,{optimisticUpdateMessageContent:o}=t(),r=M.E1.getDbMessageById(e)(t()),i=t().messageOperationMap[e],n=i?t().operations[i]:void 0,l=n?.abortController;eA("[internal_callPluginApi] messageId=%s, plugin=%s, operationId=%s, aborted=%s",e,s.identifier,i,l?.signal.aborted);try{let t=await N.O.runPluginApi(s,{signal:l?.signal,trace:{observationId:r?.observationId,traceId:r?.traceId}});a=t.text,t.traceId&&await j.T.updateMessage(e,{traceId:t.traceId})}catch(o){if(console.log(o),o.message.includes("The user aborted a request."))eA("[internal_callPluginApi] Request aborted: messageId=%s, plugin=%s",e,s.identifier);else{let s=await j.T.updateMessageError(e,o,{sessionId:r?.sessionId,topicId:r?.topicId});s?.success&&s.messages&&t().replaceMessages(s.messages,{sessionId:r?.sessionId,topicId:r?.topicId})}a=""}if(!a)return;let d=i?{operationId:i}:void 0;return await o(e,a,void 0,d),a}}))(...e),...((e,t)=>({createAssistantMessageByPlugin:async(e,s)=>{let a=M.E1.getDbMessageById(s)(t()),o={content:e,parentId:s,role:"assistant",sessionId:a?.sessionId??t().activeId,topicId:a?.topicId!==void 0?a.topicId:t().activeTopicId},r=await j.T.createMessage(o);t().replaceMessages(r.messages,{sessionId:o.sessionId,topicId:o.topicId})},triggerAIMessage:async({parentId:e,traceId:s,threadId:a,inPortalThread:o,inSearchWorkflow:r})=>{let{internal_execAgentRuntime:i}=t(),n=o?ex.Z.portalAIChatsWithHistoryConfig(t()):eo._1.mainAIChatsWithHistoryConfig(t());await i({messages:n,parentMessageId:e??n.at(-1).id,parentMessageType:"user",sessionId:t().activeId,topicId:t().activeTopicId,traceId:s,threadId:a,inPortalThread:o,inSearchWorkflow:r})}}))(...e),...((e,t)=>({internal_transformToolCalls:e=>{let t=new eI.UU,s=eM.j.getState(),a={};for(let e of eT.w.installedPlugins(s))e.manifest&&(a[e.identifier]=e.manifest);for(let e of ew.F)e.manifest&&(a[e.identifier]=e.manifest);return t.resolve(e,a)},internal_constructToolsCallingContext:e=>{let s=eo._1.getDisplayMessageById(e)(t());if(s)return{topicId:s.topicId}}}))(...e)}))(...e),...((e,t)=>({closeArtifact:()=>{t().togglePortal(!1),e({portalArtifact:void 0},!1,"closeArtifact")},closeFilePreview:()=>{e({portalFile:void 0},!1,"closeFilePreview")},closeMessageDetail:()=>{e({portalMessageDetail:void 0},!1,"openMessageDetail")},closeToolUI:()=>{e({portalToolMessage:void 0},!1,"closeToolUI")},openArtifact:s=>{t().togglePortal(!0),e({portalArtifact:s},!1,"openArtifact")},openFilePreview:s=>{t().togglePortal(!0),e({portalFile:s},!1,"openFilePreview")},openMessageDetail:s=>{t().togglePortal(!0),e({portalMessageDetail:s},!1,"openMessageDetail")},openToolUI:(s,a)=>{t().togglePortal(!0),e({portalToolMessage:{id:s,identifier:a}},!1,"openToolUI")},togglePortal:s=>{e({showPortal:void 0===s?!t().showPortal:s},!1,"toggleInspector")}}))(...e),...((e,t)=>({internal_getSessionContext:e=>{if(e?.operationId){let s=t().operations[e.operationId];if(!s)throw tl("[internal_getSessionContext] ERROR: Operation not found: %s",e.operationId),Error(`Operation not found: ${e.operationId}`);let a=s.context.sessionId,o=s.context.topicId;return tl("[internal_getSessionContext] get from operation %s: sessionId=%s, topicId=%s",e.operationId,a,o),{sessionId:a,topicId:o}}let s=t().activeId,a=t().activeTopicId;return tl("[internal_getSessionContext] use global state: sessionId=%s, topicId=%s",s,a),{sessionId:s,topicId:a}},startOperation:s=>{let{type:a,context:o,parentOperationId:r,label:i,description:n,metadata:l}=s,d=`op_${(0,O.Ak)()}`,c=o||{};if(r){let e=t().operations[r];e&&tl("[startOperation] inherit context from parent %s: %o",r,c={...e.context,...o})}tl("[startOperation] create operation %s (type=%s, context=%o)",d,a,c);let p=new AbortController,g=Date.now(),m={id:d,type:a,status:"running",context:c,abortController:p,metadata:{startTime:g,...l},parentOperationId:r,childOperationIds:[],label:i,description:n};return e((0,u.jM)(e=>{if(e.operations[d]=m,e.operationsByType[a]||(e.operationsByType[a]=[]),e.operationsByType[a].push(d),c.messageId&&(e.operationsByMessage[c.messageId]||(e.operationsByMessage[c.messageId]=[]),e.operationsByMessage[c.messageId].push(d),e.messageOperationMap[c.messageId]=d),c.sessionId){let t=(0,er.T)(c.sessionId,void 0!==c.topicId?c.topicId:null);e.operationsByContext[t]||(e.operationsByContext[t]=[]),e.operationsByContext[t].push(d)}r&&e.operations[r]&&(e.operations[r].childOperationIds||(e.operations[r].childOperationIds=[]),e.operations[r].childOperationIds.push(d))}),!1,tn(`startOperation/${a}/${d}`)),r||t().cleanupCompletedOperations(3e4),{operationId:d,abortController:p}},updateOperationMetadata:(s,a)=>{let o=t().operations[s];a.isAborting&&tl("[updateOperationMetadata] Setting isAborting=true for operation %s (type=%s)",s,o?.type),e((0,u.jM)(e=>{let t=e.operations[s];t&&(t.metadata={...t.metadata,...a})}),!1,tn(`updateOperationMetadata/${s}`))},updateOperationStatus:(t,s,a)=>{e((0,u.jM)(e=>{let o=e.operations[t];o&&(o.status=s,a&&(o.metadata={...o.metadata,...a}))}),!1,tn(`updateOperationStatus/${t}/${s}`))},updateOperationProgress:(t,s,a)=>{e((0,u.jM)(e=>{let o=e.operations[t];o&&(o.metadata.progress={current:s,total:a??o.metadata.progress?.total??s,percentage:a?Math.round(s/a*100):void 0})}),!1,tn(`updateOperationProgress/${t}`))},completeOperation:(s,a)=>{let o=t().operations[s];o&&tl("[completeOperation] operation %s (type=%s) completed, duration=%dms",s,o.type,Date.now()-o.metadata.startTime),e((0,u.jM)(e=>{let t=e.operations[s];if(!t)return;let o=Date.now();t.status="completed",t.metadata.endTime=o,t.metadata.duration=o-t.metadata.startTime,a&&(t.metadata={...t.metadata,...a})}),!1,tn(`completeOperation/${s}`))},getOperationAbortSignal:e=>{let s=t().operations[e];if(!s)throw Error(`[getOperationAbortSignal] Operation not found: ${e}`);return s.abortController.signal},onOperationCancel:(t,s)=>{e((0,u.jM)(e=>{let a=e.operations[t];a?(a.onCancelHandler=s,tl("[onOperationCancel] registered cancel handler for %s (type=%s)",t,a.type)):tl("[onOperationCancel] WARNING: Operation not found: %s",t)}),!1,tn(`onOperationCancel/${t}`))},cancelOperation:(s,a="User cancelled")=>{let o=t().operations[s];if(!o)return void tl("[cancelOperation] operation not found: %s",s);if("cancelled"===o.status||"completed"===o.status)return void tl("[cancelOperation] operation %s already %s, skipping",s,o.status);tl("[cancelOperation] cancelling operation %s (type=%s), reason: %s",s,o.type,a);try{o.abortController.abort(a)}catch{}if("execAgentRuntime"===o.type&&t().updateOperationMetadata(s,{isAborting:!0}),o.onCancelHandler){tl("[cancelOperation] calling cancel handler for %s (type=%s)",s,o.type);let e={operationId:s,type:o.type,reason:a,metadata:o.metadata};try{Promise.resolve(o.onCancelHandler(e)).catch(e=>{tl("[cancelOperation] cancel handler error for %s: %O",s,e)})}catch(e){tl("[cancelOperation] cancel handler synchronous error for %s: %O",s,e)}}e((0,u.jM)(e=>{let t=e.operations[s];if(!t)return;let o=Date.now();t.status="cancelled",t.metadata.endTime=o,t.metadata.duration=o-t.metadata.startTime,t.metadata.cancelReason=a}),!1,tn(`cancelOperation/${s}`)),o.childOperationIds&&o.childOperationIds.length>0&&(tl("[cancelOperation] cancelling %d child operations",o.childOperationIds.length),o.childOperationIds.forEach(e=>{t().cancelOperation(e,"Parent operation cancelled")}))},failOperation:(s,a)=>{let o=t().operations[s];o&&tl("[failOperation] operation %s (type=%s) failed: %s",s,o.type,a.message),e((0,u.jM)(e=>{let t=e.operations[s];if(!t)return;let o=Date.now();t.status="failed",t.metadata.endTime=o,t.metadata.duration=o-t.metadata.startTime,t.metadata.error=a}),!1,tn(`failOperation/${s}`))},cancelOperations:(e,s="Batch cancelled")=>{let a=Object.values(t().operations),o=[];return a.forEach(t=>{if("running"!==t.status)return;let s=!0;if(e.type){let a=Array.isArray(e.type)?e.type:[e.type];s=s&&a.includes(t.type)}if(e.status){let a=Array.isArray(e.status)?e.status:[e.status];s=s&&a.includes(t.status)}void 0!==e.sessionId&&(s=s&&t.context.sessionId===e.sessionId),void 0!==e.topicId&&(s=s&&t.context.topicId===e.topicId),void 0!==e.messageId&&(s=s&&t.context.messageId===e.messageId),void 0!==e.threadId&&(s=s&&t.context.threadId===e.threadId),void 0!==e.groupId&&(s=s&&t.context.groupId===e.groupId),void 0!==e.agentId&&(s=s&&t.context.agentId===e.agentId),s&&o.push(t.id)}),o.forEach(e=>{t().cancelOperation(e,s)}),o},cancelAllOperations:(e="Cancel all operations")=>{Object.values(t().operations).forEach(s=>{"running"===s.status&&t().cancelOperation(s.id,e)})},cleanupCompletedOperations:(s=6e4)=>{let a=Date.now(),o=[];return(Object.values(t().operations).forEach(e=>{let t="completed"===e.status||"cancelled"===e.status||"failed"===e.status,r=e.metadata.endTime&&a-e.metadata.endTime>s;t&&r&&o.push(e.id)}),0===o.length)?0:(e((0,u.jM)(e=>{o.forEach(t=>{let s=e.operations[t];if(!s)return;delete e.operations[t];let a=e.operationsByType[s.type];if(a&&(e.operationsByType[s.type]=a.filter(e=>e!==t)),s.context.messageId){let a=e.operationsByMessage[s.context.messageId];a&&(e.operationsByMessage[s.context.messageId]=a.filter(e=>e!==t))}if(s.context.sessionId){let a=(0,er.T)(s.context.sessionId,void 0!==s.context.topicId?s.context.topicId:null),o=e.operationsByContext[a];o&&(e.operationsByContext[a]=o.filter(e=>e!==t))}if(s.parentOperationId&&e.operations[s.parentOperationId]){let a=e.operations[s.parentOperationId];a.childOperationIds&&(a.childOperationIds=a.childOperationIds.filter(e=>e!==t))}let o=Object.entries(e.messageOperationMap).find(([,e])=>e===t);o&&delete e.messageOperationMap[o[0]]})}),!1,tn(`cleanupCompletedOperations/count=${o.length}`)),tl("[cleanupCompletedOperations] cleaned up %d operations",o.length),o.length)},associateMessageWithOperation:(t,s)=>{e((0,u.jM)(e=>{e.messageOperationMap[t]=s,e.operationsByMessage[t]||(e.operationsByMessage[t]=[]),e.operationsByMessage[t].includes(s)||e.operationsByMessage[t].push(s)}),!1,tn(`associateMessageWithOperation/${t}/${s}`))}}))(...e)}))),o.x),tu=()=>tc.getState()},17869:(e,t,s)=>{s.d(t,{G:()=>d});var a=s(96987),o=s(99278),r=s(3296),i=s(67095),n=s(62016);let l=e=>{let t=n.z.isInboxSession(e),s={avatar:t?o.xd:o.k_,backgroundColor:o.z6,description:t?(0,a.t)("inbox.desc",{ns:"chat"}):void 0,title:t?(0,a.t)("inbox.title",{ns:"chat"}):(0,a.t)("defaultSession")},r=n.z.currentSession(e);return(0,i.h)(s,r?.meta)},d={currentAgentAvatar:e=>l(e).avatar,currentAgentBackgroundColor:e=>l(e).backgroundColor,currentAgentDescription:e=>l(e).description,currentAgentMeta:l,currentAgentTitle:e=>l(e).title,currentGroupMeta:e=>{let t={description:(0,a.t)("group.desc",{ns:"chat"}),title:(0,a.t)("group.title",{ns:"chat"})},s=n.z.currentSession(e);return(0,i.h)(t,s?.meta)},getAgentMetaByAgentId:e=>t=>{let s=t.sessions?.find(t=>t.type===r.r.Agent&&t.config?.id===e);return s?.meta?s.meta:{}},getAvatar:e=>e.avatar||o.k_,getDescription:e=>e.description,getTitle:e=>e.title||(0,a.t)("defaultSession",{ns:"common"})}},25429:(e,t,s)=>{s.d(t,{Ks:()=>m,MX:()=>f,QG:()=>g,tH:()=>h});var a=s(46675),o=s(75589),r=s(4562),i=s(94192),n=s(15941),l=s(58588),d=s(24952),c=s(17140),u=s(3675),p=s(20028);let g={files:a.A,general:o.A,images:r.A,it:i.A,map:n.A,music:l.A,news:d.A,science:c.A,social_media:u.A,videos:p.A},m={arxiv:"https://icons.duckduckgo.com/ip3/arxiv.org.ico",bilibili:"https://icons.duckduckgo.com/ip3/bilibili.com.ico",bing:"https://icons.duckduckgo.com/ip3/www.bing.com.ico","bing news":"https://icons.duckduckgo.com/ip3/www.bing.com.ico",brave:"https://icons.duckduckgo.com/ip3/brave.com.ico","brave.news":"https://icons.duckduckgo.com/ip3/brave.com.ico",duckduckgo:"https://icons.duckduckgo.com/ip3/www.duckduckgo.com.ico",github:"https://icons.duckduckgo.com/ip3/github.com.ico",google:"https://icons.duckduckgo.com/ip3/google.com.ico","google scholar":"https://icons.duckduckgo.com/ip3/scholar.google.com.ico",npm:"https://icons.duckduckgo.com/ip3/npmjs.com.ico",openairepublications:"https://icons.duckduckgo.com/ip3/doi.org.ico",pubmed:"https://icons.duckduckgo.com/ip3/pubmed.ncbi.nlm.nih.gov.ico",qwant:"https://icons.duckduckgo.com/ip3/www.qwant.com.ico","sogou wechat":"https://icons.duckduckgo.com/ip3/weixin.sogou.com.ico",youtube:"https://icons.duckduckgo.com/ip3/youtube.com.ico"},h=25e3,f=30},27809:(e,t,s)=>{s.d(t,{P:()=>a});let a=async(e,t,s=!0)=>{try{let s=await fetch(e,{cache:"no-store",credentials:"omit",mode:"cors"});if(!s.ok)throw Error(`Failed to fetch image: ${s.status} ${s.statusText}`);let a=await s.blob(),o=window.URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=t,r.style.display="none",document.body.append(r),r.click(),r.remove(),window.URL.revokeObjectURL(o)}catch(t){if(console.log("Download failed:",t),s)window.open(e);else throw t}}},28557:(e,t,s)=>{s.d(t,{H:()=>r});var a=s(16748),o=s(64752);let r=({provider:e,runtimeProvider:t,payload:s})=>{let r={...s,...(0,o.ZE)(e)};return a.k6.initializeWithProvider(t??e,{dangerouslyAllowBrowser:!0,...r,...s})}},29261:(e,t,s)=>{s.d(t,{X:()=>o});var a=s(91645);let o=async e=>0===e.length?0:(0,a.BT)(e)},30333:(e,t,s)=>{s.d(t,{sessionService:()=>r});var a=s(77605);class o{constructor(){this.hasSessions=async()=>0===await this.countSessions(),this.createSession=async(e,t)=>{let{config:s,group:o,meta:r,...i}=t;return a.du.session.createSession.mutate({config:{...s,...r},session:{...i,groupId:o},type:e})},this.cloneSession=(e,t)=>a.du.session.cloneSession.mutate({id:e,newTitle:t}),this.getGroupedSessions=()=>a.du.session.getGroupedSessions.query(),this.countSessions=async e=>a.du.session.countSessions.query(e),this.rankSessions=async e=>a.du.session.rankSessions.query(e),this.updateSession=(e,t)=>{let{group:s,pinned:o,meta:r,updatedAt:i}=t;return a.du.session.updateSession.mutate({id:e,value:{groupId:"default"===s?null:s,pinned:o,...r,updatedAt:i}})},this.getSessionConfig=async e=>a.du.agent.getAgentConfig.query({sessionId:e}),this.updateSessionConfig=(e,t,s)=>a.du.session.updateSessionConfig.mutate({id:e,value:t},{context:{showNotification:!1},signal:s}),this.updateSessionMeta=(e,t,s)=>a.du.session.updateSessionConfig.mutate({id:e,value:t},{signal:s}),this.updateSessionChatConfig=(e,t,s)=>a.du.session.updateSessionChatConfig.mutate({id:e,value:t},{signal:s}),this.searchSessions=e=>a.du.session.searchSessions.query({keywords:e}),this.removeSession=e=>a.du.session.removeSession.mutate({id:e}),this.removeAllSessions=()=>a.du.session.removeAllSessions.mutate(),this.createSessionGroup=(e,t)=>a.du.sessionGroup.createSessionGroup.mutate({name:e,sort:t}),this.removeSessionGroup=(e,t)=>a.du.sessionGroup.removeSessionGroup.mutate({id:e,removeChildren:t}),this.removeSessionGroups=()=>a.du.sessionGroup.removeAllSessionGroups.mutate(),this.updateSessionGroup=(e,t)=>a.du.sessionGroup.updateSessionGroup.mutate({id:e,value:t}),this.updateSessionGroupOrder=e=>a.du.sessionGroup.updateSessionGroupOrder.mutate({sortMap:e})}}let r=new o},32559:(e,t,s)=>{s.d(t,{QG:()=>c,wp:()=>u});var a=s(47194),o=s(74038),r=s(68172),i=s(79555),n=s(77799),l=s(51753),d=s(44432);let c=(e={})=>{let{enableChecker:t,additionalManifests:s=[],defaultToolIds:i}=e,n=(0,o.getToolStoreState)(),d=[...r.w.installedPluginManifestList(n),...n.builtinTools.map(e=>e.manifest),...s];return new a.sq({defaultToolIds:i,enableChecker:t,functionCallChecker:l.D,manifestSchemas:d})},u=e=>c({defaultToolIds:[i.J.identifier],enableChecker:({pluginId:t})=>!!(0,d.j)(t)&&(t!==i.J.identifier||(0,n.H)(e.model,e.provider).useApplicationBuiltinSearchTool)})},32901:(e,t,s)=>{s.d(t,{Om:()=>m,SU:()=>o,qp:()=>n,PE:()=>l.P,HP:()=>d,Vz:()=>c,rX:()=>f,pU:()=>v});class a{getKeyStore(e){let t=this._cache.get(e);if(!t){let s=e.split(",").map(e=>e.trim()).filter(e=>!!e);t={index:0,keyLen:s.length,keys:s},this._cache.set(e,t)}return t}pick(e=""){if(!e)return;let t=this.getKeyStore(e),s=0;return"turn"===this._mode&&(s=t.index++%t.keyLen),"random"===this._mode&&(s=Math.floor(Math.random()*t.keyLen)),t.keys[s]}constructor(){this._cache=new Map,this._mode="random"}}let o=new a,r=e=>{let t=new Image;t.addEventListener("load",function(){let e=document.createElement("canvas");e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0);try{e.toBlob(function(e){let t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t]).then(function(){console.log("Image copied to clipboard successfully using canvas and modern API")})})}catch{let t=e.toDataURL("image/png"),s=document.createElement("textarea");s.value=t,document.body.append(s),s.select(),document.execCommand("copy"),s.remove()}}),t.src=e},i=async e=>{try{let t=await fetch(e),s=await t.blob(),a=new ClipboardItem({"image/png":s});await navigator.clipboard.write([a])}catch(t){console.error("Failed to copy image using modern API:",t),r(e)}},n=async e=>{navigator.clipboard&&"write"in navigator.clipboard?await i(e):r(e)};var l=s(27809);let d=(e,t)=>{let s=new Blob([e],{type:"plain/text"}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=t||"file.txt",document.body.append(o),o.click(),URL.revokeObjectURL(a),o.remove()},c=(e,t)=>{let s=new Blob([JSON.stringify(e)],{type:"application/json"}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=t,document.body.append(o),o.click(),URL.revokeObjectURL(a),o.remove()};var u=s(38759),p=s(61520),g=s(46322);let m={date:()=>new Date().toLocaleDateString(),datetime:()=>new Date().toLocaleString(),day:()=>new Date().getDate().toString().padStart(2,"0"),hour:()=>new Date().getHours().toString().padStart(2,"0"),iso:()=>new Date().toISOString(),locale:()=>Intl.DateTimeFormat().resolvedOptions().locale,minute:()=>new Date().getMinutes().toString().padStart(2,"0"),month:()=>(new Date().getMonth()+1).toString().padStart(2,"0"),second:()=>new Date().getSeconds().toString().padStart(2,"0"),time:()=>new Date().toLocaleTimeString(),timestamp:()=>Date.now().toString(),timezone:()=>Intl.DateTimeFormat().resolvedOptions().timeZone,weekday:()=>new Date().toLocaleDateString("en-US",{weekday:"long"}),year:()=>new Date().getFullYear().toString(),email:()=>p.f.email(u.k.getState())??"",nickname:()=>p.f.nickName(u.k.getState())??"",username:()=>p.f.displayUserName(u.k.getState())??p.f.fullName(u.k.getState())??"",random:()=>Math.floor(1e6*Math.random()+1).toString(),random_bool:()=>Math.random()>.5?"true":"false",random_float:()=>(100*Math.random()).toFixed(2),random_hex:()=>Math.floor(0xffffff*Math.random()).toString(16).padStart(6,"0"),random_int:()=>Math.floor(100*Math.random()+1).toString(),random_string:()=>Math.random().toString(36).slice(2,15),random_digit:()=>Math.floor(10*Math.random()).toString(),uuid:()=>(0,g.uR)(),uuid_short:()=>(0,g.uR)().split("-")[0],language:()=>"undefined"!=typeof navigator?navigator.language:"",platform:()=>"undefined"!=typeof navigator?navigator.platform:"",user_agent:()=>"undefined"!=typeof navigator?navigator.userAgent:""};var h=s(83663);let f=e=>h.A.sanitize(e,{FORBID_ATTR:["onblur","onchange","onclick","onerror","onfocus","onkeydown","onkeypress","onkeyup","onload","onmousedown","onmouseout","onmouseover","onmouseup","onreset","onselect","onsubmit","onunload"],FORBID_TAGS:["embed","link","object","script","style"],KEEP_CONTENT:!1,USE_PROFILES:{svg:!0,svgFilters:!0}});var y=s(9402);let v=e=>{if(!e.type.startsWith("video/"))return{isValid:!0};let t=e.size<=0x1400000;return{actualSize:(0,y.Xq)(e.size),isValid:t}}},35475:(e,t,s)=>{s.d(t,{m4:()=>o});var a=s(29261);let o={getMessageById:(e,t)=>{let s=e.find(e=>e.id===t);if(s)return s},getMessagesTokenCount:async e=>(0,a.X)(e.map(e=>e.content).join("")),getSlicedMessages:(e,t)=>{if(!t.enableHistoryCount||void 0===t.historyCount)return e;let s=t.includeNewUserMessage?t.historyCount+1:t.historyCount;return s<=0?[]:e.slice(-s)}}},35863:(e,t,s)=>{s.d(t,{P:()=>g});var a=s(47194),o=s(15361),r=s(50759),i=s(92399),n=s(23211),l=s(94788),d=s(68172);let c=new a.UU,u=e=>{let t=d.w.installedPluginMetaList(e);return l.W.metaList(e).concat(t)},p=e=>t=>d.w.installedPluginManifestList(t).concat(t.builtinTools.map(e=>e.manifest)).find(t=>t.identifier===e),g={enabledSystemRoles:(e=[])=>t=>{let s=d.w.installedPluginManifestList(t).concat(t.builtinTools.map(e=>e.manifest)).filter(t=>t&&e.includes(t.identifier)).map(e=>{let t=e.meta||{},s=n.V.getPluginTitle(t)||e.identifier,a=e.systemRole||n.V.getPluginDesc(t);if(a){let e=r.N.getContext();a=a.replaceAll(/{{([\S\s]+?)}}/g,(t,s)=>{let a=s.trim(),o=(0,i.A)(e,a);return void 0!==o?String(o):""})}return{apis:e.api.map(t=>({desc:t.description,name:c.generate(e.identifier,t.name,e.type)})),identifier:e.identifier,name:s,systemRole:a}});return s.length>0?(0,o.po)({tools:s}):""},getManifestById:p,getManifestLoadingStatus:e=>t=>{let s=p(e)(t);return t.pluginInstallLoading[e]?"loading":s?s?"success":void 0:"error"},getMetaById:e=>t=>{let s=u(t).find(t=>t.identifier===e);if(s)return s.meta?s.meta:{avatar:s?.avatar,backgroundColor:s?.backgroundColor,description:s?.description,title:s?.title}},isToolHasUI:e=>t=>{let s=p(e)(t);if(!s)return!1;let a=t.builtinTools.find(t=>t.identifier===e);return!!a&&"builtin"===a.type||!!s.ui},metaList:u}},37316:(e,t,s)=>{s.d(t,{v:()=>r});var a=s(42897);let o=e=>(0,a.fe)(e).general||{},r={animationMode:e=>o(e).animationMode,config:o,fontSize:e=>o(e).fontSize,highlighterTheme:e=>o(e).highlighterTheme,mermaidTheme:e=>o(e).mermaidTheme,neutralColor:e=>o(e).neutralColor,primaryColor:e=>o(e).primaryColor,transitionMode:e=>o(e).transitionMode}},38326:(e,t,s)=>{s.r(t),s.d(t,{operationSelectors:()=>c});var a=s(84354);let o=e=>{let{activeId:t,activeTopicId:s}=e;if(!t)return[];let o=(0,a.T)(t,s);return(e.operationsByContext[o]||[]).map(t=>e.operations[t]).filter(Boolean)},r=e=>Object.values(e.operations).filter(e=>"running"===e.status),i=e=>t=>(t.operationsByMessage[e]||[]).map(e=>t.operations[e]).filter(Boolean),n=e=>t=>(t.operationsByType[e]||[]).some(e=>{let s=t.operations[e];return s&&"running"===s.status}),l=e=>(e.operationsByType.execAgentRuntime||[]).some(t=>{let s=e.operations[t];return s&&"running"===s.status&&!s.metadata.isAborting}),d=e=>t=>i(e)(t).some(e=>"running"===e.status),c={canInterrupt:e=>o(e).some(e=>"running"===e.status),canSendMessage:e=>!o(e).some(e=>"running"===e.status),getActiveOperationTypes:e=>Array.from(new Set(r(e).map(e=>e.type))),getAllOperations:e=>Object.values(e.operations),getCurrentContextOperations:o,getCurrentOperationLabel:e=>{let t=o(e).filter(e=>"running"===e.status);if(0===t.length)return"";let s=t.reduce((e,t)=>t.metadata.startTime>e.metadata.startTime?t:e);return s.label||s.type},getCurrentOperationProgress:e=>{let t=o(e).filter(e=>"running"===e.status);if(0===t.length)return;let s=t.filter(e=>e.metadata.progress);if(0===s.length)return;let a=s.reduce((e,t)=>t.metadata.startTime>e.metadata.startTime?t:e);return a.metadata.progress?.percentage},getOperationById:e=>t=>t.operations[e],getOperationContextFromMessage:e=>t=>{let s=t.messageOperationMap[e];if(!s)return;let a=t.operations[s];return a?.context},getOperationsByMessage:i,getOperationsByType:e=>t=>(t.operationsByType[e]||[]).map(e=>t.operations[e]).filter(Boolean),getRunningOperations:r,hasAnyRunningOperation:e=>Object.values(e.operations).some(e=>"running"===e.status),hasRunningOperationType:n,isAIGenerating:l,isAborting:e=>o(e).some(e=>"running"===e.status&&e.metadata.isAborting),isAgentRuntimeRunning:l,isAnyMessageLoading:e=>t=>e.some(e=>d(e)(t)),isContinuing:e=>n("continue")(e),isInRAGFlow:e=>n("rag")(e),isInSearchWorkflow:e=>n("searchWorkflow")(e),isMainWindowAgentRuntimeRunning:e=>(e.operationsByType.execAgentRuntime||[]).some(t=>{let s=e.operations[t];return s&&"running"===s.status&&!s.metadata.isAborting&&!s.metadata.inThread}),isMessageAborting:e=>t=>i(e)(t).some(e=>"running"===e.status&&e.metadata.isAborting),isMessageContinuing:e=>t=>i(e)(t).some(e=>"continue"===e.type&&"running"===e.status),isMessageCreating:e=>t=>i(e)(t).some(e=>("sendMessage"===e.type||"createAssistantMessage"===e.type)&&"running"===e.status),isMessageGenerating:e=>t=>i(e)(t).some(e=>"execAgentRuntime"===e.type&&"running"===e.status),isMessageInReasoning:e=>t=>i(e)(t).some(e=>"reasoning"===e.type&&"running"===e.status),isMessageInToolCalling:e=>t=>i(e)(t).some(e=>"toolCalling"===e.type&&"running"===e.status),isMessageProcessing:d,isMessageRegenerating:e=>t=>i(e)(t).some(e=>"regenerate"===e.type&&"running"===e.status),isRegenerating:e=>n("regenerate")(e),isSendingMessage:e=>n("sendMessage")(e)}},40473:(e,t,s)=>{s.d(t,{a:()=>d});var a=s(99061),o=s(64811),r=s(62016),i=s(67095);let n=()=>{let e=o.B.getState(),t=r.z.currentSession(e);return t?.type==="group"?t.id:void 0},l=e=>t=>{let s=t.groupMap?.[e]?.config;return(0,i.h)(a.DM,s||{})},d={activeGroupId:n,allGroups:e=>e.groupMaps?Object.values(e.groupMaps):[],currentGroup:e=>{let t=n();return t&&e.groupMap?e.groupMap[t]:void 0},currentGroupConfig:e=>{let t=n();return t?l(t)(e):a.DM},currentGroupMeta:e=>{let t=n();if(!t)return a.ap;let s=e.groupMap?.[t];return(0,i.h)(a.ap,{description:s?.description||"",title:s?.title||""})},getAllGroups:e=>Object.values(e.groupMap),getGroupById:e=>t=>t.groupMap[e],getGroupByIdFromChatStore:e=>t=>t.groupMaps?.[e],getGroupConfig:l,groupsInitialized:e=>e.groupsInit,isGroupsInitialized:e=>e.groupsInit,isGroupsLoading:e=>e.isGroupsLoading}},40712:(e,t,s)=>{s.d(t,{O:()=>r,Q:()=>o});var a,o=((a={}).Code="code",a.Preview="preview",a);let r={portalArtifactDisplayMode:"preview",showPortal:!1}},44432:(e,t,s)=>{s.d(t,{T:()=>i,j:()=>r});var a=s(74551),o=s(42246);let r=e=>e!==o.M.identifier||a.xl,i=e=>e.filter(r)},45282:(e,t,s)=>{s.d(t,{t:()=>r});var a=s(42897);let o=e=>(0,a.fe)(e).keyVaults||{},r={getVaultByProvider:e=>t=>o(t)[e]||{},keyVaultsSettings:o,password:e=>o(e).password||""}},45541:(e,t,s)=>{s.d(t,{_:()=>b,o:()=>C});var a=s(50786),o=s(23993),r=s(41734);let i={...{activeId:"inbox",agentConfigInitMap:{},agentMap:{},defaultAgentConfig:s(99061).HA,isInboxAgentConfigInit:!1,showAgentSetting:!1}};var n=s(31021),l=s.n(n),d=s(85601),c=s(64911),u=s(19530),p=s(35245),g=s(46265),m=s(77605);class h{constructor(){this.createAgentKnowledgeBase=async(e,t,s)=>m.du.agent.createAgentKnowledgeBase.mutate({agentId:e,enabled:s,knowledgeBaseId:t}),this.deleteAgentKnowledgeBase=async(e,t)=>m.du.agent.deleteAgentKnowledgeBase.mutate({agentId:e,knowledgeBaseId:t}),this.toggleKnowledgeBase=async(e,t,s)=>m.du.agent.toggleKnowledgeBase.mutate({agentId:e,enabled:s,knowledgeBaseId:t}),this.createAgentFiles=async(e,t,s)=>m.du.agent.createAgentFiles.mutate({agentId:e,enabled:s,fileIds:t}),this.deleteAgentFile=async(e,t)=>m.du.agent.deleteAgentFile.mutate({agentId:e,fileId:t}),this.toggleFile=async(e,t,s)=>m.du.agent.toggleFile.mutate({agentId:e,enabled:s,fileId:t}),this.getFilesAndKnowledgeBases=async e=>m.du.agent.getKnowledgeBasesAndFiles.query({agentId:e})}}let f=new h;var y=s(30333),v=s(64811),I=s(67095),M=s(88990);let T="FETCH_AGENT_CONFIG",w="FETCH_AGENT_KNOWLEDGE",S=(0,r.t)("agent"),C=(0,o.h)()(S((...e)=>({...i,...((e,t)=>({addFilesToAgent:async(e,s)=>{let{activeAgentId:a,internal_refreshAgentConfig:o,internal_refreshAgentKnowledge:r}=t();a&&0!==e.length&&(await f.createAgentFiles(a,e,s),await o(t().activeId),await r())},addKnowledgeBaseToAgent:async e=>{let{activeAgentId:s,internal_refreshAgentConfig:a,internal_refreshAgentKnowledge:o}=t();s&&(await f.createAgentKnowledgeBase(s,e,!0),await a(t().activeId),await o())},removeFileFromAgent:async e=>{let{activeAgentId:s,internal_refreshAgentConfig:a,internal_refreshAgentKnowledge:o}=t();s&&(await f.deleteAgentFile(s,e),await a(t().activeId),await o())},removeKnowledgeBaseFromAgent:async e=>{let{activeAgentId:s,internal_refreshAgentConfig:a,internal_refreshAgentKnowledge:o}=t();s&&(await f.deleteAgentKnowledgeBase(s,e),await a(t().activeId),await o())},removePlugin:async e=>{await t().togglePlugin(e,!1)},toggleFile:async(e,s)=>{let{activeAgentId:a,internal_refreshAgentConfig:o}=t();a&&(await f.toggleFile(a,e,s),await o(t().activeId))},toggleKnowledgeBase:async(e,s)=>{let{activeAgentId:a,internal_refreshAgentConfig:o}=t();a&&(await f.toggleKnowledgeBase(a,e,s),await o(t().activeId))},togglePlugin:async(e,s)=>{let a=M.e.currentAgentConfig(t()),o=(0,d.jM)(a,t=>{t.plugins=(0,d.jM)(t.plugins||[],t=>{let a=t.indexOf(e);(void 0!==s?s:-1===a)?-1===a&&t.push(e):-1!==a&&t.splice(a,1)})});await t().updateAgentConfig(o)},updateAgentChatConfig:async e=>{let{activeId:s}=t();s&&await t().updateAgentConfig({chatConfig:e})},updateAgentConfig:async e=>{let{activeId:s}=t();if(!s)return;let a=t().internal_createAbortController("updateAgentConfigSignal");await t().internal_updateAgentConfig(s,e,a.signal)},useFetchAgentConfig:(s,a)=>(0,g.lA)(!0!==s||a.startsWith("cg_")?null:[T,a],([,e])=>y.sessionService.getSessionConfig(e),{onSuccess:s=>{t().internal_dispatchAgentMap(a,s,"fetch"),e({activeAgentId:s.id,agentConfigInitMap:{...t().agentConfigInitMap,[a]:!0}},!1,"fetchAgentConfig")}}),useFetchFilesAndKnowledgeBases:()=>(0,g.lA)([w,t().activeAgentId],([,e])=>f.getFilesAndKnowledgeBases(e),{fallbackData:[],suspense:!0}),useInitInboxAgentStore:(s,a)=>(0,g.Ju)(!0===s?"fetchInboxAgentConfig":null,()=>y.sessionService.getSessionConfig(p.Ed),{onSuccess:s=>{e({defaultAgentConfig:(0,I.h)(t().defaultAgentConfig,a),isInboxAgentConfigInit:!0},!1,"initDefaultAgent"),s&&t().internal_dispatchAgentMap(p.Ed,s,"initInbox")}}),internal_dispatchAgentMap:(s,a,o)=>{let r=(0,d.jM)(t().agentMap,e=>{e[s]?e[s]=(0,I.h)(e[s],a):e[s]=a});l()(t().agentMap,r)||e({agentMap:r},!1,"dispatchAgent"+(o?`/${o}`:""))},internal_updateAgentConfig:async(e,s,a)=>{let o=M.e.currentAgentModel(t());t().internal_dispatchAgentMap(e,s,"optimistic_updateAgentConfig"),await y.sessionService.updateSessionConfig(e,s,a),await t().internal_refreshAgentConfig(e),o!==s.model&&await v.B.getState().refreshSessions()},internal_refreshAgentConfig:async e=>{await (0,c.j)([T,e])},internal_refreshAgentKnowledge:async()=>{await (0,c.j)([w,t().activeAgentId])},internal_createAbortController:s=>{let a=t()[s];a&&a.abort(u.ve);let o=new AbortController;return e({[s]:o},!1,"internal_createAbortController"),o}}))(...e)})),a.x),b=()=>C.getState()},47194:(e,t,s)=>{s.d(t,{gs:()=>c,VS:()=>v,GO:()=>p,NT:()=>M,tv:()=>S,eu:()=>b,f2:()=>E,HV:()=>D,gz:()=>m,TT:()=>G,FK:()=>U,UU:()=>H,TE:()=>f,sq:()=>W});class a extends Error{constructor(e,t,s){super(`[${e}] ${t}`),this.processorName=e,this.originalError=s,this.name="ProcessorError"}}class o extends Error{constructor(e,t,s){super(e),this.processorName=t,this.originalError=s,this.name="PipelineError"}}class r{constructor(e={}){}async process(e){try{this.validateInput(e);let t=await this.doProcess(e);return this.validateOutput(t),t}catch(e){throw new a(this.name,`Processing failed: ${e}`,e instanceof Error?e:Error(String(e)))}}validateInput(e){if(!e||!Array.isArray(e.messages))throw Error("Invalid context")}validateOutput(e){if(!e||!Array.isArray(e.messages))throw Error("Invalid output context")}cloneContext(e){return{...e,messages:[...e.messages],metadata:{...e.metadata}}}abort(e,t){return{...e,abortReason:t,isAborted:!0}}isEmptyMessage(e){return!e||0===e.trim().length}markAsExecuted(e){return e}}class i extends r{async buildContext(e){return null}shouldInject(e){return!0}createSystemMessage(e){return{content:e,role:"system"}}}var n=s(68096),l=s.n(n);let d=l()("context-engine:ContextEngine");class c{constructor(e){this.processors=[];const{pipeline:t,...s}=e;this.processors=[...t],this.options={debug:!1,logger:console.log,...s}}addProcessor(e){return this.processors.push(e),this}removeProcessor(e){return this.processors=this.processors.filter(t=>t.name!==e),this}getProcessors(){return[...this.processors]}clear(){return this.processors=[],this}async process(e){let t=Date.now(),s={},a={initialState:{messages:e.messages},isAborted:!1,messages:[...e.messages],metadata:{}};d("Starting pipeline processing"),d("Number of processors:",this.processors.length);let r=0;try{for(let e of this.processors){if(a.isAborted){d("Pipeline aborted before processor",e.name,"reason:",a.abortReason);break}let t=Date.now();d("Executing processor:",e.name);try{a=await e.process(a),r++;let o=Date.now()-t;if(s[e.name]=o,d("Processor",e.name,"completed in",o+"ms"),a.isAborted){d("Pipeline aborted by processor",e.name,"reason:",a.abortReason);break}}catch(r){let a=Date.now()-t;throw s[e.name]=a,d("Processor",e.name,"execution failed:",r),new o(`Processor [${e.name}] execution failed`,e.name,r instanceof Error?r:Error(String(r)))}}let e=Date.now()-t;return d("Pipeline processing completed in",e+"ms"),{abortReason:a.abortReason,isAborted:a.isAborted,messages:a.messages,metadata:a.metadata,stats:{processedCount:r,processorDurations:s,totalDuration:e}}}catch(e){if(d("Pipeline processing failed:",e),e instanceof o)throw e;throw new o("Unknown error occurred during pipeline processing",void 0,e instanceof Error?e:Error(String(e)))}}getStats(){return{processorCount:this.processors.length,processorNames:this.processors.map(e=>e.name)}}clone(){return new c({pipeline:[...this.processors],...this.options})}validate(){let e=[],t=this.processors.map(e=>e.name),s=t.filter((e,s)=>t.indexOf(e)!==s);return s.length>0&&e.push(`Found duplicate processor names: ${s.join(", ")}`),0===this.processors.length&&e.push("No processors in pipeline"),this.processors.forEach(t=>{t.name||e.push("Processor missing name"),"function"!=typeof t.process&&e.push(`Processor [${t.name}] missing process method`)}),{errors:e,valid:0===e.length}}}let u=l()("context-engine:provider:HistorySummaryProvider");class p extends i{constructor(e,t={}){super(t),this.config=e,this.name="HistorySummaryProvider"}async doProcess(e){let t=this.cloneContext(e);if(!this.config.historySummary)return u("No history summary content, skipping processing"),this.markAsExecuted(t);let s=this.formatHistorySummary(this.config.historySummary);return this.injectHistorySummary(t,s),t.metadata.historySummary={formattedLength:s.length,injected:!0,originalLength:this.config.historySummary.length},u(`History summary injection completed, original length: ${this.config.historySummary.length}, formatted length: ${s.length}`),this.markAsExecuted(t)}formatHistorySummary(e){return(this.config.formatHistorySummary||(e=>`<chat_history_summary>
<docstring>Users may have lots of chat messages, here is the summary of the history:</docstring>
<summary>${e}</summary>
</chat_history_summary>`))(e)}injectHistorySummary(e,t){let s=e.messages.find(e=>"system"===e.role);s?(s.content=[s.content,t].filter(Boolean).join("\n\n"),u(`History summary merged to existing system message, final length: ${s.content.length}`)):(e.messages.unshift({content:t,role:"system"}),u(`New history summary system message created, content length: ${t.length}`))}}let g=l()("context-engine:provider:SystemRoleInjector");class m extends i{constructor(e,t={}){super(t),this.config=e,this.name="SystemRoleInjector"}async doProcess(e){let t=this.cloneContext(e);if(!this.config.systemRole||""===this.config.systemRole.trim())return g("No system role configured, skipping injection"),this.markAsExecuted(t);if(t.messages.length>0&&"system"===t.messages[0].role)return g("System role already exists, skipping injection"),this.markAsExecuted(t);let s={content:this.config.systemRole,createdAt:Date.now(),id:`system-${Date.now()}`,meta:{},role:"system",updatedAt:Date.now()};return t.messages.unshift(s),t.metadata.systemRoleInjected=!0,g(`System role injected: "${this.config.systemRole.slice(0,50)}..."`),this.markAsExecuted(t)}}let h=l()("context-engine:provider:ToolSystemRoleProvider");class f extends i{constructor(e,t={}){super(t),this.config=e,this.name="ToolSystemRoleProvider"}async doProcess(e){let t=this.cloneContext(e),s=this.getToolSystemRole();return s?(this.injectToolSystemRole(t,s),t.metadata.toolSystemRole={contentLength:s.length,injected:!0,supportsFunctionCall:this.config.isCanUseFC(this.config.model,this.config.provider),toolsCount:this.config.tools?.length||0},h(`Tool system role injection completed, tools count: ${this.config.tools?.length||0}`)):h("No need to inject tool system role, skipping processing"),this.markAsExecuted(t)}getToolSystemRole(){let{tools:e,model:t,provider:s}=this.config;if(!(e&&e.length>0))return void h("No available tools");if(!this.config.isCanUseFC(t,s))return void h(`Model ${t} (${s}) does not support function calling`);let a=this.config.getToolSystemRoles(e);return a||void h("Failed to get tool system role content")}injectToolSystemRole(e,t){let s=e.messages.find(e=>"system"===e.role);s?(s.content=[s.content,t].filter(Boolean).join("\n\n"),h(`Tool system role merged to existing system message, final length: ${s.content.length}`)):(e.messages.unshift({content:t,id:`tool-system-role-${Date.now()}`,role:"system"}),h(`New tool system message created, content length: ${t.length}`))}}let y=l()("context-engine:processor:GroupMessageFlattenProcessor");class v extends r{constructor(e={}){super(e),this.name="GroupMessageFlattenProcessor"}async doProcess(e){let t=this.cloneContext(e),s=0,a=0,o=0,r=0,i=[];for(let e of t.messages)if("assistantGroup"===e.role&&e.children){if(0===e.children.length)continue;for(let t of(s++,a++,y(`Flattening assistantGroup message ${e.id} with ${e.children.length} children`),e.children)){let s={content:t.content||"",createdAt:e.createdAt,id:t.id,meta:e.meta,role:"assistant",updatedAt:e.updatedAt};if(t.tools&&t.tools.length>0&&(s.tools=t.tools.map(e=>({apiName:e.apiName,arguments:e.arguments,id:e.id,identifier:e.identifier,type:e.type}))),t.reasoning&&(s.reasoning=t.reasoning),t.error&&(s.error=t.error),t.imageList&&t.imageList.length>0&&(s.imageList=t.imageList),e.parentId&&(s.parentId=e.parentId),e.threadId&&(s.threadId=e.threadId),e.groupId&&(s.groupId=e.groupId),e.agentId&&(s.agentId=e.agentId),e.targetId&&(s.targetId=e.targetId),e.topicId&&(s.topicId=e.topicId),i.push(s),o++,y(`Created assistant message ${s.id} from child`),t.tools){for(let s of t.tools)if(s.result){let t={content:s.result.content,createdAt:e.createdAt,id:s.result.id,meta:e.meta,plugin:{apiName:s.apiName,arguments:s.arguments,id:s.id,identifier:s.identifier,type:s.type},pluginError:s.result.error||void 0,pluginState:s.result.state||void 0,role:"tool",tool_call_id:s.id,updatedAt:e.updatedAt};e.parentId&&(t.parentId=e.parentId),e.threadId&&(t.threadId=e.threadId),e.groupId&&(t.groupId=e.groupId),e.topicId&&(t.topicId=e.topicId),i.push(t),r++,y(`Created tool message ${t.id} for tool call ${s.id}`)}}}}else i.push(e);return t.messages=i,t.metadata.groupMessagesFlattenProcessed=s,t.metadata.groupMessagesFlattened=a,t.metadata.assistantMessagesCreated=o,t.metadata.toolMessagesCreated=r,y(`AssistantGroup message flatten processing completed: ${a} groups flattened, ${o} assistant messages created, ${r} tool messages created`),this.markAsExecuted(t)}}let I=l()("context-engine:processor:HistoryTruncateProcessor");class M extends r{constructor(e,t={}){super(t),this.config=e,this.name="HistoryTruncateProcessor"}async doProcess(e){var t,s;let a=this.cloneContext(e),o=a.messages.length;t=a.messages,a.messages=(s={enableHistoryCount:this.config.enableHistoryCount,historyCount:this.config.historyCount}).enableHistoryCount&&void 0!==s.historyCount?s.historyCount<=0?[]:t.slice(-s.historyCount):t;let r=a.messages.length,i=o-r;return a.metadata.historyTruncated=i,a.metadata.finalMessageCount=r,I(`History truncation completed, truncated ${i} messages (${o} → ${r})`),this.markAsExecuted(a)}}var T=s(24902);let w=l()("context-engine:processor:InputTemplateProcessor");class S extends r{constructor(e,t={}){super(t),this.config=e,this.name="InputTemplateProcessor"}async doProcess(e){let t=this.cloneContext(e);if(!this.config.inputTemplate)return w("No input template configured, skipping processing"),this.markAsExecuted(t);let s=0;try{let e=(0,T.A)(this.config.inputTemplate,{interpolate:/{{\s*(text)\s*}}/g});w(`Applying input template: ${this.config.inputTemplate}`);for(let a=0;a<t.messages.length;a++){let o=t.messages[a];if("user"===o.role)try{let r=o.content,i=e({text:r});i!==r&&(t.messages[a]={...o,content:i},s++,w(`Applied template to message ${o.id}`))}catch(e){w.extend("error")(`Error applying template to message ${o.id}: ${e}`)}}}catch(e){w.extend("error")(`Template compilation failed: ${e}`)}return t.metadata.inputTemplateProcessed=s,w(`Input template processing completed, processed ${s} messages`),this.markAsExecuted(t)}}let C=l()("context-engine:processor:MessageCleanupProcessor");class b extends r{constructor(e={}){super(e),this.name="MessageCleanupProcessor"}async doProcess(e){let t=this.cloneContext(e),s=0;for(let e=0;e<t.messages.length;e++){let a=t.messages[e],o=this.cleanMessage(a);o!==a&&(t.messages[e]=o,s++)}return t.metadata.messageCleanup={cleanedCount:s,totalMessages:t.messages.length},C(`Message cleanup completed, cleaned ${s} messages`),this.markAsExecuted(t)}cleanMessage(e){switch(e.role){case"system":case"user":return{content:e.content,role:e.role};case"assistant":return{content:e.content,role:e.role,...e.tool_calls&&{tool_calls:e.tool_calls},...e.reasoning&&{reasoning:e.reasoning}};case"tool":return{content:e.content,role:e.role,tool_call_id:e.tool_call_id,...e.name&&{name:e.name}};default:return e}}}var _=s(15361),A=s(25040),x=s(19742);let k=l()("context-engine:processor:MessageContentProcessor");class E extends r{constructor(e,t={}){super(t),this.config=e,this.name="MessageContentProcessor"}async doProcess(e){let t=this.cloneContext(e),s=0,a=0,o=0;for(let e=0;e<t.messages.length;e++){let r=t.messages[e];try{let i=r;"user"===r.role?(i=await this.processUserMessage(r))!==r&&(a++,s++):"assistant"===r.role&&(i=await this.processAssistantMessage(r))!==r&&(o++,s++),i!==r&&(t.messages[e]=i,k(`Processed message content ${r.id}, role: ${r.role}`))}catch(e){k.extend("error")(`Error processing message ${r.id} content: ${e}`)}}return t.metadata.messageContentProcessed=s,t.metadata.userMessagesProcessed=a,t.metadata.assistantMessagesProcessed=o,k(`Message content processing completed, processed ${s} messages (user: ${a}, assistant: ${o})`),this.markAsExecuted(t)}async processUserMessage(e){let t=e.imageList&&e.imageList.length>0,s=e.videoList&&e.videoList.length>0,a=e.fileList&&e.fileList.length>0;if(!t&&!s&&!a)return{...e,content:e.content};let o=[],r=e.content||"";if((a||t||s)&&this.config.fileContext?.enabled){let t=(0,_.T)({addUrl:this.config.fileContext.includeFileUrl??!0,fileList:e.fileList,imageList:e.imageList||[],videoList:e.videoList||[]});t&&(r=(r+"\n\n"+t).trim())}if(r&&o.push({text:r,type:"text"}),t&&this.config.isCanUseVision?.(this.config.model,this.config.provider)){let t=await this.processImageList(e.imageList||[]);o.push(...t)}if(s&&this.config.isCanUseVideo?.(this.config.model,this.config.provider)){let t=await this.processVideoList(e.videoList||[]);o.push(...t)}let i=(a||t||s)&&this.config.fileContext?.enabled,n=t&&this.config.isCanUseVision?.(this.config.model,this.config.provider),l=s&&this.config.isCanUseVideo?.(this.config.model,this.config.provider);return 1!==o.length||"text"!==o[0].type||i||n||l?{content:o,createdAt:e.createdAt,id:e.id,meta:e.meta,role:e.role,updatedAt:e.updatedAt,...e.tools&&{tools:e.tools},...e.tool_calls&&{tool_calls:e.tool_calls},...e.tool_call_id&&{tool_call_id:e.tool_call_id},...e.name&&{name:e.name}}:{content:o[0].text,createdAt:e.createdAt,id:e.id,meta:e.meta,role:e.role,updatedAt:e.updatedAt,...e.tools&&{tools:e.tools},...e.tool_calls&&{tool_calls:e.tool_calls},...e.tool_call_id&&{tool_call_id:e.tool_call_id},...e.name&&{name:e.name}}}async processAssistantMessage(e){if(e.reasoning&&e.reasoning?.signature){let t=[{signature:e.reasoning.signature,thinking:e.reasoning.content,type:"thinking"},{text:e.content,type:"text"}];return{...e,content:t}}if(e.imageList&&e.imageList.length>0&&this.config.isCanUseVision?.(this.config.model,this.config.provider)){let t=[];return e.content&&t.push({text:e.content,type:"text"}),t.push(...await this.processImageList(e.imageList||[])),{...e,content:t}}return{...e,content:e.content}}async processImageList(e){return e&&0!==e.length?Promise.all(e.map(async e=>{let{type:t}=(e=>{let t=e.match(/^data:([^;]+);base64,(.+)$/);if(t)return{base64:t[2],mimeType:t[1],type:"base64"};try{return new URL(e),{base64:null,mimeType:null,type:"url"}}catch{return{base64:null,mimeType:null,type:null}}})(e.url),s=e.url;if("url"===t&&(0,x.Yt)(e.url)){let{base64:t,mimeType:a}=await (0,A.h)(e.url);s=`data:${a};base64,${t}`}return{image_url:{detail:"auto",url:s},type:"image_url"}})):[]}async processVideoList(e){return e&&0!==e.length?e.map(e=>({type:"video_url",video_url:{url:e.url}})):[]}validateContentPart(e){if(!e||!e.type)return!1;switch(e.type){case"text":return"string"==typeof e.text;case"image_url":return!!(e.image_url&&e.image_url.url);case"thinking":return!!(e.thinking&&e.signature);case"video_url":return!!(e.video_url&&e.video_url.url);default:return!1}}}let L=l()("context-engine:processor:PlaceholderVariablesProcessor"),O=/{{(.*?)}}/g,P=e=>[...e.matchAll(O)].map(e=>e[1].trim()),R=(e,t,s=2)=>{let a=e;for(let e=0;e<s;e++)try{let e=P(a),s=Object.fromEntries(e.map(e=>[e,t[e]?.()]).filter(([,e])=>void 0!==e));if(0===Object.keys(s).length)break;let o=a;for(let[e,t]of Object.entries(s)){let s=RegExp(`{{\\s*${e.replaceAll(/[$()*+.?[\\\]^{|}]/g,"\\$&")}\\s*}}`,"g");o=o.replace(s,t)}if(o===a)break;a=o}catch{break}return a};class D extends r{constructor(e,t={}){super(t),this.config=e,this.name="PlaceholderVariablesProcessor"}async doProcess(e){let t=this.cloneContext(e),s=0,a=this.config.depth??2;L(`Starting placeholder variables processing with ${Object.keys(this.config.variableGenerators).length} generators`);for(let e=0;e<t.messages.length;e++){let o=t.messages[e];try{let r=JSON.stringify(o),i=this.processMessagePlaceholders(o,a);JSON.stringify(i)!==r&&(t.messages[e]=i,s++,L(`Processed placeholders in message ${o.id}, role: ${o.role}`))}catch(e){L.extend("error")(`Error processing placeholders in message ${o.id}: ${e}`)}}return t.metadata.placeholderVariablesProcessed=s,L(`Placeholder variables processing completed, processed ${s} messages`),this.markAsExecuted(t)}processMessagePlaceholders(e,t){if(!e?.content)return e;let{content:s}=e;return"string"==typeof s?{...e,content:R(s,this.config.variableGenerators,t)}:Array.isArray(s)?{...e,content:s.map(e=>e?.type==="text"?{...e,text:R(e.text,this.config.variableGenerators,t)}:e)}:e}}let F=l()("context-engine:processor:ToolCallProcessor");class G extends r{constructor(e,t={}){super(t),this.config=e,this.name="ToolCallProcessor"}async doProcess(e){let t=this.cloneContext(e),s=!this.config.isCanUseFC||this.config.isCanUseFC(this.config.model,this.config.provider),a=0,o=0,r=0;for(let e=0;e<t.messages.length;e++){let i=t.messages[e];try{let n=await this.processMessage(i,s);n!==i&&(a++,t.messages[e]=n,"assistant"===i.role&&i.tools&&(o+=i.tools.length),"tool"===i.role&&r++,F(`Processed message ${i.id}, role: ${i.role}`))}catch(e){F.extend("error")(`Error processing tool call in message ${i.id}: ${e}`)}}return t.metadata.toolCallProcessed=a,t.metadata.toolCallsConverted=o,t.metadata.toolMessagesConverted=r,t.metadata.supportTools=s,F(`Tool call processing completed, processed ${a} messages, converted ${o} tool calls, ${r} tool messages`),this.markAsExecuted(t)}async processMessage(e,t){switch(e.role){case"assistant":return this.processAssistantMessage(e,t);case"tool":return this.processToolMessage(e,t);default:return e}}processAssistantMessage(e,t){let s=e.tools&&e.tools.length>0,a=e.tool_calls&&0===e.tool_calls.length;if(!t||!s&&a){let{tools:t,tool_calls:s,...a}=e;return a}if(!s)return e;let o=e.tools.map(e=>({function:{arguments:e.arguments,name:this.config.genToolCallingName?this.config.genToolCallingName(e.identifier,e.apiName,e.type):`${e.identifier}.${e.apiName}`},id:e.id,thoughtSignature:e.thoughtSignature,type:"function"}));return{...e,tool_calls:o}}processToolMessage(e,t){if(!t)return{...e,name:void 0,plugin:void 0,role:"user",tool_call_id:void 0};let s=e.plugin?this.config.genToolCallingName?this.config.genToolCallingName(e.plugin.identifier,e.plugin.apiName,e.plugin.type):`${e.plugin.identifier}.${e.plugin.apiName}`:void 0;return{...e,name:s}}validateToolCall(e){return!!(e&&e.id&&e.identifier&&e.apiName&&e.arguments)}validateToolMessage(e){return!!(e&&e.tool_call_id&&void 0!==e.content)}}let B=l()("context-engine:processor:ToolMessageReorder");class U extends r{constructor(e={}){super(e),this.name="ToolMessageReorder"}async doProcess(e){let t=this.cloneContext(e),s=this.reorderToolMessages(t.messages),a=t.messages.length,o=s.length;return t.messages=s,t.metadata.toolMessageReorder={originalCount:a,removedInvalidTools:a-o,reorderedCount:o},a!==o?B("Tool message reordering completed, removed",a-o,"invalid tool messages"):B("Tool message reordering completed, message order optimized"),this.markAsExecuted(t)}reorderToolMessages(e){let t=new Set;e.forEach(e=>{"assistant"===e.role&&e.tool_calls&&e.tool_calls.forEach(e=>{t.add(e.id)})});let s={};e.forEach(e=>{"tool"===e.role&&e.tool_call_id&&t.has(e.tool_call_id)&&(s[e.tool_call_id]=e)});let a=[];return e.forEach(e=>{"tool"!==e.role||e.tool_call_id&&t.has(e.tool_call_id)?!a.some(t=>!!e.tool_call_id&&t.tool_call_id===e.tool_call_id)&&(a.push(e),"assistant"===e.role&&e.tool_calls&&e.tool_calls.forEach(e=>{let t=s[e.id];t&&(a.push(t),delete s[e.id])})):B("Skipping invalid tool message:",e.id)}),a}}var $=s(15346);let N="____",j="MD5HASH_";class H{genHash(e){return $.VV.hashStr(e).toString().slice(0,12)}generate(e,t,s="default"){let a=s&&"default"!==s?`${N}${s}`:"",o=e+N+t+a;if(o.length>=64){let s=j+this.genHash(t);(o=e+N+s+a).length>=64&&(o=j+this.genHash(e)+N+s+a)}return o}resolve(e,t){return e.map(e=>{let[s,a,o]=e.function.name.split(N);if(!a)return null;if(s.startsWith(j)){let e=s.replace(j,""),a=Object.keys(t).find(t=>this.genHash(t)===e);a&&(s=a)}let r={apiName:a,arguments:e.function.arguments,id:e.id,identifier:s,thoughtSignature:e.thoughtSignature,type:o??"default"};if(a.startsWith(j)&&t[s]){let e=a.replace(j,""),o=t[s],i=o?.api.find(t=>this.genHash(t.name)===e);i&&(r.apiName=i.name)}return r}).filter(Boolean)}}let q=new H,K=l()("context-engine:tools-engine");class W{constructor(e){this.options=e,this.defaultToolIds=e.defaultToolIds||[],K("Initializing ToolsEngine with %d manifest schemas and %d default tools",e.manifestSchemas.length,this.defaultToolIds.length),this.manifestSchemas=new Map(e.manifestSchemas.map(e=>[e.identifier,e])),this.enableChecker=e.enableChecker,this.functionCallChecker=e.functionCallChecker,K("ToolsEngine initialized with plugins: %o, default tools: %o",Array.from(this.manifestSchemas.keys()),this.defaultToolIds)}generateTools(e){let{toolIds:t=[],model:s,provider:a,context:o}=e,r=[...new Set([...t,...this.defaultToolIds])];if(K("Generating tools for model=%s, provider=%s, pluginIds=%o (includes %d default tools)",s,a,r,this.defaultToolIds.length),!this.checkFunctionCallSupport(s,a))return void K("Function calling not supported for model=%s, provider=%s",s,a);let{enabledManifests:i}=this.filterEnabledPlugins(r,s,a,o);if(0===i.length)return void K("No enabled manifests found, returning undefined");let n=this.convertManifestsToTools(i);return K("Generated %d tools from %d manifests",n.length,i.length),n}generateToolsDetailed(e){let{toolIds:t=[],model:s,provider:a,context:o}=e,r=[...new Set([...t,...this.defaultToolIds])];K("Generating detailed tools for model=%s, provider=%s, pluginIds=%o (includes %d default tools)",s,a,r,this.defaultToolIds.length);let i=this.checkFunctionCallSupport(s,a),{enabledManifests:n,filteredPlugins:l}=this.filterEnabledPlugins(r,s,a,o,i),d=n.length>0?this.convertManifestsToTools(n):void 0;return K("Generated detailed result: enabled=%d, filtered=%d, tools=%d",n.length,l.length,d?.length??0),{enabledToolIds:n.map(e=>e.identifier),filteredTools:l,tools:d}}checkFunctionCallSupport(e,t){if(this.functionCallChecker){let s=this.functionCallChecker(e,t);return K("Function calling check result for %s/%s: %s",e,t,s),s}return K("No function calling checker provided, defaulting to true"),!0}filterEnabledPlugins(e,t,s,a,o){let r=[],i=[];if(K("Filtering plugins: %o",e),!1===o){for(let t of e)this.manifestSchemas.get(t)?(K("Plugin incompatible (no FC support): %s",t),i.push({id:t,reason:"incompatible"})):(K("Plugin not found: %s",t),i.push({id:t,reason:"not_found"}));return K("Filtering complete: enabled=%d, filtered=%d",0,i.length),{enabledManifests:r,filteredPlugins:i}}for(let o of e){let e=this.manifestSchemas.get(o);if(!e){K("Plugin not found: %s",o),i.push({id:o,reason:"not_found"});continue}(this.enableChecker?this.enableChecker({context:a,manifest:e,model:t,pluginId:o,provider:s}):this.defaultEnabledCheck())?(K("Plugin enabled: %s",o),r.push(e)):(K("Plugin disabled: %s",o),i.push({id:o,reason:"disabled"}))}return K("Filtering complete: enabled=%d, filtered=%d",r.length,i.length),{enabledManifests:r,filteredPlugins:i}}defaultEnabledCheck(){return!0}convertManifestsToTools(e){K("Converting %d manifests to tools",e.length);let t=e.flatMap(e=>e.api.map(t=>({function:{description:t.description,name:this.generateToolName(e.identifier,t.name,e.type),parameters:t.parameters},type:"function"})));return K("Converted to %d tools",t.length),t}generateToolName(e,t,s){return this.options.generateToolName?this.options.generateToolName(e,t,s):((e,t,s="default")=>q.generate(e,t,s))(e,t,s)}getAvailablePlugins(){return Array.from(this.manifestSchemas.keys())}hasPlugin(e){return this.manifestSchemas.has(e)}getPluginManifest(e){return this.manifestSchemas.get(e)}updateManifestSchemas(e){for(let t of(this.manifestSchemas.clear(),e))this.manifestSchemas.set(t.identifier,t)}addPluginManifest(e){this.manifestSchemas.set(e.identifier,e)}removePluginManifest(e){return this.manifestSchemas.delete(e)}getEnabledPluginManifests(e=[]){let t=[...e,...this.defaultToolIds];K("Getting enabled plugin manifests for pluginIds=%o",t);let s=new Map;for(let e of t){let t=this.manifestSchemas.get(e);t&&s.set(e,t)}return K("Returning %d enabled plugin manifests",s.size),s}getAllPluginManifests(){return new Map(this.manifestSchemas)}}},47260:(e,t,s)=>{s.d(t,{w:()=>d});var a=s(67400);let o=e=>e.aiProviderList.filter(e=>e.enabled).sort((e,t)=>e.sort-t.sort),r=e=>e.aiProviderDetail,i=new Set(["ollama","lmstudio"]),n=e=>r(e)?.keyVaults,l=e=>t=>{if(e)return t.aiProviderRuntimeConfig?.[e]},d={activeProviderConfig:r,disabledAiProviderList:e=>e.aiProviderList.filter(e=>!e.enabled),enabledAiProviderList:o,enabledImageModelList:e=>e.enabledImageModelList||[],isActiveProviderApiKeyNotEmpty:e=>{let t=n(e);return!!t?.apiKey||!!t?.accessKeyId||!!t?.secretAccessKey},isActiveProviderEndpointNotEmpty:e=>{let t=n(e);return!!t?.baseURL||!!t?.endpoint},isAiProviderConfigLoading:e=>t=>t.activeAiProvider!==e,isInitAiProviderRuntimeState:e=>!!e.isInitAiProviderRuntimeState,isProviderConfigUpdating:e=>t=>t.aiProviderConfigUpdatingIds.includes(e),isProviderEnableResponseApi:e=>t=>{let s=l(e)(t),a=s?.config?.enableResponseApi;return"boolean"==typeof a?a:"openai"===e},isProviderEnabled:e=>t=>o(t).some(t=>t.id===e),isProviderFetchOnClient:e=>t=>{let s=l(e)(t);if((0,a.isProviderDisableBrowserRequest)(e))return!1;if(i.has(e)&&void 0!==s?.fetchOnClient)return s?.fetchOnClient;let o=!!s?.keyVaults.baseURL,r=!!s?.keyVaults.apiKey;return(!!o||!!r)&&(!!o&&!r||void 0!==s?.fetchOnClient&&s?.fetchOnClient)},isProviderHasBuiltinSearch:e=>t=>{let s=l(e)(t);return!!s?.settings.searchMode},isProviderHasBuiltinSearchConfig:e=>t=>{let s=l(e)(t);return!!s?.settings.searchMode&&s?.settings.searchMode!=="internal"},isProviderLoading:e=>t=>t.aiProviderLoadingIds.includes(e),providerConfigById:l,providerKeyVaults:e=>t=>{if(e)return t.aiProviderRuntimeConfig?.[e]?.keyVaults}}},50243:(e,t,s)=>{s.d(t,{W:()=>b,u:()=>C});var a=s(14308),o=s(50786),r=s(23993),i=s(31021),n=s.n(i),l=s(85601),d=s(64911),c=s(35245),u=s(99061),p=s(46265),g=s(77152),m=s(17068),h=s(64811),f=s(61497);let y={activeThreadAgentId:"",groupMap:{},groups:[],groupsInit:!1,isGroupsLoading:!0,showGroupSetting:!1},v={addGroup:(e,{payload:t})=>(0,l.jM)(e,e=>{e.groups.push(t),e.groupMap[t.id]=t}),deleteGroup:(e,{payload:t})=>(0,l.jM)(e,e=>{e.groups=e.groups.filter(e=>e.id!==t),delete e.groupMap[t]}),loadGroups:(e,{payload:t})=>(0,l.jM)(e,e=>{e.groups=t,e.groupMap=t.reduce((e,t)=>(e[t.id]=t,e),{}),e.isGroupsLoading=!1}),setGroupsLoading:(e,{payload:t})=>({...e,isGroupsLoading:t}),updateGroup:(e,{payload:t})=>(0,l.jM)(e,e=>{if(e.groupMap[t.id]){Object.assign(e.groupMap[t.id],t.value);let s=e.groups.findIndex(e=>e.id===t.id);-1!==s&&Object.assign(e.groups[s],t.value)}})};var I=s(40473);let M=(0,f.K)("chatGroup"),T="fetchGroups",w="fetchGroupDetail",S=e=>{m.L.setState((0,l.jM)(t=>{t.groupMaps=e,t.groupsInit=!0}),!1,M("syncGroupMap/chat"))},C=(0,r.h)()((0,a.eh)((0,a.lt)((...e)=>{let t=((e,t)=>{let s=t=>{e((0,l.jM)(e=>{let s=v[t.type];if(s)return s(e,t)}),!1,t)};return{...y,addAgentsToGroup:async(e,s)=>{await g.X.addAgentsToGroup(e,s),await t().internal_refreshGroups()},createGroup:async(e,a,o=!1)=>{let{switchSession:r}=(0,h.L)(),i=await g.X.createGroup(e);return a&&a.length>0&&(await g.X.addAgentsToGroup(i.id,a),await new Promise(e=>{setTimeout(e,100)})),s({payload:i,type:"addGroup"}),await t().loadGroups(),await (0,h.L)().refreshSessions(),o||r(i.id),i.id},deleteGroup:async e=>{let a=await g.X.getGroupAgents(e);await g.X.deleteGroup(e),s({payload:e,type:"deleteGroup"});let o=(0,h.L)(),r=o.sessions||[],i=a.map(e=>{let t=r.find(t=>"agent"===t.type&&t.config?.id===e.agentId);return t&&"agent"===t.type&&t.config?.virtual?o.removeSession(t.id):null}).filter(Boolean);await Promise.all(i),await t().loadGroups(),await (0,h.L)().refreshSessions(),o.activeId===e&&o.switchSession(c.Ed)},internal_dispatchChatGroup:s,internal_refreshGroups:async()=>{await t().loadGroups();let s=(await g.X.getGroups()).reduce((e,t)=>(e[t.id]=t,e),{});n()(t().groupMap,s)||(e({groupMap:s,groupsInit:!0,isGroupsLoading:!1},!1,M("internal_refreshGroups/updateGroupMap")),S(s)),await (0,h.L)().refreshSessions()},internal_updateGroupMaps:s=>{let a=s.reduce((e,t)=>(e[t.id]=t,e),{}),o=(0,l.jM)(t().groupMap,e=>{for(let t of Object.keys(a)){let s=a[t],o=e[t];o?e[t]={...o,...s,config:o.config||s.config}:e[t]=s}});e({groupMap:o,groupsInit:!0,isGroupsLoading:!1},!1,M("internal_updateGroupMaps/chatGroup")),S(o)},loadGroups:async()=>{s({payload:!0,type:"setGroupsLoading"}),s({payload:await g.X.getGroups(),type:"loadGroups"})},pinGroup:async(e,a)=>{await g.X.updateGroup(e,{pinned:a}),s({payload:{id:e,pinned:a},type:"updateGroup"}),await t().internal_refreshGroups()},refreshGroupDetail:async e=>{await (0,d.j)([w,e])},refreshGroups:async()=>{await (0,d.j)([T,!0])},removeAgentFromGroup:async(e,s)=>{await g.X.removeAgentsFromGroup(e,[s]),await t().internal_refreshGroups()},reorderGroupMembers:async(e,s)=>{console.log("REORDER GROUP MEMBERS",e,s),await Promise.all(s.map((t,s)=>g.X.updateAgentInGroup(e,t,{order:s}))),await t().internal_refreshGroups()},toggleGroupSetting:t=>{e({showGroupSetting:t},!1,"toggleGroupSetting")},toggleThread:t=>{e({activeThreadAgentId:t},!1,"toggleThread")},updateGroup:async(e,a)=>{await g.X.updateGroup(e,a),s({payload:{id:e,value:a},type:"updateGroup"}),await t().internal_refreshGroups()},updateGroupConfig:async e=>{let a=I.a.currentGroup(t());if(!a)return;let o={...u.DM,...a.config,...e};await g.X.updateGroup(a.id,{config:o}),s({payload:{id:a.id,value:{config:o}},type:"updateGroup"}),m.L.setState((0,l.jM)(e=>{let t=e.groupMaps[a.id];t&&(e.groupMaps[a.id]={...t,config:o})}),!1,M("updateGroupConfig/syncChatStore")),await t().internal_refreshGroups()},updateGroupMeta:async e=>{let a=I.a.currentGroup(t());if(!a)return;let o=a.id;await g.X.updateGroup(o,e),s({payload:{id:o,value:e},type:"updateGroup"}),await t().internal_refreshGroups()},useFetchGroupDetail:(s,a)=>(0,p.lA)(s&&a?[w,a]:null,async([,e])=>{let t=await g.X.getGroup(e);if(!t)throw Error(`Group ${e} not found`);return t},{onSuccess:s=>{let a=t().groupMap[s.id];if(n()(a,s))return;let o={...t().groupMap,[s.id]:s};e({groupMap:o},!1,M("useFetchGroupDetail/onSuccess",{groupId:s.id})),S(o)}}),useFetchGroups:(s,a)=>(0,p.lA)(s?[T,a]:null,async()=>g.X.getGroups(),{fallbackData:[],onSuccess:s=>{let a=s.reduce((e,t)=>(e[t.id]=t,e),{}),o=t().groupMap,r={...o,...a};t().groupsInit&&n()(o,r)||(e({groupMap:r,groupsInit:!0,isGroupsLoading:!1},!1,M("useFetchGroups/onSuccess")),S(r))},suspense:!0})}})(...e);return{...y,...t}})),o.x),b=()=>C.getState()},50949:(e,t,s)=>{s.d(t,{J3:()=>l,a9:()=>d,oT:()=>n,u4:()=>u,w9:()=>c});var a=s(80286),o=s(94147),r=s(81196),i=s(47260);let n=(e,t)=>r.g.isModelSupportVision(e,t)((0,o.l)()),l=(e,t)=>r.g.isModelSupportVideo(e,t)((0,o.l)())||!1,d=(e,t)=>{let s=e,a=(0,o.l)().enabledAiModels?.find(s=>s.id===e&&s.providerId===t);return a&&a.config?.deploymentName&&(s=a.config?.deploymentName),s},c=e=>i.w.isProviderFetchOnClient(e)((0,o.l)()),u=e=>{if(Object.values(a.ModelProvider).includes(e))return e;let t=i.w.providerConfigById(e)((0,o.l)());return t?.settings.sdkType||"openai"}},51753:(e,t,s)=>{s.d(t,{D:()=>r});var a=s(81196),o=s(94147);let r=(e,t)=>a.g.isModelSupportToolUse(e,t)((0,o.l)())||!1},56016:(e,t,s)=>{s.d(t,{C:()=>i});var a=s(96987),o=s(99278),r=s(35245);let i={getAvatar:e=>e.avatar||o.k_,getSessionById:(e,t)=>{let s=t.find(t=>t.id===e);return s||r.W5},getSessionPinned:e=>e.pinned,getTitle:e=>e.title||(0,a.t)("defaultSession",{ns:"common"})}},56790:(e,t,s)=>{s.d(t,{T:()=>l});var a=s(35245),o=s(77605);class r{async execute(e,t){let s=this.controllers.get(e);s&&s.abort("New request triggered");let a=new AbortController;this.controllers.set(e,a);try{return await t(a.signal)}finally{this.controllers.get(e)===a&&this.controllers.delete(e)}}cancel(e){let t=this.controllers.get(e);t&&(t.abort("Manually cancelled"),this.controllers.delete(e))}cancelAll(){for(let e of this.controllers.values())e.abort("All requests cancelled");this.controllers.clear()}constructor(){this.controllers=new Map}}let i=new r;class n{constructor(){this.createMessage=async({sessionId:e,...t})=>o.du.message.createMessage.mutate({...t,sessionId:e?this.toDbSessionId(e):void 0}),this.getMessages=async(e,t,s)=>await o.du.message.getMessages.query({groupId:s,sessionId:this.toDbSessionId(e),topicId:t}),this.getGroupMessages=async(e,t)=>await o.du.message.getMessages.query({groupId:e,topicId:t}),this.countMessages=async e=>o.du.message.count.query(e),this.countWords=async e=>o.du.message.countWords.query(e),this.rankModels=async()=>o.du.message.rankModels.query(),this.getHeatmaps=async()=>o.du.message.getHeatmaps.query(),this.updateMessageError=async(e,t,s)=>{let a=t.type?t:{body:t,message:t.message,type:"ApplicationRuntimeError"};return o.du.message.update.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:{error:a}})},this.updateMessagePluginArguments=async(e,t)=>{let s="string"==typeof t?t:JSON.stringify(t);return o.du.message.updateMessagePlugin.mutate({id:e,value:{arguments:s}})},this.updateMessage=async(e,t,s)=>o.du.message.update.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:t}),this.updateMessageTranslate=async(e,t)=>o.du.message.updateTranslate.mutate({id:e,value:t}),this.updateMessageTTS=async(e,t)=>o.du.message.updateTTS.mutate({id:e,value:t}),this.updateMessageMetadata=async(e,t,s)=>i.execute(`message-metadata-${e}`,a=>o.du.message.updateMetadata.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:t},{signal:a})),this.updateMessagePluginState=async(e,t,s)=>o.du.message.updatePluginState.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:t}),this.updateMessagePluginError=async(e,t,s)=>o.du.message.updatePluginError.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:t}),this.updateMessagePlugin=async(e,t,s)=>o.du.message.updateMessagePlugin.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:t}),this.updateMessageRAG=async(e,t,s)=>o.du.message.updateMessageRAG.mutate({id:e,sessionId:s?.sessionId,topicId:s?.topicId,value:t}),this.removeMessage=async(e,t)=>o.du.message.removeMessage.mutate({id:e,sessionId:t?.sessionId,topicId:t?.topicId}),this.removeMessages=async(e,t)=>o.du.message.removeMessages.mutate({ids:e,sessionId:t?.sessionId,topicId:t?.topicId}),this.removeMessagesByAssistant=async(e,t)=>o.du.message.removeMessagesByAssistant.mutate({sessionId:this.toDbSessionId(e),topicId:t}),this.removeMessagesByGroup=async(e,t)=>o.du.message.removeMessagesByGroup.mutate({groupId:e,topicId:t}),this.removeAllMessages=async()=>o.du.message.removeAllMessages.mutate(),this.toDbSessionId=e=>e===a.Ed?null:e}}let l=new n},60051:(e,t,s)=>{s.d(t,{P:()=>i,T:()=>n});var a=s(99278),o=s(99061),r=s(67095);let i=[],n={chatConfig:e=>e.config.chatConfig||o.iD,currentAgentConfig:e=>(0,r.h)(o.HA,e.config),currentChatConfig:e=>(0,r.h)(o.iD,e.config.chatConfig),currentMetaConfig:e=>(0,r.h)(a.M3,e.meta),currentTtsConfig:e=>(0,r.h)(o.Nm,e.config.tts),openingMessage:e=>e.config.openingMessage,openingQuestions:e=>e.config.openingQuestions||i}},62016:(e,t,s)=>{s.d(t,{z:()=>d});var a=s(35245),o=s(56016);let r=e=>e.defaultSessions,i=e=>t=>o.C.getSessionById(e,t.sessions),n=e=>{if(e.activeId)return e.sessions.find(t=>t.id===e.activeId)},l=e=>e.isSessionsFirstFetchFinished,d={currentGroupAgents:e=>{let t=n(e);return t&&"group"!==t.type?[]:t?t.members??[]:[]},currentSession:n,currentSessionSafe:e=>n(e)||a.W5,customSessionGroups:e=>e.customSessionGroups,defaultSessions:r,getSessionById:i,getSessionMetaById:e=>t=>{let s=i(e)(t);return s?s.meta:{}},hasCustomAgents:e=>r(e).length>0,isCurrentSessionGroupSession:e=>{let t=n(e);return t?.type==="group"},isInboxSession:e=>e.activeId===a.Ed,isSessionListInit:l,isSomeSessionActive:e=>!!e.activeId&&l(e),pinnedSessions:e=>e.pinnedSessions}},64752:(e,t,s)=>{s.d(t,{createHeaderWithAuth:()=>y,ZE:()=>h,q9:()=>f});var a=s(74551),o=s(32901),r=s(80286),i=s(47260),n=s(94147),l=s(38759),d=s(45282),c=s(61520),u=s(96773);let p=e=>new TextEncoder().encode(e),g=e=>btoa(String.fromCharCode(...((e,t)=>{let s=new Uint8Array(e.length);for(let[a,o]of e.entries())s[a]=o^t[a%t.length];return s})(p(JSON.stringify(e)),p(u.RX))));var m=s(50949);let h=e=>{let t=i.w.providerKeyVaults(e)(n.d.getState())||{},s=(0,m.u4)(e);return{...((e,t)=>{switch(e){case r.ModelProvider.Bedrock:{let{accessKeyId:e,region:s,secretAccessKey:a,sessionToken:o}=t;return{accessKeyId:e,accessKeySecret:a,apiKey:(a||"")+(e||""),awsAccessKeyId:e,awsRegion:s,awsSecretAccessKey:a,awsSessionToken:o,region:s,sessionToken:o}}case r.ModelProvider.Azure:return{apiKey:o.SU.pick(t.apiKey),apiVersion:t.apiVersion,azureApiVersion:t.apiVersion,baseURL:t.baseURL||t.endpoint};case r.ModelProvider.Ollama:return{baseURL:t?.baseURL};case r.ModelProvider.Cloudflare:return{apiKey:o.SU.pick(t?.apiKey),baseURLOrAccountID:t?.baseURLOrAccountID,cloudflareBaseURLOrAccountID:t?.baseURLOrAccountID};case r.ModelProvider.ComfyUI:return{apiKey:t?.apiKey,authType:t?.authType,baseURL:t?.baseURL,customHeaders:t?.customHeaders,password:t?.password,username:t?.username};case r.ModelProvider.VertexAI:return{apiKey:t?.apiKey,baseURL:t?.baseURL,vertexAIRegion:t?.region};default:return{apiKey:o.SU.pick(t?.apiKey),baseURL:t?.baseURL}}})(s,t),runtimeProvider:s}},f=e=>g(h(e)),y=async e=>{let t=e?.payload||{};e?.provider&&(t={...t,...h(e?.provider)});let s=((e={})=>g({accessCode:d.t.password(l.k.getState()),userId:c.f.userId(l.k.getState()),...e}))(t);return{...e?.headers,[a.Zk]:s}}},64811:(e,t,s)=>{s.d(t,{L:()=>F,B:()=>D});var a=s(14308),o=s(50786),r=s(23993),i=s(12020),n=s(41734);let l={customSessionGroups:[],sessionGroups:[],activeId:"inbox",defaultSessions:[],isSearching:!1,isSessionsFirstFetchFinished:!1,pinnedSessions:[],searchKeywords:"",sessions:[]};var d=s(70674),c=s(31021),u=s.n(c),p=s(96987),g=s(85366),m=s(64911),h=s(29914),f=s(19530),y=s(35245),v=s(99061),I=s(46265),M=s(77152),T=s(30333),w=s(50243),S=s(38759),C=s(42897),b=s(61520),_=s(3296),A=s(67095),x=s(61497),k=s(85601),E=s(62016),L=s(17869);let O=(0,x.K)("session"),P="fetchSessions",R=(0,n.t)("session"),D=(0,r.h)()((0,a.eh)(R((...e)=>({...l,...((e,t)=>({clearSessions:async()=>{await T.sessionService.removeAllSessions(),await t().refreshSessions()},createSession:async(e,s=!0)=>{let{switchSession:a,refreshSessions:o}=t(),r=(0,A.h)(y.W5,C.w0.defaultAgent(S.k.getState())),i=(0,A.h)(r,e),n=await T.sessionService.createSession(_.r.Agent,i);await o();let l=(0,d.wZ)();if(l){let e=(0,S.c)(),t=b.f.userId(e);l.track({name:"new_agent_created",properties:{assistant_name:i.meta?.title||"Untitled Agent",assistant_tags:i.meta?.tags||[],session_id:n,user_id:t||"anonymous"}})}return s&&a(n),n},duplicateSession:async e=>{let{switchSession:s,refreshSessions:a}=t(),o=E.z.getSessionById(e)(t());if(!o)return;let r=L.G.getTitle(o.meta),i=(0,p.t)("duplicateSession.title",{ns:"chat",title:r}),n="duplicateSession.loading";h.iU.loading({content:(0,p.t)("duplicateSession.loading",{ns:"chat"}),duration:0,key:n});let l=await T.sessionService.cloneSession(e,i);if(!l){h.iU.destroy(n),h.iU.error((0,p.t)("copyFail",{ns:"common"}));return}await a(),h.iU.destroy(n),h.iU.success((0,p.t)("duplicateSession.success",{ns:"chat"})),s(l)},pinSession:async(e,s)=>{await t().internal_updateSession(e,{pinned:s})},removeSession:async e=>{await T.sessionService.removeSession(e),await t().refreshSessions(),e===t().activeId&&t().switchSession(y.Ed)},switchSession:s=>{t().activeId!==s&&e({activeId:s},!1,O(`activeSession/${s}`))},triggerSessionUpdate:async e=>{await t().internal_updateSession(e,{updatedAt:new Date})},updateSearchKeywords:t=>{e({isSearching:!!t,sessionSearchKeywords:t},!1,O("updateSearchKeywords"))},updateSessionGroupId:async(e,s)=>{let a=E.z.getSessionById(e)(t());a?.type==="group"?(await M.X.updateGroup(e,{groupId:"default"===s?null:s}),await t().refreshSessions()):await t().internal_updateSession(e,{group:s})},updateSessionMeta:async s=>{if(!E.z.currentSession(t()))return;let{activeId:a,refreshSessions:o}=t(),r=t().signalSessionMeta;r&&r.abort(f.ve);let i=new AbortController;e({signalSessionMeta:i},!1,"updateSessionMetaSignal"),await T.sessionService.updateSessionMeta(a,s,i.signal),await o()},useFetchSessions:(s,a)=>(0,I.lA)(s?[P,a]:null,()=>T.sessionService.getGroupedSessions(),{fallbackData:{sessionGroups:[],sessions:[]},onSuccess:s=>{if(t().isSessionsFirstFetchFinished&&u()(t().sessions,s.sessions)&&u()(t().sessionGroups,s.sessionGroups))return;t().internal_processSessions(s.sessions,s.sessionGroups,O("useFetchSessions/updateData"));let a=s.sessions.filter(e=>"group"===e.type);if(a.length>0){let e=(0,w.W)(),t=a.map(e=>({accessedAt:e.updatedAt,clientId:null,config:{maxResponseInRow:3,orchestratorModel:"gpt-4",orchestratorProvider:"openai",responseOrder:"sequential",responseSpeed:"medium",scene:v.DM.scene},createdAt:e.createdAt,description:e.meta?.description||"",groupId:e.group||null,id:e.id,pinned:e.pinned||!1,slug:null,title:e.meta?.title||"Untitled Group",updatedAt:e.updatedAt,userId:""}));e.internal_updateGroupMaps(t)}e({isSessionsFirstFetchFinished:!0},!1,O("useFetchSessions/onSuccess",s))},suspense:!0}),useSearchSessions:e=>(0,g.Ay)(["searchSessions",e],async()=>e?T.sessionService.searchSessions(e):[],{revalidateOnFocus:!1,revalidateOnMount:!1}),internal_dispatchSessions:e=>{let s=((e,t)=>{switch(t.type){case"addSession":return(0,k.jM)(e,e=>{let{session:s}=t;s&&e.unshift({...s,createdAt:new Date,updatedAt:new Date})});case"removeSession":return(0,k.jM)(e,e=>{let s=e.findIndex(e=>e.id===t.id);-1!==s&&e.splice(s,1)});case"updateSession":return(0,k.jM)(e,e=>{let{value:s,id:a}=t,o=e.findIndex(e=>e.id===a);-1!==o&&(e[o]={...e[o],...s,updatedAt:new Date})});default:return(0,k.jM)(e,()=>{})}})(t().sessions,e);t().internal_processSessions(s,t().sessionGroups)},internal_updateSession:async(e,s)=>{t().internal_dispatchSessions({type:"updateSession",id:e,value:s}),await T.sessionService.updateSession(e,s),await t().refreshSessions()},internal_processSessions:(t,s)=>{e({customSessionGroups:s.map(e=>({...e,children:t.filter(t=>t.group===e.id&&!t.pinned)})),defaultSessions:t.filter(e=>(!e.group||"default"===e.group)&&!e.pinned),pinnedSessions:t.filter(e=>e.pinned),sessionGroups:s,sessions:t},!1,O("processSessions"))},refreshSessions:async()=>{await (0,m.j)([P,!0])}}))(...e),...((e,t)=>({addSessionGroup:async e=>{let s=await T.sessionService.createSessionGroup(e);return await t().refreshSessions(),s},clearSessionGroups:async()=>{await T.sessionService.removeSessionGroups(),await t().refreshSessions()},removeSessionGroup:async e=>{await T.sessionService.removeSessionGroup(e),await t().refreshSessions()},updateSessionGroupName:async(e,s)=>{await T.sessionService.updateSessionGroup(e,{name:s}),await t().refreshSessions()},updateSessionGroupSort:async e=>{let s=e.map((e,t)=>({id:e.id,sort:t}));t().internal_dispatchSessionGroups({sortMap:s,type:"updateSessionGroupOrder"}),h.iU.loading({content:(0,p.t)("sessionGroup.sorting",{ns:"chat"}),duration:0,key:"updateSessionGroupSort"}),await T.sessionService.updateSessionGroupOrder(s),h.iU.destroy("updateSessionGroupSort"),h.iU.success((0,p.t)("sessionGroup.sortSuccess",{ns:"chat"})),await t().refreshSessions()},internal_dispatchSessionGroups:e=>{let s=((e,t)=>{switch(t.type){case"addSessionGroupItem":return[...e,t.item];case"deleteSessionGroupItem":return e.filter(e=>e.id!==t.id);case"updateSessionGroupItem":return e.map(e=>e.id===t.id?{...e,...t.item}:e);case"updateSessionGroupOrder":return e.map(e=>{let s=t.sortMap.find(t=>t.id===e.id)?.sort;return{...e,sort:s}}).sort((e,t)=>(e.sort||0)-(t.sort||0));default:return e}})(t().sessionGroups,e);t().internal_processSessions(t().sessions,s,"updateSessionGroups")}}))(...e)}),{name:"LobeChat_Session"+(i.C?"_DEV":"")})),o.x),F=()=>D.getState()},67103:(e,t,s)=>{s.d(t,{g:()=>o});var a=s(42897);let o={allowList:e=>(0,a.fe)(e).tool?.humanIntervention?.allowList||[],approvalMode:e=>(0,a.fe)(e).tool?.humanIntervention?.approvalMode||"manual",config:e=>(0,a.fe)(e).tool?.humanIntervention||{}}},70030:(e,t,s)=>{s.d(t,{v:()=>n});var a=s(99061),o=s(67095),r=s(42897);let i=e=>(0,o.h)(a.fw,(0,r.fe)(e).systemAgent),n={agentMeta:e=>i(e).agentMeta,generationTopic:e=>i(e).generationTopic,historyCompress:e=>i(e).historyCompress,queryRewrite:e=>i(e).queryRewrite,thread:e=>i(e).thread,topic:e=>i(e).topic,translation:e=>i(e).translation}},71171:(e,t,s)=>{s.d(t,{E1:()=>a.E1,fA:()=>i,yf:()=>r});var a=s(13082),o=s(91804);o._1.currentDisplayChatKey;let r=o._1.mainDisplayChatIDs,i={activeBaseChats:o._1.activeDisplayMessages,countMessagesByThreadId:a.E1.countDbMessagesByThreadId,currentChatKey:o._1.currentDisplayChatKey,currentChatLoadingState:o._1.currentChatLoadingState,currentToolMessages:a.E1.dbToolMessages,currentUserFiles:e=>a.E1.dbUserFiles(e),getBaseChatsByKey:o._1.getDisplayMessagesByKey,getMessageById:o._1.getDisplayMessageById,getSupervisorTodos:o._1.getSupervisorTodos,getThreadMessageIDs:o._1.getThreadMessageIDs,getThreadMessages:o._1.getThreadMessages,getTraceIdByMessageId:a.E1.getTraceIdByDbMessageId,inboxActiveTopicMessages:o._1.inboxActiveTopicDisplayMessages,isCurrentChatLoaded:o._1.isCurrentDisplayChatLoaded,isSupervisorLoading:o._1.isSupervisorLoading,latestMessage:a.E1.latestDbMessage,mainAIChats:o._1.mainAIChats,mainAIChatsMessageString:o._1.mainAIChatsMessageString,mainAIChatsWithHistoryConfig:o._1.mainAIChatsWithHistoryConfig,mainAILatestMessageReasoningContent:o._1.mainAILatestMessageReasoningContent,mainDisplayChatIDs:o._1.mainDisplayChatIDs,mainDisplayChats:o._1.mainDisplayChats,showInboxWelcome:o._1.showInboxWelcome}},71411:(e,t,s)=>{s.d(t,{O:()=>H});var a=s(79998),o=s(16748),r=s(22309),i=s(13839),n=s(3851),l=s(80286),d=s(96773),c=s(99061),u=s(64861),p=s(77799),g=s(32559),m=s(45541),h=s(88990),f=s(82964),y=s(94147),v=s(81196),I=s(47260),M=s(64811),T=s(17869),w=s(74038),S=s(68172),C=s(38759),b=s(37316),_=s(71457),A=s(61520),x=s(76157),k=s(74551),E=s(30791).hp;let L=e=>{let t;return{[k.MW]:(t=new TextEncoder().encode(JSON.stringify(e)),E.from(t).toString("base64"))}};var O=s(64752),P=s(32308),R=s(28557),D=s(47194),F=s(15361),G=s(32901),B=s(51753),U=s(35863),$=s(50949);let N=async({messages:e=[],tools:t,model:s,provider:a,systemRole:o,inputTemplate:r,enableHistoryCount:i,historyCount:n,historySummary:l})=>{let d=new D.UU,c=new D.gs({pipeline:[new D.NT({enableHistoryCount:i,historyCount:n}),new D.gz({systemRole:o}),new D.TE({getToolSystemRoles:e=>U.P.enabledSystemRoles(e)((0,w.getToolStoreState)()),isCanUseFC:B.D,model:s,provider:a,tools:t}),new D.GO({formatHistorySummary:F.jY,historySummary:l}),new D.tv({inputTemplate:r}),new D.HV({variableGenerators:G.Om}),new D.VS,new D.f2({fileContext:{enabled:!0,includeFileUrl:!k.xl},isCanUseVideo:$.J3,isCanUseVision:$.oT,model:s,provider:a}),new D.TT({genToolCallingName:d.generate.bind(d),isCanUseFC:B.D,model:s,provider:a}),new D.FK,new D.eu]});return(await c.process({messages:e})).messages};class j{constructor(){this.createAssistantMessage=async({plugins:e,messages:t,...s},a)=>{let o=(0,n.A)({model:c.HA.model,stream:!0,...c.HA.params},s),r=(0,p.H)(o.model,o.provider),i=[...e||[]],{tools:l,enabledToolIds:d}=(0,g.wp)({model:o.model,provider:o.provider}).generateToolsDetailed({model:o.model,provider:o.provider,toolIds:i}),u=(0,m._)(),I=h.e.currentAgentConfig(u),M=f.c.currentChatConfig(u),T=await N({enableHistoryCount:f.c.enableHistoryCount(u),historyCount:f.c.historyCount(u)+2,inputTemplate:M.inputTemplate,messages:t,model:o.model,provider:o.provider,sessionId:a?.trace?.sessionId,systemRole:I.systemRole,tools:d}),w={},S=(0,y.l)();if(v.g.isModelHasExtendParams(o.model,o.provider)(S)){let e=v.g.modelExtendParams(o.model,o.provider)(S);e.includes("enableReasoning")?M.enableReasoning?w.thinking={budget_tokens:M.reasoningBudgetToken||1024,type:"enabled"}:w.thinking={budget_tokens:0,type:"disabled"}:e.includes("reasoningBudgetToken")&&(w.thinking={budget_tokens:M.reasoningBudgetToken||1024,type:"enabled"}),e.includes("disableContextCaching")&&M.disableContextCaching&&(w.enabledContextCaching=!1),e.includes("reasoningEffort")&&M.reasoningEffort&&(w.reasoning_effort=M.reasoningEffort),e.includes("gpt5ReasoningEffort")&&M.gpt5ReasoningEffort&&(w.reasoning_effort=M.gpt5ReasoningEffort),e.includes("gpt5_1ReasoningEffort")&&M.gpt5_1ReasoningEffort&&(w.reasoning_effort=M.gpt5_1ReasoningEffort),e.includes("textVerbosity")&&M.textVerbosity&&(w.verbosity=M.textVerbosity),e.includes("thinking")&&M.thinking&&(w.thinking={type:M.thinking}),e.includes("thinkingBudget")&&void 0!==M.thinkingBudget&&(w.thinkingBudget=M.thinkingBudget),e.includes("thinkingLevel")&&M.thinkingLevel&&(w.thinkingLevel=M.thinkingLevel),e.includes("urlContext")&&M.urlContext&&(w.urlContext=M.urlContext)}return this.getChatCompletion({...s,...w,enabledSearch:!!r.enabledSearch&&!!r.useModelSearch||void 0,messages:T,tools:l},a)},this.createAssistantMessageStream=async({params:e,abortController:t,onAbort:s,onMessageHandle:a,onErrorHandle:o,onFinish:i,trace:n,historySummary:l})=>{await this.createAssistantMessage(e,{historySummary:l,onAbort:s,onErrorHandle:o,onFinish:i,onMessageHandle:a,signal:t?.signal,trace:this.mapTrace(n,r.WK.Chat)})},this.getChatCompletion=async(e,t)=>{let i,{signal:d,responseAnimation:p}=t??{},{provider:g=l.ModelProvider.OpenAI,...h}=e,v=h.model||c.HA.model;[l.ModelProvider.Azure,l.ModelProvider.Volcengine,l.ModelProvider.AzureAI,l.ModelProvider.Qwen].includes(g)&&(v=(0,$.a9)(v,g));let M=I.w.isProviderEnableResponseApi(g)((0,y.l)())?"responses":void 0,T=f.c.currentChatConfig((0,m._)()),w=(0,n.A)({model:c.HA.model,stream:!1!==T.enableStreaming,...c.HA.params},{...h,apiMode:M,model:v});null===w.temperature&&(w.temperature=void 0),null===w.top_p&&(w.top_p=void 0),null===w.presence_penalty&&(w.presence_penalty=void 0),null===w.frequency_penalty&&(w.frequency_penalty=void 0);let S=(0,$.u4)(g),_=(0,$.w9)(g);u.xl?i=x.T:_&&(i=async()=>{try{return await this.fetchOnClient({payload:w,provider:g,runtimeProvider:S,signal:d})}catch(l){var e;let t,{errorType:s=r.T_.BadRequest,error:a,...i}=l,n=a||l;return console.error(`Route: [${g}] ${s}:`,n),e={error:n,...i,provider:g},("number"!=typeof(t=(e=>{if(e.toString().includes("Invalid"))return 401;switch(e){case o.Y1.InvalidProviderAPIKey:case o.Y1.NoOpenAIAPIKey:return 401;case o.Y1.ExceededContextWindow:case r.T_.SubscriptionKeyMismatch:case r.T_.SystemTimeNotMatchError:return 400;case o.Y1.LocationNotSupportError:return 403;case o.Y1.ModelNotFound:return 404;case o.Y1.InsufficientQuota:case o.Y1.QuotaLimitReached:return 429;case o.Y1.AgentRuntimeError:return 470;case o.Y1.ProviderBizError:return 471;case o.Y1.OllamaServiceUnavailable:case r.T_.OllamaServiceUnavailable:case o.Y1.OllamaBizError:return 472}return e})(s))||t<200||t>599)&&console.error(`current StatusCode: \`${t}\` .`,"Please go to `./src/app/api/errorResponse.ts` to defined the statusCode."),new Response(JSON.stringify({body:e,errorType:s}),{status:t})}});let A=L({...t?.trace}),k=await (0,O.createHeaderWithAuth)({headers:{"Content-Type":"application/json",...A},provider:g}),{DEFAULT_MODEL_PROVIDER_LIST:E}=await Promise.resolve().then(s.bind(s,67400)),R=E.find(e=>e.id===g),D=b.v.transitionMode((0,C.c)()),F=[R?.settings?.responseAnimation||{},D,p].reduce((e,t)=>(0,n.A)(e,(0,a.Pv)(t)),{});return(0,a.aY)(P.Sn.chat(S),{body:JSON.stringify(w),fetcher:i,headers:k,method:"POST",onAbort:t?.onAbort,onErrorHandle:t?.onErrorHandle,onFinish:t?.onFinish,onMessageHandle:t?.onMessageHandle,responseAnimation:F,signal:d})},this.runPluginApi=async(e,t)=>{let s=(0,w.getToolStoreState)(),o=S.w.getPluginSettingsById(e.identifier)(s),n=S.w.getToolManifestById(e.identifier)(s),l=L(this.mapTrace(t?.trace,r.WK.ToolCalling)),d=await (0,O.createHeaderWithAuth)({headers:{...(0,i.lZ)(o),...l}}),c=n?.gateway??P.Sn.gateway,u=await fetch(c,{body:JSON.stringify({...e,manifest:n}),headers:d,method:"POST",signal:t?.signal});if(!u.ok)throw await (0,a.EB)(u);return{text:await u.text(),traceId:u.headers.get(k.g_)}},this.fetchPresetTaskResult=async({params:e,onMessageHandle:t,onFinish:s,onError:a,onLoadingChange:o,abortController:i,trace:n})=>{let l=(e,t)=>{o?.(!1),i?.signal.aborted||(a?.(e,t),console.error(e))};o?.(!0);try{let a=await N({messages:e.messages,model:e.model,provider:e.provider,tools:e.plugins}),d=(0,g.QG)().generateTools({model:e.model,provider:e.provider,toolIds:e.plugins});delete e.plugins,await this.getChatCompletion({...e,messages:a,tools:d},{onErrorHandle:e=>{l(Error(e.message),e)},onFinish:s,onMessageHandle:t,signal:i?.signal,trace:this.mapTrace(n,r.WK.SystemChain)}),o?.(!1)}catch(e){l(e)}},this.mapTrace=(e,t)=>{let s=T.G.currentAgentMeta((0,M.L)()).tags||[];return _.U.userAllowTrace((0,C.c)())?{...e,enabled:!0,tags:[t,...e?.tags||[],...s].filter(Boolean),userId:A.f.userId(C.k.getState())}:{...e,enabled:!1}},this.fetchOnClient=async e=>{let t=C.k.getState();if(d.S4&&!t.isSignedIn)throw o.MB.createError(r.T_.InvalidAccessCode);let s=await (0,R.H)({payload:e.payload,provider:e.provider,runtimeProvider:e.runtimeProvider}),a=e.payload;return s.chat(a,{signal:e.signal})}}}let H=new j},77152:(e,t,s)=>{s.d(t,{X:()=>r});var a=s(77605);class o{constructor(){this.createGroup=e=>a.du.group.createGroup.mutate({...e,config:e.config}),this.updateGroup=(e,t)=>a.du.group.updateGroup.mutate({id:e,value:{...t,config:t.config}}),this.deleteGroup=e=>a.du.group.deleteGroup.mutate({id:e}),this.getGroup=e=>a.du.group.getGroup.query({id:e}),this.getGroups=()=>a.du.group.getGroups.query(),this.addAgentsToGroup=(e,t)=>a.du.group.addAgentsToGroup.mutate({agentIds:t,groupId:e}),this.removeAgentsFromGroup=(e,t)=>a.du.group.removeAgentsFromGroup.mutate({agentIds:t,groupId:e}),this.updateAgentInGroup=(e,t,s)=>a.du.group.updateAgentInGroup.mutate({agentId:t,groupId:e,updates:{order:null===s.order?void 0:s.order,role:null===s.role?void 0:s.role}}),this.getGroupAgents=e=>a.du.group.getGroupAgents.query({groupId:e})}}let r=new o},77799:(e,t,s)=>{s.d(t,{H:()=>l});var a=s(45541),o=s(82964),r=s(94147),i=s(47260),n=s(81196);let l=(e,t)=>{let s=o.c.currentChatConfig((0,a._)()),l=(0,r.l)(),d="off"!==s.searchMode,c=i.w.isProviderHasBuiltinSearch(t)(l),u=n.g.isModelHasBuiltinSearch(e,t)(l),p=n.g.isModelBuiltinSearchInternal(e,t)(l),g=(c||u)&&s.useModelBuiltinSearch||p||!1;return{enabledSearch:d,isModelHasBuiltinSearch:u,isProviderHasBuiltinSearch:c,useApplicationBuiltinSearchTool:d&&!g,useModelSearch:g}}},81196:(e,t,s)=>{s.d(t,{g:()=>c});var a=s(80286),o=s(88573);let r=e=>e.aiProviderModelList.filter(e=>e.enabled),i=e=>e.aiProviderModelList.length,n=(e,t)=>s=>s.enabledAiModels?.find(s=>s.id===e&&(!t||t===s.providerId)),l=(e,t)=>s=>{let a=n(e,t)(s);return a?.settings?.extendParams},d=(e,t)=>s=>{let a=n(e,t)(s);return a?.settings?.searchImpl},c={aiProviderChatModelListIds:e=>e.aiProviderModelList.filter(e=>"chat"===e.type).map(e=>e.id),disabledAiProviderModelList:e=>e.aiProviderModelList.filter(e=>!e.enabled),enabledAiProviderModelList:r,filteredAiProviderModelList:e=>{let t=e.modelSearchKeyword.toLowerCase().trim();return e.aiProviderModelList.filter(e=>e.id.toLowerCase().includes(t)||e.displayName?.toLowerCase().includes(t))},getAiModelById:e=>t=>t.aiProviderModelList.find(t=>t.id===e),getEnabledModelById:n,getModelCard:(e,t)=>s=>s.builtinAiModelList.find(s=>s.id===e&&s.providerId===t),hasRemoteModels:e=>e.aiProviderModelList.some(e=>e.source===a.AiModelSourceEnum.Remote),isEmptyAiProviderModelList:e=>0===i(e),isModelBuiltinSearchInternal:(e,t)=>s=>d(e,t)(s)===o.P.Internal,isModelEnabled:e=>t=>r(t).some(t=>t.id===e),isModelHasBuiltinSearch:(e,t)=>s=>!!d(e,t)(s),isModelHasBuiltinSearchConfig:(e,t)=>s=>{let a=d(e,t)(s);return!!a&&[o.P.Tool,o.P.Params].includes(a)},isModelHasContextWindowToken:(e,t)=>s=>{let a=n(e,t)(s);return"number"==typeof a?.contextWindowTokens},isModelHasExtendParams:(e,t)=>s=>{let a=l(e,t)(s);return!!a&&a.length>0},isModelLoading:e=>t=>t.aiModelLoadingIds.includes(e),isModelSupportFiles:(e,t)=>s=>{let a=n(e,t)(s);return a?.abilities?.files},isModelSupportReasoning:(e,t)=>s=>{let a=n(e,t)(s);return a?.abilities?.reasoning},isModelSupportToolUse:(e,t)=>s=>{let a=n(e,t)(s);return a?.abilities?.functionCall||!1},isModelSupportVideo:(e,t)=>s=>{let a=n(e,t)(s);return a?.abilities?.video},isModelSupportVision:(e,t)=>s=>{let a=n(e,t)(s);return a?.abilities?.vision||!1},modelBuiltinSearchImpl:d,modelContextWindowTokens:(e,t)=>s=>{let a=n(e,t)(s);return a?.contextWindowTokens},modelExtendParams:l,totalAiProviderModelList:i}},82964:(e,t,s)=>{s.d(t,{c:()=>u});let a=new Set(["claude-haiku-4-5-20251001","claude-sonnet-4-5-latest","claude-sonnet-4-5-20250929","anthropic/claude-sonnet-4.5","claude-opus-4-latest","claude-opus-4-20250514","claude-sonnet-4-latest","claude-sonnet-4-20250514","claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","claude-3-5-sonnet-latest","claude-3-5-sonnet-20241022","claude-3-5-sonnet-20240620","claude-3-5-haiku-latest","claude-3-5-haiku-20241022","us.anthropic.claude-sonnet-4-5-20250929-v1:0","anthropic.claude-sonnet-4-5-20250929-v1:0","us.anthropic.claude-haiku-4-5-20251001-v1:0","anthropic.claude-haiku-4-5-20251001-v1:0"]),o=new Set(["claude-opus-4-latest","claude-opus-4-20250514","claude-sonnet-4-latest","claude-sonnet-4-20250514","claude-sonnet-4-5-latest","claude-sonnet-4-5-20250929","claude-haiku-4-5-20251001","anthropic/claude-sonnet-4.5","claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","us.anthropic.claude-sonnet-4-5-20250929-v1:0","anthropic.claude-sonnet-4-5-20250929-v1:0","us.anthropic.claude-haiku-4-5-20251001-v1:0","anthropic.claude-haiku-4-5-20251001-v1:0"]);var r=s(99061),i=s(88990);let n=e=>(0,i.p)(e).chatConfig||{},l=e=>n(e).searchMode||"off",d=e=>"off"!==l(e),c=e=>{let t=(0,i.p)(e),s=n(e);return!(!s.disableContextCaching&&a.has(t.model)||d(e)&&o.has(t.model))&&s.enableHistoryCount},u={agentSearchMode:l,currentChatConfig:n,displayMode:e=>n(e).displayMode||"chat",enableHistoryCount:c,enableHistoryDivider:(e,t)=>s=>{let a=n(s);return c(s)&&e>(a.historyCount??0)&&a.historyCount===e-t},historyCount:e=>n(e).historyCount??r.iD.historyCount,isAgentEnableSearch:d,searchFCModel:e=>n(e).searchFCModel||r.NN,useModelBuiltinSearch:e=>n(e).useModelBuiltinSearch}},84354:(e,t,s)=>{s.d(t,{T:()=>a});let a=(e,t)=>{let s=t;return void 0===t&&(s=null),`${e}_${s}`}},88990:(e,t,s)=>{s.d(t,{e:()=>y,p:()=>u});var a=s(74551),o=s(22309),r=s(3268),i=s(60051),n=s(44432),l=s(67095);let d=e=>(0,l.h)(a.HA,e.agentMap[a.Ed]),c=e=>t=>(0,l.h)(t.defaultAgentConfig,t.agentMap[e]),u=e=>c(e.activeId)(e),p=e=>{let t=u(e);return t?.plugins||[]},g=e=>{let t=u(e);return t?.knowledgeBases||[]},m=e=>{let t=u(e);return t?.files||[]},h=e=>{let t=u(e);return t?.tts||a.Nm},f=e=>{let t=g(e);return[...m(e).filter(e=>e.enabled).map(e=>({fileType:e.type,id:e.id,name:e.name,type:o.zW.File})),...t.filter(e=>e.enabled).map(e=>({id:e.id,name:e.name,type:o.zW.KnowledgeBase}))]},y={currentAgentConfig:u,currentAgentFiles:m,currentAgentKnowledgeBases:g,currentAgentModel:e=>{let t=u(e);return t?.model||a.UB},currentAgentModelProvider:e=>{let t=u(e);return t?.provider||a.Gr},currentAgentPlugins:p,currentAgentSystemRole:e=>u(e).systemRole,currentAgentTTS:h,currentAgentTTSVoice:e=>t=>{let s,{voice:a,ttsService:o}=h(t),i=new r.F(e);switch(o){case"openai":s=a.openai||r.F.openaiVoiceOptions?.[0].value;break;case"edge":s=a.edge||i.edgeVoiceOptions?.[0].value;break;case"microsoft":s=a.microsoft||i.microsoftVoiceOptions?.[0].value}return s||"alloy"},currentEnabledKnowledge:f,currentKnowledgeIds:e=>({fileIds:m(e).filter(e=>e.enabled).map(e=>e.id),knowledgeBaseIds:g(e).filter(e=>e.enabled).map(e=>e.id)}),displayableAgentPlugins:e=>{let t=p(e);return(0,n.T)(t)},getAgentConfigByAgentId:e=>t=>{let s=Object.keys(t.agentMap).find(s=>{let a=t.agentMap[s];return a?.id===e});return s?(0,l.h)(t.defaultAgentConfig,t.agentMap[s]):t.defaultAgentConfig},getAgentConfigById:c,hasEnabledKnowledge:e=>f(e).length>0,hasKnowledge:e=>g(e).length>0||m(e).length>0,hasSystemRole:e=>!!u(e).systemRole,inboxAgentConfig:d,inboxAgentModel:e=>d(e).model,isAgentConfigLoading:e=>!e.agentConfigInitMap[e.activeId],isInboxSession:e=>e.activeId===a.Ed,openingMessage:e=>u(e).openingMessage||"",openingQuestions:e=>u(e).openingQuestions||i.P}},91804:(e,t,s)=>{s.d(t,{_1:()=>w,oy:()=>f});var a=s(99278),o=s(35245),r=s(45541),i=s(82964),n=s(64811),l=s(17869),d=s(38759),c=s(61520),u=s(35475),p=s(84354);let g=e=>(0,p.T)(e.activeId,e.activeTopicId),m=e=>t=>(t.messagesMap[e]||[]).map(e=>({...e,meta:(e=>{switch(e.role){case"user":return{avatar:c.f.userAvatar(d.k.getState())||a.cd};case"system":return e.meta;default:if(e.groupId&&e.agentId)return l.G.getAgentMetaByAgentId(e.agentId)(n.B.getState());return l.G.currentAgentMeta(n.B.getState())}})(e)})),h=e=>e.activeId?m(g(e))(e):[],f=e=>t=>u.m4.getMessageById(h(t),e),y=(e,t)=>{if(!e.activeThreadId)return t.filter(e=>!e.threadId);let s=e.threadMaps[e.activeTopicId]?.find(t=>t.id===e.activeThreadId);if(!s)return t.filter(e=>!e.threadId);let a=t.findIndex(e=>e.id===s.sourceMessageId);return[...t.slice(0,a+1),...t.filter(t=>t.threadId===e.activeThreadId)]},v=e=>{let t=h(e);return y(e,t)},I=e=>{let t=h(e);return y(e,t)},M=e=>{let t=I(e),s=i.c.enableHistoryCount(r.o.getState()),a=i.c.historyCount(r.o.getState());return u.m4.getSlicedMessages(t,{enableHistoryCount:s,historyCount:a})},T=e=>t=>e?h(t).filter(t=>"user"===t.role&&t.targetId===e||"assistant"===t.role&&t.agentId===e&&"user"===t.targetId):[],w={activeDisplayMessages:h,currentChatLoadingState:e=>!e.messagesInit,currentDisplayChatKey:g,findLastMessageId:e=>t=>{var s=f(e)(t);if(s){if(s.children&&s.children.length>0){var a=s.children.at(-1);if(a){if(a.tools&&a.tools.length>0){let e=a.tools.at(-1);return e?.result_msg_id}return a.id}return}if(s.tools&&s.tools.length>0){let e=s.tools.at(-1);return e?.result_msg_id}return s.id}},getDisplayMessageById:f,getDisplayMessagesByKey:m,getGroupLatestMessageWithoutTools:e=>t=>{let s=f(e)(t);if(!s||"assistantGroup"!==s.role||!s.children||0===s.children.length)return;let a=s.children.at(-1);if(a&&(!a.tools||0===a.tools.length)){if(!a.content)return;return a}},getSupervisorTodos:(e,t)=>s=>e&&s.supervisorTodos[(0,p.T)(e,t)]||[],getThreadMessageIDs:e=>t=>T(e)(t).map(e=>e.id),getThreadMessages:T,inboxActiveTopicDisplayMessages:e=>{let t=e.activeTopicId,s=(0,p.T)(o.Ed,t);return e.messagesMap[s]||[]},isCurrentDisplayChatLoaded:e=>!!e.messagesMap[g(e)],isSupervisorLoading:e=>t=>t.supervisorDecisionLoading.includes(e),lastDisplayMessageId:e=>{let t=h(e);if(0!==t.length)return t.at(-1)?.id},mainAIChats:I,mainAIChatsMessageString:e=>M(e).map(e=>e.content).join(""),mainAIChatsWithHistoryConfig:M,mainAILatestMessageReasoningContent:e=>I(e).at(-1)?.reasoning?.content,mainDisplayChatIDs:e=>v(e).map(e=>e.id),mainDisplayChats:v,showInboxWelcome:e=>e.activeId===o.Ed&&0===h(e).length}},94788:(e,t,s)=>{s.d(t,{W:()=>o});var a=s(44432);let o={metaList:e=>e.builtinTools.filter(e=>!e.hidden&&!!(0,a.j)(e.identifier)).map(e=>({author:"LobeHub",identifier:e.identifier,meta:e.manifest.meta,type:"builtin"}))}},95313:(e,t,s)=>{s.d(t,{V:()=>r});var a=s(14343);class o{async listLocalFiles(e){return(0,a.dispatch)("listLocalFiles",e)}async readLocalFile(e){return(0,a.dispatch)("readLocalFile",e)}async readLocalFiles(e){return(0,a.dispatch)("readLocalFiles",e)}async searchLocalFiles(e){return(0,a.dispatch)("searchLocalFiles",e)}async openLocalFile(e){return(0,a.dispatch)("openLocalFile",e)}async openLocalFolder(e){return(0,a.dispatch)("openLocalFolder",e)}async moveLocalFiles(e){return(0,a.dispatch)("moveLocalFiles",e)}async renameLocalFile(e){return(0,a.dispatch)("renameLocalFile",e)}async writeFile(e){return(0,a.dispatch)("writeLocalFile",e)}async editLocalFile(e){return(0,a.dispatch)("editLocalFile",e)}async runCommand(e){return(0,a.dispatch)("runCommand",e)}async getCommandOutput(e){return(0,a.dispatch)("getCommandOutput",e)}async killCommand(e){return(0,a.dispatch)("killCommand",e)}async grepContent(e){return(0,a.dispatch)("grepContent",e)}async globFiles(e){return(0,a.dispatch)("globLocalFiles",e)}async openLocalFileOrFolder(e,t){return t?this.openLocalFolder({isDirectory:t,path:e}):this.openLocalFile({path:e})}async openFileFolder(e){return this.openLocalFolder({isDirectory:!1,path:e})}}let r=new o}}]);