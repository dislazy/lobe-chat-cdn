"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7120],{30179:(e,t,o)=>{o.d(t,{A:()=>D});var r=o(28802),a=o(12389),n=o(11577),s=o(50833),i=o(51997),l=o.n(i),c=o(83034),d=o(59121),u=o(80457),h=o(20480),g=o(92619),m=o(31985),p=o(3779);let f=(0,n.rU)(({css:e,token:t,prefixCls:o})=>({content:e`
      .${o}-modal-footer {
        margin: 0;
        padding: 16px;
      }
      .${o}-modal-header {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: center;

        height: 56px;
        margin-block-end: 0;
        padding: 16px;
      }
      .${o}-modal-content {
        overflow: hidden;
        padding: 0;
        border: 1px solid ${t.colorSplit};
        border-radius: ${t.borderRadiusLG}px;
      }
    `,wrap:e`
      overflow: hidden auto;
    `})),k=(0,c.memo)(({className:e,title:t,desc:o,cover:a,width:n=360,...s})=>{let{styles:i,cx:l,theme:c}=f();return(0,r.Y)(g.Ay,{theme:{token:{colorBgElevated:(0,p.a)(.005,c.colorBgContainer)}},children:(0,r.FD)(m.A,{centered:!0,className:l(i.content,e),closable:!1,maskClosable:!0,width:n,wrapClassName:i.wrap,...s,children:[a,(0,r.FD)(u.Flexbox,{padding:16,children:[(0,r.Y)("h3",{style:{fontWeight:"bold"},children:t}),(0,r.Y)("p",{style:{marginBottom:0},children:o})]})]})})}),y=(0,c.memo)(({height:e,width:t,src:o})=>{let a=(0,n.DP)();return(0,r.Y)("video",{autoPlay:!0,controls:!1,height:e,loop:!0,muted:!0,src:o,style:{background:a.colorFillSecondary,height:"auto",width:"100%"},width:t})});var w=o(98724),b=o(45628),A=o(62326),I=o(12467),C=o(12020);let x=(0,n.rU)(({css:e,token:t})=>e`
    font-size: 12px;
    color: ${t.colorTextSecondary};
  `),M=(0,c.memo)(()=>{let{t:e}=(0,d.Bd)("common"),[t,o]=(0,c.useState)(!1),[n,i]=(0,c.useState)(!1),{styles:g}=x(),{hideGitHub:m}=(0,A.wo)(I.E);return m?null:(0,r.FD)(r.FK,{children:[(0,r.Y)(u.Flexbox,{className:"settings-layout-footer",justify:"flex-end",children:(0,r.Y)(h.default,{as:"footer",className:g,flex:"none",horizontal:!0,padding:16,width:"100%",children:(0,r.FD)("div",{style:{textAlign:"center"},children:[(0,r.Y)(a.default,{icon:s.A})," ",`${e("footer.title")} `,(0,r.Y)(l(),{"aria-label":"star",href:b.U0,onClick:e=>{e.preventDefault(),o(!0)},children:e("footer.action.star")}),` ${e("footer.and")} `,(0,r.Y)(l(),{"aria-label":"feedback",href:b.ve,onClick:e=>{e.preventDefault(),i(!0)},children:e("footer.action.feedback")})," !"]})})}),(0,r.Y)(k,{cancelText:e("footer.later"),cover:(0,r.Y)(y,{height:269,src:"/videos/star.mp4?v=1",width:358}),desc:e("footer.star.desc"),okText:e("footer.star.action"),onCancel:()=>o(!1),onOk:()=>{C.i||window.open(b.U0,"__blank")},open:t,title:e("footer.star.title")}),(0,r.Y)(k,{cancelText:e("footer.later"),cover:(0,r.Y)(y,{height:269,src:"/videos/feedback.mp4?v=1",width:358}),desc:e("footer.feedback.desc",{appName:w.Se}),okText:e("footer.feedback.action"),onCancel:()=>i(!1),onOk:()=>{C.i||window.open(b.ve,"__blank")},open:n,title:e("footer.feedback.title")})]})});M.displayName="SettingFooter";let D=M},40318:(e,t,o)=>{o.d(t,{A:()=>Q});var r=o(28802),a=o(83034),n=o(15447),s=o(31021),i=o.n(s),l=o(85017),c=o(59121),d=o(83268),u=o(32308);class h{async request(e,t){let o=new Headers(t?.headers);t?.body&&!o.has("content-type")&&o.set("content-type","application/json"),this.accessToken&&!o.has("authorization")&&o.set("authorization",`Bearer ${this.accessToken}`);let r=await fetch(e,{...t,credentials:t?.credentials??"same-origin",headers:o});if(!r.ok){let e="Unknown error";try{let t=await r.json();e=t?.message??e}catch{e=await r.text()}throw Error(e||"Market request failed")}if(204!==r.status)return await r.json()}setAccessToken(e){this.accessToken=e}async createAgent(e){return this.request(u.U9.createAgent,{body:JSON.stringify(e),method:"POST"})}async getAgentDetail(e){return this.request(u.U9.getAgentDetail(e),{method:"GET"})}async checkAgentExists(e){try{return await this.getAgentDetail(e),!0}catch{return!1}}async createAgentVersion(e){let{identifier:t,...o}=e;if(!t)throw Error("Identifier is required");return this.request(u.U9.createAgentVersion,{body:JSON.stringify({identifier:t,...o}),method:"POST"})}}let g=new h,m=new Map,p=async({accountId:e,accessToken:t,marketIdentifier:o,skipCache:r=!1})=>{if(!o||!e||!t)return console.warn("[checkOwnership] Missing required parameters",{accessToken:!!t,accountId:e,marketIdentifier:o}),!1;let a=`${o}::${e??"unknown"}`,n=m.get(a);if(!r&&n&&Date.now()-n.timestamp<3e5)return console.log("[checkOwnership] Using cached result:",n.result),n.result;g.setAccessToken(t);let s=await g.getAgentDetail(o);console.log("[checkOwnership] Agent detail:",s);let i=`${s?.ownerId??""}`==`${e}`;return m.set(a,{result:i,timestamp:Date.now()}),i};var f=o(64811),k=o(17869),y=o(9274),w=o(75639),b=o(66700),A=o(68699),I=o(3675),C=o(49935),x=o(86076),M=o(62326),D=o(92941),v=o(62456),S=o(99584),P=o(69982),_=o(92912),T=o(29914),O=o(26683),F=o(45541),E=o(88990),z=o(82964),U=o(5930),Y=o(76694),B=o(49059),R=o(24080),N=o(65101),$=o(80457),V=o(74732);let H=(0,a.memo)(({agentConfig:e,chatConfig:t,files:o=[],isRemote:a=!1,knowledgeBases:n=[],meta:s,model:i,plugins:l=[],provider:d,systemRole:u,ttsConfig:h})=>{let{t:g}=(0,c.Bd)("setting"),{agentConfig:m,chatConfig:p,meta:f,model:k,plugins:y,provider:w,systemRole:b}=(()=>{if(!a||!s)return{agentConfig:e,chatConfig:t,files:o,knowledgeBases:n,meta:s,model:i,plugins:l,provider:d,systemRole:u,ttsConfig:h};let r=s.config||{};return{agentConfig:{params:r.model?.parameters||{}},chatConfig:r.chatConfig||{},files:r.files||[],knowledgeBases:r.knowledgeBases||[],meta:{avatar:s?.avatar,description:s?.description,name:s?.versionName,tags:s?.tags?[s.tags]:void 0,title:s?.name},model:r.model?.model,plugins:r.plugins?.map(e=>"string"==typeof e?e:e.identifier)||[],provider:r.model?.provider,systemRole:r.systemRole,ttsConfig:r.tts||{}}})(),A=g("agentInfoDescription.value.unset"),I=g("agentInfoDescription.value.untitled"),C=g("agentInfoDescription.plugins.empty");return(0,r.Y)("div",{style:{height:"500px",overflow:"auto"},children:(0,r.FD)($.Flexbox,{gap:16,children:[(0,r.Y)(B.JX,{bordered:!0,column:2,columns:[{dataIndex:"title",key:"title",title:g("agentInfoDescription.basic.name")},{dataIndex:"avatar",key:"avatar",render:(e,t)=>{var o;return(o=t.avatar)&&"未设置"!==o?o.startsWith("http://")||o.startsWith("https://")?(0,r.Y)(N.default,{alt:"avatar",height:40,src:o,style:{borderRadius:"50%"},width:40}):(0,r.Y)("div",{style:{fontSize:"24px",height:40,lineHeight:"40px",textAlign:"center",width:40},children:o}):A},title:g("agentInfoDescription.basic.avatar")},{dataIndex:"description",key:"description",span:2,title:g("agentInfoDescription.basic.description")},{dataIndex:"tags",key:"tags",render:(e,t)=>{let o=t.tags;return o&&o.length?o.map((e,t)=>(0,r.Y)(R.A,{color:"blue",children:e},t)):A},span:2,title:g("agentInfoDescription.basic.tags")}],dataSource:{avatar:f?.avatar||A,description:f?.description||A,tags:f?.tags?.length?f.tags:void 0,title:f?.title||f?.name||I},size:"small",title:g("agentInfoDescription.basic.title")}),(0,r.Y)(B.JX,{bordered:!0,column:1,columns:[{dataIndex:"systemRole",key:"systemRole",render:(e,t)=>t.systemRole,title:g("agentInfoDescription.role.systemRole")}],dataSource:{systemRole:b||A},size:"small",title:(0,r.FD)($.Flexbox,{align:"center",gap:8,horizontal:!0,children:[(0,r.Y)("span",{children:g("agentInfoDescription.role.title")}),(0,r.Y)(V.A,{style:{marginTop:0},value:b||""})]})}),(0,r.Y)(B.JX,{bordered:!0,column:2,columns:[{dataIndex:"model",key:"model",title:g("agentInfoDescription.model.model")},{dataIndex:"provider",key:"provider",title:g("agentInfoDescription.model.provider")},{dataIndex:"temperature",key:"temperature",title:g("agentInfoDescription.model.temperature")},{dataIndex:"topP",key:"topP",title:"Top P"},{dataIndex:"maxTokens",key:"maxTokens",span:2,title:g("agentInfoDescription.model.maxTokens")}],dataSource:{maxTokens:m?.params?.max_tokens??A,model:k||A,provider:w||A,temperature:m?.params?.temperature??A,topP:m?.params?.top_p??A},size:"small",title:g("agentInfoDescription.model.title")}),(0,r.Y)(B.JX,{bordered:!0,column:2,columns:[{dataIndex:"historyCount",key:"historyCount",title:g("agentInfoDescription.chat.historyCount")},{dataIndex:"enableHistoryCount",key:"enableHistoryCount",title:g("agentInfoDescription.chat.enableHistoryCount")},{dataIndex:"displayMode",key:"displayMode",title:g("agentInfoDescription.chat.displayMode")},{dataIndex:"searchMode",key:"searchMode",title:g("agentInfoDescription.chat.searchMode")}],dataSource:{displayMode:p?.displayMode||A,enableHistoryCount:g(p?.enableHistoryCount?"agentInfoDescription.chat.yes":"agentInfoDescription.chat.no"),historyCount:p?.historyCount??A,searchMode:p?.searchMode||A},size:"small",title:g("agentInfoDescription.chat.title")}),(0,r.Y)(B.JX,{bordered:!0,column:1,columns:[{dataIndex:"plugins",key:"plugins",render:(e,t)=>{let o=t.plugins;return o?.length?o.map((e,t)=>(0,r.Y)(R.A,{color:"green",children:e},t)):C},title:g("agentInfoDescription.plugins.title")}],dataSource:{plugins:y?.length?y:[]},size:"small",title:g("agentInfoDescription.plugins.count",{count:y?.length||0})})]})})});var L=o(48511),K=o(89098),J=o(28755),q=o(31985),j=o(27697);let G=(0,a.memo)(({identifier:e,onCancel:t,open:o})=>{let a=(0,j.Zp)(),{t:n}=(0,c.Bd)("setting"),{t:s}=(0,c.Bd)("common"),i=(0,r.FD)("div",{style:{padding:"20px 0",textAlign:"center"},children:[(0,r.Y)(L.A,{style:{color:"#52c41a",display:"block",fontSize:"48px",marginBottom:"16px"}}),(0,r.Y)("div",{style:{fontSize:"16px",marginBottom:"24px"},children:n("marketPublish.resultModal.message")}),(0,r.FD)(K.A,{children:[(0,r.Y)(J.Ay,{onClick:t,children:s("cancel")}),(0,r.Y)(J.Ay,{onClick:()=>{e&&a(`/discover/assistant/${e}`),t()},type:"primary",children:n("marketPublish.resultModal.view")})]})]});return(0,r.Y)(q.A,{centered:!0,closable:!1,footer:null,onCancel:t,open:o,title:null,width:480,children:i})}),X=(0,a.memo)(({action:e,open:t,onCancel:o,onSuccess:n})=>{let{t:s}=(0,c.Bd)("setting"),l="submit"===e,u="upload"===e,{session:h,isAuthenticated:m}=(0,d.useMarketAuth)(),p=(0,f.B)(k.G.currentAgentMeta,i()),y=(0,f.B)(e=>e.updateSessionMeta),w=(0,F.o)(E.e.currentAgentSystemRole),b=(0,U.o)(Y.c.currentLanguage),A=(0,F.o)(E.e.currentAgentConfig),I=(0,F.o)(z.c.currentChatConfig),C=(0,F.o)(E.e.currentAgentPlugins),x=(0,F.o)(E.e.currentAgentTTS),M=(0,F.o)(E.e.currentAgentModel),B=(0,F.o)(E.e.currentAgentModelProvider),R=(0,F.o)(E.e.currentAgentKnowledgeBases),N=(0,F.o)(E.e.currentAgentFiles),[$,V]=(0,a.useState)(null),[L,K]=(0,a.useState)(!1),[J,q]=(0,a.useState)(!1),[j,X]=(0,a.useState)({}),W=l?"submit":"upload-version",Z=l?s("marketPublish.modal.loading.submit"):s("marketPublish.modal.loading.upload"),Q=s("marketPublish.modal.submitButton"),ee=l?s("marketPublish.modal.title.submit"):s("marketPublish.modal.title.upload");(0,a.useEffect)(()=>{if(!u)return;let e=p?.marketIdentifier,o=h?.accessToken;if(!t||!m||!o||!e)return;let r=!1;return(async()=>{try{K(!0),g.setAccessToken(o);let t=await g.getAgentDetail(e);r||(console.log("data",t),V(t))}catch(e){console.error("Failed to fetch remote agent data:",e),r||T.iU.error(s("marketPublish.modal.messages.fetchRemoteFailed"))}finally{r||K(!1)}})(),()=>{r=!0}},[m,u,h?.accessToken,p?.marketIdentifier,t]);let et=(0,O.M)(w),eo=(0,a.useCallback)(async e=>{if(!m||!h?.accessToken)return T.iU.error(s("marketPublish.modal.messages.notAuthenticated")),!1;let t=e.changelog?.trim();if(!t)return T.iU.error({content:s("marketPublish.modal.changelog.required"),key:W}),!1;let o=p?.marketIdentifier;try{if(T.iU.loading({content:Z,key:W}),g.setAccessToken(h.accessToken),l){if(!(o=e.identifier?.trim()))return T.iU.error({content:s("marketPublish.modal.identifier.required"),key:W}),!1;try{await g.getAgentDetail(o)}catch{let e={identifier:o,name:p?.title||""};await g.createAgent(e)}}else if(!o)return T.iU.error({content:s("marketPublish.modal.messages.missingIdentifier"),key:W}),!1;let r={avatar:p?.avatar,changelog:t,config:{chatConfig:{displayMode:I?.displayMode,enableHistoryCount:I?.enableHistoryCount,historyCount:I?.historyCount,maxTokens:A?.params?.max_tokens,searchMode:I?.searchMode,temperature:A?.params?.temperature,topP:A?.params?.top_p},description:p?.description,locale:b,model:{model:M,parameters:A?.params,provider:B},plugins:C?.map(e=>({enabled:!0,identifier:e,settings:{}}))||[],systemRole:w},description:p?.description||"",identifier:o,name:p?.title||"",tags:p?.tags,tokenUsage:et};try{await g.createAgentVersion(r)}catch(t){let e=t instanceof Error?t.message:"未知错误";return T.iU.error({content:s("marketPublish.modal.messages.createVersionFailed",{message:e}),key:W}),!1}return l&&y({marketIdentifier:o}),X({identifier:o}),q(!0),T.iU.destroy(W),n?.(),!0}catch(t){console.error("Market publish failed:",t);let e=t instanceof Error?t.message:"发布失败";return T.iU.error({content:s("marketPublish.modal.messages.publishFailed",{message:e}),key:W}),!1}},[A?.params,I?.displayMode,I?.enableHistoryCount,I?.historyCount,I?.searchMode,m,l,b,p?.avatar,p?.description,p?.marketIdentifier,p?.tags,p?.title,h?.accessToken,W,Z,M,n,C,B,w,et,y]);return(0,r.FD)(r.FK,{children:[(0,r.FD)(D.K,{modalProps:{bodyStyle:{height:"70vh",overflow:"auto"},destroyOnClose:!0,onCancel:o,style:{minWidth:750}},onFinish:eo,open:t,submitter:{resetButtonProps:{style:{display:"none"}},submitButtonProps:{children:Q}},title:ee,width:"80vw",children:[l&&(0,r.Y)(v.A,{extra:s("marketPublish.modal.identifier.extra"),label:s("marketPublish.modal.identifier.label"),name:"identifier",placeholder:s("marketPublish.modal.identifier.placeholder"),rules:[{message:s("marketPublish.modal.identifier.required"),required:!0},{message:s("marketPublish.modal.identifier.patternError"),pattern:/^[\da-z-]+$/},{max:50,message:s("marketPublish.modal.identifier.lengthError"),min:3}]}),(0,r.Y)(v.A,{extra:s("marketPublish.modal.changelog.extra"),label:s("marketPublish.modal.changelog.label"),name:"changelog",placeholder:s("marketPublish.modal.changelog.placeholder"),rules:[{message:s("marketPublish.modal.changelog.required"),required:!0},{max:500,message:s("marketPublish.modal.changelog.maxLengthError")}]}),u?(0,r.FD)(S.A,{gutter:24,children:[(0,r.Y)(P.A,{span:12,children:(0,r.FD)("div",{style:{border:"1px solid #d9d9d9",borderRadius:"6px",padding:"16px"},children:[(0,r.Y)("h3",{style:{marginBottom:"16px",textAlign:"center"},children:s("marketPublish.modal.comparison.remote")}),L?(0,r.FD)("div",{style:{padding:"40px",textAlign:"center"},children:[(0,r.Y)(_.A,{size:"large"}),(0,r.Y)("div",{style:{marginTop:"16px"},children:s("marketPublish.modal.loading.fetchingRemote")})]}):(0,r.Y)(H,{isRemote:!0,meta:$||void 0})]})}),(0,r.Y)(P.A,{span:12,children:(0,r.FD)("div",{style:{border:"1px solid #d9d9d9",borderRadius:"6px",padding:"16px"},children:[(0,r.Y)("h3",{style:{marginBottom:"16px",textAlign:"center"},children:s("marketPublish.modal.comparison.local")}),(0,r.Y)(H,{agentConfig:A,chatConfig:I,files:N,knowledgeBases:R,meta:p,model:M,plugins:C,provider:B,systemRole:w,ttsConfig:x})]})})]}):(0,r.Y)("div",{style:{marginTop:24},children:(0,r.Y)(H,{agentConfig:A,chatConfig:I,files:N,knowledgeBases:R,meta:p,model:M,plugins:C,provider:B,systemRole:w,ttsConfig:x})})]}),(0,r.Y)(G,{identifier:j.identifier,onCancel:()=>q(!1),open:J})]})});X.displayName="MarketPublishModal";let W=(0,a.memo)(({action:e,marketIdentifier:t,modal:o})=>{let{t:s}=(0,c.Bd)("setting"),{t:i}=(0,c.Bd)("marketAuth"),l=(0,M.wo)(e=>e.isMobile),[u,h]=(0,a.useState)({submit:!1,upload:!1}),{isAuthenticated:g,isLoading:m,session:f,signIn:k}=(0,d.useMarketAuth)(),D=(0,a.useMemo)(()=>{if("upload"===e)return{authenticated:{icon:b.A,text:s("marketPublish.upload.button"),title:s("marketPublish.upload.tooltip")},successMessage:i("messages.success.upload"),unauthenticated:{icon:A.A,text:s("marketPublish.upload.button"),title:s("marketPublish.upload.tooltip")}};let t=s("submitAgentModal.tooltips");return{authenticated:{icon:I.A,text:t,title:t},successMessage:i("messages.success.submit"),unauthenticated:{icon:A.A,text:s("marketPublish.submit.button"),title:s("marketPublish.submit.tooltip")}}},[e,i,s]),v=(0,a.useCallback)(e=>{h(t=>({...t,[e]:!0}))},[]),S=(0,a.useCallback)(e=>{h(t=>({...t,[e]:!1}))},[]),P=(0,a.useCallback)(async()=>{if(console.log(`[MarketPublishButton][${e}] Button clicked, isAuthenticated:`,g),g){console.log(`[MarketPublishButton][${e}] User is authenticated, opening modal`),v(e);return}console.log(`[MarketPublishButton][${e}] User not authenticated, starting authorization`);try{w.Ay.loading({content:i("messages.loading"),key:"market-auth"});let o=await k();w.Ay.success({content:D.successMessage,key:"market-auth"});let r=e;if(t&&null!==o){let e=f?.accessToken;if(!e){let t=sessionStorage.getItem("market_auth_session");if(t)try{e=JSON.parse(t).accessToken}catch(e){console.error("[MarketPublishButton] Failed to parse stored session:",e)}}if(e)try{r=await p({accessToken:e,accountId:o,marketIdentifier:t,skipCache:!0})?"upload":"submit"}catch(e){console.error("[MarketPublishButton] Failed to confirm ownership:",e)}}v(r)}catch(o){console.error(`[MarketPublishButton][${e}] Authorization failed:`,o);let t=(0,x.j)(o);w.Ay.error({content:i(`errors.${t.code}`),key:"market-auth"})}},[e,D.successMessage,g,t,v,f?.accessToken,k,i]),_=g?D.authenticated:D.unauthenticated;return(0,r.FD)(r.FK,{children:[o?(0,r.Y)(n.A,{block:!0,disabled:m,icon:_.icon,loading:m,onClick:P,variant:"filled",children:_.text}):(0,r.Y)(y.A,{icon:_.icon,loading:m,onClick:P,size:(0,C.OI)(l),title:_.title}),g&&(0,r.FD)(r.FK,{children:[(0,r.Y)(X,{action:"submit",onCancel:()=>S("submit"),onSuccess:()=>S("submit"),open:u.submit}),(0,r.Y)(X,{action:"upload",onCancel:()=>S("upload"),onSuccess:()=>S("upload"),open:u.upload})]})]})});W.displayName="MarketPublishButton";let Z=(0,a.memo)(({modal:e})=>{let{t}=(0,c.Bd)("setting"),o=(0,f.B)(k.G.currentAgentMeta,i()),{isOwnAgent:s}=(e=>{let[t,o]=(0,a.useState)({isOwnAgent:null}),r=(0,d.useMarketAuth)(),{session:n,isAuthenticated:s}=r;return(0,a.useEffect)(()=>{e&&s&&n?(async()=>{try{console.log("[useAgentOwnershipCheck] Checking ownership for:",e);let t=function(e){try{let t=e.getCurrentUserInfo?.();if(t?.accountId!==null)return console.log("[useAgentOwnershipCheck] User ID from userInfo:",t?.accountId),t?.accountId??null;let o=sessionStorage.getItem("market_user_info");if(o){let e=JSON.parse(o);return console.log("[useAgentOwnershipCheck] User ID from sessionStorage:",e.accountId),e.accountId??e.sub??null}return console.warn("[useAgentOwnershipCheck] No user ID found"),null}catch(e){return console.error("[useAgentOwnershipCheck] Failed to get current user ID:",e),null}}(r);if(console.log("[useAgentOwnershipCheck] Current user ID:",t),!t){console.warn("[useAgentOwnershipCheck] Could not get current user ID"),o({isOwnAgent:!1});return}let a=await p({accessToken:n.accessToken,accountId:t,marketIdentifier:e});o({isOwnAgent:a})}catch(e){o({error:e instanceof Error?e.message:"Unknown error",isOwnAgent:!1})}})():o({isOwnAgent:!1})},[e,s,n,r]),t})(o?.marketIdentifier);switch((0,a.useMemo)(()=>o?.marketIdentifier?null===s?"loading":!0===s?"upload":"submit":"submit",[o?.marketIdentifier,s])){case"upload":return(0,r.Y)(W,{action:"upload",marketIdentifier:o?.marketIdentifier,modal:e});case"submit":return(0,r.Y)(W,{action:"submit",marketIdentifier:o?.marketIdentifier,modal:e});default:return(0,r.Y)(n.A,{block:!!e,disabled:!0,icon:l.A,loading:!0,variant:"filled",children:t("checkingPermissions")})}});Z.displayName="SmartAgentActionButton";let Q=(0,a.memo)(({modal:e})=>(0,r.Y)(Z,{modal:e}))},83268:(e,t,o)=>{o.d(t,{MarketAuthProvider:()=>p,useMarketAuth:()=>f});var r=o(28802),a=o(83034),n=o(32308),s=o(86076),i=o(55036);class l{static{this.DESKTOP_HANDOFF_CLIENT="desktop"}static{this.DESKTOP_HANDOFF_POLL_INTERVAL=1500}static{this.DESKTOP_HANDOFF_TIMEOUT=3e5}constructor(e){this.config=e}generateCodeVerifier(){console.log("[MarketOIDC] Generating PKCE code verifier");let e=new Uint8Array(32);return crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,Array.from(e))).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}async generateCodeChallenge(e){console.log("[MarketOIDC] Generating PKCE code challenge");let t=new TextEncoder().encode(e),o=await crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(o)))).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}generateState(){console.log("[MarketOIDC] Generating random state");let e=new Uint8Array(16);return crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,Array.from(e))).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}async generatePKCEParams(){console.log("[MarketOIDC] Generating PKCE parameters");let e=this.generateCodeVerifier(),t=await this.generateCodeChallenge(e),o=this.generateState();return sessionStorage.setItem("market_code_verifier",e),sessionStorage.setItem("market_state",o),console.log("[MarketOIDC] PKCE parameters generated and stored"),{codeChallenge:t,codeVerifier:e,state:o}}async buildAuthUrl(){console.log("[MarketOIDC] Building authorization URL");let e=await this.generatePKCEParams();console.log("[MarketOIDC] this.config:",this.config);let t=new URL(`${this.config.baseUrl.replace(/\/$/,"")}${n.sg.auth}`);return t.searchParams.set("client_id",this.config.clientId),t.searchParams.set("redirect_uri",this.config.redirectUri),t.searchParams.set("response_type","code"),t.searchParams.set("scope",this.config.scope),t.searchParams.set("state",e.state),t.searchParams.set("code_challenge",e.codeChallenge),t.searchParams.set("code_challenge_method","S256"),console.log("[MarketOIDC] Authorization URL built:",t.toString()),t.toString()}async exchangeCodeForToken(e,t){if(console.log("[MarketOIDC] Exchanging authorization code for token"),t!==sessionStorage.getItem("market_state"))throw console.error("[MarketOIDC] State parameter mismatch"),new s.V("stateMismatch",{message:"Invalid state parameter"});let o=sessionStorage.getItem("market_code_verifier");if(!o)throw console.error("[MarketOIDC] Code verifier not found"),new s.V("codeVerifierMissing",{message:"Code verifier not found"});let r=n.sg.token,a=new URLSearchParams({client_id:this.config.clientId,code:e,code_verifier:o,grant_type:"authorization_code",redirect_uri:this.config.redirectUri});console.log("[MarketOIDC] Sending token exchange request",{client_id:this.config.clientId,code:e,code_verifier:o,grant_type:"authorization_code",redirect_uri:this.config.redirectUri});let i=await fetch(r,{body:a.toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST"});if(console.log("[MarketOIDC] Token exchange response:",i),!i.ok){let e=await i.json().catch(()=>void 0);console.log("[MarketOIDC] Token exchange error data:",e);let t=`Token exchange failed: ${i.status} ${i.statusText} ${e?.error_description||e?.error||""}`.trim();throw console.error("[MarketOIDC]",t),new s.V("authorizationFailed",{message:t,meta:{error:e,status:i.status,statusText:i.statusText}})}let l=await i.json();return console.log("[MarketOIDC] Token exchange successful"),sessionStorage.removeItem("market_code_verifier"),sessionStorage.removeItem("market_state"),l}async startAuthorization(){console.log("[MarketOIDC] Starting authorization flow");let e=await this.buildAuthUrl(),t=sessionStorage.getItem("market_state");if(!t)throw console.error("[MarketOIDC] Missing state parameter in session storage"),new s.V("stateMissing",{message:"Authorization state not found. Please try again."});let r="1"===i.env.NEXT_PUBLIC_IS_DESKTOP_APP,a=null;if(r){console.log("[MarketOIDC] Desktop app detected, opening system browser via IPC");let{remoteServerService:r}=await Promise.resolve().then(o.bind(o,37844));try{let t=await r.requestMarketAuthorization({authUrl:e});if(!t.success)throw console.error("[MarketOIDC] Failed to open system browser:",t.error),new s.V("openBrowserFailed",{message:t.error||"Failed to open system browser",meta:{error:t.error}});console.log("[MarketOIDC] System browser opened successfully")}catch(e){throw console.error("[MarketOIDC] Exception opening system browser:",e),new s.V("openBrowserFailed",{cause:e,message:"Failed to open system browser. Please try again."})}return this.pollDesktopHandoff(t)}if(!(a=window.open(e,"market_auth","width=580,height=720,scrollbars=yes,resizable=yes")))throw console.error("[MarketOIDC] Failed to open authorization popup"),new s.V("openPopupFailed",{message:"Failed to open authorization popup. Please check popup blocker settings."});return new Promise((e,t)=>{let o,r;function n(){window.removeEventListener("message",r),o&&clearInterval(o)}r=o=>{console.log("[MarketOIDC] Received message from popup:",o.data),"MARKET_AUTH_SUCCESS"===o.data.type?(n(),e({code:o.data.code,state:o.data.state})):"MARKET_AUTH_ERROR"===o.data.type&&(n(),a?.close(),t(new s.V("authorizationFailed",{message:o.data.error||"Authorization failed",meta:{error:o.data.error}})))},window.addEventListener("message",r),a&&(o=setInterval(()=>{a.closed&&(n(),t(new s.V("popupClosed",{message:"Authorization popup was closed"})))},1e3))})}async pollDesktopHandoff(e){console.log("[MarketOIDC] Starting desktop handoff polling with state:",e);let t=Date.now(),o=`${n.sg.handoff}?id=${encodeURIComponent(e)}&client=${encodeURIComponent(l.DESKTOP_HANDOFF_CLIENT)}`;for(console.log("[MarketOIDC] Poll URL:",o);Date.now()-t<l.DESKTOP_HANDOFF_TIMEOUT;)try{let t=await fetch(o,{cache:"no-store",credentials:"include"}),r=await t.json().catch(()=>void 0);if(console.log("[MarketOIDC] Poll response:",t.status,r),200===t.status&&r?.status==="success"&&"string"==typeof r?.code)return console.log("[MarketOIDC] Desktop handoff succeeded"),{code:r.code,state:e};if(202===t.status||r?.status==="pending"){await new Promise(e=>{setTimeout(e,l.DESKTOP_HANDOFF_POLL_INTERVAL)});continue}if(404===t.status||r?.status==="consumed")throw new s.V("codeConsumed",{message:"Authorization code already consumed. Please retry."});if(410===t.status||r?.status==="expired")throw new s.V("sessionExpired",{message:"Authorization session expired. Please restart the sign-in process."});let a=r?.error||r?.message||`Handoff request failed with status ${t.status}`;throw console.error("[MarketOIDC] Handoff polling failed:",a),new s.V("handoffFailed",{message:a,meta:{data:r,status:t.status}})}catch(t){if(console.error("[MarketOIDC] Error while polling handoff endpoint:",t),t instanceof s.V)throw t;let e=t instanceof Error?t.message:"Failed to retrieve authorization result from handoff endpoint.";throw new s.V("handoffFailed",{cause:t,message:e})}throw console.warn("[MarketOIDC] Desktop handoff polling timed out"),new s.V("handoffTimeout",{message:"Authorization timeout. Please complete the authorization in the browser and try again."})}}var c=o(55036);let d=(0,a.createContext)(null),u=(e,t)=>{console.log("[MarketAuth] Storing token to cookie");let o=new Date(Date.now()+1e3*t);document.cookie=`market-bearertoken=${e}; expires=${o.toUTCString()}; path=/; secure; samesite=strict`},h=()=>{console.log("[MarketAuth] Removing token from cookie"),document.cookie="market-bearertoken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"},g=async e=>{try{let t=await fetch(n.sg.userinfo,{body:JSON.stringify({token:e}),headers:{"Content-Type":"application/json"},method:"POST"});if(console.log("[MarketAuth] User info response:",t),!t.ok)return console.error("[MarketAuth] Failed to fetch user info:",t.status,t.statusText),null;let o=await t.json();return console.log("[MarketAuth] User info fetched successfully:",o),o}catch(e){return console.error("[MarketAuth] Error fetching user info:",e),null}},m=async()=>(console.log("[MarketAuth] Refresh token not implemented yet"),!1),p=({children:e,isDesktop:t})=>{let[o,i]=(0,a.useState)(null),[p,f]=(0,a.useState)("loading"),[k,y]=(0,a.useState)(null),[w,b]=(0,a.useState)(!1);(0,a.useEffect)(()=>{{let e=c.env.NEXT_PUBLIC_MARKET_BASE_URL||"https://market.lobehub.com",o=new URL(n.sg.desktopCallback,e).toString(),r=t?o:`${window.location.origin}/market-auth-callback`;y(new l({baseUrl:e,clientId:t?"lobehub-desktop":"lobechat-com",redirectUri:r,scope:"openid profile email"}))}},[t]);let A=async()=>{if(console.log("[MarketAuth] Starting sign in process"),!k)throw console.error("[MarketAuth] OIDC client not initialized"),new s.V("oidcNotReady",{message:"OIDC client not initialized"});try{f("loading");let e=await k.startAuthorization();console.log("[MarketAuth] Authorization successful, exchanging code for token",e);let t=await k.exchangeCodeForToken(e.code,e.state);console.log("[MarketAuth] Token response:",t);let o=await g(t.accessToken),r={accessToken:t.accessToken,expiresAt:Date.now()+1e3*t.expiresIn,expiresIn:t.expiresIn,scope:t.scope,tokenType:t.tokenType,userInfo:o||void 0};return u(t.accessToken,t.expiresIn),sessionStorage.setItem("market_auth_session",JSON.stringify(r)),o&&sessionStorage.setItem("market_user_info",JSON.stringify(o)),i(r),f("authenticated"),console.log("[MarketAuth] Sign in completed successfully"),o?.accountId??null}catch(e){throw console.error("[MarketAuth] Sign in failed:",e),f("unauthenticated"),e}};return(0,a.useEffect)(()=>{(()=>{if(console.log("[MarketAuth] Attempting to restore session"),(()=>{if("undefined"==typeof document)return null;for(let e of document.cookie.split(";")){let[t,o]=e.trim().split("=");if("market-bearertoken"===t)return console.log("[MarketAuth] Found market token in cookie"),o}return null})()){let e=sessionStorage.getItem("market_auth_session");if(e)try{let t=JSON.parse(e);if(t.expiresAt>Date.now()){if(console.log("[MarketAuth] Session restored from storage"),console.log("parsedSession",t),console.log("parsedSession.userInfo",t.userInfo),console.log("sessionStorage.getItem('market_user_info')",sessionStorage.getItem("market_user_info")),!t.userInfo){let e=sessionStorage.getItem("market_user_info");if(e)try{t.userInfo=JSON.parse(e)}catch(e){console.error("[MarketAuth] Failed to parse stored user info:",e)}else b(!0)}i(t),f("authenticated");return}console.log("[MarketAuth] Stored session has expired, will trigger re-authorization"),sessionStorage.removeItem("market_auth_session"),h(),b(!0);return}catch(e){console.error("[MarketAuth] Failed to parse stored session:",e),sessionStorage.removeItem("market_auth_session"),h()}}console.log("[MarketAuth] No valid session found"),f("unauthenticated")})()},[]),(0,a.useEffect)(()=>{(async()=>{if(w&&k){b(!1);try{f("loading");let e=await k.startAuthorization(),t=await k.exchangeCodeForToken(e.code,e.state),o=await g(t.accessToken),r={accessToken:t.accessToken,expiresAt:Date.now()+1e3*t.expiresIn,expiresIn:t.expiresIn,scope:t.scope,tokenType:t.tokenType,userInfo:o||void 0};u(t.accessToken,t.expiresIn),sessionStorage.setItem("market_auth_session",JSON.stringify(r)),o&&sessionStorage.setItem("market_user_info",JSON.stringify(o)),i(r),f("authenticated"),console.log("[MarketAuth] Auto re-authorization completed successfully")}catch(e){console.error("[MarketAuth] Auto re-authorization failed:",e),f("unauthenticated")}}})()},[w,k]),(0,r.Y)(d.Provider,{value:{getCurrentUserInfo:()=>{if(console.log("getCurrentUserInfo-session",o,o?.userInfo),o?.userInfo)return o.userInfo;try{let e=sessionStorage.getItem("market_user_info");if(e)return JSON.parse(e)}catch(e){console.error("[MarketAuth] Failed to get user info from storage:",e)}return null},isAuthenticated:"authenticated"===p,isLoading:"loading"===p,refreshToken:m,session:o,signIn:A,signOut:()=>{i(null),f("unauthenticated"),h(),sessionStorage.removeItem("market_auth_session"),sessionStorage.removeItem("market_user_info")},status:p},children:e})},f=()=>{let e=(0,a.useContext)(d);if(!e)throw Error("useMarketAuth must be used within a MarketAuthProvider");return e}},86076:(e,t,o)=>{o.d(t,{V:()=>r,j:()=>n});class r extends Error{constructor(e,t={}){super(t.message??e),this.name="MarketAuthError",this.code=e,this.meta=t.meta,t.cause&&(this.cause=t.cause)}}let a=[[/authorization can only be initiated in a browser environment/i,"browserOnly"],[/authorization code already consumed/i,"codeConsumed"],[/authorization popup was closed/i,"popupClosed"],[/authorization session expired/i,"sessionExpired"],[/authorization state not found/i,"stateMissing"],[/state mismatch/i,"stateMismatch"],[/code verifier not found/i,"codeVerifierMissing"],[/failed to open authorization popup/i,"openPopupFailed"],[/failed to open system browser/i,"openBrowserFailed"],[/oidc client not initialized/i,"oidcNotReady"],[/failed to retrieve authorization result from handoff endpoint/i,"handoffFailed"],[/invalid state parameter/i,"stateMismatch"],[/timeout/i,"handoffTimeout"]],n=e=>{if(e instanceof r)return e;if(e instanceof Error){let t=a.find(([t])=>t.test(e.message));return t?new r(t[1],{cause:e}):new r("authorizationFailed",{cause:e,meta:{message:e.message}})}return new r("general")}}}]);