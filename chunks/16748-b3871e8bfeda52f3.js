"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16748],{16748:(e,t,a)=>{a.d(t,{MB:()=>O,Y1:()=>P,k6:()=>ih,TS:()=>M,W$:()=>m,NN:()=>en,r7:()=>ea});var r,i,o,n,s,l=a(60317),d=a(88185);let c=new Set(["o1-preview","o1-preview-2024-09-12","o1-mini","o1-mini-2024-09-12"]),u=new Set(["o1","o1-2024-12-17","o1-pro","o1-pro-2025-03-19","computer-use-preview","computer-use-preview-2025-03-11"]),p=new Set(["o1-pro","o1-pro-2025-03-19","o3-deep-research","o3-deep-research-2025-06-26","o3-pro","o3-pro-2025-06-10","o4-mini-deep-research","o4-mini-deep-research-2025-06-26","codex-mini-latest","computer-use-preview","computer-use-preview-2025-03-11","gpt-5-codex","gpt-5-pro","gpt-5-pro-2025-10-06"]),m=e=>{let t=e.match(/^data:([^;]+);base64,(.+)$/);if(t)return{base64:t[2],mimeType:t[1],type:"base64"};try{return new URL(e),{base64:null,mimeType:null,type:"url"}}catch{return{base64:null,mimeType:null,type:null}}};var g=a(55036),h=a(30791).hp;let y=async e=>{if("image_url"===e.type){let{type:t}=m(e.image_url.url);if("url"===t&&"1"===g.env.LLM_VISION_IMAGE_USE_BASE64){let{base64:t,mimeType:a}=await (0,l.hs)(e.image_url.url);return{...e,image_url:{...e.image_url,url:`data:${a};base64,${t}`}}}}return e},f=async e=>await Promise.all(e.map(async e=>{let t={content:"string"==typeof e.content?e.content:await Promise.all((e.content||[]).map(e=>y(e))),role:e.role};return void 0!==e.name&&(t.name=e.name),void 0!==e.tool_calls&&(t.tool_calls=e.tool_calls),void 0!==e.tool_call_id&&(t.tool_call_id=e.tool_call_id),void 0!==e.function_call&&(t.function_call=e.function_call),void 0!==e.reasoning_content&&(t.reasoning_content=e.reasoning_content),void 0!==e.reasoning_details&&(t.reasoning_details=e.reasoning_details),t})),_=async e=>{let t=[];return await Promise.all(e.map(async e=>{if(e.reasoning?.content&&t.push({summary:[{text:e.reasoning.content,type:"summary_text"}],type:"reasoning"}),"assistant"===e.role&&e.tool_calls&&e.tool_calls?.length>0)return void e.tool_calls?.forEach(e=>{t.push({arguments:e.function.name,call_id:e.id,name:e.function.name,type:"function_call"})});if("tool"===e.role)return void t.push({call_id:e.tool_call_id,output:e.content,type:"function_call_output"});if("system"===e.role)return void t.push({...e,role:"developer"});let a={...e,content:"string"==typeof e.content?e.content:await Promise.all((e.content||[]).map(async e=>{if("text"===e.type)return{...e,type:"input_text"};let t=await y(e);return{image_url:t.image_url?.url,type:"input_image"}}))};delete a.reasoning,t.push(a)})),t},v=e=>{let t=!u.has(e.model),{stream_options:a,...r}=e;return{...r,frequency_penalty:0,messages:e.messages.map(t=>({...t,role:"system"===t.role?c.has(e.model)?"user":"developer":t.role})),presence_penalty:0,stream:t,...t&&a&&{stream_options:a},temperature:1,top_p:1}},b=async e=>{let t,a;if(e.startsWith("data:")){let[r,i]=e.split(",");a=r.split(":")[1].split(";")[0],t=h.from(i,"base64")}else{let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch image from ${e}: ${r.statusText}`);t=h.from(await r.arrayBuffer()),a=r.headers.get("content-type")||"image/png"}return(0,d.eZ)(t,`image.${a.split("/")[1]}`,{type:a})};var w=a(80286),C=a(2644),T=a.n(C),E=a(52087),A=a.n(E),k=a(68096),x=a.n(k),I=a(16077);let P={AgentRuntimeError:"AgentRuntimeError",LocationNotSupportError:"LocationNotSupportError",QuotaLimitReached:"QuotaLimitReached",InsufficientQuota:"InsufficientQuota",ModelNotFound:"ModelNotFound",PermissionDenied:"PermissionDenied",ExceededContextWindow:"ExceededContextWindow",InvalidProviderAPIKey:"InvalidProviderAPIKey",ProviderBizError:"ProviderBizError",InvalidOllamaArgs:"InvalidOllamaArgs",OllamaBizError:"OllamaBizError",OllamaServiceUnavailable:"OllamaServiceUnavailable",InvalidComfyUIArgs:"InvalidComfyUIArgs",ComfyUIBizError:"ComfyUIBizError",ComfyUIServiceUnavailable:"ComfyUIServiceUnavailable",ComfyUIEmptyResult:"ComfyUIEmptyResult",ComfyUIUploadFailed:"ComfyUIUploadFailed",ComfyUIWorkflowError:"ComfyUIWorkflowError",ComfyUIModelError:"ComfyUIModelError",InvalidBedrockCredentials:"InvalidBedrockCredentials",InvalidVertexCredentials:"InvalidVertexCredentials",StreamChunkError:"StreamChunkError",InvalidGithubToken:"InvalidGithubToken",ConnectionCheckFailed:"ConnectionCheckFailed",NoOpenAIAPIKey:"NoOpenAIAPIKey"};Object.values(P);let O={chat:e=>e,createError:(e,t)=>({error:t,errorType:e}),createImage:e=>e,textToImage:e=>e},L=()=>{let e=new Date;return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`},R=async e=>{let t,a=!1,r=0,i=new TextDecoder,o=e.getReader();for(console.log(`[stream start] ${L()}`);!a;)try{let{value:e,done:n}=await o.read();if(n){console.log(`[stream finished] total chunks: ${r}
`),a=!0;break}t=e,"byteLength"in e?t=i.decode(e,{stream:!0}):"string"!=typeof e&&(t=JSON.stringify(e)),console.log(`[chunk ${r}] ${L()}`),console.log(t),console.log(""),a=n,r++}catch(e){a=!0,console.error("[debugStream error]",e),console.error("[error chunk value:]",t)}},S=e=>{console.log(`
[no stream response] ${L()}
`),console.log(JSON.stringify(e)+"\n")},U=e=>{try{let t=new URL(e),a=t.hostname.split("."),r=t.port;if(a.length>1){let e=a.length-2;a[e].length<5?a[e]="***":a[e]=a[e].replace(/^(.*?)(\w{2})(\w+)(\w{2})$/,(e,t,a,r,i)=>`${t}${a}****${i}`)}let i=a.join(".");return`${t.protocol}//${i}${r?":****":""}${t.pathname}${t.search}`}catch{return e}},M=async(e,t,r)=>{let{LOBE_DEFAULT_MODEL_LIST:i}=await Promise.resolve().then(a.bind(a,80286));if(r){let a=i.find(t=>t.id===e&&t.providerId===r);if(a&&void 0!==a[t])return a[t]}let o=i.find(t=>t.id===e);return o&&void 0!==o[t]?o[t]:"type"===t?"chat":void 0};async function N(e,t){let{LOBE_DEFAULT_MODEL_LIST:r}=await Promise.resolve().then(a.bind(a,80286));if(t){let a=r.find(a=>a.id===e&&a.providerId===t);if(a?.pricing)return a.pricing}let i=r.find(t=>t.id===e);if(i?.pricing)return i.pricing}let B=["gemini-2.5-flash-image-preview","gemini-2.5-flash-image-preview:free"];async function $(e,t){let a=await Promise.all(e.map(async e=>{let a=e.type;return!a&&t&&(a=await t(e.id)),{...e,type:a||"chat"}})),r=[];for(let e of B)for(let t of a.filter(t=>t.id.endsWith(e))){let{files:e,functionCall:a,reasoning:i,search:o,imageOutput:n,video:s,vision:l,type:d,parameters:c,...u}=t;r.push({...u,id:`${t.id}:image`,parameters:w.CHAT_MODEL_IMAGE_GENERATION_PARAMS,type:"image"})}return[...a,...r]}let D=(e,t)=>new Response(e,{headers:{"Cache-Control":"no-cache","Content-Type":"text/event-stream","X-Accel-Buffering":"no",...t?.headers}});var H=a(67176);let j=x()("lobe-cost:computeChatPricing"),G={textInput:e=>{if(void 0!==e.inputCacheMissTokens)return e.inputCacheMissTokens;if("number"==typeof e.inputCachedTokens&&"number"==typeof e.totalInputTokens)throw Error("Missing inputCacheMissTokens! You can set it by inputCacheMissTokens = totalInputTokens - inputCachedTokens");return e.inputTextTokens??e.totalInputTokens},textInput_cacheRead:e=>e.inputCachedTokens,textInput_cacheWrite:e=>e.inputWriteCacheTokens,textOutput:e=>{let{outputTextTokens:t,totalOutputTokens:a,outputReasoningTokens:r=0}=e;return"number"==typeof t?t+r:"number"==typeof a?a:"number"==typeof e.outputReasoningTokens?e.outputReasoningTokens:void 0},imageInput:e=>e.inputImageTokens,imageInput_cacheRead:()=>void 0,imageOutput:e=>e.outputImageTokens,imageGeneration:()=>void 0,audioInput:e=>e.inputAudioTokens,audioInput_cacheRead:()=>void 0,audioOutput:e=>e.outputAudioTokens},q=(e,t="USD",a=H.O)=>Math.ceil("CNY"===t?e/a:e),K=e=>e/H.C,z=(e,t)=>t*e.rate,F=(e,t)=>{if(t<=0)return{credits:0,segments:[]};let a=[],r=e.tiers??[];if(0===r.length)return{credits:0,segments:a};let i=r.find(e=>t<=("infinity"===e.upTo?1/0:e.upTo))??r.at(-1);if(!i)return{credits:0,segments:a};let o=t*i.rate;return a.push({credits:o,quantity:t,rate:i.rate}),{credits:o,segments:a}},W=(e,t,a)=>{let{key:r,missingParams:i}=((e,t)=>{if(!e.lookup?.pricingParams?.length)return{key:void 0};let a=[],r=e.lookup.pricingParams.map(e=>{let r=t?.lookupParams?.[e];return null==r?(a.push(e),"undefined"):String(r)});return a.length>0?{key:void 0,missingParams:a}:{key:r.join("_")}})(e,a);if(i&&i.length>0)return{credits:0,issues:{reason:`Missing lookup params: ${i.join(", ")}`,unit:e}};if(!r)return{credits:0,issues:{reason:"Lookup key could not be resolved",unit:e}};let o=e.lookup.prices?.[r];return"number"!=typeof o?{credits:0,issues:{reason:`Lookup price not found for key "${r}"`,unit:e},key:r}:{credits:t*o,key:r}},Y=(e,t)=>{let a=G[e.name],r=a?.(t);return"number"==typeof r?r:void 0},J=(e,t,a)=>{if(!t)return e;let r=((e,t,a)=>{if(!e)return;let r=[],i=[],o=e.currency||"USD",n=a?.usdToCnyRate??H.O;for(let s of e.units){let e=Y(s,t);if(void 0!==e){if("fixed"===s.strategy){if("millionTokens"!==s.unit)throw Error(`Unsupported chat pricing unit: ${s.unit}`);let t=q(z(s,e),o,n);r.push({cost:K(t),credits:t,quantity:e,currency:o,unit:s});continue}if("tiered"===s.strategy){let{credits:t,segments:a}=F(s,e),i=q(t,o,n);r.push({cost:K(i),credits:i,quantity:e,currency:o,segments:a,unit:s});continue}if("lookup"===s.strategy){let{credits:t,key:l,issues:d}=W(s,e,a);d&&i.push(d);let c=q(t,o,n);r.push({cost:K(c),credits:c,lookupKey:l,quantity:e,currency:o,unit:s});continue}i.push({reason:"Unsupported pricing strategy",unit:s})}}let s=Math.ceil(r.reduce((e,t)=>e+t.credits,0)),l=K(s);return j(`computeChatPricing breakdown: ${JSON.stringify(r,null,2)}`),{breakdown:r,issues:i,totalCost:l,totalCredits:s}})(t,e,a);return r?{...e,cost:r.totalCost}:e},V=(e,t,a)=>{switch(e.type){case"message_start":var r=e.message.usage;if(!r)return;let i=r.input_tokens;return(r.cache_creation_input_tokens||r.cache_read_input_tokens)&&(i=(r.input_tokens||0)+(r.cache_creation_input_tokens||0)+(r.cache_read_input_tokens||0)),{inputCacheMissTokens:r.input_tokens,inputCachedTokens:r.cache_read_input_tokens||void 0,inputWriteCacheTokens:r.cache_creation_input_tokens||void 0,totalInputTokens:i,totalOutputTokens:r.output_tokens};case"message_delta":{let r=((e,t)=>{let a=t?.output_tokens||0;if(!e&&0===a)return;let r=e?{...e}:{},i=(e?.totalOutputTokens||0)+a,o=e?.totalInputTokens||0,n=o+i;return r.totalInputTokens=o,r.totalOutputTokens=i,n>0&&(r.totalTokens=n),r})(t,e.usage);return r&&J(r,a?.pricing,a?.pricingOptions)}default:return t}};var X=a(31852);let Q=(e,t)=>e?.find(e=>e?.modality===t)?.tokenCount,Z=(e,t)=>{let a=e.promptTokenCount&&e.cachedContentTokenCount?e.promptTokenCount-e.cachedContentTokenCount:void 0,r=e.thoughtsTokenCount,i=e.candidatesTokensDetails,o=e.candidatesTokenCount??i?.reduce((e,t)=>e+(t?.tokenCount??0),0)??0,n=Q(i,X.od.IMAGE)??0,s=Q(i,X.od.TEXT),l="number"==typeof s&&s>0?s:Math.max(0,o-n);return J({inputAudioTokens:Q(e.promptTokensDetails,X.od.AUDIO),inputCacheMissTokens:a,inputCachedTokens:e.cachedContentTokenCount,inputImageTokens:Q(e.promptTokensDetails,X.od.IMAGE),inputTextTokens:Q(e.promptTokensDetails,X.od.TEXT),outputImageTokens:n,outputReasoningTokens:r,outputTextTokens:l,totalInputTokens:e.promptTokenCount,totalOutputTokens:o+(r??0),totalTokens:e.totalTokenCount},t)},ee=x()("lobe-cost:convertOpenAIUsage"),et=(e,t)=>{let a=e.prompt_tokens||0,r=e.citation_tokens||0,i=r+a,o=e.prompt_cache_hit_tokens||e.prompt_tokens_details?.cached_tokens,n=e.prompt_cache_miss_tokens||i-o,s=e.completion_tokens,l=e.completion_tokens_details?.reasoning_tokens||0,d=e.completion_tokens_details?.audio_tokens||0,c=e.completion_tokens_details?.image_tokens||0,u=t?.provider==="xai"?s-d:s-l-d-c,p=t?.provider==="xai"?s+l:s,m=r+e.total_tokens,g={acceptedPredictionTokens:e.completion_tokens_details?.accepted_prediction_tokens,inputAudioTokens:e.prompt_tokens_details?.audio_tokens,inputCacheMissTokens:n,inputCachedTokens:o,inputCitationTokens:r,inputTextTokens:a,outputAudioTokens:d,outputImageTokens:c,outputReasoningTokens:l,outputTextTokens:u,rejectedPredictionTokens:e.completion_tokens_details?.rejected_prediction_tokens,totalInputTokens:i,totalOutputTokens:p,totalTokens:m},h={};return Object.entries(g).forEach(([e,t])=>{t&&(h[e]=t)}),ee("convertOpenAIUsage data(completion-api): %O",h),J(h,t?.pricing)};x()("lobe-cost:computeImagePricing");let ea=e=>{if(!e)return{};if("number"==typeof e.approximatePricePerImage)return{approximatePrice:e.approximatePricePerImage};let t=e.units.find(e=>"imageGeneration"===e.name);if(!t)return{};if("fixed"===t.strategy){if("image"===t.unit)return{price:t.rate};if("megapixel"===t.unit)return{price:1.048576*t.rate}}return{}};x()("model-runtime:helpers:mergeChatMethodOptions");var er=a(20434);let ei=er.Ik({function:er.Ik({arguments:er.Yj(),name:er.Yj()}),id:er.Yj(),thoughtSignature:er.Yj().optional(),type:er.Yj()});var eo=a(85601);let en=(e,t)=>(0,eo.jM)(e,e=>{0===e.length?e.push(...t.map(e=>ei.parse(e))):t.forEach(({index:t,...a})=>{e?.[t]?a.function?.arguments&&(e[t].function.arguments+=a.function.arguments):e?.splice(t,0,ei.parse(a))})}),es=e=>{let t;if("string"==typeof e){try{t=JSON.parse(e)}catch{return}return t}};var el=a(15010);let ed=((e=8)=>(0,el.d)("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",e))(),ec=(e,t)=>`${t||"unknown_tool_call"}_${e}_${ed()}`,eu=async function*(e){for await(let t of e)yield t},ep="%FIRST_CHUNK_ERROR%: ",em=e=>{let t=eu(e)[Symbol.asyncIterator]();return new ReadableStream({async cancel(e){await t.return?.(e)},async pull(e){let{done:a,value:r}=await t.next();a?e.close():e.enqueue(r)},async start(e){try{let{done:a,value:r}=await t.next();a?e.close():e.enqueue(r)}catch(t){e.enqueue(ep+JSON.stringify({message:t.message,name:t.name,stack:t.stack})),e.close()}}})},eg=(e,t,a)=>{let r=!1,i=!!a?.requireTerminalEvent;return new TransformStream({flush(e){if(i&&!r){let a=t?.id||"stream_end";e.enqueue(`id: ${a}
`),e.enqueue(`event: error
`),e.enqueue(`data: ${JSON.stringify({body:{name:"Stream parsing error",reason:"unexpected_end"},message:"Stream ended unexpectedly",name:"Stream parsing error",type:"StreamChunkError"})}

`)}},transform:(a,i)=>{let o=e(a,t||{id:""});(Array.isArray(o)?o:[o]).forEach(({type:e,id:t,data:a})=>{i.enqueue(`id: ${t}
`),i.enqueue(`event: ${e}
`),i.enqueue(`data: ${JSON.stringify(a)}

`),("stop"===e||"usage"===e||"error"===e)&&(r=!0)})}})};function eh(e){let t,a,r,i,o,n=new TextEncoder,s="",l="",d=e||{};return new TransformStream({async flush(){let e={grounding:r,speed:a,text:s,thinking:o,toolsCalling:i,usage:t};d.onCompletion&&await d.onCompletion(e),d.onFinal&&await d.onFinal(e)},async start(){d.onStart&&await d.onStart()},async transform(e,c){if(c.enqueue(n.encode(e)),e.startsWith("event:"))l=e.split("event:")[1].trim();else if(e.startsWith("data:")){let n=es(e.split("data:")[1].trim());if(!n)return;switch(l){case"text":s+=n,await d.onText?.(n);break;case"reasoning":o||(o=""),o+=n,await d.onThinking?.(n);break;case"usage":t=n,await d.onUsage?.(n);break;case"speed":a=n;break;case"grounding":r=n,await d.onGrounding?.(n);break;case"tool_calls":i||(i=[]),i=en(i,n),await d.onToolsCalling?.({chunk:n,toolsCalling:i})}}}})}let ey="_isFirstChunkError",ef=(e,t)=>new TransformStream({transform(a,r){if(a.toString().startsWith(ep)){let i=JSON.parse(a.toString().replace(ep,""));r.enqueue({...i,[ey]:!0,errorType:e?.(i)||P.ProviderBizError,provider:t})}else r.enqueue(a)}}),e_=(e,{inputStartAt:t,streamStack:a,enableStreaming:r=!0}={})=>{let i;return new TransformStream({transform(o,n){let s=e(o,a||{id:""});Array.isArray(s)||(s=[s]),s.forEach(e=>{let a=(e=>{let a=[e];if(i||"text"!==e.type&&"reasoning"!==e.type||(i=Date.now()),t&&i&&"usage"===e.type){let o=e.data,n=o?.totalOutputTokens??0,s=Date.now(),l=s-(r?i:t),d=s-i,c=i-t;a.push({data:{duration:d,latency:s-t,tps:0===l?void 0:n/l*1e3,ttft:c},id:"output_speed",type:"speed"})}return a})(e);a&&a.forEach(e=>n.enqueue(e))})}})},ev=(e,t,a)=>{switch(e.type){case"message_start":{t.id=e.message.id,t.returnedCitationArray=[];let r=V(e,void 0,a);return r?t.usage=r:delete t.usage,{data:e.message,id:e.message.id,type:"data"}}case"content_block_start":switch(e.content_block.type){case"redacted_thinking":return{data:e.content_block.data,id:t.id,type:"flagged_reasoning_signature"};case"text":return{data:e.content_block.text,id:t.id,type:"data"};case"server_tool_use":case"tool_use":{let a=e.content_block;void 0===t.toolIndex?t.toolIndex=0:t.toolIndex+=1;let r={function:{arguments:"",name:a.name},id:a.id,index:t.toolIndex,type:"function"};return t.tool={id:a.id,index:t.toolIndex,name:a.name},{data:[r],id:t.id,type:"tool_calls"}}case"thinking":{let a=e.content_block;if(a.signature)return[{data:a.thinking,id:t.id,type:"reasoning"},{data:a.signature,id:t.id,type:"reasoning_signature"}];if("string"==typeof a.thinking)return{data:a.thinking,id:t.id,type:"reasoning"};return{data:a,id:t.id,type:"data"}}}return{data:e,id:t.id,type:"data"};case"content_block_delta":switch(e.delta.type){case"text_delta":return{data:e.delta.text,id:t.id,type:"text"};case"input_json_delta":return{data:[{function:{arguments:e.delta.partial_json},index:t.toolIndex||0,type:"function"}],id:t.id,type:"tool_calls"};case"signature_delta":return{data:e.delta.signature,id:t.id,type:"reasoning_signature"};case"thinking_delta":return{data:e.delta.thinking,id:t.id,type:"reasoning"};case"citations_delta":{let a=e.delta.citation;return t.returnedCitationArray&&t.returnedCitationArray.push({title:a.title,url:a.url}),{data:null,id:t.id,type:"text"}}}return{data:e,id:t.id,type:"data"};case"message_delta":{let r=V(e,t.usage,a);if(r&&(t.usage=r),r&&(r.totalTokens??0)>0)return[{data:e.delta.stop_reason,id:t.id,type:"stop"},{data:r,id:t.id,type:"usage"}];return{data:e.delta.stop_reason,id:t.id,type:"stop"}}case"message_stop":return[...t.returnedCitationArray?.length?[{data:{citations:t.returnedCitationArray},id:t.id,type:"grounding"}]:[],{data:"message_stop",id:t.id,type:"stop"}];default:return{data:e,id:t.id,type:"data"}}},eb=async function*(e){for await(let t of e)if(t.chunk){let e=new TextDecoder().decode(t.chunk.bytes,{stream:!0});try{let t=JSON.parse(e);yield t}catch(t){console.log("bedrock stream parser error:",t),yield e}}else yield t},ew=e=>{let t;return t=eb(e.body)[Symbol.asyncIterator](),new ReadableStream({async cancel(e){await t.return?.(e)},async pull(e){let{done:a,value:r}=await t.next();a?e.close():e.enqueue(r)}})},eC=(e,t)=>e.stop_reason?{data:"finished",id:t.id,type:"stop"}:{data:e.generation,id:t.id,type:"text"},eT={BLOCKLIST:"Your content contains prohibited terms. Please review and modify your input, then try again.",IMAGE_SAFETY:"The generated image was blocked for safety reasons. Please try modifying your image request.",LANGUAGE:"The language you are using is not supported. Please try again in English or another supported language.",OTHER:"The content was blocked for an unknown reason. Please try rephrasing your request.",PROHIBITED_CONTENT:"Your request may contain prohibited content. Please adjust your request to comply with the usage guidelines.",RECITATION:"Your content was blocked due to potential copyright concerns. Please try using original content or rephrase your request.",SAFETY:"Your content was blocked for safety policy reasons. Please adjust your request to avoid potentially harmful or inappropriate content.",SPII:"Your content may contain sensitive personally identifiable information (PII). To protect privacy, please remove any sensitive details and try again.",default:"Content blocked: {{blockReason}}. Please adjust your request and try again."},eE="__lobe_error",eA=(e,t)=>e.message.thinking?{data:e.message.thinking,id:t.id,type:"reasoning"}:e.message.tool_calls&&e.message.tool_calls.length>0?{data:e.message.tool_calls.map((e,t)=>({function:{arguments:JSON.stringify(e.function?.arguments)??"{}",name:e.function?.name??null},id:ec(t,e.function?.name),index:t,type:"function"})),id:t.id,type:"tool_calls"}:e.done&&!e.message.content?{data:"finished",id:t.id,type:"stop"}:(e.message.content.includes("<think>")?t.thinkingInContent=!0:e.message.content.includes("</think>")&&(t.thinkingInContent=!1),{data:e.message.content.replaceAll(/<\/?think>/g,""),id:t.id,type:t?.thinkingInContent?"reasoning":"text"}),ek=e=>{let t;if(!e)return{cleanedText:e,urls:[]};let a=[],r=/!\[[^\]]*]\(\s*(data:image\/[\d+.A-Za-z-]+;base64,[^\s)]+)\s*\)/g;for(r.lastIndex=0;null!==(t=r.exec(e));)t[1]&&a.push(t[1]);return{cleanedText:e.replaceAll(r,"").trim(),urls:a}},ex=(e,{callbacks:t,bizErrorTypeTransformer:a,payload:r,inputStartAt:i,enableStreaming:o=!0}={})=>{let n={id:""};return(e instanceof ReadableStream?e:em(e)).pipeThrough(ef(a,r?.provider)).pipeThrough(e_((e,t)=>((e,t,a)=>{if(ey in e)return delete e[ey],delete e.name,delete e.stack,{data:{body:e,message:"message"in e&&"string"==typeof e.message?e.message:JSON.stringify(e),type:"errorType"in e?e.errorType:P.ProviderBizError},id:"first_chunk_error",type:"error"};if(e.base_resp&&"number"==typeof e.base_resp.status_code){let t=e.base_resp;if(0!==t.status_code){let a=P.ProviderBizError;switch(t.status_code){case 1004:case 2049:a=P.InvalidProviderAPIKey;break;case 1008:a=P.InsufficientQuota;break;case 1002:case 1041:case 2045:a=P.QuotaLimitReached;break;case 1039:a=P.ExceededContextWindow}return{data:{body:{...t,provider:"minimax"},message:t.status_msg||t.message||"MiniMax provider error",type:a},id:e.id,type:"error"}}}try{if(!Array.isArray(e.choices)||0===e.choices.length){if(e.usage){let t=e.usage;return{data:et(t,a),id:e.id,type:"usage"}}return{data:e,id:e.id,type:"data"}}let r=e.choices[0];if(r&&"object"==typeof r.delta?.tool_calls&&r.delta.tool_calls?.length>0&&r.delta.tool_calls.filter(e=>e.index>=0||void 0===e.index).length>0)return{data:r.delta.tool_calls.map((e,a)=>(t&&!t.tool&&(t.tool={id:e.id,index:e.index,name:e.function.name}),{function:{arguments:e.function?.arguments??"",name:e.function?.name??null},id:e.id||t?.tool?.id||ec(a,e.function?.name),index:void 0!==e.index?e.index:a,type:e.type||"function"})),id:e.id,type:"tool_calls"};if(r.delta&&Array.isArray(r.delta.images)&&r.delta.images.length>0)return r.delta.images.map(t=>{let a=t?.image_url?.url||t?.image_url?.image_url?.url||t?.url||("string"==typeof t?t:void 0);return a?{data:a,id:e.id,type:"base64_image"}:null}).filter(Boolean);if(r.finish_reason){if("string"==typeof r.delta?.content&&r.delta.content){if("string"==typeof r.delta?.role&&"tool"===r.delta.role)return{data:null,id:e.id,type:"text"};let t=r.delta.content,{urls:a,cleanedText:i}=ek(t);if(a.length>0){let t=[];return i&&t.push({data:i,id:e.id,type:"text"}),t.push(...a.map(t=>({data:t,id:e.id,type:"base64_image"}))),t}return{data:t,id:e.id,type:"text"}}if(r.delta?.annotations&&r.delta.annotations.length>0)return[{data:{citations:r.delta.annotations.map(e=>({title:e.url_citation.title,url:e.url_citation.url}))},id:e.id,type:"grounding"}];if(r.messages&&r.messages.length>0)return[{data:{citations:r.messages.at(-1).annotations.map(e=>({title:e.url,url:e.url}))},id:e.id,type:"grounding"}];if(e.usage){let t=e.usage;return{data:et(t,a),id:e.id,type:"usage"}}if(e.citations)return[{data:{citations:e.citations.map(e=>({title:e,url:e}))},id:e.id,type:"grounding"}];return{data:r.finish_reason,id:e.id,type:"stop"}}if(r.delta){let i=(()=>{if("reasoning_content"in r.delta)return r.delta.reasoning_content;if("reasoning"in r.delta)return r.delta.reasoning;if("reasoning_details"in r.delta){let e=r.delta.reasoning_details;return Array.isArray(e)?e.filter(e=>e.text).map(e=>e.text).join(""):"string"==typeof e?e:"object"==typeof e&&null!==e&&"text"in e?e.text:""}return"content"in r.delta&&Array.isArray(r.delta.content)?r.delta.content.filter(e=>"thinking"===e.type&&Array.isArray(e.thinking)).map(e=>e.thinking.filter(e=>"text"===e.type&&e.text).map(e=>e.text).join("")).join(""):null})(),o="content"in r.delta?r.delta.content:null;if("string"==typeof o&&"string"==typeof i&&(""===o&&""===i?o=null:""===i&&(i=null)),"string"==typeof i)return{data:i,id:e.id,type:"reasoning"};if("string"==typeof o){if(""===o&&e.usage){let t=e.usage;return{data:et(t,a),id:e.id,type:"usage"}}if(o.includes("</think>")){let a=o.split("</think>"),r=a[0].replaceAll("<think>",""),i=a.slice(1).join("</think>"),n=[];return r&&n.push({data:r,id:e.id,type:"reasoning"}),t.thinkingInContent=!1,i&&n.push({data:i,id:e.id,type:"text"}),n.length>0?n:{data:"",id:e.id,type:"text"}}let r=o.replaceAll(/<\/?think>/g,"");if(o.includes("<think>")&&(t.thinkingInContent=!0),!t?.returnedCitation){let a="citations"in e&&e.citations||"search_info"in e&&e.search_info?.search_results||"search_results"in e&&e.search_results||"web_search"in e&&e.web_search;if(a)return t.returnedCitation=!0,[{data:{citations:a.map(e=>({title:"string"==typeof e?e:e.title,url:"string"==typeof e?e:e.url||e.link})).filter(e=>e.title&&e.url)},id:e.id,type:"grounding"},{data:r,id:e.id,type:t?.thinkingInContent?"reasoning":"text"}]}if(!t?.thinkingInContent){let{urls:t,cleanedText:a}=ek(r);if(t.length>0){let r=[];return a&&r.push({data:a,id:e.id,type:"text"}),r.push(...t.map(t=>({data:t,id:e.id,type:"base64_image"}))),r}}return{data:r,id:e.id,type:t?.thinkingInContent?"reasoning":"text"}}}if(r.delta&&null===r.delta.content)return{data:r.delta,id:e.id,type:"data"};if(e.usage){let t=e.usage;return{data:et(t,a),id:e.id,type:"usage"}}return{data:{delta:r.delta,id:e.id,index:r.index},id:e.id,type:"data"}}catch(a){let t="StreamChunkError";return console.error(`[${t}]`,a),console.error(`[${t}] raw chunk:`,e),{data:{body:{message:"chat response streaming chunk parse error, please contact your API Provider to fix it.",context:{error:{message:a.message,name:a.name},chunk:e}},type:t},id:e.id,type:"error"}}})(e,t,r),{enableStreaming:o,inputStartAt:i,streamStack:n})).pipeThrough(eg(e=>e,n)).pipeThrough(eh(t))},eI=(e,{callbacks:t,bizErrorTypeTransformer:a,inputStartAt:r,enableStreaming:i=!0,payload:o}={})=>{let n={id:""};return(e instanceof ReadableStream?e:em(e)).pipeThrough(ef(a,o?.provider)).pipeThrough(e_((e,t)=>((e,t,a)=>{if(ey in e)return delete e[ey],delete e.name,delete e.stack,{data:{body:e,message:"message"in e&&"string"==typeof e.message?e.message:JSON.stringify(e),type:"errorType"in e?e.errorType:P.ProviderBizError},id:"first_chunk_error",type:"error"};try{switch(e.type){case"response.created":return t.id=e.response.id,t.returnedCitationArray=[],{data:e.response.status,id:t.id,type:"data"};case"response.output_item.added":if("function_call"===e.item.type)return t.toolIndex=void 0===t.toolIndex?0:t.toolIndex+1,t.tool={id:e.item.call_id,index:t.toolIndex,name:e.item.name},{data:[{function:{arguments:e.item.arguments,name:e.item.name},id:e.item.call_id,index:t.toolIndex,type:"function"}],id:t.id,type:"tool_calls"};return{data:e.item,id:t.id,type:"data"};case"response.function_call_arguments.delta":return{data:[{function:{arguments:e.delta,name:t.tool?.name},id:t.tool?.id,index:t.toolIndex,type:"function"}],id:t.id,type:"tool_calls"};case"response.output_text.delta":return{data:e.delta,id:e.item_id,type:"text"};case"response.reasoning_summary_part.added":if(!t.startReasoning)return t.startReasoning=!0,{data:"",id:e.item_id,type:"reasoning"};return{data:"\n",id:e.item_id,type:"reasoning"};case"response.reasoning_summary_text.delta":return{data:e.delta,id:e.item_id,type:"reasoning"};case"response.output_text.annotation.added":{let a=e.annotation;return t.returnedCitationArray&&t.returnedCitationArray.push({title:a.title,url:a.url}),{data:null,id:e.item_id,type:"text"}}case"response.output_item.done":if(t.returnedCitationArray?.length)return{data:{citations:t.returnedCitationArray},id:e.item.id,type:"grounding"};return{data:null,id:e.item.id,type:"text"};case"response.completed":if(e.response.usage){var r;let t,i,o,n,s,l,d;return{data:(r=e.response.usage,t=r.input_tokens||0,i=r.input_tokens_details?.cached_tokens||0,o=r.output_tokens||0,n=r.output_tokens_details?.reasoning_tokens||0,s=r.total_tokens||0,l=r.output_tokens_details?.image_tokens||0,d={},Object.entries({acceptedPredictionTokens:void 0,inputAudioTokens:void 0,inputCacheMissTokens:t-i,inputCachedTokens:i,inputCitationTokens:void 0,inputTextTokens:t,outputAudioTokens:void 0,outputImageTokens:l,outputReasoningTokens:n,outputTextTokens:o-n,rejectedPredictionTokens:void 0,totalInputTokens:t,totalOutputTokens:o,totalTokens:s}).forEach(([e,t])=>{null!=t&&("number"!=typeof t||0!==t)&&t&&(d[e]=t)}),ee("convertOpenAIResponseUsage data(response-api): %O",d),J(d,a?.pricing)),id:e.response.id,type:"usage"}}return{data:e,id:t.id,type:"data"};default:return{data:e,id:t.id,type:"data"}}}catch(r){let a="StreamChunkError";return console.error(`[${a}]`,r),console.error(`[${a}] raw chunk:`,e),{data:{body:{message:"chat response streaming chunk parse error, please contact your API Provider to fix it.",context:{error:{message:r.message,name:r.name},chunk:e}},type:a},id:t.id,type:"error"}}})(e,t,o),{enableStreaming:i,inputStartAt:r,streamStack:n})).pipeThrough(eg(e=>e,n)).pipeThrough(eh(t))},eP=(e,t)=>{if(Array.isArray(e.choices)&&0===e.choices.length&&e.usage){let a=et({...e.usage,completion_tokens_details:e.usage.completion_tokens_details||{},prompt_tokens_details:e.usage.prompt_tokens_details||{}});return t&&(t.usage=a),{data:a,id:e.id,type:"usage"}}let a=e.choices[0];return a?Array.isArray(a.delta?.content)?{data:(e=>{let[t,a]=Object.entries(e)[0];return"image"===t?{text:`![image](${a})`,type:"text"}:{text:a,type:"text"}})(a.delta.content[0]).text,id:e.id,type:"text"}:a.delta?.tool_calls?{data:a.delta.tool_calls.map((e,t)=>({function:e.function,id:e.id||ec(t,e.function?.name),index:void 0!==e.index?e.index:t,type:e.type||"function"})),id:e.id,type:"tool_calls"}:a.delta&&"reasoning_content"in a.delta&&"string"==typeof a.delta.reasoning_content&&""!==a.delta.reasoning_content?{data:a.delta.reasoning_content,id:e.id,type:"reasoning"}:"string"==typeof a.delta?.content?{data:a.delta.content,id:e.id,type:"text"}:a.finish_reason?{data:a.finish_reason,id:e.id,type:"stop"}:a.delta?.content===null?{data:a.delta,id:e.id,type:"data"}:{data:{delta:a.delta,id:e.id,index:a.index},id:e.id,type:"data"}:{data:e,id:e.id,type:"data"}},eO=e=>{let t=e.choices[0];if(!t)return{data:e,id:e.id,type:"data"};if(t.delta?.tool_calls){let a=Array.isArray(t.delta.tool_calls)?t.delta.tool_calls:[t.delta.tool_calls];if(a.length>0)return{data:a.map((e,t)=>({function:e.function,id:e.id||ec(t,e.function?.name),index:void 0!==e.index?e.index:t,type:e.type||"function"})),id:e.id,type:"tool_calls"}}return t.finish_reason?"string"==typeof t.delta?.content&&t.delta.content?{data:t.delta.content,id:e.id,type:"text"}:{data:t.finish_reason,id:e.id,type:"stop"}:t.delta&&"reasoning_content"in t.delta&&"string"==typeof t.delta.reasoning_content&&""!==t.delta.reasoning_content?{data:t.delta.reasoning_content,id:e.id,type:"reasoning"}:"string"==typeof t.delta?.content?e.usage?[{data:t.delta.content,id:e.id,type:"text"},{data:et(e.usage),id:e.id,type:"usage"}]:{data:t.delta.content,id:e.id,type:"text"}:t.delta?.content===null?{data:t.delta,id:e.id,type:"data"}:e.usage?{data:et(e.usage),id:e.id,type:"usage"}:{data:{delta:t.delta,id:e.id,index:t.index},id:e.id,type:"data"}};var eL=a(12890);let eR=x()("lobe-image:openai-compatible");async function eS(e,t,a){var r,i;let o,{model:n,params:s}=t;eR("Creating image with model: %s and params: %O",n,s);let l=new Map([["imageUrls","image"],["imageUrl","image"]]),d=Object.fromEntries(Object.entries(s).map(([e,t])=>[l.get(e)??e,t]));"string"==typeof d.image&&""!==d.image.trim()&&(d.image=[d.image]);let c=Array.isArray(d.image)&&d.image.length>0;if(eR("isImageEdit: %O, userInput.image: %O",c,d.image),c)try{let e=await Promise.all(d.image.map(e=>b(e)));d.image=1===e.length?e[0]:e}catch(e){throw Error(`Failed to convert image URLs to File objects: ${e}`)}else delete d.image;"auto"===d.size&&delete d.size;let u={n:1,...n.includes("dall-e")?{response_format:"b64_json"}:{},...c&&"gpt-image-1"===n?{input_fidelity:"high"}:{}},p=(0,eL.j)({model:n,...u,...d});eR("options: %O",p);let m=c?await e.images.edit(p):await e.images.generate(p);if(!m||!m.data||!Array.isArray(m.data)||0===m.data.length)throw Error("Invalid image response: missing or empty data array");let g=m.data[0];if(!g)throw Error("Invalid image response: first data item is null or undefined");if(g.b64_json)eR("Successfully converted base64 to data URL, length: %d",(o=`data:image/png;base64,${g.b64_json}`).length);else if(g.url)eR("Using direct image URL: %s",o=g.url);else throw Error("Invalid image response: missing both b64_json and url fields");return{imageUrl:o,...m.usage?{modelUsage:(r=m.usage,i=await N(n,a),J({inputImageTokens:r.input_tokens_details.image_tokens,inputTextTokens:r.input_tokens_details.text_tokens,outputImageTokens:r.output_tokens,totalInputTokens:r.input_tokens,totalOutputTokens:r.output_tokens,totalTokens:r.total_tokens},i))}:{}}}async function eU(e){let{type:t,base64:a,mimeType:r}=m(e);if("base64"===t){if(!a)throw TypeError("Image URL doesn't contain base64 data");return`data:${r||"image/png"};base64,${a}`}if("url"===t){let{base64:t,mimeType:a}=await (0,l.hs)(e);return`data:${a};base64,${t}`}throw TypeError(`Currently we don't support image url: ${e}`)}async function eM(e,t){let{model:a,params:r}=t,i=a.replace(":image","");eR("Creating image via chat API with model: %s and params: %O",i,r);let o=[{text:r.prompt,type:"text"}];if(r.imageUrl&&null!==r.imageUrl){eR("Processing image URL for editing mode: %s",r.imageUrl);try{let e=await eU(r.imageUrl);o.push({image_url:{url:e},type:"image_url"}),eR("Successfully processed image URL for chat input")}catch(e){throw Error(`Failed to process image URL: ${e}`)}}let n=await e.chat.completions.create({messages:[{content:o,role:"user"}],model:i,stream:!1});eR("Chat API response: %O",n);let s=n.choices[0]?.message;if(!s)throw Error("No message in chat completion response");if(s.images&&Array.isArray(s.images)){let{images:e}=s;if(e.length>0){let t=e[0];if(t.image_url?.url)return eR("Successfully extracted image from chat response"),{imageUrl:t.image_url.url}}}throw Error("No image generated in chat completion response")}async function eN(e,t,a){let{model:r}=t;return r.endsWith(":image")?await eM(e,t):await eS(e,t,a)}let eB=e=>new ReadableStream({start(t){let a=e.choices||[],r=a[0],i=r?.message??{},o="string"==typeof i.reasoning_content&&i.reasoning_content.length>0?i.reasoning_content:null;o&&t.enqueue({choices:[{delta:{content:null,reasoning_content:o,role:"assistant"},finish_reason:null,index:r?.index??0,logprobs:r?.logprobs??null}],created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk"});let n={choices:a.map(e=>({delta:{content:e.message.content,role:e.message.role,tool_calls:e.message.tool_calls?.map((e,t)=>({function:e.function,id:e.id,index:t,type:e.type}))},finish_reason:null,index:e.index,logprobs:e.logprobs})),created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk"};t.enqueue(n),e.usage&&t.enqueue({choices:[],created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk",usage:e.usage}),t.enqueue({choices:a.map(e=>({delta:{content:null,role:e.message.role},finish_reason:e.finish_reason,index:e.index,logprobs:e.logprobs})),created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk",system_fingerprint:e.system_fingerprint}),t.close()}}),e$=["embedding","davinci","curie","moderation","ada","babbage","tts","whisper","dall-e"],eD=({provider:e,baseURL:t,apiKey:a,errorType:r,debug:i,constructorOptions:o,chatCompletion:n,models:s,customClient:l,responses:d,createImage:c,generateObject:u})=>{let m={bizError:r?.bizError||P.ProviderBizError,invalidAPIKey:r?.invalidAPIKey||P.InvalidProviderAPIKey};return class{constructor(r={}){this.convertChatCompletionToolToResponseTool=e=>({type:e.type,...e.function});const i={...r,apiKey:r.apiKey?.trim()||a,baseURL:r.baseURL?.trim()||t},{apiKey:n,baseURL:s=t,...d}=i;if(this._options=i,!n)throw O.createError(m?.invalidAPIKey);const c={apiKey:n,baseURL:s,...o,...d};l?.createClient?this.client=l.createClient(c):this.client=new I.Ay(c),this.baseURL=s||this.client.baseURL,this.id=r.id||e,this.logPrefix=`lobe-model-runtime:${this.id}`}shouldUseResponsesAPI(e){let{model:t,userApiMode:a,responseApi:r,flagUseResponse:i,flagUseResponseModels:o,context:n="operation"}=e,s=x()(`${this.logPrefix}:shouldUseResponsesAPI`);return"responses"===a?(s("using Responses API: explicit userApiMode=%s",a),!0):void 0!==a?(s("using Chat Completions API: userApiMode=%s",a),!1):r?(s("using Responses API: explicit responseApi flag for %s",n),!0):i?(s("using Responses API: flagUseResponse=true for %s",n),!0):t&&o?.length&&o.some(e=>"string"==typeof e?t.includes(e):e.test(t))?(s("using Responses API: model %s matches useResponseModels config",t),!0):t&&p.has(t)?(s("using Responses API: model %s in built-in responsesAPIModels",t),!0):(s("using Chat Completions API for %s",n),!1)}async chat({responseMode:e,...t},a){try{let r,o=x()(`${this.logPrefix}:chat`),s=Date.now();o("chat called with model: %s, stream: %s",t.model,t.stream??!0);let d=t,c=t.apiMode,u=t.model,p=this._options.chatCompletion||{},m=p.useResponse??(n?n.useResponse:void 0),g=p.useResponseModels??n?.useResponseModels;this.shouldUseResponsesAPI({context:"chat",flagUseResponse:m,flagUseResponseModels:g,model:u,userApiMode:c})&&(d={...t,apiMode:"responses"});let h=n?.handlePayload?n.handlePayload(d,this._options):{...d,stream:d.stream??!0};if("responses"===h.apiMode)return this.handleResponseAPIMode(d,a);let y=await f(h.messages),_={bizErrorTypeTransformer:n?.handleStreamBizErrorType,callbacks:a?.callback,payload:{model:t.model,pricing:await N(t.model,this.id),provider:this.id}};if(l?.createChatCompletionStream)o("using custom client for chat completion stream"),r=l.createChatCompletionStream(this.client,d,this);else{let e={...h,messages:y,...n?.noUserId?{}:{user:a?.user},stream_options:h.stream&&!n?.excludeUsage?{include_usage:!0}:void 0};o("sending chat completion request with %d messages",y.length),i?.chatCompletion?.()&&(console.log("[requestPayload]"),console.log(JSON.stringify(e),"\n")),r=await this.client.chat.completions.create(e,{headers:{Accept:"*/*",...a?.requestHeaders},signal:a?.signal})}if(h.stream){o("processing streaming response");let[e,t]=r.tee();if(i?.chatCompletion?.()){let e=t instanceof ReadableStream?t:t.toReadableStream();R(e).catch(console.error)}return D(n?.handleStream?n.handleStream(e,{callbacks:_.callbacks,inputStartAt:s}):ex(e,{..._,inputStartAt:s}),{headers:a?.headers})}if(i?.chatCompletion?.()&&S(r),"json"===e)return o("returning JSON response mode"),Response.json(r);o("transforming non-streaming response to stream");let v=(n?.handleTransformResponseToStream||eB)(r);return D(n?.handleStream?n.handleStream(v,{callbacks:_.callbacks,inputStartAt:s}):ex(v,{..._,enableStreaming:!1,inputStartAt:s}),{headers:a?.headers})}catch(e){throw this.handleError(e)}}async createImage(t){let a=x()(`${this.logPrefix}:createImage`);return c?(a("using custom createImage implementation"),c(t,{...this._options,apiKey:this._options.apiKey,provider:e})):(a("using default createOpenAICompatibleImage"),eN(this.client,t,this.id))}async models(){let e=x()(`${this.logPrefix}:models`);e("fetching available models");let t=[];return"function"==typeof s?(e("using custom models function"),t=await s({client:this.client})):(e("fetching models from client API"),t=(await this.client.models.list()).data.filter(e=>e$.every(t=>!e.id.toLowerCase().includes(t))).map(e=>{if(s?.transformModel)return s.transformModel(e);let t=()=>{if(e.created)return(T().extend(A()),"string"==typeof e.created||13===e.created.toFixed(0).length)?T().utc(e.created).format("YYYY-MM-DD"):T().utc(1e3*e.created).format("YYYY-MM-DD")},a=w.LOBE_DEFAULT_MODEL_LIST.find(t=>t.id===e.id);if(a){let e=a.releasedAt??t();return{...a,releasedAt:e}}return{id:e.id,releasedAt:t()}}).filter(Boolean)),e("fetched %d models",t.length),await $(t,e=>M(e,"type"))}async generateObject(e,t){let{messages:a,schema:r,model:i,responseApi:o,tools:n}=e,s=x()(`${this.logPrefix}:generateObject`);if(s("generateObject called with model: %s, hasTools: %s, hasSchema: %s",i,!!n,!!r),n)return s("using tools-based generation"),this.generateObjectWithTools(e,t);if(!r)throw Error("tools or schema is required");if(u?.useToolsCalling){s("using tool calling fallback for structured output");let e=u.handleSchema?{...r,schema:u.handleSchema(r.schema)}:r,o={function:{description:e.description||"Generate structured output according to the provided schema",name:e.name||"structured_output",parameters:e.schema},type:"function"},n=(await this.client.chat.completions.create({messages:a,model:i,tool_choice:{function:{name:o.function.name},type:"function"},tools:[o],user:t?.user},{headers:t?.headers,signal:t?.signal})).choices[0].message.tool_calls;try{return n.map(e=>({arguments:JSON.parse(e.function.arguments),name:e.function.name}))}catch{console.error("parse tool call arguments error:",n);return}}let l=this._options.generateObject||{},d=l.useResponse??(u?u.useResponse:void 0),c=l.useResponseModels??u?.useResponseModels,p=this.shouldUseResponsesAPI({context:"generateObject",flagUseResponse:d,flagUseResponseModels:c,model:i,responseApi:o}),m=u?.handleSchema?{...r,schema:u.handleSchema(r.schema)}:r;if(p){s("calling responses.create for structured output");let e=(await this.client.responses.create({input:a,model:i,text:{format:{strict:!0,type:"json_schema",...m}},user:t?.user},{headers:t?.headers,signal:t?.signal})).output_text;s("received structured output from Responses API, length: %d",e?.length||0);try{let t=JSON.parse(e);return s("successfully parsed JSON output"),t}catch(t){s("failed to parse JSON output: %O",t),console.error("parse json error:",e);return}}s("calling chat.completions.create for structured output");let g=(await this.client.chat.completions.create({messages:a,model:i,response_format:{json_schema:m,type:"json_schema"},user:t?.user},{headers:t?.headers,signal:t?.signal})).choices[0].message.content;s("received structured output from Chat Completions API, length: %d",g?.length||0);try{let e=JSON.parse(g);return s("successfully parsed JSON output"),e}catch(e){s("failed to parse JSON output: %O",e),console.error("parse json error:",g);return}}async embeddings(e,t){let a=x()(`${this.logPrefix}:embeddings`);a("embeddings called with model: %s, input items: %d",e.model,Array.isArray(e.input)?e.input.length:1);try{let r=await this.client.embeddings.create({...e,encoding_format:"float",user:t?.user},{headers:t?.headers,signal:t?.signal});return a("received %d embeddings",r.data.length),r.data.map(e=>e.embedding)}catch(e){throw this.handleError(e)}}async textToImage(e){let t=x()(`${this.logPrefix}:textToImage`);t("textToImage called with prompt length: %d",e.prompt?.length||0);try{let a=await this.client.images.generate(e);return t("generated %d images",a.data?.length||0),(a.data||[]).map(e=>e.url)}catch(e){throw this.handleError(e)}}async textToSpeech(e,t){let a=x()(`${this.logPrefix}:textToSpeech`);a("textToSpeech called with input length: %d, voice: %s",e.input?.length||0,e.voice);try{let r=await this.client.audio.speech.create(e,{headers:t?.headers,signal:t?.signal}),i=await r.arrayBuffer();return a("generated audio with size: %d bytes",i.byteLength),i}catch(e){throw this.handleError(e)}}handleError(e){let a,r=x()(`${this.logPrefix}:error`);r("handling error: %O",e);let i=this.baseURL;if(this.baseURL!==t&&(i=U(this.baseURL)),n?.handleError){r("using custom error handler");let t=n.handleError(e,this._options);if(t)return O.chat({...t,provider:this.id})}if("status"in e){let t=e.status;if(r("HTTP error with status: %d",t),401===t)return r("invalid API key error"),O.chat({endpoint:i,error:e,errorType:m.invalidAPIKey,provider:this.id})}let{errorResult:o,RuntimeError:s}=e instanceof I.Ay.APIError?{errorResult:a=e.error?e.error:e.cause?e.cause:{headers:e.headers,status:e.status}}:(a={cause:e.cause,message:e.message,name:e.name},{RuntimeError:P.AgentRuntimeError,errorResult:a});r("error code: %s, message: %s",o.code,o.message);let l=o.error?.message||o.message;if(l?.includes("Insufficient Balance"))return r("insufficient balance error detected in message"),O.chat({endpoint:i,error:o,errorType:P.InsufficientQuota,provider:this.id});switch(o.code){case"insufficient_quota":return r("insufficient quota error"),O.chat({endpoint:i,error:o,errorType:P.InsufficientQuota,provider:this.id});case"model_not_found":return r("model not found error"),O.chat({endpoint:i,error:o,errorType:P.ModelNotFound,provider:this.id});case"context_length_exceeded":case"string_above_max_length":return r("context length exceeded error"),O.chat({endpoint:i,error:o,errorType:P.ExceededContextWindow,provider:this.id})}return r("returning generic error"),O.chat({endpoint:i,error:o,errorType:s||m.bizError,provider:this.id})}async handleResponseAPIMode(e,t){let a=x()(`${this.logPrefix}:handleResponseAPIMode`);a("handleResponseAPIMode called with model: %s",e.model);let r=Date.now(),{messages:o,reasoning_effort:s,tools:l,reasoning:c,responseMode:u,max_tokens:p,...m}=d?.handlePayload?d?.handlePayload(e,this._options):e;delete m.apiMode,delete m.frequency_penalty,delete m.presence_penalty;let g=await _(o),h=!1!==e.stream;a("isStreaming: %s, hasTools: %s, hasReasoning: %s",h,!!l,!!(c||s));let y={...m,...c||s?{reasoning:{...c,...s&&{effort:s}}}:{},input:g,...p&&{max_output_tokens:p},store:!1,stream:h||void 0,tools:l?.map(e=>this.convertChatCompletionToolToResponseTool(e))};i?.responses?.()&&(console.log("[requestPayload]"),console.log(JSON.stringify(y),"\n")),a("sending responses.create request");let f=await this.client.responses.create(y,{headers:t?.requestHeaders,signal:t?.signal}),v={bizErrorTypeTransformer:n?.handleStreamBizErrorType,callbacks:t?.callback,payload:{model:e.model,pricing:await N(e.model,this.id),provider:this.id}};if(h){a("processing streaming Responses API response");let[e,o]=f.tee();return i?.responses?.()&&R(o instanceof ReadableStream?o:o.toReadableStream()).catch(console.error),D(eI(e,{...v,inputStartAt:r}),{headers:t?.headers})}return(a("processing non-streaming Responses API response"),i?.responses?.()&&S(f),"json"===u)?(a("returning JSON response mode"),Response.json(f)):(a("transforming non-streaming Responses API response to stream"),D(eI(new ReadableStream({start(e){f.output&&Array.isArray(f.output)&&f.output.forEach(t=>{"message"===t.type&&t.content&&Array.isArray(t.content)&&t.content.forEach(t=>{"output_text"===t.type&&t.text&&e.enqueue({delta:t.text,type:"response.output_text.delta"})})}),e.enqueue({response:f,sequence_number:999,type:"response.completed"}),e.close()}}),{...v,enableStreaming:!1,inputStartAt:r}),{headers:t?.headers}))}async generateObjectWithTools(e,t){let{messages:a,model:r,tools:i,responseApi:o}=e,n=x()(`${this.logPrefix}:generateObject`);n("generateObjectWithTools called with model: %s, toolsCount: %d",r,i?.length||0);let s=this._options.generateObject||{},l=s.useResponse??(u?u.useResponse:void 0),d=s.useResponseModels??u?.useResponseModels;if(this.shouldUseResponsesAPI({context:"tool calling",flagUseResponse:l,flagUseResponseModels:d,model:r,responseApi:o})){n("calling responses.create for tool calling");let e=await _(a),o=await this.client.responses.create({input:e,model:r,tool_choice:"required",tools:i.map(e=>this.convertChatCompletionToolToResponseTool(e)),user:t?.user},{headers:t?.headers,signal:t?.signal}),s=o.output?.filter(e=>"function_call"===e.type);n("received %d function calls from Responses API",s?.length||0);try{let e=s?.map(e=>({arguments:"string"==typeof e.arguments?JSON.parse(e.arguments):e.arguments,name:e.name}));return n("successfully parsed function calls: %O",e?.map(e=>e.name)),e}catch(e){n("failed to parse tool call arguments: %O",e),console.error("parse tool call arguments error:",o);return}}n("calling chat.completions.create for tool calling");let c=await this.client.chat.completions.create({messages:a,model:r,tool_choice:"required",tools:i,user:t?.user},{headers:t?.headers,signal:t?.signal}),p=c.choices[0].message.tool_calls;n("received %d tool calls from Chat Completions API",p?.length||0);try{let e=p.map(e=>({arguments:JSON.parse(e.function.arguments),name:e.function.name}));return n("successfully parsed tool calls: %O",e.map(e=>e.name)),e}catch(e){n("failed to parse tool call arguments: %O",e),console.error("parse tool call arguments error:",c);return}}}};var eH=a(61092),ej=a(55036);let eG=["o1","o3","o4","codex","computer-use","gpt-5"],eq=ej.env.OPENAI_SEARCH_CONTEXT_SIZE,eK="1"===ej.env.OPENAI_SERVICE_TIER_FLEX,ez=["gpt-5","o3","o4-mini"],eF=e=>!e.startsWith("o3-mini")&&ez.some(t=>e.startsWith(t)),eW=eD({baseURL:"https://api.openai.com/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,model:a,...r}=e;return p.has(a)||t?{...r,apiMode:"responses",enabledSearch:t,model:a}:eG.some(e=>a.startsWith(e))?v(e):a.includes("-search-")?{...r,frequency_penalty:void 0,model:a,presence_penalty:void 0,stream:e.stream??!0,temperature:void 0,top_p:void 0,...eK&&eF(a)&&{service_tier:"flex"},...eq&&{web_search_options:{search_context_size:eq}}}:{...r,model:a,...eK&&eF(a)&&{service_tier:"flex"},stream:e.stream??!0}}},debug:{chatCompletion:()=>"1"===ej.env.DEBUG_OPENAI_CHAT_COMPLETION,responses:()=>"1"===ej.env.DEBUG_OPENAI_RESPONSES},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.bY)(t,"openai")},provider:w.ModelProvider.OpenAI,responses:{handlePayload:e=>{let{enabledSearch:t,model:a,tools:r,verbosity:i,...o}=e,n=t?[...r||[],{type:"web_search",...eq&&{search_context_size:eq}}]:r;if(eG.some(e=>a.startsWith(e))){let t=e.reasoning?{...e.reasoning,summary:"auto"}:{summary:"auto"};return a.startsWith("gpt-5-pro")&&(t.effort="high"),v({...o,model:a,reasoning:t,...eK&&eF(a)&&{service_tier:"flex"},stream:e.stream??!0,tools:n,...a.startsWith("computer-use")&&{truncation:"auto"},text:i?{verbosity:i}:void 0})}return{...o,model:a,...eK&&eF(a)&&{service_tier:"flex"},stream:e.stream??!0,tools:n}}}});var eY=a(55036);let eJ=eD({baseURL:"https://api.ai21.com/studio/v1",chatCompletion:{handlePayload:e=>({...e,stream:!e.tools})},debug:{chatCompletion:()=>"1"===eY.env.DEBUG_AI21_CHAT_COMPLETION},provider:w.ModelProvider.Ai21});var eV=a(55036);let eX=eD({baseURL:"https://api.302.ai/v1",chatCompletion:{handleError:e=>{let t;return(e instanceof Response?t=e:"status"in e&&(t=e),t&&401===t.status)?{error:t.status,errorType:P.InvalidProviderAPIKey}:{error:e}}},debug:{chatCompletion:()=>"1"===eV.env.DEBUG_AI302_CHAT_COMPLETION},errorType:{bizError:P.ProviderBizError,invalidAPIKey:P.InvalidProviderAPIKey},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.bY)(t,"ai302")},provider:w.ModelProvider.Ai302});var eQ=a(55036);let eZ=eD({baseURL:"https://api.360.cn/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,tools:a,...r}=e,i=t?[...a||[],{type:"web_search",web_search:{search_mode:"auto"}}]:a;return{...r,stream:!i,tools:i}}},debug:{chatCompletion:()=>"1"===eQ.env.DEBUG_AI360_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["360gpt2-o1","360zhinao2-o1"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.total_tokens,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:"360gpt-pro"===e.id||a?.abilities?.functionCall||!1,id:e.id,maxOutput:"number"==typeof e.max_tokens?e.max_tokens:void 0,reasoning:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Ai360});var e0=a(4001),e1=a(68585);let e5=async e=>{switch(e.type){case"thinking":return e;case"text":if(e.text)return e;return;case"image_url":{let{mimeType:t,base64:a,type:r}=m(e.image_url.url);if("base64"===r)return{source:{data:a,media_type:t,type:"base64"},type:"image"};if("url"===r){let{base64:t,mimeType:a}=await (0,l.hs)(e.image_url.url);return{source:{data:t,media_type:a,type:"base64"},type:"image"}}throw Error(`Invalid image URL: ${e.image_url.url}`)}}},e2=async e=>{let t=await Promise.all(e.map(async e=>await e5(e)));return t.filter(Boolean)},e6=async e=>{let t=e.content;switch(e.role){case"system":return{content:t,role:"user"};case"user":return{content:"string"==typeof t?t:await e2(t),role:"user"};case"tool":return{content:[{content:e.content,tool_use_id:e.tool_call_id,type:"tool_result"}],role:"user"};case"assistant":if(e.tool_calls&&e.tool_calls.length>0){let a="string"==typeof t?[{text:e.content,type:"text"}]:t;return{content:[...await e2(a),...e.tool_calls.map(e=>({id:e.id,input:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_use"}))].filter(Boolean),role:"assistant"}}return{content:t,role:"assistant"};case"function":return{content:t,role:"assistant"}}},e4=async(e,t={})=>{let a=[],r=[],i=new Set;for(let t of e)"assistant"===t.role&&t.tool_calls?.length&&t.tool_calls.forEach(e=>{e.id&&i.add(e.id)});for(let t of e){let o=e.indexOf(t);if("tool"===t.role)t.tool_call_id&&i.has(t.tool_call_id)?(r.push({content:[{text:t.content,type:"text"}],tool_use_id:t.tool_call_id,type:"tool_result"}),(o===e.length-1||"tool"!==e[o+1].role)&&(a.push({content:r,role:"user"}),r=[])):a.push({content:t.content,role:"user"});else{let e=await e6(t);a.push({...e,role:e.role})}}let o=a.at(-1);if(t.enabledContextCaching&&o)if("string"==typeof o.content)o.content=[{cache_control:{type:"ephemeral"},text:o.content,type:"text"}];else{let e=o.content.at(-1);e&&"thinking"!==e.type&&"redacted_thinking"!==e.type&&(e.cache_control={type:"ephemeral"})}return a},e3=(e,t={})=>{if(e)return e.map((a,r)=>({cache_control:t.enabledContextCaching&&r===e.length-1?{type:"ephemeral"}:void 0,description:a.function.description,input_schema:a.function.parameters,name:a.function.name}))},e8=(e,t)=>{if(void 0===e||!t)return e;let a=e;return void 0!==t.min&&(a=Math.max(t.min,a)),void 0!==t.max&&(a=Math.min(t.max,a)),a},e9=(e,t={})=>{let{hasConflict:a=!1,preferTemperature:r=!0,normalizeTemperature:i=!0,temperatureRange:o,topPRange:n,frequencyPenaltyRange:s,presencePenaltyRange:l,maxTokensRange:d}=t,{temperature:c,top_p:u,frequency_penalty:p,presence_penalty:m,max_tokens:g}=e,h={},y=void 0!==c,f=void 0!==u;return a?r&&y?h.temperature=e8(i&&void 0!==c?c/2:c,o):f&&(h.top_p=e8(u,n)):(y&&(h.temperature=e8(i&&void 0!==c?c/2:c,o)),f&&(h.top_p=e8(u,n))),void 0!==p&&(h.frequency_penalty=e8(p,s)),void 0!==m&&(h.presence_penalty=e8(m,l)),void 0!==g&&(h.max_tokens=e8(g,d)),h},e7={ANTHROPIC_CLAUDE_4_PLUS:new Set(["claude-opus-4-1","claude-opus-4-1-20250805","claude-sonnet-4-5-20250929","claude-haiku-4-5-20251001"]),BEDROCK_CLAUDE_4_PLUS:new Set(["claude-opus-4-1","claude-opus-4-1-20250805","claude-opus-4-20250514","claude-sonnet-4-20250514","claude-sonnet-4-5-20250929","claude-haiku-4-5-20251001","anthropic.claude-opus-4-1-20250805-v1:0","us.anthropic.claude-opus-4-1-20250805-v1:0","anthropic.claude-opus-4-20250514-v1:0","us.anthropic.claude-opus-4-20250514-v1:0","anthropic.claude-sonnet-4-20250514-v1:0","us.anthropic.claude-sonnet-4-20250514-v1:0","anthropic.claude-sonnet-4-5-20250929-v1:0","us.anthropic.claude-sonnet-4-5-20250929-v1:0","anthropic.claude-haiku-4-5-20251001-v1:0","us.anthropic.claude-haiku-4-5-20251001-v1:0"])},te=x()("lobe-model-runtime:anthropic:generate-object"),tt=async(e,t,a)=>{let r,i,{schema:o,messages:n,model:s,tools:l}=t;te("generateObject called with model: %s",s),te("schema: %O",o),te("messages count: %d",n.length);let d=n.find(e=>"system"===e.role)?.content,c=n.filter(e=>"system"!==e.role),u=await e4(c);if(te("converted %d messages to Anthropic format",u.length),l)r=e3(l),i={type:"any"};else if(o){let e={description:o.description||"Generate structured output according to the provided schema",input_schema:o.schema,name:o.name||"structured_output"};te("converted tool: %O",e),r=[e],i={name:e.name,type:"tool"}}else throw Error("tools or schema is required");try{te("calling Anthropic API with max_tokens: %d",8192);let t=await e.messages.create({max_tokens:8192,messages:u,model:s,system:d?[{text:d,type:"text"}]:void 0,tool_choice:i,tools:r},{signal:a?.signal});if(te("received response with %d content blocks",t.content.length),te("response: %O",t),"tool"===i.type){let e=t.content.find(e=>"tool_use"===e.type&&e.name===i.name);if(!e||"tool_use"!==e.type)return void te("no tool use found in response (expected tool: %s)",i.name);return te("extracted tool input: %O",e.input),e.input}return t.content.filter(e=>"tool_use"===e.type).map(e=>({arguments:e.input,name:e.name}))}catch(e){throw te("generateObject error: %O",e),e}};var ta=a(55036);let tr=new Set(["claude-3-opus-20240229","claude-3-haiku-20240307"]),ti="https://api.anthropic.com";class to{isDebug(){return"1"===ta.env.DEBUG_ANTHROPIC_CHAT_COMPLETION}constructor({apiKey:e,baseURL:t=ti,id:a,defaultHeaders:r,...i}={}){if(!e)throw O.createError(P.InvalidProviderAPIKey);const o=ta.env.ANTHROPIC_BETA_HEADERS;this.client=new e1.Ay({apiKey:e,baseURL:t,defaultHeaders:{...r,"anthropic-beta":o},...i}),this.baseURL=this.client.baseURL,this.apiKey=e,this.id=a||w.ModelProvider.Anthropic}async chat(e,t){try{let a=await this.buildAnthropicPayload(e),r=Date.now();this.isDebug()&&(console.log("[requestPayload]"),console.log(JSON.stringify(a),"\n"));let[i,o]=(await this.client.messages.create({...a,metadata:t?.user?{user_id:t?.user}:void 0,stream:!0},{signal:t?.signal})).tee();this.isDebug()&&R(o.toReadableStream()).catch(console.error);let n=await N(e.model,this.id),s=((e,t)=>{if(Array.isArray(t.system))for(let e of t.system){let t=e.cache_control?.ttl;if(t)return t}for(let e of t.messages??[])if(Array.isArray(e.content))for(let t of e.content){let e="cache_control"in t&&t.cache_control?.ttl;if(e)return e}if(e.enabledContextCaching)return"5m"})(e,a);return D(((e,{callbacks:t,inputStartAt:a,enableStreaming:r=!0,payload:i}={})=>{let o={id:""};return(e instanceof ReadableStream?e:em(e)).pipeThrough(e_((e,t)=>ev(e,t,i),{enableStreaming:r,inputStartAt:a,streamStack:o})).pipeThrough(eg(e=>e,o)).pipeThrough(eh(t))})(i,{callbacks:t?.callback,inputStartAt:r,payload:{model:e.model,pricing:n,pricingOptions:s?{lookupParams:{ttl:s}}:void 0,provider:this.id}}),{headers:t?.headers})}catch(e){throw this.handleError(e)}}async generateObject(e,t){try{return await tt(this.client,e,t)}catch(e){throw this.handleError(e)}}async buildAnthropicPayload(e){let{messages:t,model:r,max_tokens:i,temperature:o,top_p:n,tools:s,thinking:l,enabledContextCaching:d=!0,enabledSearch:c}=e,{anthropic:u}=await Promise.resolve().then(a.bind(a,80286)),p=u.find(e=>e.id===r),m=p?.maxOutput,g=t.find(e=>"system"===e.role),h=t.filter(e=>"system"!==e.role),y=g?.content?[{cache_control:d?{type:"ephemeral"}:void 0,text:g?.content,type:"text"}]:void 0,f=await e4(h,{enabledContextCaching:d}),_=e3(s,{enabledContextCaching:d});if(c){let e=ta.env.ANTHROPIC_MAX_USES,t={name:"web_search",type:"web_search_20250305",...e&&Number.isInteger(Number(e))&&Number(e)>0&&{max_uses:Number(e)}};_=_&&_.length>0?[..._,t]:[t]}if(l&&"enabled"===l.type){let e=i||m||void 0||32e3;return{max_tokens:e,messages:f,model:r,system:y,thinking:{...l,budget_tokens:l?.budget_tokens?Math.min(l.budget_tokens,e-1):1024},tools:_}}let v=e9({temperature:o,top_p:n},{hasConflict:e7.ANTHROPIC_CLAUDE_4_PLUS.has(r),normalizeTemperature:!0,preferTemperature:!0});return{max_tokens:i||m||void 0||(tr.has(r)?4096:8192),messages:f,model:r,system:y,temperature:v.temperature,tools:_,top_p:v.top_p}}async models(){let e=`${this.baseURL}/v1/models`,t=await fetch(e,{headers:{"anthropic-version":"2023-06-01","x-api-key":`${this.apiKey}`},method:"GET"}),a=(await t.json()).data.map(e=>({created:e.created_at,displayName:e.display_name,id:e.id}));return(0,eH.processModelList)(a,eH.MODEL_LIST_CONFIGS.anthropic,"anthropic")}handleError(e){let t,a=this.baseURL;if(this.baseURL!==ti&&(a=U(this.baseURL)),"status"in e)switch(e.status){case 401:throw O.chat({endpoint:a,error:e,errorType:P.InvalidProviderAPIKey,provider:this.id});case 403:throw O.chat({endpoint:a,error:e,errorType:P.LocationNotSupportError,provider:this.id})}let{errorResult:r}=(t=e,e.error?"error"in(t=e.error)&&(t=t.error):t={headers:e.headers,stack:e.stack,status:e.status},{errorResult:t});throw O.chat({endpoint:a,error:r,errorType:P.ProviderBizError,provider:this.id})}}var tn=a(48838),ts=a(87250);function tl(e){if(!e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(tl);let t={},a=["request","headers","authorization","apikey","api-key","ocp-apim-subscription-key","x-api-key","bearer","token","auth","credential","key","secret","password","config","options"];for(let r in e)if(e.hasOwnProperty(r)){let i=e[r],o=r.toLowerCase();if(-1!==a.indexOf(o))continue;i&&"object"==typeof i?t[r]=tl(i):t[r]=i}return t}var td=a(55036);class tc{constructor(e){if(this.maskSensitiveUrl=e=>e.replace(/^(https:\/\/)([^.]+)(\.cognitiveservices\.azure\.com\/.*)$/,(e,t,a,r)=>`${t}***${r}`),!e?.apiKey||!e?.baseURL)throw O.createError(P.InvalidProviderAPIKey);this.client=(0,tn.A)(e?.baseURL,new ts.KL(e?.apiKey)),this.baseURL=e?.baseURL}async chat(e,t){let{messages:a,model:r,temperature:i,top_p:o,...n}=e,s=!r.includes("o1")&&(n.stream??!0),l=a.map(e=>({...e,role:(r.includes("o1")||r.includes("o3"))&&"system"===e.role?[...c].some(e=>r.includes(e))?"user":"developer":e.role}));try{let e=this.client.path("/chat/completions").post({body:{messages:l,model:r,...n,stream:s,temperature:r.includes("o3")||r.includes("o4")?void 0:i,tool_choice:n.tools?"auto":void 0,top_p:r.includes("o3")||r.includes("o4")?void 0:o}});if(s){let[a,r]=(await (async()=>{let t=(await e.asBrowserStream()).body;if(!t)throw Error("Azure AI response body is empty");return t})()).tee();return"1"===td.env.DEBUG_AZURE_AI_CHAT_COMPLETION&&R(r).catch(console.error),D(ex(a.pipeThrough(new TransformStream({transform(e,t){for(let a of new TextDecoder().decode(e,{stream:!0}).split("\n"))if(a.startsWith("data: ")){let e=a.slice(6);if("[DONE]"===e)continue;try{let a=JSON.parse(e);t.enqueue(a)}catch{console.warn("Failed to parse SSE data:",e)}}}})),{callbacks:t?.callback}),{headers:t?.headers})}{let a=await e,r=eB(a.body);return D(ex(r,{callbacks:t?.callback,enableStreaming:!1}),{headers:t?.headers})}}catch(i){let e=i;e.code?"DeploymentNotFound"===e.code&&(e={...e,deployId:r}):e={cause:e.cause,message:e.message,name:e.name};let t=e.code?P.ProviderBizError:P.AgentRuntimeError,a=tl(e);throw O.chat({endpoint:this.maskSensitiveUrl(this.baseURL),error:a,errorType:t,provider:w.ModelProvider.Azure})}}}class tu{parseChunk(e,t){let a=JSON.parse(e.replace(/^data: /,""));a?.response&&(t.enqueue(`event: text
`),t.enqueue(`data: ${JSON.stringify(a.response)}

`))}async transform(e,t){let a=this.textDecoder.decode(e);""!==this.buffer.trim()&&(a=this.buffer+a,this.buffer="");let r=a.split("\n\n");for(let e=0;e<r.length-1;e++){if(/\[DONE]/.test(r[e].trim()))return;this.parseChunk(r[e],t)}let i=r.at(-1);""!==i.trim()&&(this.buffer+=i)}constructor(){this.textDecoder=new TextDecoder,this.buffer=""}}let tp="https://api.cloudflare.com";function tm(e){return e.replace(/\/[\dA-Fa-f]{32}\//,"/****/")}function tg(e){let{protocol:t,hostname:a,port:r,pathname:i,search:o}=new URL(e);if(e.startsWith(tp))return`${t}//${a}${r?`:${r}`:""}${tm(i)}${o}`;{let e=U(`${t}//${a}${r?`:${r}`:""}`);return e.endsWith("/")&&i.startsWith("/")&&(i=i.slice(1)),`${e}${tm(i)}${o}`}}var th=a(55036);class ty{constructor({apiKey:e,baseURLOrAccountID:t}={}){if(!t)throw O.createError(P.InvalidProviderAPIKey);if(t.startsWith("http"))this.baseURL=t.endsWith("/")?t:t+"/",this.accountID=t.replaceAll(/^.*\/([\dA-Fa-f]{32})\/.*$/g,"$1");else{if(!e)throw O.createError(P.InvalidProviderAPIKey);this.accountID=t,this.baseURL=`${tp}/client/v4/accounts/${t}/ai/run/`}this.apiKey=e}async chat(e,t){try{let a,{model:r,tools:i,...o}=e,n=i?.map(e=>e.function),s=t?.headers||{};this.apiKey&&(s.Authorization=`Bearer ${this.apiKey}`);let l=new URL(r,this.baseURL),d=await fetch(l,{body:JSON.stringify({tools:n,...o}),headers:{"Content-Type":"application/json",...s},method:"POST",signal:t?.signal}),c=tg(l.toString());if(400===d.status)throw O.chat({endpoint:c,error:d,errorType:P.ProviderBizError,provider:w.ModelProvider.Cloudflare});if("1"===th.env.DEBUG_CLOUDFLARE_CHAT_COMPLETION){let[e,t]=d.body.tee();R(t).catch(),a=e}else a=d.body;return D(a.pipeThrough(new TransformStream(new tu)).pipeThrough(eh(t?.callback)),{headers:t?.headers})}catch(t){let e=tg(this.baseURL);throw O.chat({endpoint:e,error:t,errorType:P.ProviderBizError,provider:w.ModelProvider.Cloudflare})}}async models(){let{LOBE_DEFAULT_MODEL_LIST:e}=await Promise.resolve().then(a.bind(a,80286)),t=`${tp}/client/v4/accounts/${this.accountID}/ai/models/search`,r=await fetch(t,{headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},method:"GET"});return(await r.json()).result.map(t=>{let a=e.find(e=>t.name.toLowerCase()===e.id.toLowerCase());return{contextWindowTokens:t.properties?.max_total_tokens?Number(t.properties.max_total_tokens):a?.contextWindowTokens??void 0,displayName:a?.displayName??(t.properties?.beta==="true"?`${t.name} (Beta)`:void 0),enabled:a?.enabled||!1,functionCall:t.description.toLowerCase().includes("function call")||t.properties?.function_calling==="true"||a?.abilities?.functionCall||!1,id:t.name,reasoning:t.name.toLowerCase().includes("deepseek-r1")||a?.abilities?.reasoning||!1,vision:t.name.toLowerCase().includes("vision")||t.task?.name.toLowerCase().includes("image-to-text")||t.description.toLowerCase().includes("vision")||a?.abilities?.vision||!1}}).filter(Boolean)}}var tf=a(36049),t_=a(68334);let tv=x()("lobe-image:fal");class tb{constructor({apiKey:e}={}){if(!e)throw O.createError(P.InvalidProviderAPIKey);tf.fal.config({credentials:e}),tv("FalAI initialized with apiKey: %s",e?"*****":"Not set")}async createImage(e){let{model:t,params:a}=e;tv("Creating image with model: %s and params: %O",t,a);let r=new Map([["steps","num_inference_steps"],["cfg","guidance_scale"],["imageUrl","image_url"],["imageUrls","image_urls"],["size","image_size"]]),i={enable_safety_checker:!1,num_images:1},o=Object.fromEntries(Object.entries(a).filter(([,e])=>!(null==e||Array.isArray(e)&&0===e.length)).map(([e,t])=>[r.get(e)??e,t]));if("width"in o&&"height"in o)if(o.size)throw Error("width/height and size are not supported at the same time");else o.image_size={height:o.height,width:o.width},delete o.width,delete o.height;new Set(["flux/krea"]).has(t)&&(i.acceleration="high");let n=t.startsWith("fal-ai/")?t:`fal-ai/${t}`,s=(a.imageUrls?.length??0)>0;["fal-ai/bytedance/seedream/v4","fal-ai/hunyuan-image/v3"].includes(n)?n+=s?"/edit":"/text-to-image":"fal-ai/nano-banana"===n&&s&&(n+="/edit");let l={...i,...o};tv("Calling fal.subscribe with endpoint: %s and input: %O",n,l);try{let{data:e}=await tf.fal.subscribe(n,{input:l}),t=e.images[0];return{imageUrl:t.url,...(0,t_.A)(t,["width","height"])}}catch(e){if(e instanceof Error&&"status"in e&&401===e.status)throw O.createError(P.InvalidProviderAPIKey,{error:e});throw O.createError(P.ProviderBizError,{error:e})}}}let tw=async e=>{switch(e.type){default:return;case"text":return{text:e.text};case"image_url":{let{mimeType:t,base64:a,type:r}=m(e.image_url.url);if("base64"===r){if(!a)throw TypeError("Image URL doesn't contain base64 data");return{inlineData:{data:a,mimeType:t||"image/png"}}}if("url"===r){let{base64:t,mimeType:a}=await (0,l.hs)(e.image_url.url);return{inlineData:{data:t,mimeType:a}}}throw TypeError(`currently we don't support image url: ${e.image_url.url}`)}case"video_url":{let{mimeType:t,base64:a,type:r}=m(e.video_url.url);if("base64"===r){if(!a)throw TypeError("Video URL doesn't contain base64 data");return{inlineData:{data:a,mimeType:t||"video/mp4"}}}if("url"===r){let{base64:t,mimeType:a}=await (0,l.hs)(e.video_url.url);return{inlineData:{data:t,mimeType:a}}}throw TypeError(`currently we don't support video url: ${e.video_url.url}`)}}},tC=async(e,t)=>{let a=e.content;if(e.tool_calls)return{parts:e.tool_calls.map(e=>({functionCall:{args:es(e.function.arguments),name:e.function.name},thoughtSignature:e.thoughtSignature})),role:"model"};if("tool"===e.role&&t&&e.tool_call_id){let a=t.get(e.tool_call_id);if(a)return{parts:[{functionResponse:{name:a,response:{result:e.content}}}],role:"user"}}let r=async()=>"string"==typeof a?[{text:a}]:(await Promise.all(a.map(async e=>await tw(e)))).filter(Boolean);return{parts:await r(),role:"assistant"===e.role?"model":"user"}},tT=async e=>{let t=new Map;e.forEach(e=>{"assistant"===e.role&&e.tool_calls&&e.tool_calls.forEach(e=>{"function"===e.type&&t.set(e.id,e.function.name)})});let a=e.filter(e=>"function"!==e.role).map(async e=>await tC(e,t)),r=(await Promise.all(a)).filter(e=>e.parts&&e.parts.length>0),i=e.at(-1);if(i?.role==="tool"){let e=-1;for(let t=r.length-1;t>=0;t--)if("user"===r[t].role&&!r[t].parts?.some(e=>e.functionResponse)){e=t;break}for(let t=e+1;t<r.length;t++){let e=r[t];if("model"===e.role&&e.parts)for(let t of e.parts)t.functionCall&&!t.thoughtSignature&&(t.thoughtSignature="context_engineering_is_the_way_to_go")}}return r},tE=e=>{let t=e.function,a=t.parameters,r=a?.properties&&Object.keys(a.properties).length>0?a.properties:{dummy:{type:"string"}};return{description:t.description,name:t.name,parameters:{description:a?.description,properties:r,required:a?.required,type:X.ZU.OBJECT}}},tA=e=>{if(e&&0!==e.length)return[{functionDeclarations:e.map(e=>tE(e))}]};function tk(e){let t={error:{message:e},errorType:P.ProviderBizError};if(e.includes("location is not supported"))return{error:{message:e},errorType:P.LocationNotSupportError};let a=(e,t)=>400===e&&t.includes("API key not valid")?P.InvalidProviderAPIKey:429===e?P.QuotaLimitReached:P.ProviderBizError,r=(e,t=5)=>{if(t<=0)return null;try{let a=JSON.parse(e);if(a&&"object"==typeof a&&a.error){let e=a.error;if("string"==typeof e.message){e.message=e.message.replaceAll(/^\*\s*/g,"").replaceAll("\\n","\n").replaceAll(/\n+/g," ").trim();try{let a=r(e.message,t-1);if(a&&a.error&&a.error.code)return a}catch{}}}return a}catch{return null}},i="got status: ",o=e.indexOf(i);if(-1!==o){let t=e.slice(o+i.length),n=t.indexOf(".");if(-1!==n){let i=t.slice(0,n).trim(),o=t.slice(n+1).trim(),s=o.indexOf("{");if(-1!==s){let t=r(o.slice(s));if(t&&t.error){let r=t.error,o=r.message||e,n=r.code||null;return{error:{code:n,message:o,status:r.status||i},errorType:a(n,o)}}}}}let n=r(e);if(n&&n.error){let t=n.error,r=t.message||e,i=t.code||null;return{error:{code:i,message:r,status:t.status||""},errorType:a(i,r)}}try{let t=JSON.parse(e);if(t&&t.error&&t.error.message){let i=r(t.error.message);if(i&&i.error){let t=i.error,r=t.message||e,o=t.code||null,n=t.status||"";return{error:{code:o,message:r,status:n},errorType:a(o,r)}}}}catch{}let s=e.lastIndexOf("[");if(-1!==s)try{let a=e.slice(s),r=JSON.parse(a),i=r[0];if(i?.reason==="API_KEY_INVALID")return{...t,errorType:P.InvalidProviderAPIKey};return{error:r,errorType:P.ProviderBizError}}catch{}let l=function(e){let t=0;for(;;){let a=e.indexOf("[",t);if(-1===a)return{errorDetails:null,prefix:e};let r=e.indexOf("]",a);if(-1===r)return{errorDetails:null,prefix:e};let i=e.slice(a+1,r).trim(),o=i.indexOf(" ");if(-1!==o){let t=parseInt(i.slice(0,o),10);if(!isNaN(t)&&t>=100&&t<600){let n=i.slice(o+1).trim(),s=e.slice(0,a).trim();return{errorDetails:{message:e.slice(r+1).trim(),statusCode:t,statusCodeText:`[${t} ${n}]`},prefix:s}}}t=a+1}}(e);return l.errorDetails?{error:l.errorDetails,errorType:P.ProviderBizError}:t}async function tx(e){let{mimeType:t,base64:a,type:r}=m(e);if("base64"===r){if(!a)throw TypeError("Image URL doesn't contain base64 data");return{inlineData:{data:a,mimeType:t||"image/png"}}}if("url"===r){let{base64:t,mimeType:a}=await (0,l.hs)(e);return{inlineData:{data:t,mimeType:a}}}throw TypeError(`currently we don't support image url: ${e}`)}async function tI(e,t){let{model:a,params:r}=t,i=await e.models.generateImages({config:{aspectRatio:r.aspectRatio,numberOfImages:1},model:a,prompt:r.prompt});if(!i.generatedImages||0===i.generatedImages.length)throw Error("No images generated");let o=i.generatedImages[0];if(!o.image||!o.image.imageBytes)throw Error("Invalid image data");let{imageBytes:n}=o.image;return{imageUrl:`data:image/png;base64,${n}`}}async function tP(e,t,a){let{model:r,params:i}=t,o=r.replace(":image","");if(i.imageUrl&&i.imageUrls&&i.imageUrls.length>0)throw TypeError("Cannot provide both imageUrl and imageUrls parameters simultaneously");let n=[{text:i.prompt}];if(i.imageUrl&&null!==i.imageUrl){let e=await tx(i.imageUrl);n.push(e)}if(i.imageUrls&&Array.isArray(i.imageUrls)&&i.imageUrls.length>0){if(i.imageUrls.length>10)throw TypeError("Too many images provided. Maximum 10 images allowed");let e=await Promise.all(i.imageUrls.map(e=>tx(e)));n.push(...e)}let s=[{parts:n,role:"user"}],l={responseModalities:["Image"],...i.aspectRatio?{imageConfig:{aspectRatio:i.aspectRatio}}:{}},d=await e.models.generateContent({config:l,contents:s,model:o}),c=function(e){let t=e.candidates?.[0];if(!t?.content?.parts)throw Error("No image generated");for(let e of t.content.parts)if(e.inlineData?.data)return{imageUrl:`data:${e.inlineData.mimeType||"image/png"};base64,${e.inlineData.data}`};throw Error("No image data found in response")}(d);if(d.usageMetadata){let e=await N(r,a);c.modelUsage=Z(d.usageMetadata,e)}return c}async function tO(e,t,a){try{let{model:r}=a;if(r.endsWith(":image"))return await tP(e,a,t);return await tI(e,a)}catch(r){let{errorType:e,error:a}=tk(r.message);throw O.createImage({error:a,errorType:e,provider:t})}}let tL=x()("lobe-mode-runtime:google:generateObject");var tR=((r=tR||{}).HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",r.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",r.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",r.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",r),tS=((i=tS||{}).BLOCK_NONE="BLOCK_NONE",i);let tU=new Set(["gemini-2.0-flash-exp"]);function tM(e){return tU.has(e)?"OFF":"BLOCK_NONE"}let tN=async(e,t,a)=>{let r,{schema:i,contents:o,model:n}=t;tL("createGoogleGenerateObject started",{contentsLength:o.length,hasSchema:!!i,model:n});let s=(r=e=>{if(!e)return e;let t={type:(e=>{switch(e){case"string":default:return X.ZU.STRING;case"number":return X.ZU.NUMBER;case"integer":return X.ZU.INTEGER;case"boolean":return X.ZU.BOOLEAN;case"array":return X.ZU.ARRAY;case"object":return X.ZU.OBJECT}})(e.type)};if(e.description&&(t.description=e.description),e.enum&&(t.enum=e.enum),e.properties)for(let[a,i]of(t.properties={},Object.entries(e.properties)))t.properties[a]=r(i);return e.items&&(t.items=r(e.items)),e.required&&(t.required=e.required),e.propertyOrdering&&(t.propertyOrdering=e.propertyOrdering),t})(i.schema);tL("Schema conversion completed",{convertedSchema:s,originalSchema:i});let l={abortSignal:a?.signal,responseMimeType:"application/json",responseSchema:s,safetySettings:[{category:"HARM_CATEGORY_HATE_SPEECH",threshold:tM(n)},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:tM(n)},{category:"HARM_CATEGORY_HARASSMENT",threshold:tM(n)},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:tM(n)}]};tL("Config prepared",{hasAbortSignal:!!l.abortSignal,hasSafetySettings:!!l.safetySettings,model:n,responseMimeType:l.responseMimeType});let d=await e.models.generateContent({config:l,contents:o,model:n});tL("API response received",{hasText:!!d.text,textLength:d.text?.length});let c=d.text;try{let e=JSON.parse(c);return tL("JSON parsing successful",e),e}catch{console.error("parse json error:",c);return}},tB=async(e,t,a)=>{let{tools:r,contents:i,model:o}=t;tL("createGoogleGenerateObjectWithTools started",{contentsLength:i.length,model:o,toolsCount:r.length});let n=r.map(tE);tL("Tools conversion completed",{functionDeclarations:n});let s={abortSignal:a?.signal,safetySettings:[{category:"HARM_CATEGORY_HATE_SPEECH",threshold:tM(o)},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:tM(o)},{category:"HARM_CATEGORY_HARASSMENT",threshold:tM(o)},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:tM(o)}],toolConfig:{functionCallingConfig:{mode:X.ce.ANY}},tools:[{functionDeclarations:n}]};tL("Config prepared",{hasAbortSignal:!!s.abortSignal,hasSafetySettings:!!s.safetySettings,hasTools:!!s.tools,model:o});let l=await e.models.generateContent({config:s,contents:i,model:o});tL("API response received",{candidatesCount:l.candidates?.length,hasContent:!!l.candidates?.[0]?.content});let d=l.candidates?.[0];if(!d?.content?.parts)return void tL("no content parts in response");let c=d.content.parts.filter(e=>e.functionCall).map(e=>({arguments:e.functionCall.args,name:e.functionCall.name}));return tL("extracted function calls",{count:c.length,functionCalls:c}),c.length>0?c:void 0};var t$=a(55036);let tD=x()("model-runtime:google"),tH=new Set(["gemini-2.0-flash-exp"]),tj=new Set(["gemini-2.0-flash-exp","gemini-2.0-flash-exp-image-generation","gemini-2.0-flash-preview-image-generation","gemini-2.5-flash-image-preview","gemini-2.5-flash-image"]),tG=new Set(["gemini-2.0-flash-exp","gemini-2.0-flash-exp-image-generation","gemini-2.0-flash-preview-image-generation","gemini-2.5-flash-image-preview","gemini-2.5-flash-image","gemma-3-1b-it","gemma-3-4b-it","gemma-3-12b-it","gemma-3-27b-it","gemma-3n-e4b-it"]),tq=(e,t,a)=>Math.min(Math.max(e,t),a);var tK=((o=tK||{}).HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",o.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",o.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",o.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",o),tz=((n=tz||{}).BLOCK_NONE="BLOCK_NONE",n);function tF(e){return tH.has(e)?"OFF":"BLOCK_NONE"}let tW=e=>{let t=e.message.toLowerCase();return t.includes("aborted")||t.includes("cancelled")||t.includes("error reading from the stream")||t.includes("abort")||"AbortError"===e.name};class tY{constructor({apiKey:e,baseURL:t,client:a,isVertexAi:r,id:i,defaultHeaders:o}={}){if(!e)throw O.createError(P.InvalidProviderAPIKey);this.apiKey=e,this.client=a||new X.M4({apiKey:e,httpOptions:t?{baseUrl:t,headers:o}:void 0}),this.baseURL=a?void 0:t||"https://generativelanguage.googleapis.com",this.isVertexAi=r||!1,this.provider=i||(r?"vertexai":"google")}async chat(e,t){try{let a=this.buildPayload(e),{model:r,thinkingBudget:i,thinkingLevel:o}=a,n=((e,t)=>{let a=(e=>{if(!e)return"other";let t=e.toLowerCase();return t.includes("robotics-er-1.5-preview")?"robotics":t.includes("-2.5-flash-lite")||t.includes("flash-lite-latest")?"flashLite":t.includes("-2.5-flash")||t.includes("flash-latest")?"flash":t.includes("-2.5-pro")||t.includes("pro-latest")?"pro":"other"})(e),r=null!=t;switch(a){case"pro":if(!r||-1===t)return -1;return tq(t,128,32768);case"flash":if(!r)return -1;if(-1===t||0===t)return t;return tq(t,0,24576);case"flashLite":case"robotics":if(!r)return 0;if(-1===t||0===t)return t;return tq(t,512,24576);default:if(!r)return;return Math.min(t,24576)}})(r,i),s={includeThoughts:!!(i||r&&(r.includes("-2.5-")||r.includes("thinking")))&&0!==n||void 0,thinkingBudget:n};r?.toLowerCase().includes("-3-")&&o&&(s.thinkingLevel=o);let l=await tT(a.messages),d=new AbortController,c=t?.signal;c&&(c.aborted?d.abort():c.addEventListener("abort",()=>{d.abort()}));let u={abortSignal:c,maxOutputTokens:a.max_tokens,responseModalities:tj.has(r)?["Text","Image"]:void 0,safetySettings:[{category:"HARM_CATEGORY_HATE_SPEECH",threshold:tF(r)},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:tF(r)},{category:"HARM_CATEGORY_HARASSMENT",threshold:tF(r)},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:tF(r)}],systemInstruction:tG.has(r)?void 0:a.system,temperature:a.temperature,thinkingConfig:tG.has(r)||r.toLowerCase().includes("learnlm")?void 0:s,tools:this.buildGoogleToolsWithSearch(a.tools,a),topP:a.top_p},p=Date.now(),m={config:u,contents:l,model:r},g=this.isVertexAi?"DEBUG_VERTEX_AI_CHAT_COMPLETION":"DEBUG_GOOGLE_CHAT_COMPLETION";"1"===t$.env[g]&&(console.log("[requestPayload]"),console.log(JSON.stringify(m),"\n"));let h=await this.client.models.generateContentStream(m),[y,f]=this.createEnhancedStream(h,d.signal).tee();"1"===t$.env[g]&&R(f).catch();let _=await N(r,this.provider),v=(this.isVertexAi?(e,{callbacks:t,inputStartAt:a,enableStreaming:r=!0,payload:i}={})=>{let o={id:"chat_"+ed()};return e.pipeThrough(e_((e,t)=>((e,t,a)=>{let r=e.candidates?.[0],i=e.usageMetadata,o=[];if(r?.finishReason&&i&&o.push({data:r.finishReason,id:t?.id,type:"stop"},{data:Z(i,a?.pricing),id:t?.id,type:"usage"}),r&&Array.isArray(r.content?.parts)&&r.content.parts.length>0){for(let e of r.content.parts)if(e&&e.text&&!0===e.thought)return{data:e.text,id:t.id,type:"reasoning"}}if(!r)return{data:"",id:t?.id,type:"text"};if(r.content){let e=r.content.parts?.[0];if(e?.functionCall){let a=e.functionCall;return[{data:[{function:{arguments:JSON.stringify(a.args),name:a.name},id:ec(0,a.name),index:0,type:"function"}],id:t?.id,type:"tool_calls"},...o]}let{groundingChunks:a,webSearchQueries:n}=r.groundingMetadata??{};return a?[e?.text?{data:e.text,id:t?.id,type:"text"}:void 0,{data:{citations:a?.map(e=>({favicon:e.web?.title,title:e.web?.title,url:e.web?.uri})),searchQueries:n},id:t.id,type:"grounding"},...o].filter(Boolean):r.finishReason?i?[e?.text?{data:e.text,id:t?.id,type:"text"}:void 0,...o].filter(Boolean):{data:r.finishReason,id:t?.id,type:"stop"}:{data:e?.text,id:t?.id,type:"text"}}return{data:"",id:t?.id,type:"stop"}})(e,t,i),{enableStreaming:r,inputStartAt:a,streamStack:o})).pipeThrough(eg(e=>e,o)).pipeThrough(eh(t))}:(e,{callbacks:t,inputStartAt:a,enableStreaming:r=!0,payload:i}={})=>{let o={id:"chat_"+ed()};return e.pipeThrough(e_((e,t)=>((e,t,a)=>{if(e?.[eE])return{data:e[eE],id:t?.id||"error",type:"error"};if("promptFeedback"in e&&e.promptFeedback?.blockReason){var r;let a=eT[r=e.promptFeedback.blockReason]||eT.default.replace("{{blockReason}}",r);return{data:{body:{context:{promptFeedback:e.promptFeedback},message:a,provider:"google"},type:"ProviderBizError"},id:t?.id||"error",type:"error"}}let i=e.candidates?.[0],{usageMetadata:o}=e,n=[];if(i?.finishReason&&o){n.push({data:i.finishReason,id:t?.id,type:"stop"});let e=Z(o,a?.pricing);e&&n.push({data:e,id:t?.id,type:"usage"})}let s=i?.content?.parts?.filter(e=>e.functionCall).map(e=>({...e.functionCall,thoughtSignature:e.thoughtSignature}))||[];if(s.length>0)return[{data:s.map((e,t)=>({function:{arguments:JSON.stringify(e.args),name:e.name},id:ec(t,e.name),index:t,thoughtSignature:e.thoughtSignature,type:"function"})),id:t.id,type:"tool_calls"},...n];let l=i?.content?.parts?.filter(e=>e.text&&!e.thought&&!e.thoughtSignature).map(e=>e.text).join("")||"";if(i){if(Array.isArray(i.content?.parts)&&i.content.parts.length>0){for(let e of i.content.parts)if(e&&e.text&&!0===e.thought)return{data:e.text,id:t.id,type:"reasoning"}}let{groundingChunks:a,webSearchQueries:r}=i.groundingMetadata??{};if(a)return[{data:l,id:t.id,type:"text"},{data:{citations:a?.map(e=>({favicon:e.web?.title,title:e.web?.title,url:e.web?.uri})),searchQueries:r},id:t.id,type:"grounding"},...n];if(Array.isArray(i.content?.parts)&&i.content.parts.length>0){let a=i.content.parts[0];if(a&&a.inlineData&&a.inlineData.data&&a.inlineData.mimeType){let r={data:`data:${a.inlineData.mimeType};base64,${a.inlineData.data}`,id:t.id,type:"base64_image"};if(i.finishReason){let a=[r];return e.usageMetadata?a.push(...n):a.push({data:i.finishReason,id:t?.id,type:"stop"}),a}return r}}if(i.finishReason)return e.usageMetadata?[l?{data:l,id:t?.id,type:"text"}:void 0,...n].filter(Boolean):{data:i.finishReason,id:t?.id,type:"stop"};if(l?.trim())return{data:l,id:t?.id,type:"text"}}return{data:l||"",id:t?.id,type:"text"}})(e,t,i),{enableStreaming:r,inputStartAt:a,streamStack:o})).pipeThrough(eg(e=>e,o,{requireTerminalEvent:!0})).pipeThrough(eh(t))})(y,{callbacks:t?.callback,inputStartAt:p,payload:{model:r,pricing:_,provider:this.provider}});return D(v,{headers:t?.headers})}catch(a){if(tW(a))throw tD("Request was cancelled"),O.chat({error:{message:"Request was cancelled"},errorType:P.ProviderBizError,provider:this.provider});tD("Error: %O",a);let{errorType:e,error:t}=tk(a.message);throw O.chat({error:t,errorType:e,provider:this.provider})}}async createImage(e){return tO(this.client,this.provider,e)}async generateObject(e,t){let a=await tT(e.messages);return e.tools&&e.tools.length>0?tB(this.client,{contents:a,model:e.model,tools:e.tools},t):e.schema?tN(this.client,{contents:a,model:e.model,schema:e.schema},t):void 0}createEnhancedStream(e,t){let a=this.provider;return new ReadableStream({async start(r){let i=!1;try{for await(let o of e){if(t.aborted)if(i){tD("Stream cancelled gracefully, preserving existing output"),r.enqueue({[eE]:{body:{name:"Stream cancelled",provider:a,reason:"aborted"},message:"Stream cancelled",name:"Stream cancelled",type:P.StreamChunkError}}),r.close();return}else{tD("Stream cancelled before any output"),r.close();return}i=!0,r.enqueue(o)}}catch(e){if(tW(e)||t.aborted)if(i){tD("Stream reading cancelled gracefully, preserving existing output"),r.enqueue({[eE]:{body:{name:"Stream cancelled",provider:a,reason:"aborted"},message:"Stream cancelled",name:"Stream cancelled",type:P.StreamChunkError}}),r.close();return}else{tD("Stream reading cancelled before any output"),r.enqueue({[eE]:{body:{message:e.message,name:"AbortError",provider:a,stack:e.stack},message:e.message||"Request was cancelled",name:"AbortError",type:P.StreamChunkError}}),r.close();return}{tD("Stream parsing error: %O",e);let{error:t,errorType:i}=tk(e?.message||String(e));r.enqueue({[eE]:{body:{...t,provider:a},message:t?.message||e.message||"Stream parsing error",name:"Stream parsing error",type:i??P.StreamChunkError}}),r.close();return}}r.close()}})}async models(e){try{let t=`${this.baseURL}/v1beta/models?key=${this.apiKey}`,r=await fetch(t,{method:"GET",signal:e?.signal});if(!r.ok)throw Error(`HTTP error! status: ${r.status}`);let i=(await r.json()).models.map(e=>{let t=e.name.replace(/^models\//,"");return{contextWindowTokens:(e.inputTokenLimit||0)+(e.outputTokenLimit||0),displayName:e.displayName||t,id:t,maxOutput:e.outputTokenLimit||void 0}}),{MODEL_LIST_CONFIGS:o,processModelList:n}=await Promise.resolve().then(a.bind(a,61092));return n(i,o.google,"google")}catch(e){throw tD("Failed to fetch Google models: %O",e),e}}buildPayload(e){let t=e.messages.find(e=>"system"===e.role),a=e.messages.filter(e=>"system"!==e.role);return{...e,messages:a,system:t?.content}}buildGoogleToolsWithSearch(e,t){let a=t?.messages?.some(e=>e.tool_calls?.length),r=t?.enabledSearch,i=t?.urlContext,o=e&&e.length>0;return a&&o?tA(e):i&&r?[{urlContext:{}},{googleSearch:{}}]:i?[{urlContext:{}}]:r?[{googleSearch:{}}]:tA(e)}}async function tJ(e){let{pollingQuery:t,checkStatus:a,initialInterval:r=500,maxInterval:i=5e3,backoffMultiplier:o=1.5,maxConsecutiveFailures:n=3,maxRetries:s=1/0,onPollingError:l,logger:d}=e,c=0,u=0;for(;c<s;){let e;try{e=await t(),u=0}catch(e){if(u++,d?.error?.(`Failed to execute polling function (attempt ${c+1}/${s===1/0?"":s}, consecutive failures: ${u}/${n}):`,e),l){let t=l({consecutiveFailures:u,error:e,retries:c});if(!t.isContinuePolling)throw t.error||e;d?.debug?.("Custom error handler decided to continue polling")}else if(u>=n)throw Error(`Failed to execute polling function after ${u} consecutive attempts: ${e}`);if(c<s-1){let e=Math.min(r*Math.pow(o,c),i);d?.debug?.(`Waiting ${e}ms before next retry`),await new Promise(t=>{setTimeout(t,e)})}c++;continue}let p=a(e);switch(d?.debug?.(`Task status: ${p.status} (attempt ${c+1})`),p.status){case"success":return p.data;case"failed":throw p.error||Error("Task failed")}if(c<s-1){let e=Math.min(r*Math.pow(o,c),i);d?.debug?.(`Waiting ${e}ms before next retry`),await new Promise(t=>{setTimeout(t,e)})}c++}throw Error(`Task timeout after ${s} attempts`)}let tV=x()("lobe-image:qwen");async function tX(e,t){let{model:a,params:r}=e,i="https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis";tV("Creating image task with model: %s, endpoint: %s",a,i);let o=await fetch(i,{body:JSON.stringify({input:{prompt:r.prompt},model:a,parameters:{n:1,..."number"==typeof r.seed?{seed:r.seed}:{},...r.width&&r.height?{size:`${r.width}*${r.height}`}:r.size?{size:r.size.replaceAll("x","*")}:{size:"1024*1024"}}}),headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","X-DashScope-Async":"enable"},method:"POST"});if(!o.ok){let e;try{e=await o.json()}catch{}throw Error(`Failed to create image task (${o.status}): ${e?.message||o.statusText}`)}let n=await o.json();return tV("Task created with ID: %s",n.output.task_id),n.output.task_id}async function tQ(e,t){let{model:a,params:r}=e,i="https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation";tV("Creating image edit with model: %s, endpoint: %s",a,i);let o=r.imageUrl;if(!o&&r.imageUrls&&r.imageUrls.length>0&&tV("Converting imageUrls to imageUrl: using first image %s",o=r.imageUrls[0]),!o)throw Error("imageUrl or imageUrls is required for qwen-image-edit model");let n=await fetch(i,{body:JSON.stringify({input:{messages:[{content:[{image:o},{text:r.prompt}],role:"user"}]},model:a,parameters:{..."number"==typeof r.seed?{seed:r.seed}:{}}}),headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},method:"POST"});if(!n.ok){let e;try{e=await n.json()}catch{}throw Error(`Failed to create image edit (${n.status}): ${e?.message||n.statusText}`)}let s=await n.json();if(!s.output.choices||0===s.output.choices.length)throw Error("No image choices returned from qwen-image-edit API");let l=s.output.choices[0];if(!l.message.content||0===l.message.content.length)throw Error("No image content returned from qwen-image-edit API");let d=l.message.content.find(e=>"image"in e);if(!d)throw Error("No image found in response content");let c=d.image;return tV("Image edit generated successfully: %s",c),{imageUrl:c}}async function tZ(e,t){let a=`https://dashscope.aliyuncs.com/api/v1/tasks/${e}`;tV("Querying task status for: %s",e);let r=await fetch(a,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok){let e;try{e=await r.json()}catch{}throw Error(`Failed to query task status (${r.status}): ${e?.message||r.statusText}`)}return r.json()}async function t0(e,t){let{apiKey:a,provider:r}=t,{model:i}=e;try{if("qwen-image-edit"===i)return tV("Using multimodal-generation API for qwen-image-edit model"),await tQ(e,a);tV("Using text2image API for model: %s",i);let t=await tX(e,a);return await tJ({checkStatus:e=>{if(tV("Task %s status: %s",t,e.output.task_status),"SUCCEEDED"===e.output.task_status){if(!e.output.results||0===e.output.results.length)return{error:Error("Task succeeded but no images generated"),status:"failed"};let t=e.output.results[0].url;return tV("Image generated successfully: %s",t),{data:{imageUrl:t},status:"success"}}if("FAILED"===e.output.task_status){let t=e.output.error_message||"Image generation task failed";return{error:Error(`Qwen image generation failed: ${t}`),status:"failed"}}return{status:"pending"}},logger:{debug:(e,...t)=>tV(e,...t),error:(e,...t)=>tV(e,...t)},pollingQuery:()=>tZ(t,a)})}catch(e){throw tV("Error in createQwenImage: %O",e),O.createImage({error:e,errorType:"ProviderBizError",provider:r})}}var t1=a(55036);let t5=new Set(["qwen-72b-chat","qwen-14b-chat","qwen-7b-chat","qwen-1.8b-chat","qwen-1.8b-longcontext-chat"]),t2=eD({baseURL:"https://dashscope.aliyuncs.com/compatible-mode/v1",chatCompletion:{handlePayload:e=>{let{model:t,presence_penalty:a,temperature:r,thinking:i,top_p:o,enabledSearch:n,...s}=e,l=e9({presence_penalty:a,temperature:r,top_p:o},{normalizeTemperature:!1,presencePenaltyRange:t5.has(t)?void 0:{max:2,min:-2},temperatureRange:{max:2,min:0},topPRange:(t.startsWith("qvq")||t.startsWith("qwen-vl"),{max:1,min:0})});return{...s,...t.includes("-thinking")?{enable_thinking:!0,thinking_budget:i?.budget_tokens===0?0:i?.budget_tokens||void 0}:["qwen3","qwen-turbo","qwen-plus","deepseek-v3.1"].some(e=>t.toLowerCase().includes(e))?{enable_thinking:void 0!==i&&"enabled"===i.type,thinking_budget:i?.budget_tokens===0?0:i?.budget_tokens||void 0}:{},frequency_penalty:void 0,model:t,presence_penalty:l.presence_penalty,stream:!0,temperature:l.temperature,top_p:l.top_p,...n&&{enable_search:n,search_options:{search_strategy:t1.env.QWEN_SEARCH_STRATEGY||"standard"}},...e.tools&&{parallel_tool_calls:!0}}},handleStream:(e,{callbacks:t,inputStartAt:a,enableStreaming:r=!0}={})=>{let i={id:""};return(e instanceof ReadableStream?e:em(e)).pipeThrough(e_(eP,{enableStreaming:r,inputStartAt:a,streamStack:i})).pipeThrough(eg(e=>e,i)).pipeThrough(eh(t))}},createImage:t0,debug:{chatCompletion:()=>"1"===t1.env.DEBUG_QWEN_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.bY)(t,"qwen")},provider:w.ModelProvider.Qwen});var t6=a(55036);let t4=new Set(["grok-3-mini","grok-4","grok-code"]),t3=e=>Array.from(t4).some(t=>e.includes(t)),t8=eD({baseURL:"https://api.x.ai/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,frequency_penalty:a,model:r,presence_penalty:i,...o}=e;return{...o,frequency_penalty:t3(r)?void 0:a,model:r,presence_penalty:t3(r)?void 0:i,stream:!0,...t&&{search_parameters:{max_search_results:Math.min(Math.max(parseInt(t6.env.XAI_MAX_SEARCH_RESULTS??"15",10),1),30),mode:"auto",return_citations:!0,sources:[{safe_search:"1"===t6.env.XAI_SAFE_SEARCH,type:"news"},{safe_search:"1"===t6.env.XAI_SAFE_SEARCH,type:"web"},{type:"x"}]}}}}},debug:{chatCompletion:()=>"1"===t6.env.DEBUG_XAI_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.processModelList)(t,eH.MODEL_LIST_CONFIGS.xai,"xai")},provider:w.ModelProvider.XAI}),t9={anthropic:to,azure:tc,cloudflare:ty,fal:tb,google:tY,openai:eW,qwen:t2,xai:t8},t7=({id:e,routers:t,apiKey:a,models:r,...i})=>class{constructor(r={}){this._options={...r,apiKey:r.apiKey?.trim()||a,baseURL:r.baseURL?.trim()},this._routers=t,this._params=i,this._id=e}async createRuntimesByRouters(e){let t="function"==typeof this._routers?await this._routers(this._options,{model:e}):this._routers;if(0===t.length)throw Error("empty providers");return t.map(e=>{let t=new(e.runtime??t9[e.apiType]??eW)({...{...this._params,...this._options,...e.options},id:this._id});return{id:e.apiType,models:e.models,runtime:t}})}async getRuntimeByModel(e){let t=await this.createRuntimesByRouters(e);for(let a of t)if((a.models||[]).includes(e))return a.runtime;return t.at(-1).runtime}async chat(e,t){try{let a=await this.getRuntimeByModel(e.model);return await a.chat(e,t)}catch(e){if(i.chatCompletion?.handleError){let t=i.chatCompletion.handleError(e,this._options);if(t)throw t}throw e}}async generateObject(e,t){return(await this.getRuntimeByModel(e.model)).generateObject(e,t)}async createImage(e){return(await this.getRuntimeByModel(e.model)).createImage(e)}async textToImage(e){return(await this.getRuntimeByModel(e.model)).textToImage(e)}async models(){if(r&&"function"==typeof r){let e=await this.createRuntimesByRouters(),t=e.at(-1)?.runtime;if(t&&"client"in t){let e=await r({client:t.client});return await $(e)}}let e=await this.createRuntimesByRouters();return e.at(-1)?.runtime.models?.()}async embeddings(e,t){return(await this.getRuntimeByModel(e.model)).embeddings(e,t)}async textToSpeech(e,t){return(await this.getRuntimeByModel(e.model)).textToSpeech(e,t)}};var ae=a(55036);let at="https://aihubmix.com",aa=t7({debug:{chatCompletion:()=>"1"===ae.env.DEBUG_AIHUBMIX_CHAT_COMPLETION},defaultHeaders:{"APP-Code":"LobeHub"},id:w.ModelProvider.AiHubMix,models:async({client:e})=>{try{let t=(await e.models.list()).data||[];return await (0,eH.bY)(t,"aihubmix")}catch(e){return console.warn("Failed to fetch AiHubMix models. Please ensure your AiHubMix API key is valid:",e),[]}},routers:[{apiType:"anthropic",models:w.LOBE_DEFAULT_MODEL_LIST.map(e=>e.id).filter(e=>"anthropic"===(0,eH.UQ)(e)),options:{baseURL:at}},{apiType:"google",models:w.LOBE_DEFAULT_MODEL_LIST.map(e=>e.id).filter(e=>"google"===(0,eH.UQ)(e)),options:{baseURL:(0,e0.A)(at,"/gemini")}},{apiType:"xai",models:w.LOBE_DEFAULT_MODEL_LIST.map(e=>e.id).filter(e=>"xai"===(0,eH.UQ)(e)),options:{baseURL:(0,e0.A)(at,"/v1")}},{apiType:"openai",options:{baseURL:(0,e0.A)(at,"/v1"),chatCompletion:{useResponseModels:[...Array.from(p),/gpt-\d(?!\d)/,/^o\d/]}}}]});var ar=a(55036);let ai=new Set(["DeepSeek-V3-1"]),ao=eD({baseURL:"https://chatapi.akash.network/api/v1",chatCompletion:{handlePayload:e=>{let{model:t,thinking:a,...r}=e,i=a?.type==="enabled"||a?.type!=="disabled"&&void 0;return{...r,allowed_openai_params:["reasoning_effort"],cache:{"no-cache":!0},model:t,...ai.has(t)?{chat_template_kwargs:{thinking:i}}:{}}}},debug:{chatCompletion:()=>"1"===ar.env.DEBUG_AKASH_CHAT_COMPLETION},models:async({client:e})=>{try{let t=((await e.models.list()).data||[]).map(({created:e,...t})=>t);return await (0,eH.bY)(t,"akashchat")}catch(e){return console.warn("Failed to fetch AkashChat models. Please ensure your AkashChat API key is valid:",e),[]}},provider:w.ModelProvider.AkashChat});var an=a(55036);let as=x()("lobe-image:azure");class al{constructor(e={}){if(this.camelCaseKeys=e=>{if("object"!=typeof e||!e)return e;if(Array.isArray(e))return e.map(e=>this.camelCaseKeys(e));for(let t of Object.keys(e)){let a=e[t],r=this.tocamelCase(t);r!==t&&delete e[t],e[r]="object"==typeof e[r]?this.camelCaseKeys(a):a}return e},this.tocamelCase=e=>e.toLowerCase().replaceAll(/(_[a-z])/g,e=>e.toUpperCase().replace("_","")),this.maskSensitiveUrl=e=>e.replace(/^(https:\/\/)([^.]+)(\.openai\.azure\.com\/.*)$/,(e,t,a,r)=>`${t}***${r}`),!e.apiKey||!e.baseURL)throw O.createError(P.InvalidProviderAPIKey);this.client=new I.AC({apiKey:e.apiKey,apiVersion:e.apiVersion,dangerouslyAllowBrowser:!0,endpoint:e.baseURL}),this.baseURL=e.baseURL}async chat(e,t){let{messages:a,model:r,...i}=e,o=!r.includes("o1")&&(i.stream??!0),n=a.map(e=>({...e,role:(r.includes("o1")||r.includes("o3")||r.includes("gpt-5"))&&"system"===e.role?[...c].some(e=>r.includes(e))?"user":"developer":e.role}));try{let{reasoning_effort:e,...a}=i,s="minimal"===e?"low":e,l={messages:await f(n),model:r,...a,max_completion_tokens:void 0,tool_choice:i.tools?"auto":void 0},d=s?{...l,reasoning_effort:s}:l,c=o?await this.client.chat.completions.create({...d,stream:!0}):await this.client.chat.completions.create({...d,stream:!1});if(o){let[e,a]=c.tee();return"1"===an.env.DEBUG_AZURE_CHAT_COMPLETION&&R(a.toReadableStream()).catch(console.error),D(ex(e,{callbacks:t?.callback}),{headers:t?.headers})}{let e=eB(c);return D(ex(e,{callbacks:t?.callback,enableStreaming:!1}),{headers:t?.headers})}}catch(e){return this.handleError(e,r)}}async embeddings(e,t){try{return(await this.client.embeddings.create({...e,encoding_format:"float",user:t?.user},{headers:t?.headers,signal:t?.signal})).data.map(e=>e.embedding)}catch(t){return this.handleError(t,e.model)}}async createImage(e){let{model:t,params:a}=e;as("Creating image with model: %s and params: %O",t,a);try{let e={...a};if(Array.isArray(e.imageUrls)&&e.imageUrls.length>0){let t=await Promise.all(e.imageUrls.map(e=>b(e)));e.image=1===t.length?t[0]:t}e.imageUrl&&!e.image&&(e.image=await b(e.imageUrl)),delete e.imageUrls,delete e.imageUrl;let r=!!e.image;as("Is Image Edit: "+r),"auto"===e.size&&delete e.size;let i={model:t,n:1,...r?{input_fidelity:"high"}:{},...e};r||delete i.image;let o=r?await this.client.images.edit(i):await this.client.images.generate(i);if("string"==typeof o)try{o=JSON.parse(o)}catch{let e=o.length>500?o.slice(0,500)+"...[truncated]":o;throw as(`Failed to parse string response from images API. Raw response: ${e}`),Error("Invalid image response: expected JSON string but parsing failed")}else if(o&&"object"==typeof o){if("string"==typeof o.bodyAsText)try{o=JSON.parse(o.bodyAsText)}catch{let e=o.bodyAsText,t=e.length>500?e.slice(0,500)+"...[truncated]":e;throw as(`Failed to parse bodyAsText from images API. Raw response: ${t}`),Error("Invalid image response: bodyAsText not valid JSON")}else if("string"==typeof o.body)try{o=JSON.parse(o.body)}catch{throw as("Failed to parse body from images API response"),Error("Invalid image response: body not valid JSON")}}if(!o||!o.data||!Array.isArray(o.data)||0===o.data.length)throw Error(`Invalid image response: missing or empty data array. Response: ${JSON.stringify(o)}`);let n=o.data[0];if(!n)throw Error("Invalid image response: first data item is null or undefined");if(n.b64_json)return{imageUrl:`data:image/png;base64,${n.b64_json}`};if(n.url)return{imageUrl:n.url};throw Error("Invalid image response: missing both b64_json and url fields")}catch(e){return this.handleError(e,t)}}handleError(e,t){let a=e;a.code?"DeploymentNotFound"===a.code&&(a={...a,deployId:t}):a={cause:a.cause,message:a.message,name:a.name};let r=a.code?P.ProviderBizError:P.AgentRuntimeError,i=tl(a);throw O.chat({endpoint:this.maskSensitiveUrl(this.baseURL),error:i,errorType:r,provider:w.ModelProvider.Azure})}}var ad=a(55036);let ac=eD({baseURL:"https://api.baichuan-ai.com/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,temperature:a,tools:r,...i}=e,o=t?[...r||[],{type:"web_search",web_search:{enable:!0,search_mode:ad.env.BAICHUAN_SEARCH_MODE||"performance_first"}}]:r,n=e9({temperature:a},{normalizeTemperature:!0});return{...i,temperature:n.temperature,tools:o}}},debug:{chatCompletion:()=>"1"===ad.env.DEBUG_BAICHUAN_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.filter(Boolean).map(e=>{let a=t.find(t=>e.model.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.max_input_length,displayName:e.model_show_name,enabled:a?.enabled||!1,functionCall:e.function_call,id:e.model,maxOutput:e.max_tokens,reasoning:a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}})},provider:w.ModelProvider.Baichuan});var au=a(95828),ap=a(36881),am=a(15986),ag=a(55036);class ah{constructor({region:e,accessKeyId:t,accessKeySecret:a,sessionToken:r}={}){if(this.invokeEmbeddingModel=async(e,t)=>{let a=new au.Z({accept:"application/json",body:JSON.stringify({dimensions:e.dimensions,inputText:e.input,normalize:!0}),contentType:"application/json",modelId:e.model});try{let e=await this.client.send(a,{abortSignal:t?.signal});return JSON.parse(new TextDecoder().decode(e.body)).embedding}catch(e){throw O.chat({error:{body:e.$metadata,message:e.message,type:e.name},errorType:P.ProviderBizError,provider:w.ModelProvider.Bedrock,region:this.region})}},this.invokeClaudeModel=async(e,t)=>{let{max_tokens:a,messages:r,model:i,temperature:o,top_p:n,tools:s}=e,l=r.find(e=>"system"===e.role),d=r.filter(e=>"system"!==e.role),c=e9({temperature:o,top_p:n},{hasConflict:e7.BEDROCK_CLAUDE_4_PLUS.has(i),normalizeTemperature:!0,preferTemperature:!0}),u=new ap.C({accept:"application/json",body:JSON.stringify({anthropic_version:"bedrock-2023-05-31",max_tokens:a||4096,messages:await e4(d),system:l?.content,temperature:c.temperature,tools:e3(s),top_p:c.top_p}),contentType:"application/json",modelId:i});try{var p;let e,a=await this.client.send(u,{abortSignal:t?.signal}),[r,i]=ew(a).tee();return"1"===ag.env.DEBUG_BEDROCK_CHAT_COMPLETION&&R(i).catch(console.error),D((p=t?.callback,e={id:"chat_"+ed()},(r instanceof ReadableStream?r:ew(r)).pipeThrough(eg(ev,e)).pipeThrough(eh(p))),{headers:t?.headers})}catch(e){throw O.chat({error:{body:e.$metadata,message:e.message,type:e.name},errorType:P.ProviderBizError,provider:w.ModelProvider.Bedrock,region:this.region})}},this.invokeLlamaModel=async(e,t)=>{let{max_tokens:a,messages:r,model:i}=e,o=new ap.C({accept:"application/json",body:JSON.stringify({max_gen_len:a||400,prompt:"<s>[INST] "+r.map(({content:e,role:t},a)=>{switch(t){case"user":return e.trim();case"assistant":return` [/INST] ${e}</s><s>[INST] `;case"function":throw Error("Llama 2 does not support function calls.");default:if("system"===t&&0===a)return`<<SYS>>
${e}
<</SYS>>

`;throw Error(`Invalid message role: ${t}`)}}).join("")+" [/INST]"}),contentType:"application/json",modelId:i});try{var n;let e,a=await this.client.send(o),[r,i]=ew(a).tee();return"1"===ag.env.DEBUG_BEDROCK_CHAT_COMPLETION&&R(i).catch(console.error),D((n=t?.callback,e={id:"chat_"+ed()},(r instanceof ReadableStream?r:ew(r)).pipeThrough(eg(eC,e)).pipeThrough(eh(n))),{headers:t?.headers})}catch(e){throw O.chat({error:{body:e.$metadata,message:e.message,region:this.region,type:e.name},errorType:P.ProviderBizError,provider:w.ModelProvider.Bedrock,region:this.region})}},!(t&&a))throw O.createError(P.InvalidBedrockCredentials);this.region=e??"us-east-1",this.client=new am.m({credentials:{accessKeyId:t,secretAccessKey:a,sessionToken:r},region:this.region})}async chat(e,t){return e.model.startsWith("meta")?this.invokeLlamaModel(e,t):this.invokeClaudeModel(e,t)}async embeddings(e,t){return Promise.all((Array.isArray(e.input)?e.input:[e.input]).map(a=>this.invokeEmbeddingModel({dimensions:e.dimensions,input:a,model:e.model},t)))}}var ay=((s={}).ContentModerated="Content Moderated",s.Error="Error",s.Pending="Pending",s.Ready="Ready",s.RequestModerated="Request Moderated",s.TaskNotFound="Task not found",s);let af={"flux-dev":"/v1/flux-dev","flux-kontext-max":"/v1/flux-kontext-max","flux-kontext-pro":"/v1/flux-kontext-pro","flux-pro":"/v1/flux-pro","flux-pro-1.1":"/v1/flux-pro-1.1","flux-pro-1.1-ultra":"/v1/flux-pro-1.1-ultra"},a_=x()("lobe-image:bfl");async function av(e){try{let{type:t}=m(e);if("base64"===t){let t=e.match(/^data:[^;]+;base64,(.+)$/);if(t)return t[1];throw Error("Invalid base64 format")}if("url"===t){let{base64:t}=await (0,l.hs)(e);return t}throw Error(`Invalid image URL format: ${e}`)}catch(e){throw a_("Error converting image to base64: %O",e),e}}async function ab(e,t){a_("Building request payload for model: %s",e);let a=new Map([["aspectRatio","aspect_ratio"],["cfg","guidance"]]),r={output_format:"png",safety_tolerance:6,...e.includes("ultra")&&{raw:!0}},i=Object.fromEntries(Object.entries(t).filter(([,e])=>void 0!==e).map(([e,t])=>[a.get(e)??e,t]));if(t.imageUrls&&t.imageUrls.length>0){for(let e=0;e<Math.min(t.imageUrls.length,4);e++)i[0===e?"input_image":`input_image_${e+1}`]=await av(t.imageUrls[e]);delete i.imageUrls}return t.imageUrl&&(i.image_prompt=await av(t.imageUrl),delete i.imageUrl),{...r,...i}}async function aw(e,t,a){let r=af[e],i=`${a.baseURL||"https://api.bfl.ai"}${r}`;a_("Submitting task to: %s",i);let o=await fetch(i,{body:JSON.stringify(t),headers:{"Content-Type":"application/json","x-key":a.apiKey},method:"POST"});if(!o.ok){let e;try{e=await o.json()}catch{}throw Error(`BFL API error (${o.status}): ${e?.detail?.[0]?.msg||o.statusText}`)}let n=await o.json();return a_("Task submitted successfully with ID: %s",n.id),n}async function aC(e,t){a_("Querying task status using polling URL: %s",e);let a=await fetch(e,{headers:{accept:"application/json","x-key":t.apiKey},method:"GET"});if(!a.ok){let e;try{e=await a.json()}catch{}throw Error(`Failed to query task status (${a.status}): ${e?.detail?.[0]?.msg||a.statusText}`)}return a.json()}async function aT(e,t){let{model:a,params:r}=e;if(!af[a])throw O.createImage({error:Error(`Unsupported BFL model: ${a}`),errorType:P.ModelNotFound,provider:t.provider});try{let e=await ab(a,r),i=await aw(a,e,t);return await tJ({checkStatus:e=>{switch(a_("Task %s status: %s",i.id,e.status),e.status){case ay.Ready:{if(!e.result?.sample)return{error:Error("Task succeeded but no image generated"),status:"failed"};let t=e.result.sample;return a_("Image generated successfully: %s",t),{data:{imageUrl:t},status:"success"}}case ay.Error:case ay.ContentModerated:case ay.RequestModerated:{let t=`Image generation failed with status: ${e.status}`;return e.details&&"object"==typeof e.details?t+=` - Details: ${JSON.stringify(e.details)}`:e.result&&"object"==typeof e.result&&(t+=` - Result: ${JSON.stringify(e.result)}`),{error:Error(t),status:"failed"}}case ay.TaskNotFound:return{error:Error("Task not found - may have expired"),status:"failed"};default:return{status:"pending"}}},logger:{debug:(e,...t)=>a_(e,...t),error:(e,...t)=>a_(e,...t)},pollingQuery:()=>aC(i.polling_url,t)})}catch(e){throw a_("Error in createBflImage: %O",e),O.createImage({error:e,errorType:"ProviderBizError",provider:t.provider})}}let aE=x()("lobe-image:bfl");class aA{constructor({apiKey:e,baseURL:t}={}){if(!e)throw O.createError(P.InvalidProviderAPIKey);this.apiKey=e,this.baseURL=t||void 0,aE("BFL AI initialized")}async createImage(e){let{model:t,params:a}=e;aE("Creating image with model: %s and params: %O",t,a);try{return await aT(e,{apiKey:this.apiKey,baseURL:this.baseURL,provider:"bfl"})}catch(e){if(aE("Error in createImage: %O",e),e instanceof Error&&"status"in e&&401===e.status)throw O.createError(P.InvalidProviderAPIKey,{error:e});throw O.createError(P.ProviderBizError,{error:e})}}}var ak=a(55036);let ax=eD({baseURL:"https://api.cerebras.ai/v1",chatCompletion:{handlePayload:e=>{let{frequency_penalty:t,presence_penalty:a,model:r,...i}=e;return{...i,model:r}}},debug:{chatCompletion:()=>"1"===ak.env.DEBUG_CEREBRAS_CHAT_COMPLETION},models:async({client:e})=>{try{let t=await e.models.list(),a=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[];return await (0,eH.bY)(a,"cerebras")}catch(e){return console.warn("Failed to fetch Cerebras models. Please ensure your Cerebras API key is valid:",e),[]}},provider:w.ModelProvider.Cerebras});var aI=a(55036);let aP=eD({baseURL:"https://api.cohere.ai/compatibility/v1",chatCompletion:{excludeUsage:!0,handlePayload:e=>{let{frequency_penalty:t,presence_penalty:a,top_p:r,...i}=e,o=e9({frequency_penalty:t,presence_penalty:a,top_p:r},{frequencyPenaltyRange:{max:1,min:0},normalizeTemperature:!1,presencePenaltyRange:{max:1,min:0},topPRange:{max:1,min:0}});return{...i,...o}},noUserId:!0},debug:{chatCompletion:()=>"1"===aI.env.DEBUG_COHERE_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return e.baseURL="https://api.cohere.com/v1",(await e.models.list()).body.models.map(e=>{let a=t.find(t=>e.name.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.context_length,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:e.features&&e.features.includes("tools")||a?.abilities?.functionCall||!1,id:e.name,vision:e.supports_vision||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Cohere});var aO=a(55036);let aL=eD({baseURL:"https://api.cometapi.com/v1",chatCompletion:{handlePayload:e=>{let{model:t,...a}=e;return{...a,model:t,stream:!0}}},debug:{chatCompletion:()=>"1"===aO.env.DEBUG_COMETAPI_COMPLETION},models:async({client:e})=>{try{let t=((await e.models.list()).data||[]).map(e=>({id:e.id,object:e.object,owned_by:e.owned_by}));return await (0,eH.bY)(t,"cometapi")}catch(e){return console.warn("Failed to fetch CometAPI models. Please ensure your CometAPI API key is valid:",e),[]}},provider:w.ModelProvider.CometAPI});function aR(e){return e.replaceAll(/^\*\s*/gm,"").replaceAll("\\n","\n").replaceAll(/\n+/g," ").trim()}function aS(e){if(e&&"object"==typeof e&&"errorType"in e&&"error"in e&&"provider"in e)return{error:e.error,errorType:e.errorType};if(e&&"object"==typeof e&&"errorType"in e&&"body"in e){let t="Authentication failed";return e.body?.error?.message?t=e.body.error.message:e.body?.error&&"string"==typeof e.body.error?t=e.body.error:e.body?.message&&(t=e.body.message),{error:{message:t,status:401},errorType:P.InvalidProviderAPIKey}}let t=function e(t){if("string"==typeof t)return{message:aR(t)};if(t instanceof Error){if(t.cause){let a=e(t.cause);return{...a,type:a.type||t.name}}let a=aR(t.message);return{code:t.code,message:a,missingFileName:t.missingFileName,missingFileType:t.missingFileType,status:t.status||t.statusCode,type:t.name,userGuidance:t.userGuidance}}if(t&&"object"==typeof t){if(t.cause){let a=e(t.cause);return{...a,type:a.type||t.type||t.name||t.constructor?.name}}let a=[t.exception_message,t.error?.exception_message,t.error?.error,t.message,t.error?.message,t.data?.message,t.body?.message,t.body?.error?.message,t.response?.data?.message,t.response?.data?.error?.message,t.response?.text,t.response?.body,t.statusText].find(Boolean)||String(t),r=[t.status,t.statusCode,t.details?.status,t.response?.status,t.response?.statusCode,t.error?.status,t.error?.statusCode].find(Number.isInteger),i=t.code||t.error?.code||t.response?.data?.code,o=t.response?.data||t.details||void 0;(t.node_id||t.node_type||t.nodeId||t.nodeType||t.nodeName)&&(o={...o,nodeName:t.nodeName,node_id:t.node_id||t.nodeId,node_type:t.node_type||t.nodeType});let n=aR(a),s=t.missingFileName||t.body?.error?.missingFileName||t.error?.missingFileName,l=t.missingFileType||t.body?.error?.missingFileType||t.error?.missingFileType,d=t.userGuidance||t.body?.error?.userGuidance||t.error?.userGuidance;return{code:i,details:o,message:n,missingFileName:s,missingFileType:l,status:r,type:t.type||t.name||t.constructor?.name,userGuidance:d}}return{message:aR(String(t))}}(e),a=P.ComfyUIBizError,r=t.status,i=t.message;switch(r){case 400:case 401:case 404:a=P.InvalidProviderAPIKey;break;case 403:a=P.PermissionDenied;break;default:r&&r>=500?a=P.ComfyUIServiceUnavailable:!r&&i&&(i.includes("HTTP 401")||i.includes("401")?a=P.InvalidProviderAPIKey:i.includes("HTTP 403")||i.includes("403")?a=P.PermissionDenied:i.includes("HTTP 404")||i.includes("404")?a=P.InvalidProviderAPIKey:(i.includes("HTTP 400")||i.includes("400"))&&(a=P.InvalidProviderAPIKey))}return{error:t,errorType:a}}var aU=a(55036);let aM=x()("lobe-image:comfyui");class aN{constructor(e={}){aM("\uD83C\uDFD7 ComfyUI Runtime initialized"),this.options=e,this.baseURL=e.baseURL||aU.env.COMFYUI_DEFAULT_URL||"http://localhost:8188",aM(" ComfyUI Runtime ready - baseURL: %s",this.baseURL)}getAuthHeaders(){aM("\uD83D\uDD10 Providing auth headers for image download");let{authType:e="none",apiKey:t,username:a,password:r,customHeaders:i}=this.options;switch(e){case"basic":if(a&&r)return{Authorization:`Basic ${(0,l.d3)(a,r)}`};return;case"bearer":if(t)return{Authorization:`Bearer ${t}`};return;case"custom":return i||void 0;case"none":return}}async createImage(e){aM("\uD83C\uDFA8 Creating image with model: %s",e.model);try{let t="1"===aU.env.VERCEL,a=`https://${aU.env.VERCEL_URL}`,r=aU.env.APP_URL||(t?a:`http://localhost:${aU.env.PORT||3010}`),i={"Content-Type":"application/json",...this.getAuthHeaders()},o=aU.env.KEY_VAULTS_SECRET;o&&""!==o.trim()&&(i.Authorization=`Bearer ${o}`);let n=await fetch(`${r}/webapi/create-image/comfyui`,{body:JSON.stringify({model:e.model,options:this.options,params:e.params}),headers:i,method:"POST"});if(!n.ok){let e,t=await n.text();try{e=JSON.parse(t)}catch{e={message:t,status:n.status}}if(e&&"object"==typeof e&&"errorType"in e&&"error"in e&&"provider"in e)throw O.createImage({error:e.error,errorType:e.errorType,provider:e.provider});let{error:a,errorType:r}=aS(e);throw O.createImage({error:a,errorType:r,provider:"comfyui"})}let s=await n.json();return aM(" ComfyUI image created successfully"),s}catch(a){if(aM(" ComfyUI createImage error: %O",a),a&&"object"==typeof a&&"errorType"in a&&"error"in a&&"provider"in a)throw O.createImage({error:a.error,errorType:a.errorType,provider:a.provider});let{error:e,errorType:t}=aS(a);throw O.createImage({error:e,errorType:t,provider:"comfyui"})}}}var aB=a(55036);let a$=eD({baseURL:"https://api.deepseek.com/v1",chatCompletion:{handlePayload:e=>{let t=e.messages.map(e=>{if(e.reasoning?.content){let{reasoning:t,...a}=e;return{...a,reasoning_content:t.content}}return delete e.reasoning,e});return{...e,messages:t,stream:e.stream??!0}}},debug:{chatCompletion:()=>"1"===aB.env.DEBUG_DEEPSEEK_CHAT_COMPLETION},generateObject:{useToolsCalling:!0},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.processModelList)(t,eH.MODEL_LIST_CONFIGS.deepseek,"deepseek")},provider:w.ModelProvider.DeepSeek});var aD=a(55036);let aH=eD({baseURL:"https://api.fireworks.ai/inference/v1",debug:{chatCompletion:()=>"1"===aD.env.DEBUG_FIREWORKSAI_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["deepseek-r1","qwq"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.context_length,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:e.supports_tools||e.id.toLowerCase().includes("function"),id:e.id,reasoning:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:e.supports_image_input}}).filter(Boolean)},provider:w.ModelProvider.FireworksAI});var aj=a(55036);let aG=eD({baseURL:"https://ai.gitee.com/v1",debug:{chatCompletion:()=>"1"===aj.env.DEBUG_GITEE_AI_CHAT_COMPLETION},models:async({client:e})=>{try{let t=await e.models.list(),a=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[];return await (0,eH.bY)(a,"giteeai")}catch(e){return console.warn("Failed to fetch GiteeAI models. Please ensure your GiteeAI API key is valid:",e),[]}},provider:w.ModelProvider.GiteeAI});var aq=a(55036);let aK=eD({baseURL:"https://models.github.ai/inference",chatCompletion:{handlePayload:e=>{let{model:t}=e;return t.startsWith("o1")||t.startsWith("o3")?{...v(e),stream:!1}:"xai/grok-3-mini"===t?{...e,frequency_penalty:void 0,presence_penalty:void 0}:{...e,stream:e.stream??!0}}},debug:{chatCompletion:()=>"1"===aq.env.DEBUG_GITHUB_CHAT_COMPLETION},errorType:{bizError:P.ProviderBizError,invalidAPIKey:P.InvalidGithubToken},models:async()=>{let e=await fetch("https://models.github.ai/catalog/models"),t=(await e.json()).map(e=>({contextWindowTokens:e.limits?.max_input_tokens+e.limits?.max_output_tokens,description:e.summary,displayName:e.name,functionCall:e.capabilities?.includes("tool-calling")??void 0,id:e.id,maxOutput:e.limits?.max_output_tokens??void 0,reasoning:e.tags?.includes("reasoning")??void 0,releasedAt:e.version&&/^\d{4}-\d{2}-\d{2}$/.test(e.version)?e.version:void 0,vision:(e.tags?.includes("multimodal")||e.supported_input_modalities?.includes("image"))??void 0}));return await (0,eH.bY)(t,"github")},provider:w.ModelProvider.Github});var az=a(55036);let aF=e=>{if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(aF);let t={},a=new Set(["maxItems","minItems","maxLength","minLength","pattern","format","uniqueItems","maxProperties","minProperties","multipleOf","maximum","minimum","exclusiveMaximum","exclusiveMinimum"]);for(let[r,i]of Object.entries(e))a.has(r)||(t[r]=aF(i));return t},aW=eD({baseURL:"https://api.groq.com/openai/v1",chatCompletion:{handleError:e=>{if(403===e.status)return{error:e,errorType:P.LocationNotSupportError}},handlePayload:e=>{let{temperature:t,...a}=e,r=e9({temperature:t},{normalizeTemperature:!1});return{...a,stream:e.stream??!0,temperature:void 0!==r.temperature&&r.temperature<=0?void 0:r.temperature}}},debug:{chatCompletion:()=>"1"===az.env.DEBUG_GROQ_CHAT_COMPLETION},generateObject:{handleSchema:aF},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["tool","llama-3.3","llama-3.1","llama3-","mixtral-8x7b-32768","gemma2-9b-it"],i=["deepseek-r1"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.context_window,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.functionCall||!1,id:e.id,reasoning:i.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:e.id.toLowerCase().includes("vision")||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Groq});var aY=a(30143),aJ=a(55036);let aV=eD({constructorOptions:{defaultHeaders:{"HTTP-Referer":"https://lobehub.com","X-Title":"LobeHub","x-Request-Id":(0,aY.A)("lobe-chat-")}},debug:{chatCompletion:()=>"1"===aJ.env.DEBUG_HIGRESS_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.context_length,description:e.description,displayName:e.name,enabled:a?.enabled||!1,functionCall:e.description.includes("function calling")||e.description.includes("tools")||a?.abilities?.functionCall||!1,id:e.id,maxTokens:e.top_provider.max_completion_tokens,reasoning:e.description.includes("reasoning")||a?.abilities?.reasoning||!1,vision:e.description.includes("vision")||e.description.includes("multimodal")||e.id.includes("vision")||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Higress});var aX=a(90301),aQ=a(55036);let aZ=eD({chatCompletion:{handleStreamBizErrorType:e=>e.message?.includes("Model requires a Pro subscription")?P.PermissionDenied:e.message?.includes("the token seems invalid")?P.InvalidProviderAPIKey:void 0},customClient:{createChatCompletionStream:(e,t,a)=>em(e.chatCompletionStream({endpointUrl:a.baseURL?(0,e0.A)(a.baseURL,t.model):a.baseURL,max_tokens:t.max_tokens,messages:t.messages.map(e=>{let t;return"string"==typeof e.content?t=e.content:Array.isArray(e.content)&&(t=e.content.map(e=>"text"===e.type?{text:e.text,type:"text"}:"image_url"===e.type?{image_url:{detail:e.image_url.detail,url:e.image_url.url},type:"image_url"}:{text:"",type:"text"})),{content:t,name:e.name,role:e.role,tool_call_id:e.tool_call_id,tool_calls:e.tool_calls?.map(e=>({function:{arguments:e.function.arguments,name:e.function.name},id:e.id,type:"function"}))}}),model:t.model,stream:!0,temperature:t.temperature,top_p:t?.top_p?t?.top_p>=1?.99:t?.top_p<=0?.01:t?.top_p:void 0})),createClient:e=>new aX.L2(e.apiKey??"",{endpointUrl:e.baseURL??void 0})},debug:{chatCompletion:()=>"1"===aQ.env.DEBUG_HUGGINGFACE_CHAT_COMPLETION},models:async()=>{let e=[];try{let t=await fetch("https://router.huggingface.co/v1/models");t.ok&&(e=(await t.json()).data)}catch(e){return console.error("Failed to fetch HuggingFace router models:",e),[]}let t=e.map(e=>{let{architecture:t,providers:a}=e,r=a.find(e=>e.is_model_author)||a.reduce((e,t)=>{let a=Object.values(e).filter(e=>null!=e).length;return Object.values(t).filter(e=>null!=e).length>a?t:e})||a[0];if(!r)return;let i=e=>{let t=r[e];return null!=t?t:a.find(t=>t!==r&&void 0!==t[e]&&null!==t[e])?.[e]},o=t?.input_modalities||[],n=i("context_length"),s=i("supports_tools"),l="string"==typeof e.id&&e.id.includes("/")?e.id.split("/").slice(1).join("/").trim():e.id,d=i("pricing");return{contextWindowTokens:n,created:e.created,displayName:l,functionCall:s??!1,id:e.id,pricing:d,vision:o.includes("image")??!1}}).filter(e=>void 0!==e);return await (0,eH.bY)(t,"huggingface")},provider:w.ModelProvider.HuggingFace});var a0=a(55036);let a1=eD({baseURL:"https://api.hunyuan.cloud.tencent.com/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,frequency_penalty:a,model:r,presence_penalty:i,thinking:o,...n}=e;return{...n,frequency_penalty:void 0,model:r,presence_penalty:void 0,stream:!0,...t&&{citation:!0,enable_enhancement:!0,enable_speed_search:"1"===a0.env.HUNYUAN_ENABLE_SPEED_SEARCH,search_info:!0},..."hunyuan-a13b"===r&&{enable_thinking:o?.type==="enabled"||o?.type!=="disabled"&&void 0}}}},debug:{chatCompletion:()=>"1"===a0.env.DEBUG_HUNYUAN_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["hunyuan-functioncall","hunyuan-turbo","hunyuan-pro"],i=["hunyuan-t1"];return(await e.models.list()).data.filter(Boolean).map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:r.some(t=>e.id.toLowerCase().includes(t))&&!e.id.toLowerCase().includes("vision")||a?.abilities?.functionCall||!1,id:e.id,reasoning:i.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:e.id.toLowerCase().includes("vision")||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Hunyuan});var a5=a(55036);let a2=eD({baseURL:"https://cloud.infini-ai.com/maas/v1",chatCompletion:{handlePayload:e=>{let{model:t,thinking:a,...r}=e;return{...r,enable_thinking:void 0!==a&&"enabled"===a.type,model:t}}},debug:{chatCompletion:()=>"1"===a5.env.DEBUG_INFINIAI_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.bY)(t,"infiniai")},provider:w.ModelProvider.InfiniAI});var a6=a(55036);let a4=eD({baseURL:"https://internlm-chat.intern-ai.org.cn/puyu/api/v1",chatCompletion:{handlePayload:e=>({...e,stream:!e.tools})},debug:{chatCompletion:()=>"1"===a6.env.DEBUG_INTERNLM_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["internlm"],i=["internvl"];return(await e.models.list()).data.filter(e=>e&&e.id).map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.functionCall||!1,id:e.id,reasoning:a?.abilities?.reasoning||!1,vision:i.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.vision||!1}})},provider:w.ModelProvider.InternLM});var a3=a(55036);let a8=eD({baseURL:"https://deepsearch.jina.ai/v1",debug:{chatCompletion:()=>"1"===a3.env.DEBUG_JINA_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["deepsearch"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:a?.abilities?.functionCall||!1,id:e.id,reasoning:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Jina});var a9=a(55036);let a7=eD({apiKey:"placeholder-to-avoid-error",baseURL:"http://127.0.0.1:1234/v1",debug:{chatCompletion:()=>"1"===a9.env.DEBUG_LMSTUDIO_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:a?.abilities?.functionCall||!1,id:e.id,reasoning:a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.LMStudio}),re=x()("lobe-image:minimax");async function rt(e,t){let{apiKey:a,baseURL:r,provider:i}=t,{model:o,params:n}=e;try{let e=`${r}/image_generation`,t=await fetch(e,{body:JSON.stringify({aspect_ratio:n.aspectRatio,model:o,n:1,prompt:n.prompt,..."number"==typeof n.seed?{seed:n.seed}:{}}),headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},method:"POST"});if(!t.ok){let e;try{e=await t.json()}catch{}throw Error(`MiniMax API error (${t.status}): ${e?.base_resp||t.statusText}`)}let i=await t.json();if(re("Image generation response: %O",i),0!==i.base_resp.status_code)throw Error(`MiniMax API error: ${i.base_resp.status_msg}`);if(!i.data?.image_urls||0===i.data.image_urls.length)throw Error("No images generated in response");let s=parseInt(i.metadata.success_count),l=parseInt(i.metadata.failed_count);re("Image generation completed: %d successful, %d failed",s,l);let d=i.data.image_urls[0];if(!d)throw Error("No valid image URL in response");return re("Image generated successfully: %s",d),{imageUrl:d}}catch(e){throw re("Error in createMiniMaxImage: %O",e),O.createImage({error:e,errorType:"ProviderBizError",provider:i})}}var ra=a(55036);let rr=eD({baseURL:"https://api.minimaxi.com/v1",chatCompletion:{handlePayload:e=>{var t;let a,{enabledSearch:r,max_tokens:i,messages:o,temperature:n,tools:s,top_p:l,...d}=e,c=r?[...s||[],{type:"web_search"}]:s,u=o.map(e=>{if("assistant"===e.role&&e.reasoning){if(!e.reasoning.signature&&e.reasoning.content){let{reasoning:t,...a}=e;return{...a,reasoning_details:[{format:"MiniMax-response-v1",id:"reasoning-text-0",index:0,text:t.content,type:"reasoning.text"}]}}let{reasoning:t,...a}=e;return a}return e}),p=e9({max_tokens:void 0!==i?i:(t=e.model,(a=w.minimax.find(e=>e.id===t))?a.maxOutput:void 0),temperature:n,top_p:l},{normalizeTemperature:!0,topPRange:{max:1,min:.01}}),m=void 0!==p.temperature&&p.temperature<=0?void 0:p.temperature;return{...d,max_tokens:p.max_tokens,messages:u,reasoning_split:!0,temperature:m,tools:c,top_p:p.top_p}}},createImage:rt,debug:{chatCompletion:()=>"1"===ra.env.DEBUG_MINIMAX_CHAT_COMPLETION},provider:w.ModelProvider.Minimax});var ri=a(55036);let ro=eD({baseURL:"https://api.mistral.ai/v1",chatCompletion:{excludeUsage:!0,handlePayload:e=>({...e9({max_tokens:e.max_tokens,temperature:e.temperature,top_p:e.top_p},{normalizeTemperature:!0}),messages:e.messages,model:e.model,stream:!0,...e.tools&&{tools:e.tools}}),noUserId:!0},debug:{chatCompletion:()=>"1"===ri.env.DEBUG_MISTRAL_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.max_context_length,description:e.description,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:e.capabilities.function_calling,id:e.id,reasoning:a?.abilities?.reasoning||!1,vision:e.capabilities.vision}}).filter(Boolean)},provider:w.ModelProvider.Mistral});var rn=a(55036);let rs=eD({baseURL:"https://api-inference.modelscope.cn/v1",debug:{chatCompletion:()=>"1"===rn.env.DEBUG_MODELSCOPE_CHAT_COMPLETION},models:async({client:e})=>{try{let t=(await e.models.list()).data||[];return await (0,eH.bY)(t,"modelscope")}catch(e){return console.warn("Failed to fetch ModelScope models. Please ensure your ModelScope API key is valid and your Alibaba Cloud account is properly bound:",e),[]}},provider:w.ModelProvider.ModelScope});var rl=a(55036);let rd=eD({baseURL:"https://api.moonshot.cn/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,messages:a,temperature:r,tools:i,...o}=e,n=a.map(e=>"assistant"!==e.role||e.content&&""!==e.content?e:{...e,content:" "}),s=t?[...i||[],{function:{name:"$web_search"},type:"builtin_function"}]:i,l=e9({temperature:r},{normalizeTemperature:!0});return{...o,messages:n,temperature:l.temperature,tools:s}}},debug:{chatCompletion:()=>"1"===rl.env.DEBUG_MOONSHOT_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.processModelList)(t,eH.MODEL_LIST_CONFIGS.moonshot,"moonshot")},provider:w.ModelProvider.Moonshot});var rc=a(55036);let ru=eD({baseURL:"https://api.studio.nebius.com/v1",chatCompletion:{handlePayload:e=>{let{model:t,...a}=e;return{...a,model:t,stream:!0}}},debug:{chatCompletion:()=>"1"===rc.env.DEBUG_NEBIUS_CHAT_COMPLETION},models:async({client:e})=>{let t=e.baseURL||"https://api.studio.nebius.com/v1",a=`${t.replace(/\/+$/,"")}/models?verbose=true`,r=await fetch(a,{headers:{Accept:"application/json",Authorization:`Bearer ${e.apiKey}`},method:"GET"});if(!r.ok)throw Error(`Failed to fetch Nebius models: ${r.status} ${r.statusText}`);let i=await r.json(),o=(i?.data??[]).map(e=>{let t,a=e.architecture?.modality;if("string"==typeof a&&a.includes("->")){let e=a.split("->"),r=e[1]?.trim().toLowerCase();"image"===r&&(t="image"),"embedding"===r&&(t="embedding")}return{contextWindowTokens:e.context_length??void 0,description:e.description??"",displayName:e.name??e.id,functionCall:e.features?.includes("function-calling"),id:e.id,pricing:{input:1e6*e.pricing.prompt,output:1e6*e.pricing.completion},reasoning:e.features?.includes("reasoning"),type:t,vision:e.features?.includes("vision")}});return(0,eH.bY)(o,"nebius")},provider:w.ModelProvider.Nebius});var rp=a(55036);let rm=t7({debug:{chatCompletion:()=>"1"===rp.env.DEBUG_NEWAPI_CHAT_COMPLETION},defaultHeaders:{"X-Client":"LobeHub"},id:w.ModelProvider.NewAPI,models:async({client:e})=>{let t=e.baseURL.replace(/\/v\d+[a-z]*\/?$/,""),a=(await e.models.list()).data||[],r=new Map;try{let a=await fetch(`${t}/api/pricing`,{headers:{Authorization:`Bearer ${e.apiKey}`}});if(a.ok){let e=await a.json();e.success&&e.data&&e.data.forEach(e=>{r.set(e.model_name,e)})}}catch(e){console.debug("Failed to fetch NewAPI pricing info:",e)}let i=a.map(e=>{let t={...e},a=r.get(e.id);if(a){let e,r;0===a.quota_type&&(a.model_price&&a.model_price>0?e=2*a.model_price:a.model_ratio&&(e=2*a.model_ratio),void 0!==e&&(r=e*(a.completion_ratio||1),t.pricing={units:[{name:"textInput",rate:e,strategy:"fixed",unit:"millionTokens"},{name:"textOutput",rate:r,strategy:"fixed",unit:"millionTokens"}]}))}return t});return(0,eH.bY)(i,"newapi")},routers:e=>{let t=e.baseURL?.replace(/\/v\d+[a-z]*\/?$/,"")||"";return[{apiType:"anthropic",models:w.LOBE_DEFAULT_MODEL_LIST.map(e=>e.id).filter(e=>"anthropic"===(0,eH.UQ)(e)),options:{...e,baseURL:t}},{apiType:"google",models:w.LOBE_DEFAULT_MODEL_LIST.map(e=>e.id).filter(e=>"google"===(0,eH.UQ)(e)),options:{...e,baseURL:t}},{apiType:"xai",models:w.LOBE_DEFAULT_MODEL_LIST.map(e=>e.id).filter(e=>"xai"===(0,eH.UQ)(e)),options:{...e,baseURL:(0,e0.A)(t,"/v1")}},{apiType:"openai",options:{...e,baseURL:(0,e0.A)(t,"/v1"),chatCompletion:{useResponseModels:[...Array.from(p),/gpt-\d(?!\d)/,/^o\d/]}}}]}});var rg=a(55036);let rh=e=>{if(null!=e&&"number"==typeof e&&-1!==e)return Number((e/1e4).toPrecision(5))},ry=eD({baseURL:"https://api.novita.ai/v3/openai",constructorOptions:{defaultHeaders:{"X-Novita-Source":"lobechat"}},debug:{chatCompletion:()=>"1"===rg.env.DEBUG_NOVITA_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data.map(e=>{let t=Array.isArray(e.features)?e.features:[],a=Array.isArray(e.input_modalities)?e.input_modalities:[];return{contextWindowTokens:e.context_size??e.max_output_tokens??void 0,created:e.created,description:e.description??"",displayName:e.display_name??e.title??e.id,functionCall:t.includes("function-calling")||!1,id:e.id,maxOutput:"number"==typeof e.max_output_tokens?e.max_output_tokens:void 0,pricing:{input:rh(e.input_token_price_per_m),output:rh(e.output_token_price_per_m)},reasoning:t.includes("reasoning")||!1,type:e.model_type??void 0,vision:a.includes("image")||t.includes("vision")||!1}});return await (0,eH.bY)(t,"novita")},provider:w.ModelProvider.Novita});var rf=a(55036);let r_=new Set(["deepseek-ai/deepseek-v3.1","deepseek-ai/deepseek-v3.1-terminus"]),rv=eD({baseURL:"https://integrate.api.nvidia.com/v1",chatCompletion:{handlePayload:e=>{let{model:t,thinking:a,...r}=e,i=a?.type==="enabled"||a?.type!=="disabled"&&void 0;return{...r,model:t,...r_.has(t)?{chat_template_kwargs:{thinking:i}}:{}}}},debug:{chatCompletion:()=>"1"===rf.env.DEBUG_NVIDIA_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.bY)(t,"nvidia")},provider:w.ModelProvider.Nvidia});var rb=a(55583),rw=a(22309),rC=a(55036);w.ModelProvider.Ollama;class rT{constructor({baseURL:e}={}){this.invokeEmbeddingModel=async e=>{try{return(await this.client.embeddings({model:e.model,prompt:e.input})).embedding}catch(e){throw O.chat({error:{message:e.message,name:e.name,status_code:e.status_code},errorType:P.OllamaBizError,provider:w.ModelProvider.Ollama})}},this.convertContentToOllamaMessage=async e=>{if("string"==typeof e.content)return{content:e.content,role:e.role};let t={content:"",role:e.role},a=[];for(let r of e.content)switch(r.type){case"text":t.content=r.text;break;case"image_url":{let{base64:e,type:t}=m(r.image_url.url);e?a.push(e):"url"===t&&a.push((0,l.hs)(r.image_url.url).then(e=>e.base64).catch(()=>null))}}if(a.length>0){let e=(await Promise.all(a)).filter(e=>null!==e);e.length>0&&(t.images=e)}return t};try{e&&new URL(e)}catch(e){throw O.createError(P.InvalidOllamaArgs,e)}this.client=new rb.n(!e?void 0:{host:e}),e&&(this.baseURL=e)}async chat(e,t){try{var a;let r,i=()=>{this.client.abort(),t?.signal?.removeEventListener("abort",i)};t?.signal?.addEventListener("abort",i);let o=await this.client.chat({messages:await this.buildOllamaMessages(e.messages),model:e.model,options:{frequency_penalty:e.frequency_penalty,presence_penalty:e.presence_penalty,temperature:void 0!==e.temperature?e.temperature/2:void 0,top_p:e.top_p},stream:!0,tools:e.tools}),[n,s]=em(o).tee();return"1"===rC.env.DEBUG_OLLAMA_CHAT_COMPLETION&&R(s).catch(console.error),D((a=t?.callback,r={id:"chat_"+ed()},n.pipeThrough(eg(eA,r)).pipeThrough(eh(a))),{headers:t?.headers})}catch(e){if("fetch failed"===e.message)throw O.chat({error:{message:"please check whether your ollama service is available"},errorType:P.OllamaServiceUnavailable,provider:w.ModelProvider.Ollama});throw O.chat({error:{..."string"!=typeof e.error?e.error:void 0,message:String(e.error?.message||e.message),name:e.name,status_code:e.status_code},errorType:P.OllamaBizError,provider:w.ModelProvider.Ollama})}}async embeddings(e){let t=(Array.isArray(e.input)?e.input:[e.input]).map(t=>this.invokeEmbeddingModel({dimensions:e.dimensions,input:t,model:e.model}));return await Promise.all(t)}async models(){let{LOBE_DEFAULT_MODEL_LIST:e}=await Promise.resolve().then(a.bind(a,80286));return(await this.client.list()).models.map(t=>{let a=e.find(e=>t.name.toLowerCase()===e.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:a?.abilities?.functionCall||!1,id:t.name,reasoning:a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)}async buildOllamaMessages(e){return Promise.all(e.map(e=>this.convertContentToOllamaMessage(e)))}async pullModel(e,t){let{model:a,insecure:r}=e,i=t?.signal,o=()=>{this.client.abort()};i?.addEventListener("abort",o,{once:!0});try{let e=await this.client.pull({insecure:r??!1,model:a,stream:!0}),t=((e,t,{onCancel:a}={})=>{let r;return new ReadableStream({cancel(e){a&&a(e),r&&"function"==typeof r.return&&r.return().catch()},async start(a){r=e[Symbol.asyncIterator]();let i=new TextEncoder;try{for(;;){let{value:e,done:o}=await r.next();if(o)break;if("pulling manifest"===e.status)continue;let n=JSON.stringify({completed:e.completed,digest:e.digest,model:t,status:e.status,total:e.total})+"\n";a.enqueue(i.encode(n))}a.close()}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)try{a.enqueue(new TextEncoder().encode(JSON.stringify({status:"cancelled"}))),a.close()}catch{}else{console.error("[createModelPullStream] model download stream error:",e);let r=JSON.stringify({error:e instanceof Error?e.message:String(e),model:t,status:"error"})+"\n";try{null!==a.desiredSize&&a.desiredSize>0&&a.enqueue(i.encode(r))}catch(e){console.error("[createModelPullStream] Error enqueueing error message:",e)}try{a.close()}catch{a.error(e)}}}}})})(e,a,{onCancel:()=>{i?.removeEventListener("abort",o),o()}});return new Response(t,{headers:{"Content-Type":"application/json"}})}catch(e){if(i?.removeEventListener("abort",o),"fetch failed"===e.message){var n,s;let e;return n=P.OllamaServiceUnavailable,s={message:"please check whether your ollama service is available",provider:w.ModelProvider.Ollama},("number"!=typeof(e=(e=>{if(e.toString().includes("Invalid"))return 401;switch(e){case P.InvalidProviderAPIKey:return 401;case P.ExceededContextWindow:return 400;case P.LocationNotSupportError:return 403;case P.ModelNotFound:return 404;case P.InsufficientQuota:case P.QuotaLimitReached:return 429;case P.AgentRuntimeError:return 470;case P.ProviderBizError:return 471;case P.OllamaServiceUnavailable:case rw.T_.OllamaServiceUnavailable:case P.OllamaBizError:return 472}return e})(n))||e<200||e>599)&&console.error(`current StatusCode: \`${e}\` .`,"Please go to `./utils/errorResponse.ts` to defined the statusCode."),new Response(JSON.stringify({body:s,errorType:n}),{status:e})}if(console.error("model download error:",e),"AbortError"===e.name)return new Response(JSON.stringify({model:a,status:"cancelled"}),{headers:{"Content-Type":"application/json"},status:499});return new Response(JSON.stringify({error:e instanceof Error?e.message:String(e),model:a,status:"error"}),{headers:{"Content-Type":"application/json"},status:500})}}}var rE=a(55036);let rA=eD({baseURL:"https://ollama.com/v1",chatCompletion:{handlePayload:e=>{let{model:t,...a}=e;return{...a,model:t}}},debug:{chatCompletion:()=>"1"===rE.env.DEBUG_OLLAMA_CLOUD_CHAT_COMPLETION},models:async({client:e})=>{try{let t=await e.models.list(),a=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[];return await (0,eH.bY)(a,"ollamacloud")}catch(e){return console.warn("Failed to fetch Ollama Cloud models. Please ensure your Ollama Cloud API key is valid:",e),[]}},provider:w.ModelProvider.OllamaCloud});var rk=a(55036);let rx=e=>{if(void 0!==e&&"-1"!==e)return Number((1e6*Number(e)).toPrecision(5))},rI=eD({baseURL:"https://openrouter.ai/api/v1",chatCompletion:{handlePayload:e=>{let{thinking:t,model:a,max_tokens:r}=e,i={};if(t?.type==="enabled"){let e=w.openrouter.find(e=>e.id===a),o=e?.maxOutput;i={max_tokens:t?.budget_tokens?Math.min(t.budget_tokens,(r||o||void 0||32e3)-1):1024}}return{...e,model:e.enabledSearch?`${e.model}:online`:e.model,reasoning:i,stream:e.stream??!0}}},constructorOptions:{defaultHeaders:{"HTTP-Referer":"https://lobehub.com","X-Title":"LobeHub"}},debug:{chatCompletion:()=>"1"===rk.env.DEBUG_OPENROUTER_CHAT_COMPLETION},models:async()=>{let e=[];try{let t=await fetch("https://openrouter.ai/api/v1/models");t.ok&&(e=(await t.json()).data)}catch(e){return console.error("Failed to fetch OpenRouter frontend models:",e),[]}let t=e.map(e=>{let{top_provider:t,architecture:a,pricing:r,supported_parameters:i}=e,o=a.input_modalities||[],n=e.name,s=n.indexOf(":");if(-1!==s){let t=n.slice(0,Math.max(0,s)).trim(),a=n.slice(Math.max(0,s+1)).trim(),r="deepseek"===t.toLowerCase(),i=a.toLowerCase().includes("deepseek");n=r&&!i?e.name:a}let l=rx(r.prompt),d=rx(r.completion),c=rx(r.input_cache_read),u=rx(r.input_cache_write);return 0!==l||0!==d||n.endsWith("(free)")||(n+=" (free)"),{contextWindowTokens:t.context_length||e.context_length,description:e.description,displayName:n,functionCall:i.includes("tools"),id:e.id,maxOutput:"number"==typeof t.max_completion_tokens?t.max_completion_tokens:void 0,pricing:{cachedInput:c,input:l,output:d,writeCacheInput:u},reasoning:i.includes("reasoning"),releasedAt:new Date(1e3*e.created).toISOString().split("T")[0],vision:o.includes("image")}});return await (0,eH.bY)(t,"openrouter")},provider:w.ModelProvider.OpenRouter});var rP=a(55036);let rO=eD({baseURL:"https://api.perplexity.ai",chatCompletion:{handlePayload:e=>{let{presence_penalty:t,frequency_penalty:a,stream:r=!0,temperature:i,...o}=e,n=e9({frequency_penalty:0!==t?void 0:a||1,presence_penalty:0!==t?t:void 0,temperature:i},{normalizeTemperature:!1}),s=void 0!==n.temperature&&n.temperature>=2?void 0:n.temperature;return{...o,frequency_penalty:n.frequency_penalty,presence_penalty:n.presence_penalty,stream:r,temperature:s}}},debug:{chatCompletion:()=>"1"===rP.env.DEBUG_PERPLEXITY_CHAT_COMPLETION},provider:w.ModelProvider.Perplexity});var rL=a(55036);let rR=eD({baseURL:"https://api.ppinfra.com/v3/openai",constructorOptions:{defaultHeaders:{"X-API-Source":"lobechat"}},debug:{chatCompletion:()=>"1"===rL.env.DEBUG_PPIO_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["deepseek-r1"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.context_size,description:e.description,displayName:e.display_name?.replace(/[\t]/g,e=>""===e?" (":""===e?")":"")||e.title||e.id,enabled:a?.enabled||!1,functionCall:a?.abilities?.functionCall||!1,id:e.id,reasoning:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:e.description.toLowerCase().includes("")||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.PPIO});var rS=a(55036);let rU=eD({apiKey:"placeholder-to-avoid-error",baseURL:"https://openai.qiniu.com/v1",debug:{chatCompletion:()=>"1"===rS.env.DEBUG_QINIU_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data.map(e=>{let{created:t,...a}=e;return a});return(0,eH.bY)(t,"qiniu")},provider:w.ModelProvider.Qiniu});var rM=a(55036);let rN=eD({baseURL:"https://api.sambanova.ai/v1",debug:{chatCompletion:()=>"1"===rM.env.DEBUG_SAMBANOVA_CHAT_COMPLETION},provider:w.ModelProvider.SambaNova});var rB=a(55036);let r$=eD({baseURL:"https://api.search1api.com/v1",chatCompletion:{handlePayload:e=>{let t,{presence_penalty:a,frequency_penalty:r,stream:i=!0,temperature:o,...n}=e;return t=0!==a?{presence_penalty:a}:{frequency_penalty:r||1},{...n,...t,stream:i,temperature:void 0!==o&&o>=2?void 0:o}}},debug:{chatCompletion:()=>"1"===rB.env.DEBUG_SEARCH1API_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.filter(e=>e&&e.id).map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled??!1,functionCall:a?.abilities?.functionCall||!1,id:e.id,reasoning:a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Search1API});var rD=a(55036);let rH=eD({baseURL:"https://api.sensenova.cn/compatible-mode/v1",chatCompletion:{handlePayload:e=>{let{frequency_penalty:t,max_tokens:a,messages:r,model:i,temperature:o,thinking:n,top_p:s,...l}=e;return{...l,frequency_penalty:void 0!==t&&t>0&&t<=2?t:void 0,max_new_tokens:void 0!==a&&a>0?a:void 0,messages:r.map(e=>{var t;return"user"===e.role&&i&&/^Sense(Nova-V6|Chat-Vision)/.test(i)?{...e,content:"string"==typeof(t=e.content)?[{text:t,type:"text"}]:Array.isArray(t)?t.map(e=>{if(!e)return null;if("text"===e.type)return e;if("image_url"===e.type&&e.image_url){let t=e.image_url.url;return t&&"string"==typeof t?t.startsWith("data:image/jpeg;base64")||t.startsWith("data:image/png;base64")?{image_base64:t.split(",")[1],type:"image_base64"}:{image_url:t,type:"image_url"}:null}return null}).filter(Boolean):[]}:e}),model:i,stream:!0,temperature:void 0!==o&&o>0&&o<=2?o:void 0,thinking:n?i&&i.includes("-V6-5-")&&"enabled"===n.type?{enabled:!0}:{enabled:!1}:void 0,top_p:void 0!==s&&s>0&&s<1?s:void 0}}},debug:{chatCompletion:()=>"1"===rD.env.DEBUG_SENSENOVA_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["1202"],i=["vision","sensenova-v6"],o=["deepseek-r1","reasoner"];return e.baseURL="https://api.sensenova.cn/v1/llm",(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.functionCall||!1,id:e.id,reasoning:o.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:i.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.SenseNova}),rj=x()("lobe-image:siliconcloud");async function rG(e){let{type:t,base64:a,mimeType:r}=m(e);if("base64"===t){if(!a)throw TypeError("Image URL doesn't contain base64 data");return`data:${r||"image/png"};base64,${a}`}if("url"===t){let{base64:t,mimeType:a}=await (0,l.hs)(e);return`data:${a};base64,${t}`}throw TypeError(`Unsupported image url: ${e}`)}async function rq(e,t){let{model:a,params:r}=e,{apiKey:i,baseURL:o,provider:n}=t;rj("Creating image with SiliconCloud model: %s, params: %O",a,r);let s=`${o}/images/generations`,l=new Map([["negativePrompt","negative_prompt"],["size","image_size"],["n","batch_size"],["steps","num_inference_steps"]]),d={model:a,prompt:r.prompt};for(let[e,t]of Object.entries(r))if(null!=t){if("cfg"===e){a.toLowerCase().includes("kolors")?d.guidance_scale=t:d.cfg=t;continue}if("imageUrl"===e){"string"==typeof t&&(d.image=await rG(t));continue}if("imageUrls"===e){Array.isArray(t)&&t.length>0&&(d.image=await rG(t[0]),"Qwen/Qwen-Image-Edit-2509"===a&&(t.length>1&&(d.image2=await rG(t[1])),t.length>2&&(d.image3=await rG(t[2]))));continue}d[l.get(e)||e]=t}rj("Request body: %O",d);let c=await fetch(s,{body:JSON.stringify(d),headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},method:"POST"});if(!c.ok){let e=await c.json().catch(()=>null);throw rj("Error response from SiliconCloud API: %O",{errorData:e,status:c.status,statusText:c.statusText}),O.createImage({error:{...e,status:c.status,statusText:c.statusText},errorType:P.ProviderBizError,provider:n})}let u=await c.json();if(rj("SiliconCloud API response: %O",u),!u.images||0===u.images.length||!u.images[0].url)throw rj("Invalid response from SiliconCloud API: no images generated. Response data: %O",u),O.createImage({error:{data:u,message:"No images generated"},errorType:P.ProviderBizError,provider:n});return{imageUrl:u.images[0].url}}var rK=a(55036);let rz=eD({baseURL:"https://api.siliconflow.cn/v1",chatCompletion:{handleError:e=>{let t;if(e instanceof Response?t=e:"status"in e&&(t=e),t){if(401===t.status)return{error:t.status,errorType:P.InvalidProviderAPIKey};if(403===t.status)return{error:t.status,errorType:P.ProviderBizError,message:" API Key  API Key "}}return{error:e}},handlePayload:e=>{let{max_tokens:t,model:a,thinking:r,...i}=e,o=r?.budget_tokens===0?1:r?.budget_tokens||void 0,n={...i,max_tokens:void 0===t?void 0:Math.min(Math.max(t,1),16384),model:a};return r&&([/GLM-4\.5(?!.*Air$)/,/Qwen3-(?:\d+B|\d+B-A\d+B)$/,/DeepSeek-V3\.1/,/Hunyuan-A13B-Instruct/].some(e=>e.test(a))&&(n.enable_thinking="enabled"===r.type),void 0!==o&&(n.thinking_budget=Math.min(Math.max(o,1),32768))),n}},createImage:rq,debug:{chatCompletion:()=>"1"===rK.env.DEBUG_SILICONCLOUD_CHAT_COMPLETION},errorType:{bizError:P.ProviderBizError,invalidAPIKey:P.InvalidProviderAPIKey},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.bY)(t,"siliconcloud")},provider:w.ModelProvider.SiliconCloud});var rF=a(55036);let rW=eD({baseURL:"https://spark-api-open.xf-yun.com/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,tools:a,...r}=e,i=t?[...a||[],{type:"web_search",web_search:{enable:!0,search_mode:rF.env.SPARK_SEARCH_MODE||"normal"}}]:a;return{...r,tools:i}},handleStream:(e,{callbacks:t,inputStartAt:a}={})=>(e instanceof ReadableStream?e:em(e)).pipeThrough(eg(eO)).pipeThrough(eh(t)),handleTransformResponseToStream:function(e){return new ReadableStream({start(t){let a=e?.choices||[],r={choices:a.map(e=>{let t=e.message.tool_calls?Array.isArray(e.message.tool_calls)?e.message.tool_calls:[e.message.tool_calls]:[];return{delta:{content:e.message.content,role:e.message.role,tool_calls:t.map((e,t)=>({function:e.function,id:e.id,index:t,type:e.type}))},finish_reason:null,index:e.index,logprobs:e.logprobs}}),created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk"};t.enqueue(r),e.usage&&t.enqueue({choices:[],created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk",usage:e.usage}),t.enqueue({choices:a.map(e=>({delta:{content:null,role:e.message.role},finish_reason:e.finish_reason,index:e.index,logprobs:e.logprobs})),created:e.created,id:e.id,model:e.model,object:"chat.completion.chunk",system_fingerprint:e.system_fingerprint}),t.close()}})},noUserId:!0},debug:{chatCompletion:()=>"1"===rF.env.DEBUG_SPARK_CHAT_COMPLETION},provider:w.ModelProvider.Spark});var rY=a(55036);let rJ=eD({baseURL:"https://api.stepfun.com/v1",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,tools:a,...r}=e,i=t?[...a||[],{function:{description:"use web_search to search information on the internet"},type:"web_search"}]:a;return{...r,stream:!i,tools:i}}},debug:{chatCompletion:()=>"1"===rY.env.DEBUG_STEPFUN_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["step-1-","step-1o-","step-1v-","step-2-"],i=["step-1o-","step-r1-v-","step-1v-"],o=["step-r1-"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.functionCall||!1,id:e.id,reasoning:o.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:i.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Stepfun});var rV=a(55036);let rX=eD({baseURL:"https://ai-maas.wair.ac.cn/maas/v1",chatCompletion:{handlePayload:e=>{let{temperature:t,top_p:a,...r}=e;return{...r,temperature:void 0!==t?Math.max(t/2,.01):void 0,top_p:void 0!==a?Math.min(9.9,Math.max(a/2,.1)):void 0}}},debug:{chatCompletion:()=>"1"===rV.env.DEBUG_TAICHU_CHAT_COMPLETION},provider:w.ModelProvider.Taichu});var rQ=a(55036);let rZ=eD({baseURL:"https://api.lkeap.cloud.tencent.com/v1",debug:{chatCompletion:()=>"1"===rQ.env.DEBUG_TENCENT_CLOUD_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["deepseek-r1"];return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:a?.abilities?.functionCall||!1,id:e.id,reasoning:r.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.TencentCloud});var r0=a(55036);let r1=eD({baseURL:"https://api.together.xyz/v1",constructorOptions:{defaultHeaders:{"HTTP-Referer":"https://chat-preview.lobehub.com","X-Title":"Lobe Chat"}},debug:{chatCompletion:()=>"1"===r0.env.DEBUG_TOGETHERAI_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286)),r=["qvq","vision"],i=["deepseek-r1","qwq"];return e.baseURL="https://api.together.xyz/api",(await e.models.list()).body.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,description:e.description,displayName:e.display_name,enabled:a?.enabled||!1,functionCall:e.description?.toLowerCase().includes("function calling")||a?.abilities?.functionCall||!1,id:e.id,maxOutput:e.context_length,reasoning:i.some(t=>e.id.toLowerCase().includes(t))||a?.abilities?.reasoning||!1,tokens:e.context_length,vision:e.description?.toLowerCase().includes("vision")||r.some(t=>e.id?.toLowerCase().includes(t))||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.TogetherAI});var r5=a(55036);let r2=eD({baseURL:"https://api.upstage.ai/v1/solar",debug:{chatCompletion:()=>"1"===r5.env.DEBUG_UPSTAGE_CHAT_COMPLETION},provider:w.ModelProvider.Upstage});var r6=a(55036);let r4=eD({baseURL:"https://api.v0.dev/v1",debug:{chatCompletion:()=>"1"===r6.env.DEBUG_V0_CHAT_COMPLETION},models:async({client:e})=>{try{let t=await e.models.list(),a=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[];return(0,eH.processModelList)(a,eH.MODEL_LIST_CONFIGS.v0,"v0")}catch(e){return console.warn("Failed to fetch V0 models. Please ensure your V0 API key is valid:",e),[]}},provider:w.ModelProvider.V0});var r3=a(55036);let r8=e=>{if(null==e)return;let t="number"==typeof e?e:Number(e);if(!Number.isNaN(t))return Number((1e6*t).toPrecision(5))},r9=eD({baseURL:"https://ai-gateway.vercel.sh/v1",chatCompletion:{handlePayload:e=>{let{model:t,reasoning_effort:a,verbosity:r,...i}=e,o={};return(a||r)&&(o.openai={},a&&(o.openai.reasoningEffort=a,o.openai.reasoningSummary="auto"),r&&(o.openai.textVerbosity=r)),{...i,model:t,providerOptions:o}}},constructorOptions:{defaultHeaders:{"http-referer":"https://lobehub.com","x-title":"LobeHub"}},debug:{chatCompletion:()=>"1"===r3.env.DEBUG_VERCELAIGATEWAY_CHAT_COMPLETION},models:async({client:e})=>{let t=((await e.models.list()).data||[]).map(e=>{let t=Array.isArray(e.tags)?e.tags:[],a=r8(e.pricing?.input),r=r8(e.pricing?.output),i=r8(e.pricing?.input_cache_read),o=r8(e.pricing?.input_cache_write),n=e.name??e.id;return 0===a&&0===r&&(n+=" (free)"),{contextWindowTokens:e.context_window??void 0,created:e.created,description:e.description??"",displayName:n,functionCall:t.includes("tool-use")||!1,id:e.id,maxOutput:"number"==typeof e.max_tokens?e.max_tokens:void 0,pricing:{cachedInput:i,input:a,output:r,writeCacheInput:o},reasoning:t.includes("reasoning")||!1,type:"embedding"===e.type?"embedding":"chat",vision:t.includes("vision")||!1}});return await (0,eH.bY)(t,"vercelaigateway")},provider:w.ModelProvider.VercelAIGateway});var r7=a(55036);let ie=eD({baseURL:"http://localhost:8000/v1",debug:{chatCompletion:()=>"1"===r7.env.DEBUG_VLLM_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:a?.contextWindowTokens??void 0,displayName:a?.displayName??void 0,enabled:a?.enabled||!1,functionCall:a?.abilities?.functionCall||!1,id:e.id,reasoning:a?.abilities?.reasoning||!1,vision:a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.VLLM}),it=x()("lobe-image:volcengine");async function ia(e,t){let a,r,i,{model:o,params:n}=e;it("Creating image with Volcengine API - model: %s, params: %O",o,n);let s=new I.Ay({apiKey:t.apiKey,baseURL:t.baseURL||"https://ark.cn-beijing.volces.com/api/v3"}),l=new Map([["imageUrls","image"],["imageUrl","image"],["cfg","guidance_scale"]]),d=Object.fromEntries(Object.entries(n).map(([e,t])=>[l.get(e)??e,t]));null!==d.image&&void 0!==d.image&&(!Array.isArray(d.image)||d.image.length>0)?it("Image input detected: %O",d.image):delete d.image;let c={model:o,watermark:!1,...d};it("Volcengine API options: %O",c);let u=await s.images.generate(c);if(it("Volcengine API response: %O",u),!u||!u.data||!Array.isArray(u.data)||0===u.data.length)throw it("Invalid response: missing data array"),Error("Invalid response: missing or empty data array");let p=u.data[0];if(!p)throw it("Invalid response: first data item is null/undefined"),Error("Invalid response: first data item is null or undefined");if(p.b64_json)it("Successfully converted base64 to data URL, length: %d",(a=`data:image/jpeg;base64,${p.b64_json}`).length);else if(p.url)it("Using direct image URL: %s",a=p.url);else throw it("Invalid response: missing both b64_json and url fields"),Error("Invalid response: missing both b64_json and url fields");if(p.size){let e=p.size.match(/^(\d+)x(\d+)$/);e&&it("Extracted image dimensions: %dx%d",r=parseInt(e[1],10),i=parseInt(e[2],10))}return{height:i,imageUrl:a,width:r}}var ir=a(55036);let ii=["thinking-vision-pro","thinking-pro-m","doubao-seed-1-6","doubao-1-5-ui-tars","deepseek-v3-1"],io=eD({baseURL:"https://ark.cn-beijing.volces.com/api/v3",chatCompletion:{handlePayload:e=>{let{model:t,thinking:a,...r}=e;return{...r,model:t,...ii.some(e=>t.toLowerCase().includes(e))?{thinking:{type:a?.type}}:{}}}},createImage:ia,debug:{chatCompletion:()=>"1"===ir.env.DEBUG_VOLCENGINE_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data;return(0,eH.processModelList)(t,eH.MODEL_LIST_CONFIGS.volcengine,"volcengine")},provider:w.ModelProvider.Volcengine});var is=a(55036);let il=eD({baseURL:"https://qianfan.baidubce.com/v2",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,thinking:a,...r}=e;return{...r,stream:!0,...t&&{web_search:{enable:!0,enable_citation:!0,enable_trace:!0}},...a&&{enable_thinking:({disabled:!1,enabled:!0})[a.type],...a?.budget_tokens!==0&&{thinking_budget:Math.min(Math.max(a?.budget_tokens,100),16384)}}}}},debug:{chatCompletion:()=>"1"===is.env.DEBUG_WENXIN_CHAT_COMPLETION},models:async({client:e})=>{let t=(await e.models.list()).data.map(e=>({id:e.id}));return(0,eH.bY)(t,"wenxin")},provider:w.ModelProvider.Wenxin});var id=a(55036);let ic=eD({baseURL:"http://localhost:9997/v1",debug:{chatCompletion:()=>"1"===id.env.DEBUG_XINFERENCE_CHAT_COMPLETION},models:async({client:e})=>{let{LOBE_DEFAULT_MODEL_LIST:t}=await Promise.resolve().then(a.bind(a,80286));return(await e.models.list()).data.map(e=>{let a=t.find(t=>e.id.toLowerCase()===t.id.toLowerCase());return{contextWindowTokens:e.context_length,description:e.model_description,displayName:e.name,enabled:a?.enabled||!1,functionCall:e.model_ability&&e.model_ability.includes("tools")||a?.abilities?.functionCall||!1,id:e.id,reasoning:e.model_ability&&e.model_ability.includes("reasoning")||a?.abilities?.reasoning||!1,vision:e.model_ability&&e.model_ability.includes("vision")||a?.abilities?.vision||!1}}).filter(Boolean)},provider:w.ModelProvider.Xinference});var iu=a(55036);let ip=eD({baseURL:"https://api.lingyiwanwu.com/v1",debug:{chatCompletion:()=>"1"===iu.env.DEBUG_ZEROONE_CHAT_COMPLETION},models:async({client:e})=>{try{let t=await e.models.list(),a=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[];return(0,eH.processModelList)(a,eH.MODEL_LIST_CONFIGS.zeroone)}catch(e){return console.warn("Failed to fetch ZeroOne models. Please ensure your ZeroOne API key is valid:",e),[]}},provider:w.ModelProvider.ZeroOne});var im=a(55036);let ig={ai21:eJ,ai302:eX,ai360:eZ,aihubmix:aa,akashchat:ao,anthropic:to,azure:al,azureai:tc,baichuan:ac,bedrock:ah,bfl:aA,cerebras:ax,cloudflare:ty,cohere:aP,cometapi:aL,comfyui:aN,deepseek:a$,fal:tb,fireworksai:aH,giteeai:aG,github:aK,google:tY,groq:aW,higress:aV,huggingface:aZ,hunyuan:a1,infiniai:a2,internlm:a4,jina:a8,lmstudio:a7,minimax:rr,mistral:ro,modelscope:rs,moonshot:rd,nebius:ru,newapi:rm,novita:ry,nvidia:rv,ollama:rT,ollamacloud:rA,openai:eW,openrouter:rI,perplexity:rO,ppio:rR,qiniu:rU,qwen:t2,sambanova:rN,search1api:r$,sensenova:rH,siliconcloud:rz,spark:rW,stepfun:rJ,taichu:rX,tencentcloud:rZ,togetherai:r1,upstage:r2,v0:r4,vercelaigateway:r9,vllm:ie,volcengine:io,wenxin:il,xai:t8,xinference:ic,zeroone:ip,zhipu:eD({baseURL:"https://open.bigmodel.cn/api/paas/v4",chatCompletion:{handlePayload:e=>{let{enabledSearch:t,max_tokens:a,model:r,temperature:i,thinking:o,tools:n,top_p:s,...l}=e,d=t?[...n||[],{type:"web_search",web_search:{enable:!0,result_sequence:"before",search_engine:im.env.ZHIPU_SEARCH_ENGINE||"search_std",search_result:!0}}]:n,c=e9({max_tokens:a,temperature:i,top_p:s},{maxTokensRange:r.includes("glm-4v")?{max:1024}:"glm-zero-preview"===r?{max:15300}:void 0,normalizeTemperature:!0,..."glm-4-alltools"===r&&{temperatureRange:{max:.99,min:.01},topPRange:{max:.99,min:.01}}});return{...l,...c,model:r,stream:!0,thinking:r.includes("-4.5")?{type:o?.type}:void 0,tools:d}},handleStream:(e,{callbacks:t,inputStartAt:a})=>ex((e instanceof ReadableStream?e:em(e)).pipeThrough(new TransformStream({transform(e,t){if(e.choices&&e.choices[0]){let a=e.choices[0];if(a.delta?.tool_calls&&Array.isArray(a.delta.tool_calls)){let r=a.delta.tool_calls.map((e,t)=>({...e,index:e.index<0?t:e.index})),i={...e,choices:[{...a,delta:{...a.delta,tool_calls:r}}]};t.enqueue(i)}else t.enqueue(e)}else t.enqueue(e)}})),{callbacks:t,inputStartAt:a,payload:{provider:"zhipu"}})},debug:{chatCompletion:()=>"1"===im.env.DEBUG_ZHIPU_CHAT_COMPLETION},models:async({client:e})=>{let t=await fetch("https://open.bigmodel.cn/api/fine-tuning/model_center/list?pageSize=100&pageNum=1",{headers:{Authorization:`Bearer ${e.apiKey}`,"Bigmodel-Organization":"lobehub","Bigmodel-Project":"lobechat"},method:"GET"}),a=(await t.json()).rows.map(e=>({description:e.description,displayName:e.modelName,id:e.modelCode}));return(0,eH.processModelList)(a,eH.MODEL_LIST_CONFIGS.zhipu,"zhipu")},provider:w.ModelProvider.ZhiPu})};class ih{constructor(e){this._runtime=e}async chat(e,t){return this._runtime.chat(e,t)}async generateObject(e){return this._runtime.generateObject(e)}async textToImage(e){return this._runtime.textToImage?.(e)}async createImage(e){return this._runtime.createImage?.(e)}async models(){return this._runtime.models?.()}async embeddings(e,t){return this._runtime.embeddings?.(e,t)}async textToSpeech(e,t){return this._runtime.textToSpeech?.(e,t)}async pullModel(e,t){return this._runtime.pullModel?.(e,t)}getAuthHeaders(){return this._runtime.getAuthHeaders?.()}static initializeWithProvider(e,t){return new ih(new(ig[e]??eW)(t))}}},61092:(e,t,a)=>{a.d(t,{MODEL_LIST_CONFIGS:()=>i,UQ:()=>c,bY:()=>h,processModelList:()=>g});let r=["-search"],i={anthropic:{functionCallKeywords:["claude"],reasoningKeywords:["-3-7","3.7","-4"],visionKeywords:["claude"]},comfyui:{functionCallKeywords:[],reasoningKeywords:[],visionKeywords:[]},deepseek:{functionCallKeywords:["v3","r1","deepseek-chat"],reasoningKeywords:["r1","deepseek-reasoner","v3.1","v3.2"],visionKeywords:["ocr"]},google:{excludeKeywords:["tts"],functionCallKeywords:["gemini","!-image-"],imageOutputKeywords:["-image-"],reasoningKeywords:["thinking","-2.5-","!-image-"],searchKeywords:["-search","!-image-"],videoKeywords:["-2.5-","!-image-"],visionKeywords:["gemini","learnlm"]},inclusionai:{functionCallKeywords:["ling-"],reasoningKeywords:["ring-"],visionKeywords:["ming-"]},llama:{functionCallKeywords:["llama-3.2","llama-3.3","llama-4"],reasoningKeywords:[],visionKeywords:["llava"]},longcat:{functionCallKeywords:["longcat"],reasoningKeywords:["thinking"],visionKeywords:[]},minimax:{functionCallKeywords:["minimax"],reasoningKeywords:["-m"],visionKeywords:["-vl","Text-01"]},moonshot:{functionCallKeywords:["moonshot","kimi"],reasoningKeywords:["thinking"],visionKeywords:["vision","kimi-latest","kimi-thinking-preview"]},openai:{excludeKeywords:["audio"],functionCallKeywords:["4o","4.1","o3","o4","oss"],reasoningKeywords:["o1","o3","o4","oss"],visionKeywords:["4o","4.1","o4"]},qwen:{functionCallKeywords:["qwen-max","qwen-plus","qwen-turbo","qwen-long","qwen1.5","qwen2","qwen2.5","qwen3"],reasoningKeywords:["qvq","qwq","qwen3","!-instruct-","!-coder-","!-max-"],visionKeywords:["qvq","-vl","-omni"]},v0:{functionCallKeywords:["v0"],reasoningKeywords:["v0-1.5"],visionKeywords:["v0"]},volcengine:{functionCallKeywords:["1.5","1-5","1.6","1-6"],reasoningKeywords:["thinking","seed","ui-tars"],visionKeywords:["vision","-m","seed","ui-tars"]},wenxin:{functionCallKeywords:["ernie-5","ernie-x1","pro","ernie-4.5-21b-a3b-thinking"],reasoningKeywords:["thinking","ernie-x","ernie-4.5-vl-28b-a3b"],visionKeywords:["-vl","ernie-5.0","picocr","qianfan-composition"]},xai:{functionCallKeywords:["grok"],reasoningKeywords:["mini","grok-4","grok-code-fast","!non-reasoning"],visionKeywords:["vision","grok-4"]},zeroone:{functionCallKeywords:["fc"],visionKeywords:["vision"]},zhipu:{functionCallKeywords:["glm-4","glm-z1"],reasoningKeywords:["glm-zero","glm-z1","glm-4.5"],visionKeywords:["glm-4v","glm-4.1v","glm-4.5v"]}},o={anthropic:["claude"],comfyui:["comfyui/"],deepseek:["deepseek"],google:["gemini","imagen"],inclusionai:["ling-","ming-","ring-"],llama:["llama","llava"],longcat:["longcat"],minimax:["minimax"],moonshot:["moonshot","kimi"],openai:["o1","o3","o4","gpt-"],qwen:["qwen","qwq","qvq"],v0:["v0"],volcengine:["doubao"],wenxin:["ernie","qianfan"],xai:["grok"],zeroone:["yi-"],zhipu:["glm"]},n=["dall-e","dalle","midjourney","stable-diffusion","sd","flux","imagen","firefly","cogview","wanxiang","DESCRIBE","UPSCALE","!gemini","-image","^V3","^V_2","^V_1"],s=["embedding","embed","bge","m3e"],l=(e,t)=>{let a=t.filter(e=>e.startsWith("!")),r=t.filter(e=>!e.startsWith("!"));for(let t of a){let a=t.slice(1);if(a.startsWith("^")?e.startsWith(a.slice(1)):e.includes(a))return!1}return r.some(t=>{if(t.startsWith("^")){let a=t.slice(1);return e.startsWith(a)}return e.includes(t)})},d=async(e,t)=>{let r=e.toLowerCase();try{let e=await Promise.resolve().then(a.bind(a,80286));if(!(t in e))return null;let i=e[t];if(Array.isArray(i))return i.find(e=>e.id.toLowerCase()===r);return null}catch{return null}},c=e=>{let t=e.toLowerCase();for(let[e,a]of Object.entries(o))if(l(t,a)&&e in i)return e;return"openai"},u=async e=>{let t=null;if(e)try{t=(await Promise.resolve().then(a.bind(a,80286)))[e]}catch{t=null}return t},p=(e,t)=>{let a=null;return e&&Array.isArray(e)&&(a=e.find(e=>e.id===t.id)),a},m=(e,t,a)=>{var i;let{functionCallKeywords:o=[],visionKeywords:d=[],reasoningKeywords:c=[],excludeKeywords:u=[],searchKeywords:p=r,imageOutputKeywords:m=[],videoKeywords:g=[]}=t,h=l(e.id.toLowerCase(),u),y=e.type||a?.type||(l(e.id.toLowerCase(),n.map(e=>e.toLowerCase()))?"image":l(e.id.toLowerCase(),s.map(e=>e.toLowerCase()))?"embedding":"chat");if("image"!==y||e.parameters||a?.parameters)return{contextWindowTokens:e.contextWindowTokens??a?.contextWindowTokens??void 0,description:e.description??a?.description??"",displayName:(i=e.displayName??a?.displayName??e.id).includes("Gemini 2.5 Flash Image Preview")?i.replace("Gemini 2.5 Flash Image Preview","Nano Banana"):i,enabled:e?.enabled||!1,functionCall:e.functionCall??a?.abilities?.functionCall??(l(e.id.toLowerCase(),o)&&!h||!1),id:e.id,imageOutput:e.imageOutput??a?.abilities?.imageOutput??(l(e.id.toLowerCase(),m)&&!h||!1),maxOutput:e.maxOutput??a?.maxOutput??void 0,pricing:(e=>{if(!e||"object"!=typeof e)return;if(Array.isArray(e.units))return{units:e.units};let{input:t,output:a,cachedInput:r,writeCacheInput:i}=e;if("number"!=typeof t&&"number"!=typeof a&&"number"!=typeof r&&"number"!=typeof i)return;let o=[];return"number"==typeof t&&o.push({name:"textInput",rate:t,strategy:"fixed",unit:"millionTokens"}),"number"==typeof a&&o.push({name:"textOutput",rate:a,strategy:"fixed",unit:"millionTokens"}),"number"==typeof r&&o.push({name:"textInput_cacheRead",rate:r,strategy:"fixed",unit:"millionTokens"}),"number"==typeof i&&o.push({name:"textInput_cacheWrite",rate:i,strategy:"fixed",unit:"millionTokens"}),{units:o}})(e?.pricing)??void 0,reasoning:e.reasoning??a?.abilities?.reasoning??(l(e.id.toLowerCase(),c)&&!h||!1),releasedAt:((e,t)=>{if(void 0!==e.created&&null!==e.created){if("number"==typeof e.created&&e.created>163e7)return(e=>{if(null==e||Number.isNaN(e))return;let t=new Date(e>1e12?e:1e3*e),a=t.getUTCFullYear();if(a<1e3||a>9999)return;let r=t.toISOString().split("T")[0];return 10===r.length?r:void 0})(e.created);if("string"==typeof e.created)return/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/.test(e.created)?e.created.split("T")[0]:e.created}return e.releasedAt??t?.releasedAt??void 0})(e,a),search:e.search??a?.abilities?.search??(l(e.id.toLowerCase(),p)&&!h||!1),type:y,..."image"===y&&{parameters:e.parameters??a?.parameters},video:e.video??a?.abilities?.video??(l(e.id.toLowerCase(),g)&&!h||!1),vision:e.vision??a?.abilities?.vision??(l(e.id.toLowerCase(),d)&&!h||!1)}},g=async(e,t,r)=>{let{LOBE_DEFAULT_MODEL_LIST:i}=await Promise.resolve().then(a.bind(a,80286)),o=await u(r);return Promise.all(e.map(async e=>{let a=null;r&&(a=await d(e.id,r)),a||(a=i.find(t=>e.id.toLowerCase()===t.id.toLowerCase()));let n=m(e,t,a),s=p(o,e);return n&&s&&"boolean"==typeof s.enabled&&(n.enabled=s.enabled),n})).then(e=>e.filter(e=>!!e))},h=async(e,t)=>{let{LOBE_DEFAULT_MODEL_LIST:r}=await Promise.resolve().then(a.bind(a,80286)),o=await u(t);return Promise.all(e.map(async e=>{let t=c(e.id),a=i[t],n=await d(e.id,t);n||(n=r.find(t=>e.id.toLowerCase()===t.id.toLowerCase()));let s=p(o,e),l=m(e,a,n);return l&&s&&"boolean"==typeof s.enabled&&(l.enabled=s.enabled),l})).then(e=>e.filter(e=>!!e))}}}]);