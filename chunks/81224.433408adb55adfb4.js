"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[67806,81224],{61586:(e,t,a)=>{a.d(t,{r:()=>o});var i=a(84781);let n=e=>t=>t.generationBatchesMap[e]||[],r=e=>{let t=i.Q.activeGenerationTopicId(e);return t?n(t)(e):[]},o={getGenerationBatchesByTopicId:n,currentGenerationBatches:r,getGenerationBatchByBatchId:e=>t=>r(t).find(t=>t.id===e),isCurrentGenerationTopicLoaded:e=>{let t=i.Q.activeGenerationTopicId(e);return!!t&&Array.isArray(e.generationBatchesMap[t])}}},67806:(e,t,a)=>{a.d(t,{imageGenerationConfigSelectors:()=>n});let i=e=>e.parametersSchema,n={model:e=>e.model,provider:e=>e.provider,imageNum:e=>e.imageNum,isSupportedParam:e=>t=>e in i(t),parameters:e=>e.parameters,parametersSchema:i}},81224:(e,t,a)=>{a.d(t,{q:()=>er,k:()=>en});var i=a(14308),n=a(50786),r=a(23993),o=a(41734),c=a(80286),s=a(99061);let l=c.ModelProvider.OpenAI,p=(0,c.extractDefaultValues)(c.gptImage1ParamsSchema),d={model:"gpt-image-1",provider:l,imageNum:s.bw.defaultImageNum,parameters:p,parametersSchema:c.gptImage1ParamsSchema,isAspectRatioLocked:!1,activeAspectRatio:null,isInit:!1},u={activeGenerationTopicId:new URLSearchParams(window.location.search).get("topic"),loadingGenerationTopicIds:[],generationTopics:[]},g={...d,...u,generationBatchesMap:{},isCreating:!1,isCreatingWithNewTopic:!1};var h=a(68096),m=a.n(h),f=a(77605);let T=m()("lobe-image:service");class G{async createImage(e){T("Creating image with payload: %O",e);try{let t=await f.du.image.createImage.mutate(e);return T("Image creation service call completed successfully: %O",{batchId:t.data?.batch?.id,generationCount:t.data?.generations?.length,success:t.success}),t}catch(t){throw T("Image creation service call failed: %O",{error:t.message,payload:e}),t}}}let w=new G;var I=a(61586),y=a(67806),v=a(84781),B=a(35007),S=a(83034),M=a(64911),b=a(46265);class C{async getGenerationStatus(e,t){return f.du.generation.getGenerationStatus.query({asyncTaskId:t,generationId:e})}async deleteGeneration(e){return f.du.generation.deleteGeneration.mutate({generationId:e})}}let _=new C;class A{async getGenerationBatches(e){return f.du.generationBatch.getGenerationBatches.query({topicId:e})}async deleteGenerationBatch(e){return f.du.generationBatch.deleteGenerationBatch.mutate({batchId:e})}}let N=new A;var x=a(73722),E=a(61497),L=a(85601);let R=(0,E.K)("generationBatch"),$="SWR_USE_FETCH_GENERATION_BATCHES";var k=a(47260),P=a(94147),F=a(5930),z=a(38759),W=a(61520),j=a(42897);function O(e){if(!e||"string"!=typeof e)return 1;let t=e.split(":");if(2!==t.length)return 1;let[a,i]=t,n=Number(a),r=Number(i);return!Number.isFinite(n)||!Number.isFinite(r)||n<=0||r<=0?1:n/r}function H(e,t){let a=k.w.enabledImageModelList((0,P.l)()),i=a.find(e=>e.id===t);if(!i)throw Error(`Provider "${t}" not found in enabled image provider list. Available providers: ${a.map(e=>e.id).join(", ")}`);let n=i.children.find(t=>t.id===e);if(!n)throw Error(`Model "${e}" not found in provider "${t}". Available models: ${i.children.map(e=>e.id).join(", ")}`);let r=n.parameters;return{defaultValues:(0,c.extractDefaultValues)(r),activeModel:n,parametersSchema:r}}function U(e,t){let{defaultValues:a,parametersSchema:i}=H(e,t),n=((e,t)=>{if(e?.aspectRatio||e?.size||!e?.width||!e?.height)return null;let{width:a,height:i}=t;return"number"==typeof a&&"number"==typeof i&&a>0&&i>0?`${a}:${i}`:"1:1"})(i,a);return{defaultValues:a,parametersSchema:i,initialActiveRatio:n}}var D=a(15361),Q=a(31021),V=a.n(Q),q=a(19530),K=a(71411);class J{async getAllGenerationTopics(){return f.du.generationTopic.getAllGenerationTopics.query()}async createTopic(){return f.du.generationTopic.createTopic.mutate(void 0)}async updateTopic(e,t){return f.du.generationTopic.updateTopic.mutate({id:e,value:t})}async updateTopicCover(e,t){return f.du.generationTopic.updateTopicCover.mutate({coverUrl:t,id:e})}async deleteTopic(e){return f.du.generationTopic.deleteTopic.mutate({id:e})}}let X=new J;var Y=a(14306),Z=a(70030),ee=a(67095);let et="fetchGenerationTopics",ea=(0,E.K)("generationTopic"),ei=(0,o.t)("image"),en=(0,r.h)()((0,i.eh)(ei((...e)=>({...g,...((e,t)=>({setParamOnInput:(t,a)=>{e(e=>{let{parameters:i}=e;return{parameters:{...i,[t]:a}}},!1,`setParamOnInput/${t}`)},setWidth:t=>{e(e=>{let{parameters:a,isAspectRatioLocked:i,activeAspectRatio:n,parametersSchema:r}=e,o={...a,width:t};if(i&&n){let e=O(n),a=r?.height;a&&"number"==typeof a.max&&"number"==typeof a.min&&(o.height=Math.max(Math.min(Math.round(t/e),a.max),a.min))}return{parameters:o}},!1,"setWidth")},setHeight:t=>{e(e=>{let{parameters:a,isAspectRatioLocked:i,activeAspectRatio:n,parametersSchema:r}=e,o={...a,height:t};if(i&&n){let e=O(n),a=r?.width;a&&"number"==typeof a.max&&"number"==typeof a.min&&(o.width=Math.max(Math.min(Math.round(t*e),a.max),a.min))}return{parameters:o}},!1,"setHeight")},toggleAspectRatioLock:()=>{e(e=>{let{isAspectRatioLocked:t,activeAspectRatio:a,parameters:i,parametersSchema:n}=e,r=!t;if(r&&a&&i&&n){let e=i.width,t=i.height;if("number"==typeof e&&"number"==typeof t&&n?.width&&n?.height){let o=O(a);if(Math.abs(e/t-o)>.01){let a=n.width,c=n.height;if(a&&c&&"number"==typeof a.max&&"number"==typeof a.min&&"number"==typeof c.max&&"number"==typeof c.min){let n=e,s=Math.round(e/o);return s>c.max||s<c.min?(s=t,n=Math.max(Math.min(n=Math.round(t*o),a.max),a.min)):s=Math.max(Math.min(s,c.max),c.min),{isAspectRatioLocked:r,parameters:{...i,width:n,height:s}}}}}}return{isAspectRatioLocked:r}},!1,"toggleAspectRatioLock")},setAspectRatio:a=>{let{parameters:i,parametersSchema:n}=t();if(!i||!n)return;let r=(0,c.extractDefaultValues)(n),o={...i};if(n?.width&&n?.height&&"number"==typeof r.width&&"number"==typeof r.height){let{width:e,height:t}=function(e,t,a){if(!Number.isFinite(e)||e<=0)throw Error("Invalid ratio: must be a positive finite number");if(!Number.isFinite(t)||t<=0)throw Error("Invalid defaultWidth: must be a positive finite number");if(!Number.isFinite(a)||a<=0)throw Error("Invalid defaultHeight: must be a positive finite number");return e>t/a?{width:t,height:Math.round(t/e)}:{width:Math.round(a*e),height:a}}(O(a),r.width,r.height);o.width=e,o.height=t}n?.aspectRatio&&(o.aspectRatio=a),e({activeAspectRatio:a,parameters:o},!1,`setAspectRatio/${a}`)},setModelAndProviderOnSelect:(t,a)=>{let{defaultValues:i,parametersSchema:n,initialActiveRatio:r}=U(t,a);e({model:t,provider:a,parameters:i,parametersSchema:n,isAspectRatioLocked:!1,activeAspectRatio:r},!1,`setModelAndProviderOnSelect/${t}/${a}`),W.P.isLogin(z.k.getState())&&F.o.getState().updateSystemStatus({lastSelectedImageModel:t,lastSelectedImageProvider:a})},setImageNum:t=>{e(()=>({imageNum:t}),!1,`setImageNum/${t}`)},reuseSettings:(t,a,i)=>{let{defaultValues:n,parametersSchema:r}=H(t,a);e(()=>({model:t,provider:a,parameters:{...n,...i},parametersSchema:r}),!1,`reuseSettings/${t}/${a}`)},reuseSeed:t=>{e(e=>({parameters:{...e.parameters,seed:t}}),!1,`reuseSeed/${t}`)},_initializeDefaultImageConfig:()=>{let{defaultImageNum:t}=j.w0.currentImageSettings(z.k.getState());e({imageNum:t,isInit:!0},!1,"initializeImageConfig/default")},initializeImageConfig:(a,i,n)=>{let{_initializeDefaultImageConfig:r}=t(),{defaultImageNum:o}=j.w0.currentImageSettings(z.k.getState());if(a&&i&&n)try{let{defaultValues:t,parametersSchema:a,initialActiveRatio:r}=U(i,n);e({model:i,provider:n,parameters:t,parametersSchema:a,isAspectRatioLocked:!1,activeAspectRatio:r,imageNum:o,isInit:!0},!1,`initializeImageConfig/${i}/${n}`)}catch{r()}else r()}}))(...e),...((e,t)=>({createGenerationTopic:async e=>{if(!e||0===e.length)throw Error("Prompts cannot be empty when creating a generation topic");let{internal_createGenerationTopic:a,summaryGenerationTopicTitle:i}=t(),n=await a();return i(n,e),n},switchGenerationTopic:a=>{t().generationTopics.find(e=>e.id===a)?t().activeGenerationTopicId!==a&&e({activeGenerationTopicId:a},!1,ea("switchGenerationTopic")):console.warn(`Generation topic with id ${a} not found`)},openNewGenerationTopic:()=>{e({activeGenerationTopicId:null},!1,ea("openNewGenerationTopic"))},summaryGenerationTopicTitle:async(e,a)=>{if(!v.Q.getGenerationTopicById(e)(t()))throw Error(`Topic ${e} not found`);let{internal_updateGenerationTopicTitleInSummary:i,internal_updateGenerationTopicLoading:n}=t();n(e,!0),i(e,q.VH);let r="",o=Z.v.generationTopic(z.k.getState());return await K.O.fetchPresetTaskResult({params:(0,ee.h)(o,(0,D.ux)(a,"image",Y.J.getCurrentLanguage())),onError:async()=>{let n=a[0].replaceAll(/[^\s\w\u4E00-\u9FFF]/g,"").trim().split(/\s+/).slice(0,3).join(" ").slice(0,10);i(e,n),await t().internal_updateGenerationTopic(e,{title:n})},onFinish:async a=>{await t().internal_updateGenerationTopic(e,{title:a})},onLoadingChange:t=>{n(e,t)},onMessageHandle:t=>{"text"===t.type&&i(e,r+=t.text)}}),r},internal_createGenerationTopic:async()=>{let e=Date.now().toString();t().internal_dispatchGenerationTopic({type:"addTopic",value:{id:e,title:""}},"internal_createGenerationTopic"),t().internal_updateGenerationTopicLoading(e,!0);let a=await X.createTopic();return t().internal_updateGenerationTopicLoading(e,!1),t().internal_updateGenerationTopicLoading(a,!0),await t().refreshGenerationTopics(),t().internal_updateGenerationTopicLoading(a,!1),a},internal_updateGenerationTopic:async(e,a)=>{t().internal_dispatchGenerationTopic({type:"updateTopic",id:e,value:a}),t().internal_updateGenerationTopicLoading(e,!0),await X.updateTopic(e,a),await t().refreshGenerationTopics(),t().internal_updateGenerationTopicLoading(e,!1)},internal_updateGenerationTopicTitleInSummary:(e,a)=>{t().internal_dispatchGenerationTopic({type:"updateTopic",id:e,value:{title:a}},"updateGenerationTopicTitleInSummary")},internal_updateGenerationTopicLoading:(t,a)=>{e(e=>a?{loadingGenerationTopicIds:[...e.loadingGenerationTopicIds,t]}:{loadingGenerationTopicIds:e.loadingGenerationTopicIds.filter(e=>e!==t)},!1,ea("updateGenerationTopicLoading"))},internal_dispatchGenerationTopic:(a,i)=>{let n=((e=[],t)=>{switch(t.type){case"addTopic":return(0,L.jM)(e,e=>{let a=new Date;e.unshift({title:t.value.title||null,coverUrl:t.value.coverUrl||null,createdAt:t.value.createdAt||a,updatedAt:t.value.updatedAt||a,...t.value})});case"updateTopic":return(0,L.jM)(e,e=>{let a=e.findIndex(e=>e.id===t.id);-1!==a&&(e[a]={...e[a],...t.value,updatedAt:new Date})});case"deleteTopic":return e.filter(e=>e.id!==t.id);default:return e}})(t().generationTopics,a);V()(n,t().generationTopics)||e({generationTopics:n},!1,i??ea(`dispatchGenerationTopic/${a.type}`))},useFetchGenerationTopics:a=>(0,b.lA)(a?[et]:null,()=>X.getAllGenerationTopics(),{suspense:!0,onSuccess:a=>{V()(a,t().generationTopics)||e({generationTopics:a},!1,ea("useFetchGenerationTopics"))}}),refreshGenerationTopics:async()=>{await (0,M.j)([et])},removeGenerationTopic:async e=>{let{internal_removeGenerationTopic:a,generationTopics:i,activeGenerationTopicId:n,switchGenerationTopic:r,openNewGenerationTopic:o}=t(),c=n===e,s=-1;if(c&&(s=i.findIndex(t=>t.id===e)),await a(e),c){let e=t().generationTopics;if(e.length>0){let t=Math.min(s,e.length-1),a=e[t];a?r(a.id):o()}else o()}},internal_removeGenerationTopic:async e=>{t().internal_updateGenerationTopicLoading(e,!0);try{await X.deleteTopic(e),await t().refreshGenerationTopics()}finally{t().internal_updateGenerationTopicLoading(e,!1)}},updateGenerationTopicCover:async(e,a)=>{let{internal_updateGenerationTopicCover:i}=t();await i(e,a)},internal_updateGenerationTopicCover:async(e,a)=>{let{internal_dispatchGenerationTopic:i,internal_updateGenerationTopicLoading:n,refreshGenerationTopics:r}=t();i({type:"updateTopic",id:e,value:{coverUrl:a}},"internal_updateGenerationTopicCover/optimistic"),n(e,!0);try{await X.updateTopicCover(e,a),await r()}finally{n(e,!1)}}}))(...e),...((e,t)=>({setTopicBatchLoaded:a=>{let i={...t().generationBatchesMap,[a]:[]};(0,B.A)(i,t().generationBatchesMap)||e({generationBatchesMap:i},!1,R("setTopicBatchLoaded"))},removeGeneration:async e=>{let{internal_deleteGeneration:a,activeGenerationTopicId:i,refreshGenerationBatches:n}=t();if(await a(e),i){let e=(t().generationBatchesMap[i]||[]).filter(e=>0===e.generations.length);for(let a of e)await t().internal_deleteGenerationBatch(a.id,i);e.length>0&&await n()}},internal_deleteGeneration:async e=>{let{activeGenerationTopicId:a,refreshGenerationBatches:i,internal_dispatchGenerationBatch:n}=t();if(!a)return;let r=(t().generationBatchesMap[a]||[]).find(t=>t.generations.some(t=>t.id===e));r&&(n(a,{type:"deleteGenerationInBatch",batchId:r.id,generationId:e},"internal_deleteGeneration"),await _.deleteGeneration(e),await i())},removeGenerationBatch:async(e,a)=>{let{internal_deleteGenerationBatch:i}=t();await i(e,a)},internal_deleteGenerationBatch:async(e,a)=>{let{internal_dispatchGenerationBatch:i,refreshGenerationBatches:n}=t();i(a,{type:"deleteBatch",id:e},"internal_deleteGenerationBatch"),await N.deleteGenerationBatch(e),await n()},internal_dispatchGenerationBatch:(a,i,n)=>{let r=((e=[],t)=>{switch(t.type){case"updateGenerationInBatch":return(0,L.jM)(e,e=>{let a=e.findIndex(e=>e.id===t.batchId);if(-1===a)return;let i=e[a].generations.findIndex(e=>e.id===t.generationId);-1!==i&&(e[a].generations[i]={...e[a].generations[i],...t.value})});case"updateBatch":return(0,L.jM)(e,e=>{let a=e.findIndex(e=>e.id===t.id);-1!==a&&(e[a]={...e[a],...t.value})});case"deleteBatch":return e.filter(e=>e.id!==t.id);case"deleteGenerationInBatch":return(0,L.jM)(e,e=>{let a=e.findIndex(e=>e.id===t.batchId);-1!==a&&(e[a].generations=e[a].generations.filter(e=>e.id!==t.generationId))});case"addBatch":return(0,L.jM)(e,e=>{e.unshift(t.value)});default:return e}})(t().generationBatchesMap[a]||[],i),o={...t().generationBatchesMap,[a]:r};(0,B.A)(o,t().generationBatchesMap)||e({generationBatchesMap:o},!1,n??R(`dispatchGenerationBatch/${i.type}`))},refreshGenerationBatches:async()=>{let{activeGenerationTopicId:e}=t();e&&await (0,M.j)([$,e])},useFetchGenerationBatches:a=>(0,b.lA)(a?[$,a]:null,async([,e])=>N.getGenerationBatches(e),{onSuccess:i=>{let n={...t().generationBatchesMap,[a]:i};(0,B.A)(n,t().generationBatchesMap)||e({generationBatchesMap:n},!1,R("useFetchGenerationBatches(success)",{topicId:a}))}}),useCheckGenerationStatus:(e,a,i,n=!0)=>{let r=(0,S.useRef)(0),o=(0,S.useRef)(!1);return(0,b.lA)(n&&e&&!e.startsWith("temp-")&&a?["SWR_USE_CHECK_GENERATION_STATUS",e,a]:null,async([,e,t])=>(r.current+=1,_.getGenerationStatus(e,t)),{refreshWhenHidden:!1,refreshInterval:e=>{if(e?.status===x.cz.Success||e?.status===x.cz.Error)return 0;let t=Math.min(1e3*Math.pow(2,Math.floor(r.current/5)),3e4);return o.current&&(t=Math.min(2*t,3e4)),t},onError:e=>{o.current=!0,console.error("Generation status check error:",e)},onSuccess:async a=>{if(!a)return;o.current=!1;let n=(t().generationBatchesMap[i]||[]).find(t=>t.generations.some(t=>t.id===e));if((a.status===x.cz.Success||a.status===x.cz.Error)&&n){if(r.current=0,a.generation&&(t().internal_dispatchGenerationBatch(i,{type:"updateGenerationInBatch",batchId:n.id,generationId:e,value:a.generation},R(`useCheckGenerationStatus/${a.status===x.cz.Success?"success":"error"}`)),a.status===x.cz.Success&&a.generation.asset?.thumbnailUrl)){let e=v.Q.getGenerationTopicById(i)(t());e&&!e.coverUrl&&await t().updateGenerationTopicCover(i,a.generation.asset.thumbnailUrl)}await t().refreshGenerationBatches()}}})}}))(...e),...((e,t)=>({async createImage(){e({isCreating:!0},!1,"createImage/startCreateImage");let a=t(),i=y.imageGenerationConfigSelectors.imageNum(a),n=y.imageGenerationConfigSelectors.parameters(a),r=y.imageGenerationConfigSelectors.provider(a),o=y.imageGenerationConfigSelectors.model(a),c=v.Q.activeGenerationTopicId(a),{createGenerationTopic:s,switchGenerationTopic:l,setTopicBatchLoaded:p}=a;if(!n)throw TypeError("parameters is not initialized");if(!n.prompt)throw TypeError("prompt is empty");let d=c,u=!1;if(!c){u=!0;let e=[n.prompt],t=await s(e);d=t,p(t),l(t)}try{u&&e({isCreatingWithNewTopic:!0},!1,"createImage/startCreateImageWithNewTopic"),await w.createImage({generationTopicId:d,provider:r,model:o,imageNum:i,params:n}),u||await t().refreshGenerationBatches(),e(e=>({parameters:{...e.parameters,prompt:""}}),!1,"createImage/clearPrompt")}finally{u?e({isCreating:!1,isCreatingWithNewTopic:!1},!1,"createImage/endCreateImageWithNewTopic"):e({isCreating:!1},!1,"createImage/endCreateImage")}},async recreateImage(a){e({isCreating:!0},!1,"recreateImage/startCreateImage");let i=t(),n=v.Q.activeGenerationTopicId(i);if(!n)throw Error("No active generation topic");let{removeGenerationBatch:r}=i,o=I.r.getGenerationBatchByBatchId(a)(i),c=o.generations.length;try{await r(a,n),await w.createImage({generationTopicId:n,provider:o.provider,model:o.model,imageNum:c,params:o.config}),await i.refreshGenerationBatches()}finally{e({isCreating:!1},!1,"recreateImage/endCreateImage")}}}))(...e)}))),n.x),er=()=>en.getState()},84781:(e,t,a)=>{a.d(t,{Q:()=>i});let i={activeGenerationTopicId:e=>e.activeGenerationTopicId,generationTopics:e=>e.generationTopics,getGenerationTopicById:e=>t=>t.generationTopics.find(t=>t.id===e),isLoadingGenerationTopic:e=>t=>t.loadingGenerationTopicIds.includes(e)}}}]);